<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Penjualan & Pembelian - PT. Sumber Ganda Mekar</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- SheetJS library untuk export/import Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://tkrmmdthpxhnthhyqrsh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrcm1tZHRocHhobnRoaHlxcnNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MjMxNzEsImV4cCI6MjA4NTI5OTE3MX0.y9naUEWQHfEcx3IgcbFNBaGuAl0YDqTzoqUNUismEkE';

        let supabaseClient;
        if (typeof supabase !== 'undefined') {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            // Re-check after a small delay if not loaded yet
            setTimeout(() => {
                if (typeof supabase !== 'undefined') {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                }
            }, 100);
        }

        // Supabase Sync Functions
        async function syncToSupabase(tableName, data) {
            try {
                // Sederhanakan: Simpan setiap item ke kolom 'data' dalam tabel Supabase
                // Pastikan tabel di Supabase memiliki kolom 'id' (int8) dan 'content' (jsonb)
                const { error } = await supabaseClient
                    .from(tableName)
                    .upsert({ id: 1, content: data }); // Menggunakan single record id=1 sebagai "store"

                if (error) throw error;
                console.log(`Synced ${tableName} to Supabase`);
            } catch (err) {
                console.error(`Error syncing ${tableName}:`, err.message);
            }
        }

        async function loadFromSupabase() {
            const tables = [
                'dataPenjualan', 'dataPembelian', 'dataTransaksiKas',
                'dataPembayaranPiutang', 'dataPembayaranHutang', 'dataJurnal',
                'dataMasterCustomer', 'dataMasterSupplier', 'dataMasterBarang',
                'dataPiutangAwal', 'dataHutangAwal', 'dataKasHarian',
                'kategoriKas', 'kategoriKasMasuk', 'kategoriKasKeluar'
            ];

            for (const table of tables) {
                try {
                    const { data, error } = await supabaseClient
                        .from(table)
                        .select('content')
                        .eq('id', 1)
                        .single();

                    if (error) {
                        if (error.code !== 'PGRST116') console.warn(`Table ${table} not found or empty in Supabase`);
                        continue;
                    }

                    if (data && data.content) {
                        window[table] = data.content;
                        console.log(`Loaded ${table} from Supabase`);
                    }
                } catch (err) {
                    console.error(`Error loading ${table}:`, err.message);
                }
            }
            updateAllDisplays();
        }

        // Auth Logic
        let authMode = 'login'; // 'login' or 'signup'

        function toggleAuthMode(e) {
            if (e) e.preventDefault();
            const title = document.querySelector('.login-card h2');
            const subTitle = document.querySelector('.login-card p');
            const submitBtn = document.getElementById('login-btn');
            const link = document.getElementById('auth-toggle-link');
            const errorEl = document.getElementById('login-error');
            const successEl = document.getElementById('login-success');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            if (authMode === 'login') {
                authMode = 'signup';
                title.textContent = 'DAFTAR AKUN BARU';
                subTitle.textContent = 'Buat akun untuk mulai menggunakan sistem';
                submitBtn.textContent = '📝 Daftar Sekarang';
                link.textContent = 'Sudah punya akun? Login';
            } else {
                authMode = 'login';
                title.textContent = 'PT. SUMBER GANDA MEKAR';
                subTitle.textContent = 'Silakan masuk untuk mengakses sistem';
                submitBtn.textContent = '🔓 Login';
                link.textContent = 'Belum punya akun? Daftar Baru';
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            const errorEl = document.getElementById('login-error');
            const successEl = document.getElementById('login-success');

            btn.disabled = true;
            btn.textContent = '⌛ Memproses...';
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            console.log('Attempting auth:', authMode, email);

            try {
                if (!supabaseClient) throw new Error("Supabase client belum siap. Coba lagi dalam beberapa detik.");

                if (authMode === 'login') {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    console.log('Login success:', data);
                } else {
                    const { data, error } = await supabaseClient.auth.signUp({ email, password });
                    if (error) throw error;

                    console.log('Signup success:', data);

                    if (data.user) {
                        if (data.session) {
                            successEl.textContent = '✅ Berhasil mendaftar dan langsung masuk!';
                            successEl.style.display = 'block';
                        } else {
                            successEl.textContent = '✅ Pendaftaran berhasil! Silakan cek email Anda untuk verifikasi atau hubungi Admin.';
                            successEl.style.display = 'block';
                            // Switch mode to login after successful signup
                            authMode = 'login';
                            toggleAuthMode(null);
                        }
                    }
                }
            } catch (err) {
                console.error('Auth error:', err);
                let userMessage = err.message || 'Terjadi kesalahan tidak dikenal';

                // Specific handling for common Supabase Auth errors
                if (err.message.includes('Email not confirmed')) {
                    userMessage = '❌ Email belum dikonfirmasi. <br><br><b>Solusi:</b><br>1. Cek inbox/spam email Anda untuk link aktivasi, ATAU<br>2. Di Dashboard Supabase, buka menu <i>Authentication -> Providers -> Email</i> dan matikan <b>"Confirm email"</b> agar bisa langsung login.';
                } else if (err.message.includes('rate limit exceeded')) {
                    userMessage = '❌ Terlalu banyak permintaan (Rate Limit). Mohon tunggu beberapa menit sebelum mencoba lagi.';
                } else if (err.message.includes('Invalid login credentials')) {
                    userMessage = '❌ Email atau Password salah.';
                }

                errorEl.innerHTML = userMessage;
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = authMode === 'login' ? '🔓 Login' : '📝 Daftar Sekarang';
            }
        }

        async function handleLogout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                await supabaseClient.auth.signOut();
                window.location.reload();
            }
        }

        // Initialize Auth when client is ready
        function initAuth() {
            if (!supabaseClient) {
                setTimeout(initAuth, 50);
                return;
            }

            // Listen for auth changes
            supabaseClient.auth.onAuthStateChange((event, session) => {
                console.log('Auth state change:', event, session?.user?.email);
                if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
                    if (session) {
                        document.getElementById('login-overlay').style.display = 'none';
                        document.getElementById('main-app').style.display = 'flex';
                        document.getElementById('user-display').textContent = session.user.email;
                        loadFromSupabase(); // Load data after login
                    }
                } else if (event === 'SIGNED_OUT') {
                    document.getElementById('login-overlay').style.display = 'flex';
                    document.getElementById('main-app').style.display = 'none';
                }
            });
        }
        initAuth();
    </script>

    <script>
        // Array untuk detail barang penjualan
        let detailBarangJual = [];
        // Array untuk detail barang pembelian
        let detailBarangBeli = [];

        // Fungsi format Rupiah
        function formatRupiah(angka) {
            if (angka === null || angka === undefined || angka === '') return 'Rp 0';
            var number_string = angka.toString().replace(/[^,\d]/g, '').toString(),
                split = number_string.split(','),
                sisa = split[0].length % 3,
                rupiah = split[0].substr(0, sisa),
                ribuan = split[0].substr(sisa).match(/\d{3}/gi);

            if (ribuan) {
                separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }

            rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
            return 'Rp ' + rupiah;
        }

        // Fungsi format Tanggal
        function formatTanggal(tanggal) {
            if (!tanggal) return '';
            const date = new Date(tanggal);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }

        // Fungsi format Tanggal Singkat (DD/MM/YYYY)
        function formatTanggalShort(tanggal) {
            if (!tanggal) return '';
            const date = new Date(tanggal);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Fungsi parse Rupiah value (convert dari string format Rupiah ke angka)
        function parseRupiahValue(str) {
            if (!str) return 0;
            // Hapus 'Rp', spasi, dan titik pemisah ribuan, lalu parse ke integer
            return parseInt(str.toString().replace(/[^\d]/g, '') || '0');
        }

        // Fungsi format Tanggal Baru (format standar Indonesia)
        function formatTanggalBaru(tanggal) {
            if (!tanggal) return '';
            const date = new Date(tanggal);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Fungsi debounce untuk performance
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Fungsi Laporan Kas Masuk dan Kas Keluar - DIHAPUS, gunakan Jurnal atau Transaksi Kas

        function tambahDetailBarangBeli() {
            const nama = document.getElementById('namaBarangBeli').value.trim();
            const qty = parseInt(document.getElementById('qtyBeli').value.replace(/[^\d]/g, '')) || 0;
            const harga = parseInt(document.getElementById('hargaBeli').value.replace(/[^\d]/g, '')) || 0;
            const diskon = parseInt(document.getElementById('diskonBeli').value.replace(/[^\d]/g, '')) || 0;
            const ppn = document.getElementById('jenisPpnBeli').value;
            if (!nama || qty <= 0 || harga <= 0) {
                alert('Nama barang, qty, dan harga harus diisi!');
                return;
            }
            // Hitung subtotal
            let subtotal = qty * harga - diskon;
            if (ppn === 'ppn11') subtotal += Math.round(subtotal * 0.11);
            if (ppn === 'ppn1') subtotal += Math.round(subtotal * 0.011);
            detailBarangBeli.push({ nama, qty, harga, diskon, ppn, subtotal });
            renderDetailBarangBeli();
            // Reset input barang
            document.getElementById('namaBarangBeli').value = '';
            document.getElementById('qtyBeli').value = '';
            document.getElementById('hargaBeli').value = '';
            document.getElementById('diskonBeli').value = '0';
            document.getElementById('jenisPpnBeli').value = 'nonppn';
            document.getElementById('subtotalBeli').value = '';
            hitungTotalBeliDariDetail();
        }

        function hapusDetailBarangBeli(idx) {
            detailBarangBeli.splice(idx, 1);
            renderDetailBarangBeli();
            hitungTotalBeliDariDetail();
        }

        function renderDetailBarangBeli() {
            const tbody = document.getElementById('bodyDetailBarangBeli');
            if (!tbody) return;
            if (detailBarangBeli.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="center">Belum ada barang</td></tr>';
                return;
            }
            tbody.innerHTML = detailBarangBeli.map((b, i) => `
            <tr>
                <td class="center">${i + 1}</td>
                <td>${b.nama}</td>
                <td class="center">${b.qty}</td>
                <td class="number">${formatRupiah(b.harga)}</td>
                <td class="number">${formatRupiah(b.diskon)}</td>
                <td>${b.ppn}</td>
                <td class="number">${formatRupiah(b.subtotal)}</td>
                <td class="center"><button class="delete-btn" onclick="hapusDetailBarangBeli(${i})">🗑️</button></td>
            </tr>
        `).join('');
        }

        function hitungTotalBeliDariDetail() {
            let total = detailBarangBeli.reduce((sum, b) => sum + b.subtotal, 0);
            const totalEl = document.getElementById('totalBeli');
            if (totalEl) totalEl.value = formatRupiah(total);
            calculateSisaTagihanBeli();
        }

        function calculateSisaTagihanJual() {
            const total = parseRupiahValue(document.getElementById('totalJual').value);
            const dp = parseRupiahValue(document.getElementById('dpJual').value);
            const sisa = Math.max(0, total - dp);
            const sisaEl = document.getElementById('sisaJual');
            if (sisaEl) sisaEl.value = formatRupiah(sisa);
        }

        function calculateSisaTagihanBeli() {
            const total = parseRupiahValue(document.getElementById('totalBeli').value);
            const dp = parseRupiahValue(document.getElementById('dpBeli').value);
            const sisa = Math.max(0, total - dp);
            const sisaEl = document.getElementById('sisaBeli');
            if (sisaEl) sisaEl.value = formatRupiah(sisa);
        }

        // Reset detail barang saat reset form pembelian
        function resetFormPembelianCustom() {
            detailBarangBeli = [];
            renderDetailBarangBeli();
            document.getElementById('formPembelian').reset();
            hitungTotalBeliDariDetail();
        }

        function tambahDetailBarangJual() {
            const nama = document.getElementById('namaBarangJual').value.trim();
            const qty = parseInt(document.getElementById('qtyJual').value.replace(/[^\d]/g, '')) || 0;
            const harga = parseInt(document.getElementById('hargaJual').value.replace(/[^\d]/g, '')) || 0;
            const diskon = parseInt(document.getElementById('diskonJual').value.replace(/[^\d]/g, '')) || 0;
            const ppn = document.getElementById('jenisPpnJual').value;
            if (!nama || qty <= 0 || harga <= 0) {
                alert('Nama barang, qty, dan harga harus diisi!');
                return;
            }
            // Hitung subtotal
            let subtotal = qty * harga - diskon;
            if (ppn === 'ppn11') subtotal += Math.round(subtotal * 0.11);
            if (ppn === 'ppn1') subtotal += Math.round(subtotal * 0.011);
            // Tambah ke array
            detailBarangJual.push({ nama, qty, harga, diskon, ppn, subtotal });
            renderDetailBarangJual();
            // Reset input barang
            document.getElementById('namaBarangJual').value = '';
            document.getElementById('qtyJual').value = '';
            document.getElementById('hargaJual').value = '';
            document.getElementById('diskonJual').value = '0';
            document.getElementById('jenisPpnJual').value = 'nonppn';
            document.getElementById('subtotalJual').value = '';
            hitungTotalJualDariDetail();
        }

        function hapusDetailBarangJual(idx) {
            detailBarangJual.splice(idx, 1);
            renderDetailBarangJual();
            hitungTotalJualDariDetail();
        }

        function renderDetailBarangJual() {
            const tbody = document.getElementById('bodyDetailBarangJual');
            if (!tbody) return;
            if (detailBarangJual.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="center">Belum ada barang</td></tr>';
                return;
            }
            tbody.innerHTML = detailBarangJual.map((b, i) => `
            <tr>
                <td class="center">${i + 1}</td>
                <td>${b.nama}</td>
                <td class="center">${b.qty}</td>
                <td class="number">${formatRupiah(b.harga)}</td>
                <td class="number">${formatRupiah(b.diskon)}</td>
                <td>${b.ppn}</td>
                <td class="number">${formatRupiah(b.subtotal)}</td>
                <td class="center"><button class="delete-btn" onclick="hapusDetailBarangJual(${i})">🗑️</button></td>
            </tr>
        `).join('');
        }

        function hitungTotalJualDariDetail() {
            let total = detailBarangJual.reduce((sum, b) => sum + b.subtotal, 0);
            document.getElementById('totalJual').value = formatRupiah(total);
            calculateSisaTagihanJual();
        }

        // Reset detail barang saat reset form
        function resetFormPenjualanCustom() {
            detailBarangJual = [];
            renderDetailBarangJual();
            document.getElementById('formPenjualan').reset();
            hitungTotalJualDariDetail();
        }
    </script>
    <script>
        // FUNGSI PRINT - Dipindahkan dari bawah, sekarang dalam tag script

        // Fungsi untuk mencetak Buku Besar (format Excel, tanpa menu aplikasi)
        function printBukuBesar() {
            var akun = document.getElementById('filterAkunBukuBesar').value;
            var mulai = document.getElementById('filterBukuBesarMulai').value;
            var selesai = document.getElementById('filterBukuBesarSelesai').value;
            var periode = (mulai && selesai) ? 'Periode: ' + mulai + ' s/d ' + selesai : 'Periode: Semua Data';
            var akunText = akun ? 'Akun: ' + akun : 'Semua Akun';

            var bukuBesarContent = document.getElementById('bukuBesarAkun').innerHTML;

            var win = window.open('', '', 'height=800,width=1000');
            win.document.write('<html><head><title>Buku Besar - PT. Sumber Ganda Mekar</title>');
            win.document.write('<style>');
            win.document.write('body { font-family: "Inter", "Segoe UI", Arial, sans-serif; padding: 20px; margin: 0; background: white; color: #1e293b; }');
            win.document.write('.header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }');
            win.document.write('.header h1 { font-size: 18pt; margin: 0 0 5px 0; color: #1e293b; font-weight: 700; }');
            win.document.write('.header h2 { font-size: 14pt; margin: 0 0 5px 0; color: #64748b; font-weight: 600; }');
            win.document.write('.header p { font-size: 10pt; margin: 3px 0; color: #64748b; }');
            win.document.write('table { border-collapse: collapse; width: 100%; font-size: 10pt; margin: 10px 0; }');
            win.document.write('th, td { border: 1px solid #e2e8f0; padding: 8px 12px; }');
            win.document.write('th { background-color: #f8fafc; color: #1e293b; text-align: left; font-weight: 600; }');
            win.document.write('td { text-align: left; vertical-align: top; }');

            // Utility classes
            win.document.write('.text-right, td.number { text-align: right; font-family: "JetBrains Mono", Consolas, monospace; }');
            win.document.write('.text-center { text-align: center; }');

            // Widths
            win.document.write('.w-40px { width: 40px; }');
            win.document.write('.w-100px { width: 100px; }');
            win.document.write('.w-80px { width: 80px; }');
            win.document.write('.w-120px { width: 120px; }');

            win.document.write('tr:nth-child(even) { background-color: #f8fafc; }');
            win.document.write('tfoot tr { background-color: #fffde7 !important; font-weight: bold; border-top: 2px solid #cbd5e1; }');

            // Account header styling
            win.document.write('h3 { color: #1e293b; margin: 20px 0 10px 0; padding: 10px; background: #f1f5f9; border-left: 4px solid #4338ca; border-radius: 4px; font-size: 11pt; }');

            win.document.write('.footer { text-align: center; margin-top: 30px; font-size: 9pt; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 10px; }');
            win.document.write('@media print { body { padding: 0; } }');
            win.document.write('</style>');
            win.document.write('</head><body>');
            win.document.write('<div class="header">');
            win.document.write('<h1>PT. SUMBER GANDA MEKAR</h1>');
            win.document.write('<h2>BUKU BESAR</h2>');
            win.document.write('<p>' + akunText + '</p>');
            win.document.write('<p>' + periode + '</p>');
            win.document.write('</div>');
            win.document.write(bukuBesarContent);
            win.document.write('<div class="footer">Dicetak pada: ' + formatTanggal(new Date()) + '</div>');
            win.document.write('</body></html>');
            win.document.close();
            win.focus();
            win.print();
            win.close();
        }

        // Fungsi untuk mencetak Laporan Divisi (format Excel, tanpa menu aplikasi)
        function printLaporanDivisi() {
            var divisi = document.getElementById('filterDivisi').value;
            var mulai = document.getElementById('filterDivisiMulai').value;
            var selesai = document.getElementById('filterDivisiSelesai').value;
            var periode = (mulai && selesai) ? 'Periode: ' + mulai + ' s/d ' + selesai : 'Periode: Semua Data';
            var divisiText = divisi === 'semua' ? 'Semua Divisi' : 'Divisi: ' + divisi;

            var tableClone = document.getElementById('tableLaporanDivisi').cloneNode(true);

            var win = window.open('', '', 'height=800,width=1000');
            win.document.write('<html><head><title>Laporan Per Divisi - PT. Sumber Ganda Mekar</title>');
            win.document.write('<style>');
            win.document.write('body { font-family: Arial, sans-serif; padding: 20px; margin: 0; background: white; }');
            win.document.write('.header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px; }');
            win.document.write('.header h1 { font-size: 18pt; margin: 0 0 5px 0; color: #2c3e50; }');
            win.document.write('.header h2 { font-size: 14pt; margin: 0 0 5px 0; color: #333; }');
            win.document.write('.header p { font-size: 10pt; margin: 3px 0; color: #666; }');
            win.document.write('table { border-collapse: collapse; width: 100%; font-size: 10pt; margin-top: 10px; }');
            win.document.write('th, td { border: 1px solid #333; padding: 6px 8px; }');
            win.document.write('th { background-color: #4472C4; color: white; text-align: center; font-weight: bold; }');
            win.document.write('td { text-align: left; }');
            win.document.write('td.number { text-align: right; font-family: Consolas, monospace; }');
            win.document.write('tr:nth-child(even) { background-color: #D6DCE4; }');
            win.document.write('tfoot tr { background-color: #FFC000 !important; font-weight: bold; }');
            win.document.write('tfoot tr[style*="background-color: #4CAF50"] { background-color: #4CAF50 !important; color: white; }');
            win.document.write('.footer { text-align: center; margin-top: 30px; font-size: 9pt; color: #888; border-top: 1px solid #ccc; padding-top: 10px; }');
            win.document.write('@media print { body { padding: 10px; } }');
            win.document.write('</style>');
            win.document.write('</head><body>');
            win.document.write('<div class="header">');
            win.document.write('<h1>PT. SUMBER GANDA MEKAR</h1>');
            win.document.write('<h2>LAPORAN PER DIVISI</h2>');
            win.document.write('<p>' + divisiText + '</p>');
            win.document.write('<p>' + periode + '</p>');
            win.document.write('</div>');
            win.document.write(tableClone.outerHTML);
            win.document.write('<div class="footer">Dicetak pada: ' + formatTanggalBaru(new Date()) + '</div>');
            win.document.write('</body></html>');
            win.document.close();
            win.focus();
            win.print();
            win.close();
        }

        // Fungsi untuk mencetak Laporan PPN (format Excel, tanpa menu aplikasi)
        function printLaporanPPN() {
            var kategoriPPN = document.getElementById('filterKategoriPPN').value;
            var kategoriText = '';
            switch (kategoriPPN) {
                case 'nonppn': kategoriText = 'Non PPN'; break;
                case 'ppn11': kategoriText = 'PPN 11%'; break;
                case 'ppn1': kategoriText = 'PPN 1%'; break;
                default: kategoriText = kategoriPPN;
            }

            // Clone kedua tabel (penjualan dan pembelian PPN)
            var tablePenjualan = document.getElementById('tablePenjualanNonPPN').cloneNode(true);
            var tablePembelian = document.getElementById('tablePembelianNonPPN').cloneNode(true);

            var win = window.open('', '', 'height=800,width=1000');
            win.document.write('<html><head><title>Laporan ' + kategoriText + ' - PT. Sumber Ganda Mekar</title>');
            win.document.write('<style>');
            win.document.write('body { font-family: Arial, sans-serif; padding: 20px; margin: 0; background: white; }');
            win.document.write('.header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px; }');
            win.document.write('.header h1 { font-size: 18pt; margin: 0 0 5px 0; color: #2c3e50; }');
            win.document.write('.header h2 { font-size: 14pt; margin: 0 0 5px 0; color: #333; }');
            win.document.write('.header p { font-size: 10pt; margin: 3px 0; color: #666; }');
            win.document.write('.section-title { color: #2c3e50; margin: 25px 0 10px 0; padding: 8px; background: #e8e8e8; border-left: 4px solid #4472C4; font-size: 12pt; }');
            win.document.write('table { border-collapse: collapse; width: 100%; font-size: 10pt; margin: 10px 0; }');
            win.document.write('th, td { border: 1px solid #333; padding: 6px 8px; }');
            win.document.write('th { background-color: #4472C4; color: white; text-align: center; font-weight: bold; }');
            win.document.write('td { text-align: left; }');
            win.document.write('td.number { text-align: right; font-family: Consolas, monospace; }');
            win.document.write('tr:nth-child(even) { background-color: #D6DCE4; }');
            win.document.write('tfoot tr { background-color: #FFC000 !important; font-weight: bold; }');
            win.document.write('.footer { text-align: center; margin-top: 30px; font-size: 9pt; color: #888; border-top: 1px solid #ccc; padding-top: 10px; }');
            win.document.write('@media print { body { padding: 10px; } }');
            win.document.write('</style>');
            win.document.write('</head><body>');
            win.document.write('<div class="header">');
            win.document.write('<h1>PT. SUMBER GANDA MEKAR</h1>');
            win.document.write('<h2>LAPORAN TRANSAKSI ' + kategoriText.toUpperCase() + '</h2>');
            win.document.write('<p>Tanggal Cetak: ' + formatTanggalBaru(new Date()) + '</p>');
            win.document.write('</div>');
            win.document.write('<h3 class="section-title">📤 PENJUALAN ' + kategoriText.toUpperCase() + '</h3>');
            win.document.write(tablePenjualan.outerHTML);
            win.document.write('<h3 class="section-title">📥 PEMBELIAN ' + kategoriText.toUpperCase() + '</h3>');
            win.document.write(tablePembelian.outerHTML);
            win.document.write('<div class="footer">Dicetak pada: ' + formatTanggalBaru(new Date()) + '</div>');
            win.document.write('</body></html>');
            win.document.close();
            win.focus();
            win.print();
            win.close();
        }

        // Fungsi untuk mencetak Tabel (Daftar Penjualan/Pembelian)
        function printTable(tableId) {
            // Ambil tabel berdasarkan ID
            var table = document.getElementById(tableId);
            if (!table) {
                alert('⚠️ Tabel tidak ditemukan!');
                return;
            }

            // Clone table untuk di-print
            var tableClone = table.cloneNode(true);

            // Hapus kolom Aksi dari table clone (biasanya kolom terakhir)
            var rows = tableClone.getElementsByTagName('tr');
            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].children;
                // Hapus cell terakhir (kolom Aksi)
                if (cells.length > 0) {
                    // Cek apakah kolom terakhir adalah kolom aksi
                    var lastCell = cells[cells.length - 1];
                    if (lastCell.classList.contains('action-col') ||
                        lastCell.textContent.includes('Aksi') ||
                        lastCell.innerHTML.includes('button')) {
                        rows[i].removeChild(lastCell);
                    }
                }
            }

            // Tentukan judul berdasarkan ID tabel
            var title = '';
            if (tableId === 'tablePenjualan') {
                title = 'DAFTAR PENJUALAN';
            } else if (tableId === 'tablePembelian') {
                title = 'DAFTAR PEMBELIAN';
            } else {
                title = 'LAPORAN TRANSAKSI';
            }

            // Buka window print baru
            var win = window.open('', '', 'height=800,width=1200');
            win.document.write('<html><head><title>' + title + ' - PT. Sumber Ganda Mekar</title>');
            win.document.write('<style>');
            win.document.write('body { font-family: Arial, sans-serif; padding: 20px; margin: 0; background: white; }');
            win.document.write('.header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px; }');
            win.document.write('.header h1 { font-size: 18pt; margin: 0 0 5px 0; color: #2c3e50; }');
            win.document.write('.header h2 { font-size: 14pt; margin: 0 0 5px 0; color: #333; }');
            win.document.write('.header p { font-size: 10pt; margin: 3px 0; color: #666; }');
            win.document.write('table { border-collapse: collapse; width: 100%; font-size: 9pt; margin-top: 10px; }');
            win.document.write('th, td { border: 1px solid #333; padding: 5px 6px; }');
            win.document.write('th { background-color: #4472C4; color: white; text-align: center; font-weight: bold; }');
            win.document.write('td { text-align: left; }');
            win.document.write('td.number { text-align: right; font-family: Consolas, monospace; }');
            win.document.write('td.center, th.center { text-align: center; }');
            win.document.write('tr:nth-child(even) { background-color: #D6DCE4; }');
            win.document.write('tfoot tr { background-color: #FFC000 !important; font-weight: bold; }');
            win.document.write('tfoot td { border: 1.5px solid #000 !important; }');
            win.document.write('.footer { text-align: center; margin-top: 30px; font-size: 9pt; color: #888; border-top: 1px solid #ccc; padding-top: 10px; }');
            win.document.write('.w-35px { width: 35px; }');
            win.document.write('.w-50px { width: 50px; }');
            win.document.write('.w-70px { width: 70px; }');
            win.document.write('.w-75px { width: 75px; }');
            win.document.write('.w-80px { width: 80px; }');
            win.document.write('.w-85px { width: 85px; }');
            win.document.write('.w-90px { width: 90px; }');
            win.document.write('.w-100px { width: 100px; }');
            win.document.write('.w-120px { width: 120px; }');
            win.document.write('@media print { body { padding: 10px; } .footer { page-break-after: avoid; } }');
            win.document.write('</style>');
            win.document.write('</head><body>');
            win.document.write('<div class="header">');
            win.document.write('<h1>PT. SUMBER GANDA MEKAR</h1>');
            win.document.write('<h2>' + title + '</h2>');
            win.document.write('<p>Tanggal Cetak: ' + formatTanggalBaru(new Date()) + '</p>');
            win.document.write('</div>');
            win.document.write(tableClone.outerHTML);
            win.document.write('<div class="footer">Dicetak pada: ' + formatTanggalBaru(new Date()) + '</div>');
            win.document.write('</body></html>');
            win.document.close();
            win.focus();
            win.print();
            win.close();
        }
    </script>
    <style>
        :root {
            /* Color Palette - Professional & Elegant */
            --primary: #4338ca;
            /* Indigo 700 */
            --primary-light: #e0e7ff;
            /* Indigo 100 */
            --primary-hover: #3730a3;
            /* Indigo 800 */

            --secondary: #64748b;
            /* Slate 500 */
            --secondary-light: #f1f5f9;
            /* Slate 100 */

            --success: #059669;
            /* Emerald 600 */
            --success-light: #d1fae5;
            /* Emerald 100 */

            --danger: #dc2626;
            /* Red 600 */
            --danger-light: #fee2e2;
            /* Red 100 */

            --warning: #d97706;
            /* Amber 600 */
            --warning-light: #fef3c7;
            /* Amber 100 */

            --bg-body: #f8fafc;
            /* Slate 50 */
            --bg-surface: #ffffff;

            --text-main: #1e293b;
            /* Slate 800 */
            --text-muted: #64748b;
            /* Slate 500 */

            --border-color: #cbd5e1;
            /* Slate 300 - Darker for better visibility */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;

            --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline-color: var(--primary);
        }

        /* Utility Classes */
        .text-primary {
            color: var(--primary) !important;
        }

        .text-success {
            color: var(--success) !important;
        }

        .text-danger {
            color: var(--danger) !important;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .bg-light {
            background-color: var(--secondary-light) !important;
        }

        .font-bold {
            font-weight: 600 !important;
        }

        .font-mono {
            font-family: var(--font-mono) !important;
        }

        .text-mono-blue {
            font-family: var(--font-mono) !important;
            color: var(--primary) !important;
        }

        .text-mono-sm {
            font-family: var(--font-mono) !important;
            font-size: 0.875rem !important;
        }

        .text-mono-xs {
            font-family: var(--font-mono) !important;
            font-size: 0.75rem !important;
        }

        .text-small {
            font-size: 0.875rem !important;
        }

        .text-uppercase {
            text-transform: uppercase !important;
        }

        .text-right {
            text-align: right !important;
        }

        .number {
            text-align: right !important;
            font-family: var(--font-mono) !important;
        }

        .center {
            text-align: center !important;
        }

        .mb-1 {
            margin-bottom: 0.25rem !important;
        }

        .m-0 {
            margin: 0 !important;
        }

        .p-0 {
            padding: 0 !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .mb-4 {
            margin-bottom: 1.5rem !important;
        }

        .mt-1 {
            margin-top: 0.25rem !important;
        }

        .mt-2 {
            margin-top: 0.5rem !important;
        }

        .mt-3 {
            margin-top: 1rem !important;
        }

        .mt-4 {
            margin-top: 1.5rem !important;
        }

        .p-2 {
            padding: 0.5rem !important;
        }

        .p-3 {
            padding: 1rem !important;
        }

        .whitespace-nowrap {
            white-space: nowrap !important;
        }

        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .text-xs {
            font-size: 10px !important;
        }

        .text-xxs {
            font-size: 9px !important;
        }

        .text-md {
            font-size: 13px !important;
        }

        .text-grey-400 {
            color: var(--text-muted) !important;
        }

        .text-green-600 {
            color: var(--success) !important;
        }

        .text-red-600 {
            color: var(--danger) !important;
        }

        .bg-blue-light {
            background: var(--primary-light);
        }

        .bg-green-light {
            background: var(--success-light);
        }

        .bg-red-light {
            background: var(--danger-light);
        }

        .bg-dark-header {
            background: #37474f;
            color: white;
        }

        .bg-gradient-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        .card-bb-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .table-excel {
            margin: 0;
            border-radius: 0;
        }

        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .rounded-md {
            border-radius: 8px !important;
        }

        .shadow-md {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        }

        .tracking-wide {
            letter-spacing: 1px !important;
        }

        .opacity-80 {
            opacity: 0.8 !important;
        }

        .text-lg {
            font-size: 18px !important;
        }

        .m-0 {
            margin: 0 !important;
        }

        .mb-3 {
            margin-bottom: 15px !important;
        }

        .text-sm {
            font-size: 12px !important;
        }

        .text-green-800 {
            color: #1b5e20 !important;
        }

        .text-red-800 {
            color: #b71c1c !important;
        }

        .text-grey-800 {
            color: #333 !important;
        }

        .bg-yellow-light {
            background: #fff59d;
        }

        .p-right-15 {
            padding-right: 15px !important;
        }

        .p-right-20 {
            padding-right: 20px !important;
        }

        .pl-60px {
            padding-left: 60px !important;
        }

        .bg-grey-light {
            background: #f5f5f5;
        }

        .bg-success {
            background: #28a745 !important;
        }

        .bg-danger {
            background: #dc3545 !important;
        }

        .py-3 {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
        }

        .pl-20px {
            padding-left: 20px !important;
        }

        .pl-40px {
            padding-left: 40px !important;
        }

        .d-flex {
            display: flex !important;
        }

        .justify-between {
            justify-content: space-between !important;
        }

        .items-center {
            align-items: center !important;
        }

        .text-white {
            color: white !important;
        }

        .gap-10px {
            gap: 10px !important;
        }

        .gap-15px {
            gap: 15px !important;
        }

        .grid-3-cols {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .invisible {
            visibility: hidden !important;
        }

        .show {
            display: block !important;
        }

        .flex-wrap {
            flex-wrap: wrap !important;
        }

        .align-center {
            align-items: center !important;
        }

        .justify-between {
            justify-content: space-between !important;
        }

        .justify-end {
            justify-content: flex-end !important;
        }

        .gap-2 {
            gap: 0.5rem !important;
        }

        .gap-3 {
            gap: 1rem !important;
        }

        .w-100 {
            width: 100% !important;
        }

        .hidden {
            display: none !important;
        }

        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, #ece9e6 0%, #ffffff 100%);
            /* Clean Gradient */
            background-attachment: fixed;
            color: var(--text-main);
            padding: 15px;
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: var(--bg-surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Header */
        h1 {
            background: linear-gradient(to right, var(--primary), var(--primary-hover));
            color: white;
            padding: 16px 24px;
            font-size: 20px;
            font-weight: 700;
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 20;
        }

        h1::before {
            content: '📊';
            font-size: 24px;
            filter: none;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 8px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--primary);
            /* Match Header */
            padding: 0 20px;
            border-bottom: none;
            overflow-x: auto;
            flex-shrink: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 4px solid transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s;
            border-radius: 0;
            white-space: nowrap;
        }

        .tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            color: var(--primary);
            background: var(--bg-surface);
            border-bottom: 4px solid var(--warning);
            border-radius: 8px 8px 0 0;
            margin-top: 4px;
        }

        .tab-content {
            display: none !important;
            padding: 24px;
            background-color: var(--bg-surface);
            overflow-y: auto;
            flex: 1;
        }

        .tab-content.active {
            display: block !important;
        }

        /* Sub-tabs */
        .sub-tab-content {
            display: none;
            padding-top: 10px;
        }

        .sub-tab-content.active {
            display: block;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Form Styling */
        .form-section {
            background: var(--bg-surface);
            padding: 24px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            border-top: 3px solid var(--primary);
            /* Added color accent */
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .form-grid,
        .form-header-grid,
        .form-items-grid,
        .form-grid-2,
        .form-grid-3,
        .form-grid-4 {
            display: grid;
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-header-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .form-grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .form-grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .form-grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .form-items-grid {
            grid-template-columns: 2fr 0.8fr 1.2fr 1fr 1fr 1.2fr auto;
            align-items: end;
            gap: 8px;
        }

        .col-span-3 {
            grid-column: span 3;
        }

        @media (max-width: 1024px) {
            .form-header-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-grid-3,
            .form-grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-items-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-items-grid .btn-add {
                grid-column: span 2;
            }

            .col-span-3 {
                grid-column: span 2;
            }
        }

        @media (max-width: 640px) {

            .form-header-grid,
            .form-grid-2,
            .form-grid-3,
            .form-grid-4 {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile Menu Styles */
        .mobile-menu-toggle {
            display: none;
        }

        .mobile-menu-close {
            display: none;
        }

        .menu-overlay {
            display: none;
        }

        @media (max-width: 1024px) {
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                gap: 8px;
                background: var(--primary);
                color: white;
                border: none;
                padding: 12px 20px;
                width: 100%;
                text-align: left;
                font-weight: 600;
                border-radius: var(--radius-md);
                margin-bottom: 15px;
                cursor: pointer;
                box-shadow: var(--shadow-sm);
            }

            .tabs {
                display: none;
                /* Hidden by default on mobile */
                flex-direction: column;
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100vh;
                background: var(--bg-surface);
                z-index: 9999;
                padding: 60px 0 20px 0;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
                overflow-y: auto;
                transition: transform 0.3s ease;
            }

            .tabs.show-menu {
                display: flex;
                /* Show when active */
                animation: slideInLeft 0.3s ease-out;
            }

            .mobile-menu-close {
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                top: 15px;
                right: 15px;
                background: var(--danger-light);
                color: var(--danger);
                border: none;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                font-size: 20px;
                cursor: pointer;
                z-index: 10000;
            }

            .tab {
                width: 100%;
                text-align: left;
                padding: 15px 24px;
                border-radius: 0;
                border-bottom: 1px solid var(--border-color);
                color: var(--text-main);
            }

            .tab.active {
                background: var(--primary-light);
                color: var(--primary);
                border-left: 4px solid var(--primary);
                border-bottom: 1px solid var(--border-color);
                border-radius: 0;
            }

            /* Overlay when menu is open */
            .menu-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9998;
                backdrop-filter: blur(2px);
            }

            .menu-overlay.show {
                display: block;
            }

            @keyframes slideInLeft {
                from {
                    transform: translateX(-100%);
                }

                to {
                    transform: translateX(0);
                }
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
            position: relative;
        }

        .form-group label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 4px 8px;
            border: 1px solid #94a3b8;
            /* Darker border for visibility */
            border-radius: var(--radius-md);
            font-size: 12px;
            width: 100%;
            transition: all 0.2s;
            background-color: var(--bg-surface);
            font-family: var(--font-sans);
            color: var(--text-main);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
            outline: none;
        }

        .form-group input[readonly] {
            background-color: var(--secondary-light);
            color: var(--text-muted);
            font-weight: 500;
            cursor: not-allowed;
        }

        .input-highlight {
            background-color: var(--success-light) !important;
            color: var(--success) !important;
            font-weight: 700 !important;
            font-size: 14px !important;
        }

        .font-mono {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
        }

        .text-uppercase {
            text-transform: uppercase !important;
        }

        /* Utility Classes */
        .btn-xs {
            padding: 4px 8px !important;
            font-size: 11px !important;
        }

        .btn-sm {
            padding: 5px 10px !important;
            font-size: 12px !important;
        }

        .mr-5 {
            margin-right: 5px !important;
        }

        .text-xs {
            font-size: 11px !important;
        }

        .text-xxs {
            font-size: 10px !important;
        }

        .text-md {
            font-size: 14px !important;
        }

        .text-lg {
            font-size: 18px !important;
        }

        .text-xl {
            font-size: 20px !important;
        }

        .text-muted {
            color: #999 !important;
        }

        .max-w-md {
            max-width: 600px;
        }

        .w-50px {
            width: 50px !important;
        }

        .w-80px {
            width: 80px !important;
        }

        .h-400-scroll {
            max-height: 400px;
            overflow-y: auto !important;
        }

        .h-200-scroll {
            max-height: 200px;
            overflow-y: auto !important;
        }

        .h-300-scroll {
            max-height: 300px;
            overflow-y: auto !important;
        }

        .h-500-scroll {
            max-height: 500px;
            overflow-y: auto !important;
        }

        .w-120px {
            width: 120px !important;
        }

        .w-full {
            width: 100% !important;
        }

        .max-w-250px {
            max-width: 250px;
        }

        .bg-white {
            background-color: #ffffff !important;
        }

        .text-green-800 {
            color: #2e7d32 !important;
        }

        .text-red-800 {
            color: #c62828 !important;
        }

        .text-success-bold {
            color: #28a745 !important;
            font-weight: bold !important;
        }

        .text-danger-bold {
            color: #dc3545 !important;
            font-weight: bold !important;
        }

        .bg-success-light-2 {
            background-color: rgba(76, 175, 80, 0.3) !important;
        }

        .bg-danger-light-2 {
            background-color: rgba(244, 67, 54, 0.3) !important;
        }

        .p-1 {
            padding: 4px !important;
        }

        .py-3 {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
        }

        .p-40px {
            padding: 40px !important;
        }

        .pl-20px {
            padding-left: 20px !important;
        }

        .pl-40px {
            padding-left: 40px !important;
        }

        .pl-60px {
            padding-left: 60px !important;
        }

        .p-right-20 {
            padding-right: 20px !important;
        }

        .border-bbb {
            border: 1px solid #bbb !important;
        }

        .text-dark-green {
            color: #006400 !important;
        }

        .text-dark-red {
            color: #8b0000 !important;
        }

        /* Flexbox Utilities */
        .d-flex {
            display: flex !important;
        }

        .justify-between {
            justify-content: space-between !important;
        }

        .items-center {
            align-items: center !important;
        }

        /* Typography */
        .tracking-wide {
            letter-spacing: 1px !important;
        }

        .opacity-90 {
            opacity: 0.9 !important;
        }

        /* Table Styles Custom */
        .table-bordered-custom td,
        .table-bordered-custom th {
            border: 1px solid #bbb !important;
        }

        .bg-yellow-light-bold {
            background-color: #fff3cd !important;
            font-weight: bold !important;
        }

        .bg-row-masuk {
            background-color: #e2efda !important;
        }

        .bg-row-keluar {
            background-color: #fce4d6 !important;
        }

        .bg-green-light {
            background-color: var(--success-light) !important;
        }

        .bg-yellow-light {
            background-color: var(--warning-light) !important;
        }

        .bg-red-light {
            background-color: var(--danger-light) !important;
        }

        .bg-grey-light {
            background-color: #f5f5f5 !important;
        }

        .bg-gray-100 {
            background-color: #f8f9fa !important;
        }

        .bg-blue-light {
            background-color: var(--primary-light) !important;
        }

        .bg-orange-light {
            background-color: #fff8e1 !important;
        }

        .bg-success {
            background-color: var(--success) !important;
        }

        .bg-danger {
            background-color: var(--danger) !important;
        }

        .bg-success-light {
            background-color: var(--success-light) !important;
        }

        .bg-danger-light {
            background-color: var(--danger-light) !important;
        }

        .text-white {
            color: white !important;
        }

        .text-grey-400 {
            color: #bdbdbd !important;
        }

        .text-green-600 {
            color: #43a047 !important;
        }

        .text-red-600 {
            color: #e53935 !important;
        }

        .text-orange-dark {
            color: #f57c00 !important;
        }

        .badge-masuk {
            background-color: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .badge-keluar {
            background-color: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .badge-sumber-jual {
            background-color: #4caf50;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .jurnal-entry-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 40px;
            gap: 10px;
            margin-bottom: 5px;
        }

        .edit-btn {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 2px 5px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 11px;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        /* Account Headers */
        .header-kas {
            background: linear-gradient(135deg, #2e7d32 0%, #2e7d32dd 100%) !important;
        }

        .header-piutang {
            background: linear-gradient(135deg, #1565c0 0%, #1565c0dd 100%) !important;
        }

        .header-hutang {
            background: linear-gradient(135deg, #c62828 0%, #c62828dd 100%) !important;
        }

        .header-penjualan {
            background: linear-gradient(135deg, #2e7d32 0%, #2e7d32dd 100%) !important;
        }

        .header-pembelian {
            background: linear-gradient(135deg, #e65100 0%, #e65100dd 100%) !important;
        }

        .header-beban {
            background: linear-gradient(135deg, #d32f2f 0%, #d32f2fdd 100%) !important;
        }

        .header-default {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }

        .badge-awal {
            background: #9b59b6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .badge-jual {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .badge-beli {
            background: #e67e22;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .badge-lunas {
            background-color: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
        }

        .badge-belum {
            background-color: #f44336;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
        }

        .badge-gradient-purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
        }

        .print-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #217346;
            padding-bottom: 10px;
        }

        .print-title {
            margin: 0;
            font-size: 16px;
            color: #217346;
        }

        .print-subtitle {
            margin: 5px 0;
            font-size: 14px;
            color: #333;
        }

        .print-meta {
            margin: 3px 0;
            font-size: 11px;
            color: #666;
        }

        .print-footer {
            text-align: right;
            font-size: 9px;
            color: #999;
            margin-top: 15px;
        }

        .summary-box-green {
            border: 2px solid #28a745;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            width: 30%;
        }

        .summary-box-red {
            border: 2px solid #dc3545;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            width: 30%;
        }

        .summary-box-dark-green {
            border: 2px solid #217346;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            width: 30%;
        }

        .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
        }

        .grid-4-cols {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
        }

        .border-bottom {
            border-bottom: 1px solid #ddd;
        }

        .border-right {
            border-right: 1px solid #ddd;
        }

        .p-3 {
            padding: 12px !important;
        }

        .mb-1 {
            margin-bottom: 4px !important;
        }

        .text-uppercase {
            text-transform: uppercase !important;
        }

        .font-bold {
            font-weight: bold !important;
        }

        .d-none {
            display: none !important;
        }

        .ml-4 {
            margin-left: 1rem;
        }

        .mt-2 {
            margin-top: 0.5rem;
        }

        .mt-4 {
            margin-top: 1.5rem;
        }

        .mt-20px {
            margin-top: 20px;
        }

        .flex-1 {
            flex: 1;
        }

        .relative {
            position: relative;
        }

        .overflow-x-auto {
            overflow-x: auto;
        }

        /* Width Utilities */
        .w-35px {
            width: 35px !important;
        }

        .w-40px {
            width: 40px !important;
        }

        .w-50px {
            width: 50px !important;
        }

        .w-70px {
            width: 70px !important;
        }

        .w-80px {
            width: 80px !important;
        }

        .w-85px {
            width: 85px !important;
        }

        .w-90px {
            width: 90px !important;
        }

        .w-100px {
            width: 100px !important;
        }

        .w-120px {
            width: 120px !important;
        }

        .w-140px {
            width: 140px !important;
        }

        .w-150px {
            width: 150px !important;
        }

        .w-200px {
            width: 200px !important;
        }

        .m-0 {
            margin: 0 !important;
        }

        /* Text Alignment */
        .text-left {
            text-align: left !important;
        }

        .text-center {
            text-align: center !important;
        }

        .text-right {
            text-align: right !important;
        }

        /* Specific */
        .show {
            display: block !important;
        }

        .search-hint {
            font-size: 13px;
            margin-top: 10px;
            color: #777;
        }

        .ml-2 {
            margin-left: 0.5rem !important;
        }

        .mr-2 {
            margin-right: 0.5rem !important;
        }

        .text-mono-blue {
            font-family: monospace;
            font-size: 10px;
            color: #1976D2;
        }

        .badge-divisi {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
        }

        .w-4pct {
            width: 4% !important;
        }

        .w-8pct {
            width: 8% !important;
        }

        .w-10pct {
            width: 10% !important;
        }

        .w-11pct {
            width: 11% !important;
        }

        .w-25pct {
            width: 25% !important;
        }

        .grid-cols-100-1fr {
            grid-template-columns: 100px 1fr !important;
        }

        .autocomplete-success {
            background: #e8f5e9 !important;
            color: #2e7d32 !important;
        }

        .text-green {
            color: green !important;
        }

        .text-md {
            font-size: 14px !important;
        }

        .text-muted {
            color: #6c757d !important;
        }

        .text-xxs {
            font-size: 10px !important;
        }

        /* Width Percentages */
        .w-30pct {
            width: 30% !important;
        }

        .w-45pct {
            width: 45% !important;
        }

        .w-50pct {
            width: 50% !important;
        }

        .w-55pct {
            width: 55% !important;
        }

        .w-70pct {
            width: 70% !important;
        }

        .w-100pct {
            width: 100% !important;
        }

        /* Width Fixed */
        .w-30px {
            width: 30px !important;
        }

        .w-60px {
            width: 60px !important;
        }

        .w-110px {
            width: 110px !important;
        }

        .w-130px {
            width: 130px !important;
        }

        /* Alignment & Padding */
        .align-top {
            vertical-align: top !important;
        }

        .p-2px-0 {
            padding: 2px 0 !important;
        }

        .p-4px-8px {
            padding: 4px 8px !important;
        }

        .p-6px-8px {
            padding: 6px 8px !important;
        }

        .pr-15 {
            padding-right: 15px !important;
        }

        /* Borders */
        .border-top-black {
            border-top: 1px solid #000 !important;
        }

        /* Colors & Headers */
        .bg-purple-header {
            background-color: #667eea !important;
            color: white !important;
        }

        .bg-pink-header {
            background-color: #c2185b !important;
            color: white !important;
        }

        .font-size-16 {
            font-size: 16px !important;
        }

        /* Invoice / Faktur Print Styles */
        .invoice-box {
            max-width: 210mm;
            margin: 0 auto;
            padding: 15mm 20mm;
            font-family: Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            background: white;
        }

        .invoice-header-table {
            width: 100%;
            margin-bottom: 15px;
        }

        .invoice-company-name {
            font-size: 11pt;
            font-weight: bold;
        }

        .invoice-company-desc {
            font-size: 9pt;
            line-height: 1.4;
        }

        .invoice-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 5px;
        }

        .invoice-meta {
            font-size: 8pt;
            text-align: right;
        }

        .invoice-divider {
            border-bottom: 2px solid #000;
            margin-bottom: 15px;
        }

        .invoice-title-container {
            text-align: center;
            margin: 15px 0;
        }

        .invoice-title-box {
            border: 2px solid #000;
            display: inline-block;
            padding: 6px 40px;
        }

        .invoice-title-text {
            font-size: 11pt;
            font-weight: bold;
        }

        .invoice-info-box {
            border: 2px solid #000;
            padding: 12px;
            margin: 15px 0;
        }

        .invoice-info-table {
            width: 100%;
            font-size: 9pt;
        }

        .invoice-items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 9pt;
        }

        .invoice-items-th {
            border: 1px solid #000;
            padding: 6px;
            text-align: center;
            background: #f5f5f5;
        }

        .invoice-items-th-left {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
            background: #f5f5f5;
        }

        .invoice-items-th-right {
            border: 1px solid #000;
            padding: 6px;
            text-align: right;
            background: #f5f5f5;
        }

        .invoice-items-td {
            border: 1px solid #000;
            padding: 6px;
        }

        .invoice-items-td-center {
            border: 1px solid #000;
            padding: 6px;
            text-align: center;
        }

        .invoice-items-td-right {
            border: 1px solid #000;
            padding: 6px;
            text-align: right;
        }

        .invoice-summary-table {
            width: 100%;
            margin-top: 10px;
            font-size: 9pt;
        }

        .invoice-terbilang-box {
            border: 1px solid #000;
            padding: 8px;
            margin: 10px 0;
            background: #f0f0f0;
            font-style: italic;
            font-weight: bold;
        }

        .invoice-payment-info {
            margin: 15px 0;
            font-size: 9pt;
        }

        .invoice-signature-table {
            width: 100%;
            margin-top: 40px;
            font-size: 9pt;
        }

        .invoice-signature-line {
            border-bottom: 1px solid #000;
            margin: 0 60px;
        }

        .invoice-spacer-60 {
            height: 60px;
        }

        .text-red {
            color: red !important;
        }

        .text-danger {
            color: var(--danger) !important;
        }

        .text-success {
            color: var(--success) !important;
        }

        .text-primary {
            color: var(--primary) !important;
        }

        .jurnal-entry-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 40px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .bg-success-light {
            background-color: #e8f5e9 !important;
        }

        .bg-danger-light {
            background-color: #ffebee !important;
        }

        .autocomplete-success {
            background: #e8f5e9 !important;
            color: #2e7d32 !important;
        }

        .badge-sehat {
            background: #4CAF50 !important;
            color: white !important;
        }

        .badge-normal {
            background: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }

        .badge-minus {
            background: #f44336 !important;
            color: white !important;
        }

        .badge-awal {
            background: #9b59b6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .badge-jual {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .badge-beli {
            background: #e67e22;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .badge-masuk {
            background-color: #4CAF50 !important;
            color: white !important;
            padding: 2px 5px !important;
            border-radius: 3px !important;
            font-size: 9px !important;
            font-weight: bold !important;
        }

        .badge-keluar {
            background-color: #f44336 !important;
            color: white !important;
            padding: 2px 5px !important;
            border-radius: 3px !important;
            font-size: 9px !important;
            font-weight: bold !important;
        }

        .p-2 {
            padding: 8px !important;
        }

        .modal-show {
            display: block !important;
        }

        .modal-bg-dark {
            background-color: rgba(0, 0, 0, 0.5) !important;
        }

        .modal-content-custom {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .text-dark-blue {
            color: #2c3e50 !important;
        }

        .close-custom {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-info {
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
        }

        .text-green-bold {
            color: green !important;
            font-weight: bold !important;
        }

        .text-red-bold {
            color: red !important;
            font-weight: bold !important;
        }

        .text-blue-bold {
            color: blue !important;
            font-weight: bold !important;
        }

        .btn-xs {
            padding: 5px 10px !important;
            font-size: 12px !important;
        }

        /* Buttons */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #b45309;
        }

        .btn-info {
            background: #0ea5e9;
            color: white;
        }

        .btn-info:hover {
            background: #0284c7;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            height: auto;
        }

        /* Buku Besar & Laporan Utilities */
        .text-mono-sm {
            font-family: 'Consolas', monospace;
            font-size: 10px;
        }

        .text-mono-xs {
            font-family: monospace;
            font-size: 8px;
        }

        .text-mono-blue {
            font-family: 'Consolas', monospace;
            font-size: 10px;
            color: #1565c0;
        }

        .bg-gradient-blue {
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
        }

        .bg-gradient-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        .bg-dark-header {
            background: #37474f !important;
            color: white !important;
        }

        .card-buku-besar {
            margin-top: 20px;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .card-bb-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .card-bb-item-success {
            background: rgba(76, 175, 80, 0.3);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .card-bb-item-danger {
            background: rgba(244, 67, 54, 0.3);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .bb-header {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .bb-value {
            font-size: 18px;
            font-weight: bold;
        }

        .badge-sumber-jual {
            background: #c8e6c9;
            color: #2e7d32;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
        }

        .badge-sumber-beli {
            background: #ffccbc;
            color: #e65100;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
        }

        .badge-sumber-kas-plus {
            background: #b3e5fc;
            color: #0277bd;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
        }

        .badge-sumber-kas-minus {
            background: #f8bbd9;
            color: #c2185b;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
        }

        .badge-sumber-jurnal {
            background: #e0e0e0;
            color: #616161;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
        }

        .font-500 {
            font-weight: 500;
        }

        .bg-yellow-light {
            background: #fff59d !important;
        }

        /* Additional Utilities for Refactoring */
        .p-10px {
            padding: 10px !important;
        }

        .p-20px {
            padding: 20px !important;
        }

        .mt-30px {
            margin-top: 30px !important;
        }

        .bg-primary {
            background-color: var(--primary) !important;
            color: white !important;
        }

        .grid-cols-fixed-100 {
            display: grid;
            grid-template-columns: 100px 1fr !important;
        }

        .max-h-200 {
            max-height: 200px !important;
            overflow-y: auto;
        }

        .max-h-500 {
            max-height: 500px !important;
            overflow-y: auto;
        }

        .bg-blue-light {
            background: #e3f2fd !important;
        }

        .bg-green-light {
            background: #e8f5e9 !important;
        }

        .bg-red-light {
            background: #ffebee !important;
        }

        .text-dark-green {
            color: #1b5e20 !important;
        }

        .text-dark-red {
            color: #b71c1c !important;
        }

        .text-green-600 {
            color: #2e7d32 !important;
        }

        .bg-grey-light {
            background: #f5f5f5 !important;
        }

        .text-red-600 {
            color: #c62828 !important;
        }

        .text-grey-400 {
            color: #999 !important;
        }

        .text-xxs {
            font-size: 10px !important;
        }

        .text-xs {
            font-size: 11px !important;
        }

        .text-sm {
            font-size: 12px !important;
        }

        .text-md {
            font-size: 13px !important;
        }

        .text-lg {
            font-size: 14px !important;
        }

        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-excel {
            margin: 0;
            border-radius: 0;
        }

        .no-border-radius {
            border-radius: 0 !important;
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            justify-content: center;
        }

        .delete-btn {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid transparent;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: var(--danger);
            color: white;
        }

        .edit-btn {
            background: var(--warning-light);
            color: var(--warning);
            border: 1px solid transparent;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-btn:hover {
            background: var(--warning);
            color: white;
        }

        .print-btn {
            background: var(--primary-light);
            color: var(--primary);
            border: 1px solid transparent;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .print-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary);
        }

        .card.success::before {
            background: var(--success);
        }

        .card.danger::before {
            background: var(--danger);
        }

        .card.warning::before {
            background: var(--warning);
        }

        .card h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .card .amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
            font-family: var(--font-mono);
            letter-spacing: -0.02em;
        }

        /* Tables (Screen) */
        .table-container {
            border: 1px solid #ccc;
            border-radius: 0;
            /* overflow: hidden; Removed to allow scrolling from utility classes */
            box-shadow: none;
            margin: 16px 0;
            background: white;
            overflow-x: auto;
        }

        .excel-table,
        .kas-harian-excel {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            font-family: 'Segoe UI', 'Calibri', sans-serif;
            color: #000;
        }

        .excel-table thead,
        .kas-harian-excel thead {
            background: #e6e6e6;
            border-bottom: 1px solid #999;
        }

        .excel-table th,
        .kas-harian-excel th {
            position: sticky;
            top: 0;
            background: #e6e6e6;
            padding: 6px 8px;
            text-align: center;
            font-weight: 700;
            color: #000;
            font-size: 11px;
            z-index: 10;
            border: 1px solid #888;
        }

        .excel-table td,
        .kas-harian-excel td {
            padding: 4px 8px;
            border: 1px solid #a0a0a0;
            color: #000;
        }

        .excel-table tbody tr:hover,
        .kas-harian-excel tbody tr:hover {
            background: #e8f5e9;
        }

        .excel-table td.number,
        .kas-harian-excel td.number,
        .kas-harian-excel td.col-angka {
            font-family: 'Segoe UI', 'Calibri', sans-serif;
            text-align: right;
            font-feature-settings: "tnum";
        }

        .excel-table td.center,
        .kas-harian-excel td.center {
            text-align: center;
        }

        .table-summary td {
            background-color: #f0f0f0;
            font-weight: bold;
            border: 1px solid #ccc;
            color: #000;
        }

        /* Kas Harian Specifics */
        .kas-harian-excel td.col-masuk {
            color: var(--success);
            background: #e8f5e9;
        }

        .kas-harian-excel td.col-keluar {
            color: var(--danger);
            background: #ffebee;
        }

        .kas-harian-excel tfoot td {
            background: #e6e6e6;
            font-weight: 700;
            border: 1px solid #999;
            padding: 4px 8px;
            color: #000;
        }

        /* Autocomplete */
        .autocomplete-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-height: 250px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            margin-top: 4px;
        }

        .autocomplete-dropdown.show {
            display: block !important;
        }

        .autocomplete-item {
            padding: 6px 10px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
            transition: all 0.15s;
        }

        .autocomplete-item:hover,
        .autocomplete-item.active {
            background: var(--primary-light);
            color: var(--primary);
        }

        .autocomplete-item .item-code {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 8px;
        }

        .autocomplete-item:hover .item-code {
            color: var(--primary);
            opacity: 0.7;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            margin: 5vh auto;
            padding: 30px;
            border: none;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 800px;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            color: var(--text-muted);
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-main);
        }

        /* Alerts */
        .alert {
            padding: 16px;
            margin: 16px 0;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: var(--success-light);
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-danger {
            background: var(--danger-light);
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Search Box */
        .search-box {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 50px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            color: var(--text-muted);
            font-size: 18px;
            pointer-events: none;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        /* Badges */
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-lunas {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-belum {
            background: var(--danger-light);
            color: var(--danger);
        }

        .badge-kredit {
            background: var(--warning-light);
            color: var(--warning);
        }

        .badge-tunai {
            background: var(--primary-light);
            color: var(--primary);
        }

        /* Alerts */
        .alert {
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            border: 1px solid transparent;
            font-size: 14px;
        }

        .alert-warning {
            background-color: var(--warning-light);
            color: #92400e;
            /* Darker amber */
            border-color: #fcd34d;
        }

        .alert-info {
            background-color: var(--primary-light);
            color: var(--primary);
            border-color: #c7d2fe;
        }

        .alert-success {
            background-color: var(--success-light);
            color: var(--success);
            border-color: #a7f3d0;
        }

        .alert-danger {
            background-color: var(--danger-light);
            color: var(--danger);
            border-color: #fecaca;
        }

        /* Faktur Styles (Modern Screen) */
        .modal-faktur {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
        }

        .modal-faktur-content {
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.3s ease-out;
        }

        .faktur-header-bar {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }

        .faktur-buttons {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            z-index: 9;
        }

        .faktur-container {
            padding: 40px;
            background: #525659;
            flex: 1;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .faktur-pdf {
            background: white;
            padding: 40px;
            width: 210mm;
            min-height: 297mm;
            box-shadow: var(--shadow-lg);
            font-family: var(--font-sans);
        }

        .faktur-company {
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .faktur-company h1 {
            background: none;
            color: var(--primary);
            border: none;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .faktur-title {
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin: 20px 0;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 2px solid var(--text-main);
            padding: 10px;
            display: inline-block;
        }

        .faktur-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }

        .faktur-table th {
            background: var(--primary);
            color: white;
            padding: 10px;
            font-size: 12px;
        }

        .faktur-total {
            margin-top: 30px;
            text-align: right;
        }

        .faktur-grand-total {
            background: var(--primary);
            color: white;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
            border-radius: var(--radius-md);
        }

        /* Dot Matrix Specific Styles */
        .invoice-box-dotmatrix {
            font-family: 'Courier New', Courier, monospace !important;
            font-size: 12px !important;
            color: black !important;
            background: white !important;
            padding: 0 !important;
            max-width: 100% !important;
            border: none !important;
        }

        .invoice-box-dotmatrix .invoice-logo {
            display: none !important;
        }

        .invoice-box-dotmatrix table {
            width: 100% !important;
            border-collapse: collapse !important;
        }

        .invoice-box-dotmatrix th,
        .invoice-box-dotmatrix td {
            padding: 4px !important;
            border: 1px dashed black !important;
        }

        .invoice-box-dotmatrix .invoice-header-table td,
        .invoice-box-dotmatrix .invoice-info-table td,
        .invoice-box-dotmatrix .invoice-signature-table td {
            border: none !important;
        }

        .invoice-box-dotmatrix .invoice-title-box {
            border: 2px solid black !important;
        }

        .invoice-box-dotmatrix .invoice-company-desc {
            font-size: 11px !important;
        }

        @media print {
            .invoice-box-dotmatrix {
                width: 100% !important;
                margin: 0 !important;
            }
        }

        /* =========================================
           PRINT STYLES - PRESERVED & OPTIMIZED
           ========================================= */
        @media print {

            .tabs,
            .form-buttons,
            .btn,
            .delete-btn,
            .edit-btn,
            .print-btn,
            .filter-section,
            .form-section,
            .search-box {
                display: none !important;
            }

            body {
                background: white !important;
                color: black !important;
                padding: 0;
                margin: 0;
                font-family: 'Calibri', 'Arial', sans-serif;
                font-size: 11pt;
            }

            .container {
                box-shadow: none !important;
                max-width: 100% !important;
                padding: 0 !important;
                background: white !important;
                margin: 0 !important;
                border: none !important;
                height: auto !important;
            }

            h1 {
                font-size: 18pt !important;
                padding: 8px 0 !important;
                margin: 0 0 10px 0 !important;
                border-bottom: 2px solid #000;
                background: none !important;
                color: black !important;
                justify-content: center !important;
            }

            h1::before {
                display: none;
            }

            .tab-content {
                display: none !important;
            }

            .tab-content.active {
                display: block !important;
                padding: 0 !important;
            }

            .report-header {
                text-align: center;
                margin-bottom: 15px;
                padding: 8px 0;
                border-bottom: 2px solid #000;
            }

            .report-header h2 {
                font-size: 16pt !important;
                margin: 5px 0 !important;
                font-weight: bold;
            }

            .summary-cards {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
                page-break-inside: avoid;
            }

            .card {
                border: 1.5pt solid #000 !important;
                padding: 8px !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }

            .card::before {
                display: none;
            }

            .card h3 {
                color: black !important;
                font-size: 11pt !important;
            }

            .card .amount {
                color: black !important;
                font-size: 13pt !important;
            }

            /* EXCEL TABLE EMULATION */
            .table-container {
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
            }

            .excel-table,
            .kas-harian-excel {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 11pt !important;
                border: 1.5pt solid #000 !important;
                font-family: 'Calibri', 'Arial', sans-serif;
            }

            .excel-table th,
            .kas-harian-excel th {
                background: #d9d9d9 !important;
                color: black !important;
                border: 0.75pt solid #000 !important;
                padding: 6pt 4pt !important;
                text-align: center !important;
                font-weight: bold !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .excel-table td,
            .kas-harian-excel td {
                border: 0.75pt solid #000 !important;
                padding: 4pt 6pt !important;
                font-size: 11pt !important;
                color: black !important;
            }

            .excel-table tbody tr:nth-child(even) {
                background-color: white !important;
            }

            .excel-table tfoot,
            .kas-harian-excel tfoot {
                display: table-footer-group !important;
                background: #f2f2f2 !important;
                font-weight: bold !important;
            }

            .excel-table tfoot td,
            .kas-harian-excel tfoot td {
                border: 1.5pt solid #000 !important;
                background: #f2f2f2 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Row Colors Preservation */
            .excel-table tbody tr[style*="background-color: #e8f5e9"] {
                background-color: #e8f5e9 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .excel-table tbody tr[style*="background-color: #ffebee"] {
                background-color: #ffebee !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .excel-table tbody tr[style*="background-color: #fff9c4"] {
                background-color: #fff9c4 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Faktur Print */
            body.printing-faktur .container {
                display: none !important;
            }

            body.printing-faktur .modal-faktur {
                display: block !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: white !important;
            }

            body.printing-faktur .faktur-pdf {
                box-shadow: none !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
            }

            body.printing-faktur .faktur-header-bar,
            body.printing-faktur .faktur-buttons {
                display: none !important;
            }

            @page {
                margin: 10mm;
                size: A4 portrait;
            }
        }

        /* --- LOGIN STYLES --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: all 0.5s ease;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .login-card h2 {
            color: #1a237e;
            margin-bottom: 24px;
            font-size: 24px;
        }

        .login-group {
            margin-bottom: 16px;
            text-align: left;
        }

        .login-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #444;
        }

        .login-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .login-group input:focus {
            outline: none;
            border-color: #3949ab;
        }

        .btn-login {
            width: 100%;
            padding: 12px;
            background: #1a237e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-login:hover {
            background: #3949ab;
        }

        .login-footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>

<body>
    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-card">
            <img src="logo sgm.jpg" alt="Logo SGM" style="width: 100px; margin-bottom: 15px;"
                onerror="this.style.display='none'">
            <h2>PT. SUMBER GANDA MEKAR</h2>
            <p style="margin-bottom: 20px; color: #666;">Silakan masuk untuk mengakses sistem</p>
            <form id="login-form">
                <div class="login-group">
                    <label>Email</label>
                    <input type="email" id="login-email" required placeholder="nama@email.com">
                </div>
                <div class="login-group">
                    <label>Password</label>
                    <input type="password" id="login-password" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn-login" id="login-btn">🔓 Login</button>
                <div style="margin-top: 15px;">
                    <a href="#" onclick="toggleAuthMode(event)" id="auth-toggle-link"
                        style="color: #3949ab; text-decoration: none; font-size: 14px; font-weight: 600;">Belum punya
                        akun? Daftar Baru</a>
                </div>
            </form>
            <div id="login-error" style="color: #f44336; margin-top: 15px; font-size: 14px; display: none;"></div>
            <div id="login-success" style="color: #4CAF50; margin-top: 15px; font-size: 14px; display: none;"></div>
            <div class="login-footer">
                &copy; 2026 PT. Sumber Ganda Mekar <br>
                Sistem Pembukuan Cloud
            </div>
        </div>
    </div>

    <div class="container" style="display: none;" id="main-app">
        <h1>
            <span>📊 SISTEM PEMBUKUAN PT. SUMBER GANDA MEKAR</span>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="user-display" style="font-size: 12px; font-weight: normal; opacity: 0.8;"></span>
                <button class="logout-btn" onclick="handleLogout()">🚪 Logout</button>
            </div>
        </h1>

        <button class="mobile-menu-toggle" onclick="toggleMenu()">☰ Menu Aplikasi</button>
        <div class="menu-overlay" onclick="closeMenu()"></div>

        <div class="tabs">
            <button class="mobile-menu-close" onclick="closeMenu()">&times;</button>
            <button class="tab active" onclick="openTab(event, 'penjualan')">💰 Penjualan</button>
            <button class="tab" onclick="openTab(event, 'pembelian')">🛒 Pembelian</button>
            <button class="tab" onclick="openTab(event, 'kas-harian')">💵 Kas Harian</button>
            <button class="tab" onclick="openTab(event, 'piutang')">📊 Piutang</button>
            <button class="tab" onclick="openTab(event, 'hutang')">📋 Hutang</button>
            <button class="tab" onclick="openTab(event, 'laporan-divisi')">🏢 Laporan Divisi</button>
            <button class="tab" onclick="openTab(event, 'laporan-non-ppn')">🧾 Laporan Per PPN</button>

            <button class="tab" onclick="openTab(event, 'pencarian')">🔍 Pencarian</button>
            <button class="tab" onclick="openTab(event, 'data-master')">📋 Data Master</button>
        </div>

        <!-- TAB PENJUALAN -->
        <div id="penjualan" class="tab-content active">
            <div class="report-header">
                <h2>📝 FORM INPUT PENJUALAN</h2>
                <p>PT. Sumber Ganda Mekar - Transaksi Penjualan Barang</p>
            </div>

            <div class="card mb-4">
                <form id="formPenjualan">
                    <div class="form-header-grid">
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="text" id="tglPenjualan" placeholder="DD/MM/YYYY" maxlength="10" required
                                oninput="formatTanggalInput(this)">
                        </div>
                        <div class="form-group">
                            <label>No. Faktur</label>
                            <input type="text" id="noFakturJual" placeholder="Auto Generate" readonly>
                        </div>
                        <div class="form-group">
                            <label>Divisi</label>
                            <select id="divisiJual" required>
                                <option value="">— Pilih Divisi —</option>
                                <option value="Angkutan">🚚 Angkutan</option>
                                <option value="Besi">🔩 Besi</option>
                                <option value="Pakan">🌾 Pakan</option>
                                <option value="Umum">🏢 Umum</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nama Pelanggan</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="namaPelanggan" required placeholder="Ketik nama pelanggan..."
                                    autocomplete="off">
                                <div id="dropdownPelanggan" class="autocomplete-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>No. Telepon</label>
                            <input type="text" id="teleponPelanggan" placeholder="No. HP/Telepon">
                        </div>
                        <div class="form-group">
                            <label>NPWP/NIK</label>
                            <input type="text" id="npwpPelanggan" placeholder="NPWP atau NIK">
                        </div>
                        <div class="form-group col-span-3">
                            <label>Alamat Pelanggan</label>
                            <input type="text" id="alamatPelanggan" placeholder="Alamat lengkap">
                        </div>
                    </div>
                    <hr class="mb-3">
                    <div>
                        <h4 class="mb-2 text-primary">Daftar Barang Penjualan</h4>
                        <div class="form-items-grid">
                            <div class="form-group">
                                <label>Nama Barang</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="namaBarangJual" placeholder="Ketik nama barang..."
                                        autocomplete="off">
                                    <div id="dropdownBarangJual" class="autocomplete-dropdown"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Jumlah (Qty)</label>
                                <input type="text" id="qtyJual" placeholder="0" oninput="formatAngkaInput(this);">
                            </div>
                            <div class="form-group">
                                <label>Harga Satuan</label>
                                <input type="text" id="hargaJual" placeholder="Rp 0" oninput="formatRupiahInput(this);">
                            </div>
                            <div class="form-group">
                                <label>Diskon</label>
                                <input type="text" id="diskonJual" placeholder="Rp 0" value="0"
                                    oninput="formatRupiahInput(this);">
                            </div>
                            <div class="form-group">
                                <label>Jenis PPN</label>
                                <select id="jenisPpnJual">
                                    <option value="nonppn">Non PPN</option>
                                    <option value="ppn11">PPN 11%</option>
                                    <option value="ppn1">PPN 1.1%</option>
                                    <option value="dibebaskan">PPN Dibebaskan</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Subtotal</label>
                                <input type="text" id="subtotalJual" readonly placeholder="Rp 0">
                            </div>
                            <div class="form-group d-flex align-end">
                                <button type="button" class="btn btn-info btn-add" onclick="tambahDetailBarangJual()">➕
                                    Tambah</button>
                            </div>
                        </div>
                        <div class="table-container mb-3 h-200-scroll">
                            <table class="excel-table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nama Barang</th>
                                        <th>Qty</th>
                                        <th>Harga</th>
                                        <th>Diskon</th>
                                        <th>PPN</th>
                                        <th>Subtotal</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="bodyDetailBarangJual">
                                    <tr>
                                        <td colspan="8" class="center">Belum ada barang</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <hr class="mb-3">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Total Penjualan</label>
                            <input type="text" id="totalJual" readonly placeholder="Rp 0" class="input-highlight">
                        </div>
                        <div class="form-group">
                            <label>Uang Muka (DP)</label>
                            <input type="text" id="dpJual" placeholder="Rp 0" value="0"
                                oninput="formatRupiahInput(this); calculateSisaTagihanJual();">
                        </div>
                        <div class="form-group">
                            <label>Sisa Tagihan</label>
                            <input type="text" id="sisaJual" readonly placeholder="Rp 0" class="input-highlight">
                        </div>
                        <div class="form-group">
                            <label>Metode Pembayaran</label>
                            <select id="metodeBayarJual" required onchange="toggleBayarJual()">
                                <option value="tunai">Tunai</option>
                                <option value="transfer">Transfer</option>
                                <option value="kredit">Kredit</option>
                            </select>
                        </div>
                        <div class="form-group d-none" id="groupBayarJual">
                            <label>Jumlah Bayar</label>
                            <input type="text" id="bayarJual" placeholder="Rp 0" oninput="formatRupiahInput(this);">
                        </div>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" class="btn btn-success">💾 Simpan Penjualan</button>
                        <button type="button" class="btn btn-warning" onclick="resetForm('formPenjualan')">🔄
                            Reset</button>
                    </div>
                </form>
            </div>

            <div id="alertPenjualan"></div>

            <h3 class="section-title">📊 Daftar Transaksi Penjualan</h3>

            <!-- Filter Tanggal Penjualan -->
            <div class="card mb-3" style="background: var(--primary-light); border-left: 4px solid var(--primary);">
                <div class="form-header-grid">
                    <div class="form-group">
                        <label>📅 Dari Tanggal</label>
                        <input type="text" id="filterPenjualanMulai" placeholder="DD/MM/YYYY" maxlength="10"
                            oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group">
                        <label>📅 Sampai Tanggal</label>
                        <input type="text" id="filterPenjualanSelesai" placeholder="DD/MM/YYYY" maxlength="10"
                            oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group d-flex align-end gap-2">
                        <button class="btn btn-primary" onclick="filterDaftarPenjualan()">🔍 Filter</button>
                        <button class="btn btn-secondary" onclick="resetFilterPenjualan()">🔄 Reset</button>
                    </div>
                </div>
            </div>

            <!-- Search Box Penjualan -->
            <div class="search-box">
                <div class="search-container">
                    <input type="text" id="searchPenjualan"
                        placeholder="🔍 Cari berdasarkan tanggal, faktur, pelanggan, barang, divisi..."
                        oninput="searchTable('searchPenjualan', 'bodyPenjualan')">
                    <span class="search-icon">🔍</span>
                </div>
                <div class="search-results-info" id="resultsPenjualan"></div>
            </div>

            <div class="table-container">
                <div class="form-buttons mb-2">
                    <button class="btn btn-primary" onclick="printTable('tablePenjualan')">🖨️ Cetak Daftar
                        Penjualan</button>
                </div>
                <table class="excel-table" id="tablePenjualan">
                    <thead>
                        <tr>
                            <th class="w-35px">No</th>
                            <th class="w-85px">Tanggal</th>
                            <th class="w-70px">Divisi</th>
                            <th class="w-100px">No. Faktur</th>
                            <th>Pelanggan</th>
                            <th>Barang</th>
                            <th class="w-50px">Qty</th>
                            <th class="w-90px">Harga Satuan</th>
                            <th class="w-80px">Diskon</th>
                            <th class="w-75px">PPN</th>
                            <th class="w-85px">DP</th>
                            <th class="w-100px">Total</th>
                            <th class="w-100px">Sisa Tagihan</th>
                            <th class="w-120px action-col">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="bodyPenjualan">
                        <tr>
                            <td colspan="15" class="text-center">Belum ada data penjualan</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-summary">
                            <td colspan="11" class="text-right">TOTAL PENJUALAN:</td>
                            <td class="number" id="grandTotalJual">Rp 0</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- TAB PEMBELIAN -->
        <div id="pembelian" class="tab-content">
            <div class="report-header">
                <h2>📝 FORM INPUT PEMBELIAN</h2>
                <p>PT. Sumber Ganda Mekar - Transaksi Pembelian Barang</p>
            </div>

            <div class="card mb-4">
                <form id="formPembelian">
                    <div class="form-header-grid">
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="text" id="tglPembelian" placeholder="DD/MM/YYYY" maxlength="10" required
                                oninput="formatTanggalInput(this)">
                        </div>
                        <div class="form-group">
                            <label>No. Faktur</label>
                            <input type="text" id="noFakturBeli" placeholder="Auto Generate" readonly>
                        </div>
                        <div class="form-group">
                            <label>Divisi</label>
                            <select id="divisiBeli" required>
                                <option value="">— Pilih Divisi —</option>
                                <option value="Angkutan">🚚 Angkutan</option>
                                <option value="Besi">🔩 Besi</option>
                                <option value="Pakan">🌾 Pakan</option>
                                <option value="Umum">🏢 Umum</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nama Supplier</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="namaSupplier" required placeholder="Ketik nama supplier..."
                                    autocomplete="off">
                                <div id="dropdownSupplier" class="autocomplete-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>No. Telepon</label>
                            <input type="text" id="teleponSupplier" placeholder="No. HP/Telepon">
                        </div>
                        <div class="form-group">
                            <label>NPWP/NIK</label>
                            <input type="text" id="npwpSupplier" placeholder="NPWP atau NIK">
                        </div>
                        <div class="form-group col-span-3">
                            <label>Alamat Supplier</label>
                            <input type="text" id="alamatSupplier" placeholder="Alamat lengkap">
                        </div>
                    </div>
                    <hr class="mb-3">
                    <div>
                        <h4 class="mb-2 text-primary">Daftar Barang Pembelian</h4>
                        <div class="form-items-grid">
                            <div class="form-group">
                                <label>Nama Barang</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="namaBarangBeli" placeholder="Ketik nama barang..."
                                        autocomplete="off">
                                    <div id="dropdownBarangBeli" class="autocomplete-dropdown"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Jumlah (Qty)</label>
                                <input type="text" id="qtyBeli" placeholder="0" oninput="formatAngkaInput(this);">
                            </div>
                            <div class="form-group">
                                <label>Harga Satuan</label>
                                <input type="text" id="hargaBeli" placeholder="Rp 0" oninput="formatRupiahInput(this);">
                            </div>
                            <div class="form-group">
                                <label>Diskon</label>
                                <input type="text" id="diskonBeli" placeholder="Rp 0" value="0"
                                    oninput="formatRupiahInput(this);">
                            </div>
                            <div class="form-group">
                                <label>Jenis PPN</label>
                                <select id="jenisPpnBeli">
                                    <option value="nonppn">Non PPN</option>
                                    <option value="ppn11">PPN 11%</option>
                                    <option value="ppn1">PPN 1.1%</option>
                                    <option value="dibebaskan">PPN Dibebaskan</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Subtotal</label>
                                <input type="text" id="subtotalBeli" readonly placeholder="Rp 0">
                            </div>
                            <div class="form-group d-flex align-end">
                                <button type="button" class="btn btn-info btn-add" onclick="tambahDetailBarangBeli()">➕
                                    Tambah</button>
                            </div>
                        </div>
                        <div class="table-container mb-3 max-h-200">
                            <table class="excel-table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nama Barang</th>
                                        <th>Qty</th>
                                        <th>Harga</th>
                                        <th>Diskon</th>
                                        <th>PPN</th>
                                        <th>Subtotal</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="bodyDetailBarangBeli">
                                    <tr>
                                        <td colspan="8" class="text-center">Belum ada barang</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <hr class="mb-3">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Total Pembelian</label>
                            <input type="text" id="totalBeli" readonly placeholder="Rp 0" class="input-highlight">
                        </div>
                        <div class="form-group">
                            <label>Uang Muka (DP)</label>
                            <input type="text" id="dpBeli" placeholder="Rp 0" value="0"
                                oninput="formatRupiahInput(this); calculateSisaTagihanBeli();">
                        </div>
                        <div class="form-group">
                            <label>Sisa Tagihan</label>
                            <input type="text" id="sisaBeli" readonly placeholder="Rp 0" class="input-highlight">
                        </div>
                        <div class="form-group">
                            <label>Metode Pembayaran</label>
                            <select id="metodeBayarBeli" required onchange="toggleBayarBeli()">
                                <option value="tunai">Tunai</option>
                                <option value="transfer">Transfer</option>
                                <option value="kredit">Kredit</option>
                            </select>
                        </div>
                        <div class="form-group d-none" id="groupBayarBeli">
                            <label>Jumlah Bayar</label>
                            <input type="text" id="bayarBeli" placeholder="Rp 0" oninput="formatRupiahInput(this);">
                        </div>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" class="btn btn-success">💾 Simpan Pembelian</button>
                        <button type="button" class="btn btn-warning" onclick="resetForm('formPembelian')">🔄
                            Reset</button>
                    </div>
                </form>
            </div>

            <div id="alertPembelian"></div>

            <h3 class="section-title">📊 Daftar Transaksi Pembelian</h3>

            <!-- Filter Tanggal Pembelian -->
            <div class="card mb-3" style="background: var(--primary-light); border-left: 4px solid var(--primary);">
                <div class="form-header-grid">
                    <div class="form-group">
                        <label>📅 Dari Tanggal</label>
                        <input type="text" id="filterPembelianMulai" placeholder="DD/MM/YYYY" maxlength="10"
                            oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group">
                        <label>📅 Sampai Tanggal</label>
                        <input type="text" id="filterPembelianSelesai" placeholder="DD/MM/YYYY" maxlength="10"
                            oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group d-flex align-end gap-2">
                        <button class="btn btn-primary" onclick="filterDaftarPembelian()">🔍 Filter</button>
                        <button class="btn btn-secondary" onclick="resetFilterPembelian()">🔄 Reset</button>
                    </div>
                </div>
            </div>

            <!-- Search Box Pembelian -->
            <div class="search-box">
                <div class="search-container">
                    <input type="text" id="searchPembelian"
                        placeholder="🔍 Cari berdasarkan tanggal, faktur, supplier, barang, divisi..."
                        oninput="searchTable('searchPembelian', 'bodyPembelian')">
                    <span class="search-icon">🔍</span>
                </div>
                <div class="search-results-info" id="resultsPembelian"></div>
            </div>

            <div class="table-container">
                <div class="form-buttons mb-2">
                    <button class="btn btn-primary" onclick="printTable('tablePembelian')">🖨️ Cetak Daftar
                        Pembelian</button>
                </div>
                <table class="excel-table" id="tablePembelian">
                    <thead>
                        <tr>
                            <th class="w-35px">No</th>
                            <th class="w-85px">Tanggal</th>
                            <th class="w-70px">Divisi</th>
                            <th class="w-100px">No. Faktur</th>
                            <th>Supplier</th>
                            <th>Barang</th>
                            <th class="w-50px">Qty</th>
                            <th class="w-90px">Harga Satuan</th>
                            <th class="w-80px">Diskon</th>
                            <th class="w-75px">PPN</th>
                            <th class="w-85px">DP</th>
                            <th class="w-100px">Total</th>
                            <th class="w-100px">Sisa Tagihan</th>
                            <th class="w-120px action-col">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="bodyPembelian">
                        <tr>
                            <td colspan="15" class="text-center">Belum ada data pembelian</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-summary">
                            <td colspan="11" class="text-right">TOTAL PEMBELIAN:</td>
                            <td class="number" id="grandTotalBeli">Rp 0</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- TAB PIUTANG -->
        <div id="piutang" class="tab-content">
            <div class="report-header">
                <h2>📊 LAPORAN PIUTANG</h2>
                <p>PT. Sumber Ganda Mekar - Daftar Penjualan Kredit & Pembayaran</p>
            </div>

            <!-- Filter Section Piutang -->
            <div class="card mb-4">
                <div class="form-header-grid">
                    <div class="form-group">
                        <label>Dari Tanggal</label>
                        <input type="text" id="filterPiutangMulai" placeholder="DD/MM/YYYY" maxlength="10"
                            oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group">
                        <label>Sampai Tanggal</label>
                        <input type="text" id="filterPiutangSelesai" placeholder="DD/MM/YYYY" maxlength="10"
                            oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="filterPiutangStatus">
                            <option value="semua">Semua Status</option>
                            <option value="belum">Belum Lunas</option>
                            <option value="lunas">Sudah Lunas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pelanggan</label>
                        <input type="text" id="filterPiutangPelanggan" list="listCustomer"
                            placeholder="Semua Pelanggan">
                    </div>
                    <div class="form-group d-flex align-end">
                        <button class="btn btn-info" onclick="filterLaporanPiutang()">📊 Filter</button>
                        <button class="btn btn-warning" onclick="resetFilterPiutang()">🔄 Reset</button>
                    </div>
                </div>
            </div>

            <div class="summary-cards">
                <div class="card danger">
                    <h3>Total Piutang Belum Lunas</h3>
                    <div class="amount" id="totalPiutang">Rp 0</div>
                </div>
                <div class="card success">
                    <h3>Total Sudah Dibayar</h3>
                    <div class="amount" id="totalBayarPiutang">Rp 0</div>
                </div>
                <div class="card">
                    <h3>Total Penjualan Kredit</h3>
                    <div class="amount" id="totalPenjualanKredit">Rp 0</div>
                </div>
                <div class="card warning">
                    <h3>Jumlah Pelanggan</h3>
                    <div class="amount" id="jumlahPelangganPiutang">0</div>
                </div>
            </div>

            <!-- Form Input Piutang Awal -->
            <div class="card mb-4">
                <h3 class="mb-3 text-warning">➕ Input Piutang Awal / Saldo Awal</h3>
                <form id="formPiutangAwal" onsubmit="return submitPiutangAwal(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="text" id="tglPiutangAwal" placeholder="DD/MM/YYYY" maxlength="10" required
                                oninput="formatTanggalInput(this)">
                        </div>
                        <div class="form-group">
                            <label>Pelanggan</label>
                            <input type="text" id="namaPelangganPiutangAwal" list="listCustomer" required
                                placeholder="Nama pelanggan">
                        </div>
                        <div class="form-group">
                            <label>Keterangan</label>
                            <input type="text" id="ketPiutangAwal" placeholder="Keterangan">
                        </div>
                        <div class="form-group">
                            <label>Jumlah Piutang (Rp)</label>
                            <input type="text" id="jumlahPiutangAwal" required placeholder="0"
                                oninput="formatRupiahInput(this)">
                        </div>
                        <div class="form-group">
                            <label>Sudah Dibayar (Rp)</label>
                            <input type="text" id="dibayarPiutangAwal" placeholder="0"
                                oninput="formatRupiahInput(this)">
                        </div>
                        <div class="form-group d-flex align-end">
                            <button type="submit" class="btn btn-success">💾 Simpan</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Rekap Per Pelanggan -->
            <div class="card mb-4">
                <h3 class="mb-3 text-primary">📊 Rekap Piutang Per Pelanggan</h3>
                <div class="table-container h-300-scroll">
                    <table class="excel-table" id="tabelRekapPiutang">
                        <thead>
                            <tr>
                                <th class="w-35px">No</th>
                                <th>Nama Pelanggan</th>
                                <th class="w-80px">Jml Transaksi</th>
                                <th class="w-120px">Total Piutang</th>
                                <th class="w-120px">Total Dibayar</th>
                                <th class="w-120px">Sisa Piutang</th>
                                <th class="w-80px">Status</th>
                            </tr>
                        </thead>
                        <tbody id="bodyRekapPiutang">
                            <tr>
                                <td colspan="7" class="center">Belum ada data</td>
                            </tr>
                        </tbody>
                        <tfoot id="footerRekapPiutang">
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="report-header mt-4">
                <h3>📋 Daftar Piutang</h3>
            </div>

            <!-- Search Box Piutang -->
            <div class="search-box">
                <div class="search-container">
                    <input type="text" id="searchPiutang"
                        placeholder="🔍 Cari berdasarkan faktur, pelanggan, barang, status..."
                        oninput="searchTable('searchPiutang', 'bodyPiutang')">
                    <span class="search-icon">🔍</span>
                </div>
                <div class="search-results-info" id="resultsPiutang"></div>
            </div>

            <div class="table-container">
                <table class="excel-table" id="tabelPiutang">
                    <thead>
                        <tr>
                            <th class="w-35px">No</th>
                            <th class="w-85px">Tanggal</th>
                            <th class="w-70px">Sumber</th>
                            <th class="w-100px">No. Faktur</th>
                            <th>Pelanggan</th>
                            <th>Keterangan</th>
                            <th class="w-100px">Total</th>
                            <th class="w-100px">Dibayar</th>
                            <th class="w-100px">Sisa</th>
                            <th class="w-80px">Status</th>
                            <th class="w-100px">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="bodyPiutang">
                        <tr>
                            <td colspan="11" class="center">Belum ada piutang</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-summary">
                            <td colspan="6" class="text-right">TOTAL:</td>
                            <td class="number" id="footerTotalPiutang">Rp 0</td>
                            <td class="number" id="footerDibayarPiutang">Rp 0</td>
                            <td class="number" id="footerSisaPiutang">Rp 0</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Tombol Cetak dan Export -->
            <div class="form-buttons mt-4">
                <button class="btn btn-primary" onclick="printLaporanPiutang()">🖨️ Cetak Laporan</button>
                <button class="btn btn-success" onclick="eksporPiutangExcel()">📥 Ekspor Excel</button>
                <button class="btn btn-info" onclick="printRekapPiutang()">📊 Cetak Rekap Per Pelanggan</button>
            </div>
        </div>

        <!-- TAB HUTANG -->
        <div id="hutang" class="tab-content">
            <div class="report-header">
                <h2>📋 LAPORAN HUTANG</h2>
                <p>PT. Sumber Ganda Mekar - Daftar Pembelian Kredit & Pembayaran</p>
            </div>

            <!-- Filter Section Hutang -->
            <div class="card mb-4">
                <div class="form-header-grid">
                    <div class="form-group">
                        <label>Dari Tanggal</label>
                        <input type="text" id="filterHutangMulai" placeholder="DD/MM/YYYY" maxlength="10"
                            oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group">
                        <label>Sampai Tanggal</label>
                        <input type="text" id="filterHutangSelesai" placeholder="DD/MM/YYYY" maxlength="10"
                            oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="filterHutangStatus">
                            <option value="semua">Semua Status</option>
                            <option value="belum">Belum Lunas</option>
                            <option value="lunas">Sudah Lunas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="filterHutangSupplier" list="listSupplier" placeholder="Semua Supplier">
                    </div>
                    <div class="form-group d-flex align-end">
                        <button class="btn btn-info" onclick="filterLaporanHutang()">📊 Filter</button>
                        <button class="btn btn-warning" onclick="resetFilterHutang()">🔄 Reset</button>
                    </div>
                </div>
            </div>

            <div class="summary-cards">
                <div class="card danger">
                    <h3>Total Hutang Belum Lunas</h3>
                    <div class="amount" id="totalHutang">Rp 0</div>
                </div>
                <div class="card success">
                    <h3>Total Sudah Dibayar</h3>
                    <div class="amount" id="totalBayarHutang">Rp 0</div>
                </div>
                <div class="card">
                    <h3>Total Pembelian Kredit</h3>
                    <div class="amount" id="totalPembelianKredit">Rp 0</div>
                </div>
                <div class="card warning">
                    <h3>Jumlah Supplier</h3>
                    <div class="amount" id="jumlahSupplierHutang">0</div>
                </div>
            </div>

            <!-- Form Input Hutang Awal -->
            <div class="card mb-4">
                <h3 class="mb-3 text-danger">➕ Input Hutang Awal / Saldo Awal</h3>
                <form id="formHutangAwal" onsubmit="return submitHutangAwal(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="text" id="tglHutangAwal" placeholder="DD/MM/YYYY" maxlength="10" required
                                oninput="formatTanggalInput(this)">
                        </div>
                        <div class="form-group">
                            <label>Supplier</label>
                            <input type="text" id="namaSupplierHutangAwal" list="listSupplier" required
                                placeholder="Nama supplier">
                        </div>
                        <div class="form-group">
                            <label>Keterangan</label>
                            <input type="text" id="ketHutangAwal" placeholder="Keterangan">
                        </div>
                        <div class="form-group">
                            <label>Jumlah Hutang (Rp)</label>
                            <input type="text" id="jumlahHutangAwal" required placeholder="0"
                                oninput="formatRupiahInput(this)">
                        </div>
                        <div class="form-group">
                            <label>Sudah Dibayar (Rp)</label>
                            <input type="text" id="dibayarHutangAwal" placeholder="0" oninput="formatRupiahInput(this)">
                        </div>
                        <div class="form-group d-flex align-end">
                            <button type="submit" class="btn btn-success">💾 Simpan</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Rekap Per Supplier -->
            <div class="card mb-4">
                <h3 class="mb-3 text-primary">📊 Rekap Hutang Per Supplier</h3>
                <div class="table-container h-300-scroll">
                    <table class="excel-table" id="tabelRekapHutang">
                        <thead>
                            <tr>
                                <th class="w-35px">No</th>
                                <th>Nama Supplier</th>
                                <th class="w-80px">Jml Transaksi</th>
                                <th class="w-120px">Total Hutang</th>
                                <th class="w-120px">Total Dibayar</th>
                                <th class="w-120px">Sisa Hutang</th>
                                <th class="w-80px">Status</th>
                            </tr>
                        </thead>
                        <tbody id="bodyRekapHutang">
                            <tr>
                                <td colspan="7" class="text-center">Belum ada data</td>
                            </tr>
                        </tbody>
                        <tfoot id="footerRekapHutang">
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="report-header mt-4">
                <h3>📋 Daftar Hutang</h3>
            </div>

            <!-- Search Box Hutang -->
            <div class="search-box">
                <div class="search-container">
                    <input type="text" id="searchHutang"
                        placeholder="🔍 Cari berdasarkan faktur, supplier, barang, status..."
                        oninput="searchTable('searchHutang', 'bodyHutang')">
                    <span class="search-icon">🔍</span>
                </div>
                <div class="search-results-info" id="resultsHutang"></div>
            </div>

            <div class="table-container">
                <table class="excel-table" id="tabelHutang">
                    <thead>
                        <tr>
                            <th class="w-35px">No</th>
                            <th class="w-85px">Tanggal</th>
                            <th class="w-70px">Sumber</th>
                            <th class="w-100px">No. Faktur</th>
                            <th>Supplier</th>
                            <th>Keterangan</th>
                            <th class="w-100px">Total</th>
                            <th class="w-100px">Dibayar</th>
                            <th class="w-100px">Sisa</th>
                            <th class="w-80px">Status</th>
                            <th class="w-100px">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="bodyHutang">
                        <tr>
                            <td colspan="11" class="text-center">Belum ada hutang</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-summary">
                            <td colspan="6" class="text-right">TOTAL:</td>
                            <td class="number" id="footerTotalHutang">Rp 0</td>
                            <td class="number" id="footerDibayarHutang">Rp 0</td>
                            <td class="number" id="footerSisaHutang">Rp 0</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Tombol Cetak dan Export -->
            <div class="form-buttons mt-4">
                <button class="btn btn-primary" onclick="printLaporanHutang()">🖨️ Cetak Laporan</button>
                <button class="btn btn-success" onclick="eksporHutangExcel()">📥 Ekspor Excel</button>
                <button class="btn btn-info" onclick="printRekapHutang()">📊 Cetak Rekap Per Supplier</button>
            </div>
        </div>

        <!-- TAB LAPORAN DIVISI -->
        <div id="laporan-divisi" class="tab-content">
            <div class="report-header">
                <h2>🏢 LAPORAN PER DIVISI</h2>
                <p>PT. Sumber Ganda Mekar - Analisa Per Divisi</p>
            </div>

            <div class="card mb-4">
                <div class="form-header-grid">
                    <div class="form-group">
                        <label>Pilih Divisi</label>
                        <select id="filterDivisi" onchange="updateLaporanDivisi()">
                            <option value="semua">Semua Divisi</option>
                            <option value="Angkutan">Angkutan</option>
                            <option value="Besi">Besi</option>
                            <option value="Pakan">Pakan</option>
                            <option value="Umum">Umum</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Dari Tanggal</label>
                        <input type="text" id="filterDivisiMulai" placeholder="DD/MM/YYYY" maxlength="10"
                            pattern="\d{2}/\d{2}/\d{4}" oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group">
                        <label>Sampai</label>
                        <input type="text" id="filterDivisiSelesai" placeholder="DD/MM/YYYY" maxlength="10"
                            pattern="\d{2}/\d{2}/\d{4}" oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group d-flex align-end">
                        <button class="btn btn-info" onclick="updateLaporanDivisi()">📊 Generate</button>
                    </div>
                </div>
            </div>

            <!-- Summary Cards Per Divisi -->
            <h3 class="section-title">📊 Ringkasan Per Divisi</h3>

            <div id="summaryDivisiAngkutan" class="mb-4">
                <h4 class="section-subtitle bg-primary text-white p-3 rounded mb-3">🚛 DIVISI ANGKUTAN</h4>
                <div class="summary-cards">
                    <div class="card success">
                        <h3>Pendapatan</h3>
                        <div class="amount" id="pendapatanAngkutan">Rp 0</div>
                    </div>
                    <div class="card danger">
                        <h3>Beban</h3>
                        <div class="amount" id="bebanAngkutan">Rp 0</div>
                    </div>
                    <div class="card" id="labaAngkutan">
                        <h3>Laba/Rugi</h3>
                        <div class="amount" id="labaAngkutanValue">Rp 0</div>
                    </div>
                </div>
            </div>

            <div id="summaryDivisiBesi" class="mb-4">
                <h4 class="section-subtitle bg-warning text-white p-3 rounded mb-3">🔩 DIVISI BESI</h4>
                <div class="summary-cards">
                    <div class="card success">
                        <h3>Pendapatan</h3>
                        <div class="amount" id="pendapatanBesi">Rp 0</div>
                    </div>
                    <div class="card danger">
                        <h3>Beban</h3>
                        <div class="amount" id="bebanBesi">Rp 0</div>
                    </div>
                    <div class="card" id="labaBesi">
                        <h3>Laba/Rugi</h3>
                        <div class="amount" id="labaBesiValue">Rp 0</div>
                    </div>
                </div>
            </div>

            <div id="summaryDivisiPakan" class="mb-4">
                <h4 class="section-subtitle bg-success text-white p-3 rounded mb-3">🌾 DIVISI PAKAN</h4>
                <div class="summary-cards">
                    <div class="card success">
                        <h3>Pendapatan</h3>
                        <div class="amount" id="pendapatanPakan">Rp 0</div>
                    </div>
                    <div class="card danger">
                        <h3>Beban</h3>
                        <div class="amount" id="bebanPakan">Rp 0</div>
                    </div>
                    <div class="card" id="labaPakan">
                        <h3>Laba/Rugi</h3>
                        <div class="amount" id="labaPakanValue">Rp 0</div>
                    </div>
                </div>
            </div>

            <!-- Tabel Detail Per Divisi -->
            <h3 class="section-title">📋 Detail Transaksi Per Divisi</h3>
            <div class="table-container">
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th class="w-50px">No</th>
                            <th>Divisi</th>
                            <th>Tanggal</th>
                            <th>No. Ref</th>
                            <th>Jenis</th>
                            <th>Keterangan</th>
                            <th>Pendapatan</th>
                            <th>Beban</th>
                        </tr>
                    </thead>
                    <tbody id="bodyLaporanDivisi">
                        <tr>
                            <td colspan="8" class="text-center">Pilih divisi dan klik Generate untuk melihat laporan
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-summary">
                            <td colspan="6" class="text-right">TOTAL:</td>
                            <td class="number" id="totalPendapatanDivisi">Rp 0</td>
                            <td class="number" id="totalBebanDivisi">Rp 0</td>
                        </tr>
                        <tr class="bg-success text-white">
                            <td colspan="6" class="text-right font-bold text-lg">LABA/RUGI:</td>
                            <td colspan="2" class="number font-bold text-lg" id="totalLabaDivisi">Rp 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="form-buttons mt-4">
                <button class="btn btn-primary" onclick="printLaporanDivisi()">🖨️ Cetak Laporan</button>
                <button class="btn btn-success" onclick="eksporDivisiExcel()">📥 Ekspor Excel</button>
            </div>
        </div>

        <!-- TAB LAPORAN PER JENIS PPN -->
        <div id="laporan-non-ppn" class="tab-content">
            <div class="report-header">
                <h2>🧾 LAPORAN TRANSAKSI PER JENIS PPN</h2>
                <p>PT. Sumber Ganda Mekar - Laporan Berdasarkan Kategori PPN</p>
            </div>

            <div class="card mb-4">
                <div class="form-header-grid">
                    <div class="form-group">
                        <label>Kategori PPN</label>
                        <select id="filterKategoriPPN" onchange="displayLaporanNonPPN()" class="font-bold">
                            <option value="nonppn">📄 Non PPN</option>
                            <option value="ppn11">💵 PPN 11%</option>
                            <option value="ppn1">💰 PPN 1.1%</option>
                            <option value="dibebaskan">✅ PPN Dibebaskan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jenis</label>
                        <select id="filterJenisNonPpn" onchange="displayLaporanNonPPN()">
                            <option value="semua">Semua (Penjualan & Pembelian)</option>
                            <option value="penjualan">Penjualan Saja</option>
                            <option value="pembelian">Pembelian Saja</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Dari Tanggal</label>
                        <input type="text" id="filterNonPpnMulai" placeholder="DD/MM/YYYY" maxlength="10"
                            pattern="\d{2}/\d{2}/\d{4}" oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group">
                        <label>Sampai</label>
                        <input type="text" id="filterNonPpnSelesai" placeholder="DD/MM/YYYY" maxlength="10"
                            pattern="\d{2}/\d{2}/\d{4}" oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group d-flex align-end">
                        <button class="btn btn-info" onclick="displayLaporanNonPPN()">📊 Generate</button>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="card success">
                    <h3 id="labelPenjualanPPN">Total Penjualan</h3>
                    <div class="amount" id="totalPenjualanNonPPN">Rp 0</div>
                    <small id="countPenjualanNonPPN">0 transaksi</small>
                </div>
                <div class="card danger">
                    <h3 id="labelPembelianPPN">Total Pembelian</h3>
                    <div class="amount" id="totalPembelianNonPPN">Rp 0</div>
                    <small id="countPembelianNonPPN">0 transaksi</small>
                </div>
                <div class="card">
                    <h3>Selisih</h3>
                    <div class="amount" id="selisihNonPPN">Rp 0</div>
                </div>
            </div>

            <!-- Tabel Penjualan -->
            <h3 class="section-title" id="headerPenjualanPPN">💰 Data Penjualan</h3>
            <div class="table-container">
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th class="w-50px">No</th>
                            <th>Tanggal</th>
                            <th>Divisi</th>
                            <th>No. Faktur</th>
                            <th>Pelanggan</th>
                            <th>Barang</th>
                            <th>Qty</th>
                            <th>Harga</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="bodyPenjualanNonPPN">
                        <tr>
                            <td colspan="9" class="center">Tidak ada data penjualan Non PPN</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-summary">
                            <td colspan="8" class="text-right">TOTAL PENJUALAN:</td>
                            <td class="number" id="footerTotalPenjualanNonPPN">Rp 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Tabel Pembelian Non PPN -->
            <h3 class="section-title" id="headerPembelianPPN">🛒 Data Pembelian</h3>
            <div class="table-container">
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th class="w-50px">No</th>
                            <th>Tanggal</th>
                            <th>Divisi</th>
                            <th>No. Faktur</th>
                            <th>Supplier</th>
                            <th>Barang</th>
                            <th>Qty</th>
                            <th>Harga</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="bodyPembelianNonPPN">
                        <tr>
                            <td colspan="9" class="text-center">Tidak ada data pembelian Non PPN</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-summary">
                            <td colspan="8" class="text-right">TOTAL PEMBELIAN:</td>
                            <td class="number" id="footerTotalPembelianNonPPN">Rp 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="form-buttons mt-4">
                <button class="btn btn-primary" onclick="printLaporanPPN()">🖨️ Cetak Laporan</button>
                <button class="btn btn-success" onclick="eksporPPNExcel()">📥 Ekspor Excel</button>
            </div>
        </div>




        <!-- TAB LAPORAN CASH FLOW (REMOVED) -->
        <!--
        <div id="laporan-cashflow" class="tab-content">
            <div class="report-header">
                <h2>💸 LAPORAN CASH FLOW</h2>
                <p>PT. Sumber Ganda Mekar - Laporan Arus Kas Masuk & Keluar</p>
            </div>
            
            <div class="filter-section">
                <div class="filter-row">
                    <div class="form-group grid-cols-fixed-100">
                        <label>Dari Tanggal:</label>
                        <input type="text" id="filterCashFlowMulai" placeholder="DD/MM/YYYY" maxlength="10" pattern="\d{2}/\d{2}/\d{4}" oninput="formatTanggalInput(this)">
                    </div>
                    <div class="form-group grid-cols-100-1fr">
                        <label>Sampai:</label>
                        <input type="text" id="filterCashFlowSelesai" placeholder="DD/MM/YYYY" maxlength="10" pattern="\d{2}/\d{2}/\d{4}" oninput="formatTanggalInput(this)">
                    </div>
                    <div>
                        <button class="btn btn-info" onclick="displayCashFlow()">📊 Generate</button>
                        <button class="btn btn-warning ml-2" onclick="recalculateJurnal()">🔄 Refresh Data</button>
                    </div>
                </div>
            </div>

            <div class="summary-cards">
                <div class="card success">
                    <h3>Total Masuk</h3>
                    <div class="amount" id="totalCashFlowMasuk">Rp 0</div>
                </div>
                <div class="card danger">
                    <h3>Total Keluar</h3>
                    <div class="amount" id="totalCashFlowKeluar">Rp 0</div>
                </div>
                <div class="card">
                    <h3>Saldo Akhir</h3>
                    <div class="amount" id="saldoCashFlow">Rp 0</div>
                </div>
            </div>

            <div class="table-container mt-4">
                <table class="excel-table" id="tableCashFlow">
                    <thead>
                        <tr>
                            <th class="w-50px">No</th>
                            <th>Tanggal</th>
                            <th>Akun / Kategori</th>
                            <th>Keterangan</th>
                            <th class="text-right">Masuk</th>
                            <th class="text-right">Keluar</th>
                            <th class="text-right">Saldo</th>
                        </tr>
                    </thead>
                    <tbody id="bodyCashFlow">
                        <tr>
                            <td colspan="7" class="text-center">Silakan filter tanggal untuk menampilkan data</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right pr-4 font-bold">TOTAL:</td>
                            <td class="number font-bold text-success" id="footerTotalMasukCF">Rp 0</td>
                            <td class="number font-bold text-danger" id="footerTotalKeluarCF">Rp 0</td>
                            <td class="number font-bold" id="footerSaldoCF">Rp 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="form-buttons mt-4">
                <button class="btn btn-primary" onclick="printCashFlow()">🖨️ Cetak Laporan</button>
                <button class="btn btn-success" onclick="eksporCashFlowExcel()">📥 Ekspor Excel</button>
            </div>
        </div>
        -->

        <!-- TAB PENCARIAN GLOBAL -->
        <div id="pencarian" class="tab-content">
            <div class="report-header">
                <h2>🔍 PENCARIAN GLOBAL</h2>
                <p>PT. Sumber Ganda Mekar - Pencarian Data Terintegrasi</p>
            </div>

            <div class="search-box mb-4">
                <div class="search-container">
                    <input type="text" id="searchGlobal"
                        placeholder="🔍 Cari di semua data (penjualan, pembelian, piutang, hutang, kas, jurnal)..."
                        oninput="searchGlobal()">
                    <span class="search-icon">🔍</span>
                </div>
                <div class="search-results-info" id="resultsGlobal"></div>
            </div>

            <div id="globalSearchResults">
                <div class="no-results">
                    <p>🔍 Masukkan kata kunci untuk mencari di semua data</p>
                    <p class="text-muted text-small mt-2">Cari berdasarkan: tanggal, nomor faktur/transaksi, nama
                        pelanggan/supplier, barang, kategori, divisi, dll.</p>
                </div>
            </div>
        </div>

        <!-- TAB KAS HARIAN -->
        <div id="kas-harian" class="tab-content">
            <div class="report-header">
                <h2>💵 KAS HARIAN</h2>
                <p>PT. Sumber Ganda Mekar - Pencatatan Arus Kas</p>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="card success">
                    <h3>💰 Total Kas Masuk</h3>
                    <div class="amount" id="totalKasHarianMasuk">Rp 0</div>
                </div>
                <div class="card danger">
                    <h3>💸 Total Kas Keluar</h3>
                    <div class="amount" id="totalKasHarianKeluar">Rp 0</div>
                </div>
                <div class="card" id="cardSaldoKasHarian">
                    <h3>💼 Saldo Kas</h3>
                    <div class="amount" id="saldoKasHarian">Rp 0</div>
                </div>
            </div>

            <!-- Filter Tanggal -->
            <div class="card mb-4">
                <div class="form-header-grid">
                    <div class="form-group">
                        <label>Tanggal Mulai</label>
                        <input type="text" id="filterKasHarianMulai" placeholder="DD/MM/YYYY" maxlength="10"
                            oninput="formatTanggalInput(this)" onchange="displayKasHarian()">
                    </div>
                    <div class="form-group">
                        <label>Tanggal Selesai</label>
                        <input type="text" id="filterKasHarianSelesai" placeholder="DD/MM/YYYY" maxlength="10"
                            oninput="formatTanggalInput(this)" onchange="displayKasHarian()">
                    </div>
                    <div class="form-group">
                        <label>Filter Divisi</label>
                        <select id="filterDivisiKasHarian" onchange="displayKasHarian()">
                            <option value="semua">Semua Divisi</option>
                            <option value="Angkutan">Angkutan</option>
                            <option value="Besi">Besi</option>
                            <option value="Pakan">Pakan</option>
                            <option value="Umum">Umum</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filter Jenis</label>
                        <select id="filterJenisKasHarian" onchange="displayKasHarian()">
                            <option value="semua">Semua</option>
                            <option value="masuk">Kas Masuk</option>
                            <option value="keluar">Kas Keluar</option>
                        </select>
                    </div>
                    <div class="form-group d-flex align-end">
                        <button type="button" class="btn btn-info" onclick="displayKasHarian()">🔍 Filter</button>
                        <button type="button" class="btn btn-warning" onclick="resetFilterKasHarian()">🔄 Reset</button>
                        <button type="button" class="btn btn-secondary" onclick="showRekapKasHarian()">📊 Rekap
                            Akun</button>
                    </div>
                </div>
            </div>

            <!-- Form Input Kas Harian -->
            <div class="card mb-4">
                <h3 class="mb-3 text-primary">➕ Input Transaksi Kas</h3>
                <form id="formKasHarian" onsubmit="return submitKasHarian(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="text" id="tglKasHarian" placeholder="DD/MM/YYYY" maxlength="10" required
                                oninput="formatTanggalInput(this)">
                        </div>
                        <div class="form-group">
                            <label>Divisi</label>
                            <select id="divisiKasHarian" required>
                                <option value="">— Pilih Divisi —</option>
                                <option value="Angkutan">🚚 Angkutan</option>
                                <option value="Besi">🔩 Besi</option>
                                <option value="Pakan">🌾 Pakan</option>
                                <option value="Umum">🏢 Umum</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Jenis</label>
                            <select id="jenisKasHarian" required>
                                <option value="masuk">Kas Masuk</option>
                                <option value="keluar">Kas Keluar</option>
                            </select>
                        </div>
                        <div class="form-group relative">
                            <label>Kategori Akun</label>
                            <input type="text" id="kategoriKasHarian" required
                                placeholder="Ketik untuk mencari kategori..." autocomplete="off">
                            <div id="dropdownKategoriKasHarian" class="autocomplete-dropdown"></div>
                        </div>
                        <div class="form-group">
                            <label>Keterangan</label>
                            <input type="text" id="ketKasHarian" required placeholder="Keterangan transaksi">
                        </div>
                        <div class="form-group">
                            <label>Jumlah (Rp)</label>
                            <input type="text" id="jumlahKasHarian" required placeholder="0"
                                oninput="formatRupiahInput(this)">
                        </div>
                    </div>
                    <div class="form-buttons mt-4">
                        <button type="submit" class="btn btn-success">💾 Simpan</button>
                        <button type="button" id="btnCancelEditKasHarian" class="btn btn-secondary d-none"
                            onclick="cancelEditKasHarian()">❌ Batal</button>
                    </div>
                </form>
            </div>

            <!-- Search Box Kas Harian -->
            <div class="search-box">
                <div class="search-container">
                    <input type="text" id="searchKasHarian"
                        placeholder="🔍 Cari berdasarkan tanggal, divisi, kategori, atau keterangan..."
                        oninput="searchTable('searchKasHarian', 'bodyKasHarian')">
                    <span class="search-icon">🔍</span>
                </div>
                <div class="search-results-info" id="resultsKasHarian"></div>
            </div>

            <!-- Tabel Kas Harian (Excel-like) -->
            <div class="table-container max-h-500">
                <table class="kas-harian-excel">
                    <thead>
                        <tr>
                            <th colspan="9" class="table-title-header">📊 BUKU KAS HARIAN - SGM</th>
                        </tr>
                        <tr>
                            <th class="w-40px">A</th>
                            <th class="w-90px">B</th>
                            <th class="w-90px">C</th>
                            <th class="w-140px">D</th>
                            <th>E</th>
                            <th class="w-120px">F</th>
                            <th class="w-120px">G</th>
                            <th class="w-120px">H</th>
                            <th class="w-80px">I</th>
                        </tr>
                        <tr>
                            <th>No</th>
                            <th>Tanggal</th>
                            <th>Divisi</th>
                            <th>Kategori</th>
                            <th>Keterangan</th>
                            <th>Kas Masuk</th>
                            <th>Kas Keluar</th>
                            <th>Saldo</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="bodyKasHarian">
                        <tr>
                            <td colspan="9" class="text-center">Belum ada data kas harian</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-summary">
                            <td colspan="5" class="text-right">TOTAL :</td>
                            <td class="number" id="footerKasMasuk">Rp 0</td>
                            <td class="number" id="footerKasKeluar">Rp 0</td>
                            <td class="number" id="footerSaldoAkhir">Rp 0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Tombol Cetak dan Export -->
            <div class="form-buttons mt-3">
                <button class="btn btn-primary" onclick="printKasHarian()">🖨️ Cetak Laporan</button>
                <button class="btn btn-success" onclick="exportKasHarianExcel()">📥 Export Excel</button>
            </div>

            <div id="alertKasHarian"></div>
        </div>

        <!-- TAB DATA MASTER -->
        <div id="data-master" class="tab-content">
            <div class="report-header">
                <h2>📋 DATA MASTER</h2>
                <p>PT. Sumber Ganda Mekar - Manajemen Data Induk</p>
            </div>

            <!-- Tombol Reset Data Master -->
            <div class="alert alert-warning mb-4 d-flex justify-between align-center">
                <span class="text-small">
                    💡 <strong>Tips:</strong> Data master (Customer, Supplier, Barang) sudah tersedia secara default.
                    Data akan muncul di dropdown saat input transaksi.
                </span>
                <button onclick="resetDataMasterToDefault()" class="btn btn-danger btn-sm">
                    🔄 Reset Semua ke Default
                </button>
            </div>

            <!-- Sub-Tabs untuk Data Master -->
            <div class="tabs mb-4">
                <button class="tab active" onclick="openSubTab(event, 'master-customer')">👥 Customer</button>
                <button class="tab" onclick="openSubTab(event, 'master-supplier')">🏭 Supplier</button>
                <button class="tab" onclick="openSubTab(event, 'master-barang')">📦 Barang</button>
                <button class="tab" onclick="openSubTab(event, 'master-kategori')">📂 Kategori</button>
                <button class="tab" onclick="openSubTab(event, 'master-info')">ℹ️ Info Sistem</button>
            </div>

            <!-- SUB-TAB: MASTER CUSTOMER -->
            <div id="master-customer" class="sub-tab-content active">
                <h3 class="text-primary mb-3">👥 Data Master Customer</h3>

                <!-- Tombol Export/Import Excel Customer -->
                <div class="d-flex gap-2 flex-wrap align-center mb-3">
                    <button onclick="exportCustomerToExcel()" class="btn btn-success">
                        📥 Export Excel
                    </button>
                    <button onclick="document.getElementById('importCustomerFile').click()" class="btn btn-primary">
                        📤 Import Excel
                    </button>
                    <input type="file" id="importCustomerFile" accept=".xlsx,.xls"
                        onchange="importCustomerFromExcel(event)" class="hidden">
                    <button onclick="downloadTemplateCustomer()" class="btn btn-secondary">
                        📋 Download Template
                    </button>
                    <button onclick="loadSampleCustomer()" class="btn btn-info">
                        🔄 Muat Sample Data
                    </button>
                    <span class="text-muted text-small">Total: <strong id="totalMasterCustomer">0</strong>
                        customer</span>
                </div>

                <div class="card mb-4">
                    <h4 class="mb-3">➕ Tambah Customer</h4>
                    <form id="formMasterCustomer" onsubmit="return submitMasterCustomer(event)">
                        <div class="form-grid-3">
                            <div class="form-group">
                                <label>Nama Customer:</label>
                                <input type="text" id="masterNamaCustomer" required placeholder="Nama customer">
                            </div>
                            <div class="form-group">
                                <label>Alamat:</label>
                                <input type="text" id="masterAlamatCustomer" placeholder="Alamat">
                            </div>
                            <div class="form-group">
                                <label>Telepon:</label>
                                <input type="text" id="masterTeleponCustomer" placeholder="No. Telepon">
                            </div>
                            <div class="form-group">
                                <label>NPWP/NIK:</label>
                                <input type="text" id="masterNpwpCustomer" placeholder="NPWP/NIK">
                            </div>
                            <div class="form-group">
                                <label>Email:</label>
                                <input type="email" id="masterEmailCustomer" placeholder="email@domain.com">
                            </div>
                            <div class="form-group">
                                <label>Keterangan:</label>
                                <input type="text" id="masterKetCustomer" placeholder="Catatan">
                            </div>
                            <div class="form-group full-width d-flex gap-2 mt-2">
                                <button type="submit" class="btn btn-primary">💾 Simpan</button>
                                <button type="reset" class="btn btn-secondary">🔄 Reset</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="search-box">
                    <div class="search-container">
                        <input type="text" id="searchMasterCustomer" placeholder="🔍 Cari customer..."
                            oninput="searchTable('searchMasterCustomer', 'bodyMasterCustomer')">
                        <span class="search-icon">🔍</span>
                    </div>
                </div>

                <div class="table-container">
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th class="w-50px">No</th>
                                <th>Nama Customer</th>
                                <th>Alamat</th>
                                <th>Telepon</th>
                                <th>NPWP/NIK</th>
                                <th>Email</th>
                                <th>Keterangan</th>
                                <th class="w-100px">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="bodyMasterCustomer">
                            <tr>
                                <td colspan="8" class="text-center">Belum ada data customer</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUB-TAB: MASTER SUPPLIER -->
            <div id="master-supplier" class="sub-tab-content">
                <h3 class="text-primary mb-3">🏭 Data Master Supplier</h3>

                <!-- Tombol Export/Import Excel Supplier -->
                <div class="d-flex gap-2 flex-wrap align-center mb-3">
                    <button onclick="exportSupplierToExcel()" class="btn btn-success">
                        📥 Export Excel
                    </button>
                    <button onclick="document.getElementById('importSupplierFile').click()" class="btn btn-primary">
                        📤 Import Excel
                    </button>
                    <input type="file" id="importSupplierFile" accept=".xlsx,.xls"
                        onchange="importSupplierFromExcel(event)" class="hidden">
                    <button onclick="downloadTemplateSupplier()" class="btn btn-secondary">
                        📋 Download Template
                    </button>
                    <button onclick="loadSampleSupplier()" class="btn btn-info">
                        🔄 Muat Sample Data
                    </button>
                    <span class="text-muted text-small">Total: <strong id="totalMasterSupplier">0</strong>
                        supplier</span>
                </div>

                <div class="card mb-4">
                    <h4 class="mb-3">➕ Tambah Supplier</h4>
                    <form id="formMasterSupplier" onsubmit="return submitMasterSupplier(event)">
                        <div class="form-grid-3">
                            <div class="form-group">
                                <label>Nama Supplier:</label>
                                <input type="text" id="masterNamaSupplier" required placeholder="Nama supplier">
                            </div>
                            <div class="form-group">
                                <label>Alamat:</label>
                                <input type="text" id="masterAlamatSupplier" placeholder="Alamat">
                            </div>
                            <div class="form-group">
                                <label>Telepon:</label>
                                <input type="text" id="masterTeleponSupplier" placeholder="No. Telepon">
                            </div>
                            <div class="form-group">
                                <label>NPWP/NIK:</label>
                                <input type="text" id="masterNpwpSupplier" placeholder="NPWP/NIK">
                            </div>
                            <div class="form-group">
                                <label>Email:</label>
                                <input type="email" id="masterEmailSupplier" placeholder="email@domain.com">
                            </div>
                            <div class="form-group">
                                <label>Keterangan:</label>
                                <input type="text" id="masterKetSupplier" placeholder="Catatan">
                            </div>
                            <div class="form-group full-width d-flex gap-2 mt-2">
                                <button type="submit" class="btn btn-primary">💾 Simpan</button>
                                <button type="reset" class="btn btn-secondary">🔄 Reset</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="search-box">
                    <div class="search-container">
                        <input type="text" id="searchMasterSupplier" placeholder="🔍 Cari supplier..."
                            oninput="searchTable('searchMasterSupplier', 'bodyMasterSupplier')">
                        <span class="search-icon">🔍</span>
                    </div>
                </div>

                <div class="table-container">
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th class="w-50px">No</th>
                                <th>Nama Supplier</th>
                                <th>Alamat</th>
                                <th>Telepon</th>
                                <th>NPWP/NIK</th>
                                <th>Email</th>
                                <th>Keterangan</th>
                                <th class="w-100px">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="bodyMasterSupplier">
                            <tr>
                                <td colspan="8" class="text-center">Belum ada data supplier</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUB-TAB: MASTER BARANG -->
            <div id="master-barang" class="sub-tab-content">
                <h3 class="text-primary mb-3">📦 Data Master Barang</h3>

                <!-- Tombol Export/Import Excel -->
                <div class="d-flex gap-2 flex-wrap align-center mb-3">
                    <button onclick="exportBarangToExcel()" class="btn btn-success">
                        📥 Export Excel
                    </button>
                    <button onclick="document.getElementById('importBarangFile').click()" class="btn btn-primary">
                        📤 Import Excel
                    </button>
                    <input type="file" id="importBarangFile" accept=".xlsx,.xls" onchange="importBarangFromExcel(event)"
                        class="hidden">
                    <button onclick="downloadTemplateBarang()" class="btn btn-secondary">
                        📋 Download Template
                    </button>
                    <button onclick="loadSampleBarang()" class="btn btn-info">
                        🔄 Muat Sample Data
                    </button>
                    <span class="text-muted text-small">Total: <strong id="totalMasterBarang">0</strong> barang</span>
                </div>

                <div class="card mb-4">
                    <h4 class="mb-3">➕ Tambah Barang</h4>
                    <form id="formMasterBarang" onsubmit="return submitMasterBarang(event)">
                        <div class="form-grid-4">
                            <div class="form-group">
                                <label>Kode:</label>
                                <input type="text" id="masterKodeBarang" placeholder="Kode">
                            </div>
                            <div class="form-group">
                                <label>Nama Barang:</label>
                                <input type="text" id="masterNamaBarang" required placeholder="Nama barang">
                            </div>
                            <div class="form-group autocomplete-wrapper">
                                <label>Kategori:</label>
                                <input type="text" id="masterKategoriBarang" placeholder="Ketik atau pilih kategori"
                                    autocomplete="off">
                                <div id="dropdownKategori" class="autocomplete-dropdown"></div>
                            </div>
                            <div class="form-group">
                                <label>Satuan:</label>
                                <input type="text" id="masterSatuanBarang" placeholder="kg, pcs, unit">
                            </div>
                            <div class="form-group">
                                <label>Harga Beli:</label>
                                <input type="text" id="masterHargaBeliBarang" placeholder="Rp 0"
                                    oninput="formatRupiahInput(this)">
                            </div>
                            <div class="form-group">
                                <label>Harga Jual:</label>
                                <input type="text" id="masterHargaJualBarang" placeholder="Rp 0"
                                    oninput="formatRupiahInput(this)">
                            </div>
                            <div class="form-group full-width">
                                <label>Keterangan:</label>
                                <input type="text" id="masterKetBarang" placeholder="Deskripsi">
                            </div>
                            <div class="form-group full-width d-flex gap-2 mt-2">
                                <button type="submit" class="btn btn-primary">💾 Simpan</button>
                                <button type="reset" class="btn btn-secondary">🔄 Reset</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="search-box">
                    <div class="search-container">
                        <input type="text" id="searchMasterBarang" placeholder="🔍 Cari barang..."
                            oninput="searchTable('searchMasterBarang', 'bodyMasterBarang')">
                        <span class="search-icon">🔍</span>
                    </div>
                </div>

                <div class="table-container">
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th class="w-50px">No</th>
                                <th>Kode</th>
                                <th>Nama Barang</th>
                                <th>Kategori</th>
                                <th>Satuan</th>
                                <th>Harga Beli</th>
                                <th>Harga Jual</th>
                                <th>Keterangan</th>
                                <th class="w-100px">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="bodyMasterBarang">
                            <tr>
                                <td colspan="9" class="center">Belum ada data barang</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUB-TAB: MASTER KATEGORI -->
            <div id="master-kategori" class="sub-tab-content">
                <h3 class="text-primary mb-3">📂 Data Master Kategori Kas</h3>

                <div class="card mb-4 max-w-md">
                    <h4 class="text-primary mb-3">📋 Daftar Kategori</h4>
                    <form id="formTambahKategori" onsubmit="return tambahKategori(event)" class="d-flex gap-2 mb-3">
                        <input type="text" id="inputKategori" required placeholder="Nama kategori baru"
                            class="form-control flex-1">
                        <button type="submit" class="btn btn-success">➕ Tambah</button>
                    </form>

                    <div class="table-container h-400-scroll">
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th class="w-50px">No</th>
                                    <th>Nama Kategori</th>
                                    <th class="w-80px">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="bodyKategori">
                                <tr>
                                    <td colspan="3" class="center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="alert alert-info max-w-md">
                    <p class="mb-1 text-primary"><strong>ℹ️ Catatan:</strong></p>
                    <ul class="text-primary mt-2 ml-4">
                        <li>Kategori yang ditambahkan akan otomatis muncul di dropdown Kas Harian</li>
                        <li>Kategori default akan dikembalikan jika semua kategori dihapus</li>
                        <li>Perubahan kategori langsung tersimpan secara otomatis</li>
                    </ul>
                </div>
            </div>

            <!-- SUB-TAB: INFO SISTEM -->
            <div id="master-info" class="sub-tab-content">
                <h3 class="text-primary mb-3">ℹ️ Informasi Sistem</h3>

                <div class="summary-cards">
                    <div class="card">
                        <h3>Total Transaksi Penjualan</h3>
                        <div class="amount" id="totalTransaksiJual">0</div>
                    </div>
                    <div class="card warning">
                        <h3>Total Transaksi Pembelian</h3>
                        <div class="amount" id="totalTransaksiBeli">0</div>
                    </div>
                    <div class="card success">
                        <h3>Total Jurnal Entry</h3>
                        <div class="amount" id="totalJurnalEntry">0</div>
                    </div>
                </div>

                <div class="grid-3-col mt-4">
                    <div>
                        <button class="btn btn-danger full-width" onclick="hapusSemuaData()">🗑️ Hapus Semua
                            Data</button>
                    </div>
                    <div>
                        <button class="btn btn-success full-width" onclick="exportData()">💾 Export Data (JSON)</button>
                    </div>
                    <div>
                        <button class="btn btn-info full-width"
                            onclick="document.getElementById('importFile').click()">📤 Import Data (JSON)</button>
                        <input type="file" id="importFile" accept=".json" class="d-none" onchange="importData(event)">
                    </div>
                </div>

                <div class="card mt-4 bg-light">
                    <h3 class="text-primary mb-2 text-small">ℹ️ Informasi Aplikasi</h3>
                    <p><strong>Nama Aplikasi:</strong> Sistem Pembukuan PT. Sumber Ganda Mekar</p>
                    <p><strong>Versi:</strong> 1.0.0</p>
                    <p><strong>Fitur:</strong></p>
                    <ul class="ml-4 mt-2">
                        <li>✅ Input Transaksi Penjualan (Tunai & Kredit)</li>
                        <li>✅ Input Transaksi Pembelian (Tunai & Kredit)</li>
                        <li>✅ Manajemen Piutang & Pembayaran</li>
                        <li>✅ Manajemen Hutang & Pembayaran</li>
                        <li>✅ Transaksi Buku Jurnal Umum</li>
                        <li>✅ Monitoring Saldo Kas Real-time</li>
                        <li>✅ Edit Semua Transaksi</li>
                        <li>✅ Jurnal Otomatis (Double Entry)</li>
                        <li>✅ Laporan Laba Rugi (termasuk Beban Operasional)</li>
                        <li>✅ Tampilan seperti Excel</li>
                        <li>✅ Export/Import Data</li>
                        <li>✅ Filter berdasarkan tanggal</li>
                        <li>✅ Auto-generate nomor faktur/transaksi</li>
                        <li>✅ Data Master Customer, Supplier, Barang</li>
                        <li>✅ Autocomplete Input Data</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit Penjualan -->
    <div id="modalEditPenjualan" class="modal">
        <div class="modal-content card">
            <span class="close" onclick="closeModal('modalEditPenjualan')">&times;</span>
            <div class="report-header text-left mb-4">
                <h2 class="text-primary">✏️ Edit Penjualan</h2>
            </div>
            <form id="formEditPenjualan">
                <input type="hidden" id="editIdJual">
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Tanggal</label>
                        <input type="text" id="editTglJual" placeholder="DD/MM/YYYY" maxlength="10"
                            pattern="\d{2}/\d{2}/\d{4}" required oninput="formatTanggalInput(this)"
                            class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Divisi</label>
                        <select id="editDivisiJual" required class="form-control">
                            <option value="Angkutan">Angkutan</option>
                            <option value="Besi">Besi</option>
                            <option value="Pakan">Pakan</option>
                            <option value="Umum">Umum</option>
                        </select>
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label>Pelanggan</label>
                    <input type="text" id="editPelanggan" required class="form-control font-bold">
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Alamat Pelanggan</label>
                        <input type="text" id="editAlamatPelanggan" placeholder="Alamat lengkap" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Telepon</label>
                        <input type="text" id="editTeleponPelanggan" placeholder="No. HP/Telepon" class="form-control">
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label>NPWP/NIK</label>
                    <input type="text" id="editNpwpPelanggan" placeholder="NPWP atau NIK"
                        class="form-control font-mono">
                </div>
                <div class="form-group mb-3">
                    <label>Barang</label>
                    <input type="text" id="editBarangJual" required class="form-control font-bold">
                </div>
                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Qty</label>
                        <input type="number" id="editQtyJual" required min="1" oninput="calculateEditTotalJual()"
                            class="form-control text-right">
                    </div>
                    <div class="form-group">
                        <label>Harga</label>
                        <input type="number" id="editHargaJual" required min="0" oninput="calculateEditTotalJual()"
                            class="form-control text-right">
                    </div>
                    <div class="form-group">
                        <label>Jenis PPN</label>
                        <select id="editJenisPpnJual" onchange="calculateEditTotalJual()" required class="form-control">
                            <option value="non">Non PPN</option>
                            <option value="ppn11">PPN 11%</option>
                            <option value="ppn1">PPN 1.1%</option>
                            <option value="dibebaskan">PPN Dibebaskan</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>DP / Uang Muka</label>
                        <input type="text" id="editDpJual"
                            oninput="formatRupiahInput(this); calculateEditSisaTagihanJual()"
                            class="form-control number" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Sisa Tagihan</label>
                        <input type="text" id="editSisaJual" readonly class="form-control number font-bold text-danger"
                            placeholder="0">
                    </div>
                </div>
                <div class="d-flex justify-between mt-4">
                    <button type="button" class="btn btn-warning"
                        onclick="closeModal('modalEditPenjualan')">Batal</button>
                    <button type="submit" class="btn btn-primary">💾 Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Edit Pembelian -->
    <div id="modalEditPembelian" class="modal">
        <div class="modal-content card">
            <span class="close" onclick="closeModal('modalEditPembelian')">&times;</span>
            <div class="report-header text-left mb-4">
                <h2 class="text-primary">✏️ Edit Pembelian</h2>
            </div>
            <form id="formEditPembelian">
                <input type="hidden" id="editIdBeli">
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Tanggal</label>
                        <input type="text" id="editTglBeli" placeholder="DD/MM/YYYY" maxlength="10"
                            pattern="\d{2}/\d{2}/\d{4}" required oninput="formatTanggalInput(this)"
                            class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Divisi</label>
                        <select id="editDivisiBeli" required class="form-control">
                            <option value="Angkutan">Angkutan</option>
                            <option value="Besi">Besi</option>
                            <option value="Pakan">Pakan</option>
                            <option value="Umum">Umum</option>
                        </select>
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label>Supplier</label>
                    <input type="text" id="editSupplier" required class="form-control font-bold">
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Alamat Supplier</label>
                        <input type="text" id="editAlamatSupplier" placeholder="Alamat lengkap" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Telepon</label>
                        <input type="text" id="editTeleponSupplier" placeholder="No. HP/Telepon" class="form-control">
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label>NPWP/NIK</label>
                    <input type="text" id="editNpwpSupplier" placeholder="NPWP atau NIK" class="form-control font-mono">
                </div>
                <div class="form-group mb-3">
                    <label>Barang</label>
                    <input type="text" id="editBarangBeli" required class="form-control font-bold">
                </div>
                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Qty</label>
                        <input type="number" id="editQtyBeli" required min="1" oninput="calculateEditTotalBeli()"
                            class="form-control text-right">
                    </div>
                    <div class="form-group">
                        <label>Harga</label>
                        <input type="number" id="editHargaBeli" required min="0" oninput="calculateEditTotalBeli()"
                            class="form-control text-right">
                    </div>
                    <div class="form-group">
                        <label>Jenis PPN</label>
                        <select id="editJenisPpnBeli" onchange="calculateEditTotalBeli()" required class="form-control">
                            <option value="non">Non PPN</option>
                            <option value="ppn11">PPN 11%</option>
                            <option value="ppn1">PPN 1.1%</option>
                            <option value="dibebaskan">PPN Dibebaskan</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>DP / Uang Muka</label>
                        <input type="text" id="editDpBeli"
                            oninput="formatRupiahInput(this); calculateEditSisaTagihanBeli()"
                            class="form-control number" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Sisa Tagihan</label>
                        <input type="text" id="editSisaBeli" readonly class="form-control number font-bold text-danger"
                            placeholder="0">
                    </div>
                </div>
                <div class="d-flex justify-between mt-4">
                    <button type="button" class="btn btn-warning"
                        onclick="closeModal('modalEditPembelian')">Batal</button>
                    <button type="submit" class="btn btn-primary">💾 Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Faktur -->
    <div id="modalFaktur" class="modal-faktur">
        <div class="modal-faktur-content">
            <div class="faktur-header-bar">
                <h2 class="m-0">📄 Preview Faktur</h2>
                <span class="close" onclick="closeModalFaktur()">&times;</span>
            </div>
            <div class="faktur-buttons">
                <button class="btn-print" onclick="printPDF()">📄 Cetak PDF (Format Bagus)</button>
                <button class="btn-dotmatrix" onclick="printDotMatrix()">🖨️ Cetak Dot Matrix (Format Text)</button>
                <button class="btn btn-secondary" onclick="closeModalFaktur()">❌ Tutup</button>
            </div>
            <div id="fakturContent" class="faktur-container">
                <!-- Faktur content will be generated here -->
            </div>
        </div>
    </div>

    <!-- Modal Edit Kas -->
    <div id="modalEditKas" class="modal">
        <div class="modal-content card">
            <span class="close" onclick="closeModal('modalEditKas')">&times;</span>
            <div class="report-header text-left mb-4">
                <h2 class="text-primary">✏️ Edit Transaksi Kas</h2>
            </div>
            <form id="formEditKas">
                <input type="hidden" id="editIdKas">
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>No. Jurnal Harian</label>
                        <input type="text" id="editNoJurnalKas" readonly
                            class="form-control bg-light text-primary font-mono">
                    </div>
                    <div class="form-group">
                        <label>No. Transaksi</label>
                        <input type="text" id="editNoTransaksiKas" readonly class="form-control bg-light font-mono">
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Tanggal</label>
                        <input type="text" id="editTglKas" placeholder="DD/MM/YYYY" maxlength="10"
                            pattern="\d{2}/\d{2}/\d{4}" required oninput="formatTanggalInput(this)"
                            class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Jenis</label>
                        <input type="text" id="editJenisKas" readonly class="form-control bg-light text-uppercase">
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label>Kategori</label>
                    <select id="editKategoriKas" required class="form-control">
                        <option value="">-- Pilih Kategori --</option>
                    </select>
                </div>
                <div class="form-group mb-3">
                    <label>Keterangan</label>
                    <input type="text" id="editKeteranganKas" required placeholder="Deskripsi transaksi"
                        class="form-control">
                </div>
                <div class="form-group mb-4">
                    <label>Jumlah (Rp)</label>
                    <input type="text" id="editJumlahKas" required placeholder="Rp 0" oninput="formatRupiahInput(this)"
                        class="form-control number">
                </div>
                <div class="d-flex justify-between">
                    <button type="button" class="btn btn-warning" onclick="closeModal('modalEditKas')">Batal</button>
                    <button type="submit" class="btn btn-primary">💾 Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Bayar Piutang -->
    <div id="modalBayarPiutang" class="modal">
        <div class="modal-content card">
            <span class="close" onclick="closeModal('modalBayarPiutang')">&times;</span>
            <div class="report-header text-left mb-4">
                <h2 class="text-primary">💰 Pembayaran Piutang</h2>
            </div>
            <form id="formBayarPiutang">
                <input type="hidden" id="bayarIdPiutang">
                <input type="hidden" id="bayarTipePiutang" value="transaksi">
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>No. Faktur</label>
                        <input type="text" id="bayarNoFakturPiutang" readonly class="form-control bg-light font-mono">
                    </div>
                    <div class="form-group">
                        <label>Pelanggan</label>
                        <input type="text" id="bayarNamaPelanggan" readonly class="form-control bg-light">
                    </div>
                </div>
                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Total Piutang</label>
                        <input type="text" id="bayarTotalPiutang" readonly
                            class="form-control bg-light text-right font-mono">
                    </div>
                    <div class="form-group">
                        <label>Sudah Dibayar</label>
                        <input type="text" id="bayarSudahBayar" readonly
                            class="form-control bg-light text-right font-mono">
                    </div>
                    <div class="form-group">
                        <label>Sisa Piutang</label>
                        <input type="text" id="bayarSisaPiutang" readonly
                            class="form-control bg-light text-right font-mono font-bold text-danger">
                    </div>
                </div>
                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Metode Pembayaran</label>
                        <select id="bayarMetodePiutang" class="form-control font-bold">
                            <option value="Tunai">Tunai</option>
                            <option value="Transfer">Transfer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Bayar</label>
                        <input type="text" id="bayarTglPiutang" placeholder="DD/MM/YYYY" maxlength="10"
                            pattern="\d{2}/\d{2}/\d{4}" required oninput="formatTanggalInput(this)"
                            class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Jumlah Bayar</label>
                        <input type="number" id="bayarJumlahPiutang" required min="0" placeholder="0"
                            class="form-control font-bold text-primary">
                    </div>
                </div>
                <div class="d-flex justify-between mt-4">
                    <button type="button" class="btn btn-warning"
                        onclick="closeModal('modalBayarPiutang')">Batal</button>
                    <button type="submit" class="btn btn-success">💰 Bayar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Bayar Hutang -->
    <div id="modalBayarHutang" class="modal">
        <div class="modal-content card">
            <span class="close" onclick="closeModal('modalBayarHutang')">&times;</span>
            <div class="report-header text-left mb-4">
                <h2 class="text-primary">💸 Pembayaran Hutang</h2>
            </div>
            <form id="formBayarHutang">
                <input type="hidden" id="bayarIdHutang">
                <input type="hidden" id="bayarTipeHutang" value="transaksi">
                <div class="form-grid-3">
                    <div class="form-group">
                        <label>No. Faktur</label>
                        <input type="text" id="bayarNoFakturHutang" readonly class="form-control bg-light font-mono">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="bayarNamaSupplier" readonly class="form-control bg-light">
                    </div>
                    <div class="form-group">
                        <label>Divisi</label>
                        <input type="text" id="bayarDivisiHutang" readonly class="form-control bg-light text-uppercase">
                    </div>
                </div>
                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Total Hutang</label>
                        <input type="text" id="bayarTotalHutang" readonly
                            class="form-control bg-light text-right font-mono">
                    </div>
                    <div class="form-group">
                        <label>Sudah Dibayar</label>
                        <input type="text" id="bayarSudahBayarHutang" readonly
                            class="form-control bg-light text-right font-mono">
                    </div>
                    <div class="form-group">
                        <label>Sisa Hutang</label>
                        <input type="text" id="bayarSisaHutang" readonly
                            class="form-control bg-light text-right font-mono font-bold text-danger">
                    </div>
                </div>
                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Metode Pembayaran</label>
                        <select id="bayarMetodeHutang" class="form-control font-bold">
                            <option value="Tunai">Tunai</option>
                            <option value="Transfer">Transfer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Bayar</label>
                        <input type="text" id="bayarTglHutang" placeholder="DD/MM/YYYY" maxlength="10"
                            pattern="\d{2}/\d{2}/\d{4}" required oninput="formatTanggalInput(this)"
                            class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Jumlah Bayar</label>
                        <input type="number" id="bayarJumlahHutang" required min="0" placeholder="0"
                            class="form-control font-bold text-primary">
                    </div>
                </div>
                <div class="d-flex justify-between mt-4">
                    <button type="button" class="btn btn-warning"
                        onclick="closeModal('modalBayarHutang')">Batal</button>
                    <button type="submit" class="btn btn-success">💰 Bayar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Edit Jurnal -->
    <!-- Datalist untuk autocomplete native browser (fallback) -->
    <datalist id="listCustomer"></datalist>
    <datalist id="listSupplier"></datalist>
    <datalist id="listBarang"></datalist>
    <datalist id="listBarangBeli"></datalist>

    <script>
        // Data Storage
        let dataPenjualan = [];
        let dataPembelian = [];
        let dataTransaksiKas = [];
        let dataPembayaranPiutang = [];
        let dataPembayaranHutang = [];
        let dataJurnal = [];
        // Database Lokal - Data Master (langsung diinisialisasi dengan data default)
        // Data Customer Default
        let dataMasterCustomer = [
            { id: 1, nama: 'Toko Berkah Jaya', alamat: 'Jl. Sudirman No. 123, Jakarta', telepon: '021-5551234', npwp: '01.234.567.8-123.000', email: 'berkah@email.com', keterangan: 'Customer tetap' },
            { id: 2, nama: 'CV. Maju Bersama', alamat: 'Jl. Ahmad Yani No. 45, Bandung', telepon: '022-4567890', npwp: '02.345.678.9-234.000', email: 'maju@email.com', keterangan: 'Pembayaran COD' },
            { id: 3, nama: 'PT. Sentosa Abadi', alamat: 'Jl. Gatot Subroto No. 78, Surabaya', telepon: '031-7890123', npwp: '03.456.789.0-345.000', email: 'sentosa@email.com', keterangan: 'Customer VIP' },
            { id: 4, nama: 'UD. Sinar Terang', alamat: 'Jl. Diponegoro No. 56, Semarang', telepon: '024-3456789', npwp: '04.567.890.1-456.000', email: 'sinar@email.com', keterangan: 'Kredit maksimal 30 hari' },
            { id: 5, nama: 'Toko Makmur', alamat: 'Jl. Pahlawan No. 90, Yogyakarta', telepon: '0274-8901234', npwp: '05.678.901.2-567.000', email: 'makmur@email.com', keterangan: 'Customer baru' },
            { id: 6, nama: 'CV. Prima Mandiri', alamat: 'Jl. Veteran No. 12, Malang', telepon: '0341-2345678', npwp: '06.789.012.3-678.000', email: 'prima@email.com', keterangan: 'Pembayaran transfer' },
            { id: 7, nama: 'PT. Jaya Abadi', alamat: 'Jl. Merdeka No. 34, Medan', telepon: '061-5678901', npwp: '07.890.123.4-789.000', email: 'jaya@email.com', keterangan: 'Customer prioritas' },
            { id: 8, nama: 'UD. Sejahtera', alamat: 'Jl. Asia Afrika No. 67, Makassar', telepon: '0411-6789012', npwp: '08.901.234.5-890.000', email: 'sejahtera@email.com', keterangan: 'Customer tetap' }
        ];

        // Data Supplier Default
        let dataMasterSupplier = [
            { id: 1, nama: 'PT. Semen Indonesia', alamat: 'Jl. Industri No. 1, Gresik', telepon: '031-9876543', npwp: '11.111.111.1-111.000', email: 'semen@email.com', keterangan: 'Supplier semen utama' },
            { id: 2, nama: 'CV. Baja Kuat', alamat: 'Jl. Baja No. 25, Jakarta', telepon: '021-8765432', npwp: '22.222.222.2-222.000', email: 'bajakuat@email.com', keterangan: 'Supplier besi beton' },
            { id: 3, nama: 'PT. Cat Warna', alamat: 'Jl. Warna No. 50, Tangerang', telepon: '021-7654321', npwp: '33.333.333.3-333.000', email: 'catwarna@email.com', keterangan: 'Supplier cat & plitur' },
            { id: 4, nama: 'UD. Pipa Jaya', alamat: 'Jl. Pipa No. 15, Bekasi', telepon: '021-6543210', npwp: '44.444.444.4-444.000', email: 'pipajaya@email.com', keterangan: 'Supplier pipa PVC' },
            { id: 5, nama: 'PT. Keramik Indah', alamat: 'Jl. Keramik No. 30, Cikampek', telepon: '0264-5432109', npwp: '55.555.555.5-555.000', email: 'keramik@email.com', keterangan: 'Supplier keramik & granit' },
            { id: 6, nama: 'CV. Pakan Sejahtera', alamat: 'Jl. Peternakan No. 88, Blitar', telepon: '0342-4321098', npwp: '66.666.666.6-666.000', email: 'pakan@email.com', keterangan: 'Supplier pakan ternak' },
            { id: 7, nama: 'PT. Kayu Makmur', alamat: 'Jl. Kehutanan No. 77, Kalimantan', telepon: '0511-3210987', npwp: '77.777.777.7-777.000', email: 'kayu@email.com', keterangan: 'Supplier kayu & triplek' },
            { id: 8, nama: 'UD. Pasir Jaya', alamat: 'Jl. Quarry No. 99, Bogor', telepon: '0251-2109876', npwp: '88.888.888.8-888.000', email: 'pasir@email.com', keterangan: 'Supplier pasir & batu' }
        ];

        // Data Barang Default
        let dataMasterBarang = [
            { id: 1, kode: 'SMN-001', nama: 'Semen Gresik 50kg', kategori: 'Bahan Bangunan', satuan: 'Sak', hargaBeli: 52000, hargaJual: 58000, keterangan: 'Semen portland' },
            { id: 2, kode: 'SMN-002', nama: 'Semen Tiga Roda 50kg', kategori: 'Bahan Bangunan', satuan: 'Sak', hargaBeli: 54000, hargaJual: 60000, keterangan: 'Semen portland' },
            { id: 3, kode: 'BSI-001', nama: 'Besi Beton 10mm', kategori: 'Besi', satuan: 'Batang', hargaBeli: 85000, hargaJual: 95000, keterangan: 'Besi beton polos' },
            { id: 4, kode: 'BSI-002', nama: 'Besi Beton 12mm', kategori: 'Besi', satuan: 'Batang', hargaBeli: 120000, hargaJual: 135000, keterangan: 'Besi beton polos' },
            { id: 5, kode: 'BSI-003', nama: 'Besi Beton 8mm', kategori: 'Besi', satuan: 'Batang', hargaBeli: 55000, hargaJual: 65000, keterangan: 'Besi beton polos' },
            { id: 6, kode: 'PSR-001', nama: 'Pasir Cor', kategori: 'Bahan Bangunan', satuan: 'Kubik', hargaBeli: 250000, hargaJual: 300000, keterangan: 'Pasir silika' },
            { id: 7, kode: 'BTU-001', nama: 'Batu Split', kategori: 'Bahan Bangunan', satuan: 'Kubik', hargaBeli: 280000, hargaJual: 350000, keterangan: 'Batu pecah 2-3cm' },
            { id: 8, kode: 'BTA-001', nama: 'Bata Merah', kategori: 'Bahan Bangunan', satuan: 'Buah', hargaBeli: 800, hargaJual: 1000, keterangan: 'Bata press' },
            { id: 9, kode: 'BTK-001', nama: 'Batako', kategori: 'Bahan Bangunan', satuan: 'Buah', hargaBeli: 3500, hargaJual: 4500, keterangan: 'Batako pres' },
            { id: 10, kode: 'KRM-001', nama: 'Keramik 40x40', kategori: 'Bahan Bangunan', satuan: 'Dus', hargaBeli: 55000, hargaJual: 68000, keterangan: 'Keramik lantai' },
            { id: 11, kode: 'KRM-002', nama: 'Keramik 60x60', kategori: 'Bahan Bangunan', satuan: 'Dus', hargaBeli: 85000, hargaJual: 105000, keterangan: 'Keramik granit' },
            { id: 12, kode: 'CAT-001', nama: 'Cat Tembok 5kg', kategori: 'Bahan Bangunan', satuan: 'Kaleng', hargaBeli: 75000, hargaJual: 95000, keterangan: 'Cat interior' },
            { id: 13, kode: 'PPA-001', nama: 'Pipa PVC 4"', kategori: 'Bahan Bangunan', satuan: 'Batang', hargaBeli: 45000, hargaJual: 58000, keterangan: 'Pipa AW' },
            { id: 14, kode: 'TRP-001', nama: 'Triplek 9mm', kategori: 'Bahan Bangunan', satuan: 'Lembar', hargaBeli: 125000, hargaJual: 150000, keterangan: 'Triplek meranti' },
            { id: 15, kode: 'PKN-001', nama: 'Pakan Ayam Layer', kategori: 'Pakan Ternak', satuan: 'Karung', hargaBeli: 320000, hargaJual: 360000, keterangan: 'Pakan petelur 50kg' },
            { id: 16, kode: 'PKN-002', nama: 'Pakan Ayam Broiler', kategori: 'Pakan Ternak', satuan: 'Karung', hargaBeli: 340000, hargaJual: 380000, keterangan: 'Pakan pedaging 50kg' },
            { id: 17, kode: 'PKN-003', nama: 'Dedak Padi', kategori: 'Pakan Ternak', satuan: 'Karung', hargaBeli: 85000, hargaJual: 100000, keterangan: 'Dedak halus 50kg' },
            { id: 18, kode: 'JSA-001', nama: 'Jasa Angkutan Truck', kategori: 'Jasa Angkutan', satuan: 'Trip', hargaBeli: 0, hargaJual: 350000, keterangan: 'Truck engkel' },
            { id: 19, kode: 'JSA-002', nama: 'Jasa Angkutan Pickup', kategori: 'Jasa Angkutan', satuan: 'Trip', hargaBeli: 0, hargaJual: 150000, keterangan: 'Pickup standar' },
            { id: 20, kode: 'SNG-001', nama: 'Seng Gelombang', kategori: 'Bahan Bangunan', satuan: 'Lembar', hargaBeli: 65000, hargaJual: 80000, keterangan: 'Seng BJLS 0.25mm' }
        ];

        let dataPiutangAwal = [];  // Data piutang awal/saldo awal
        let dataHutangAwal = [];   // Data hutang awal/saldo awal
        let dataKasHarian = [];    // Data kas harian
        let kategoriKas = ['Penjualan', 'Pembelian', 'Pelunasan Piutang', 'Bayar Hutang', 'Beban Gaji', 'Beban Sewa', 'Beban Listrik', 'Beban Operasional', 'Beban Telepon', 'Beban Transport', 'Beban Konsumsi', 'Pendapatan Lain', 'Beban Lain', 'Prive', 'Lainnya'];
        let kategoriKasDefault = ['Penjualan', 'Pembelian', 'Pelunasan Piutang', 'Bayar Hutang', 'Beban Gaji', 'Beban Sewa', 'Beban Listrik', 'Beban Operasional', 'Beban Telepon', 'Beban Transport', 'Beban Konsumsi', 'Pendapatan Lain', 'Beban Lain', 'Prive', 'Lainnya'];
        let batchKasMasuk = [];
        let batchKasKeluar = [];

        // Penambahan variabel global yang sebelumnya tidak terdeklarasi secara eksplisit
        let kategoriKasMasuk = ['Penjualan', 'Pelunasan Piutang', 'Pendapatan Harian', 'Pendapatan Lain', 'Lainnya'];
        let kategoriKasKeluar = ['Pembelian', 'Bayar Hutang', 'Beban Gaji', 'Beban Operasional', 'Beban Listrik', 'Beban Telepon', 'Beban Transport', 'Beban Konsumsi', 'Beban Lain', 'Lainnya'];

        // Variabel untuk cetak faktur
        var currentFakturMode = 'pdf';
        var currentFakturData = null;

        // Backup Sample Data untuk reset
        const sampleMasterCustomer = [
            { id: 1, nama: 'Toko Berkah Jaya', alamat: 'Jl. Sudirman No. 123, Jakarta', telepon: '021-5551234', npwp: '01.234.567.8-123.000', email: 'berkah@email.com', keterangan: 'Customer tetap' },
            { id: 2, nama: 'CV. Maju Bersama', alamat: 'Jl. Ahmad Yani No. 45, Bandung', telepon: '022-4567890', npwp: '02.345.678.9-234.000', email: 'maju@email.com', keterangan: 'Pembayaran COD' },
            { id: 3, nama: 'PT. Sentosa Abadi', alamat: 'Jl. Gatot Subroto No. 78, Surabaya', telepon: '031-7890123', npwp: '03.456.789.0-345.000', email: 'sentosa@email.com', keterangan: 'Customer VIP' },
            { id: 4, nama: 'UD. Sinar Terang', alamat: 'Jl. Diponegoro No. 56, Semarang', telepon: '024-3456789', npwp: '04.567.890.1-456.000', email: 'sinar@email.com', keterangan: 'Kredit maksimal 30 hari' },
            { id: 5, nama: 'Toko Makmur', alamat: 'Jl. Pahlawan No. 90, Yogyakarta', telepon: '0274-8901234', npwp: '05.678.901.2-567.000', email: 'makmur@email.com', keterangan: 'Customer baru' },
            { id: 6, nama: 'CV. Prima Mandiri', alamat: 'Jl. Veteran No. 12, Malang', telepon: '0341-2345678', npwp: '06.789.012.3-678.000', email: 'prima@email.com', keterangan: 'Pembayaran transfer' },
            { id: 7, nama: 'PT. Jaya Abadi', alamat: 'Jl. Merdeka No. 34, Medan', telepon: '061-5678901', npwp: '07.890.123.4-789.000', email: 'jaya@email.com', keterangan: 'Customer prioritas' },
            { id: 8, nama: 'UD. Sejahtera', alamat: 'Jl. Asia Afrika No. 67, Makassar', telepon: '0411-6789012', npwp: '08.901.234.5-890.000', email: 'sejahtera@email.com', keterangan: 'Customer tetap' }
        ];

        const sampleMasterSupplier = [
            { id: 1, nama: 'PT. Semen Indonesia', alamat: 'Jl. Industri No. 1, Gresik', telepon: '031-9876543', npwp: '11.111.111.1-111.000', email: 'semen@email.com', keterangan: 'Supplier semen utama' },
            { id: 2, nama: 'CV. Baja Kuat', alamat: 'Jl. Baja No. 25, Jakarta', telepon: '021-8765432', npwp: '22.222.222.2-222.000', email: 'bajakuat@email.com', keterangan: 'Supplier besi beton' },
            { id: 3, nama: 'PT. Cat Warna', alamat: 'Jl. Warna No. 50, Tangerang', telepon: '021-7654321', npwp: '33.333.333.3-333.000', email: 'catwarna@email.com', keterangan: 'Supplier cat & plitur' },
            { id: 4, nama: 'UD. Pipa Jaya', alamat: 'Jl. Pipa No. 15, Bekasi', telepon: '021-6543210', npwp: '44.444.444.4-444.000', email: 'pipajaya@email.com', keterangan: 'Supplier pipa PVC' },
            { id: 5, nama: 'PT. Keramik Indah', alamat: 'Jl. Keramik No. 30, Cikampek', telepon: '0264-5432109', npwp: '55.555.555.5-555.000', email: 'keramik@email.com', keterangan: 'Supplier keramik & granit' },
            { id: 6, nama: 'CV. Pakan Sejahtera', alamat: 'Jl. Peternakan No. 88, Blitar', telepon: '0342-4321098', npwp: '66.666.666.6-666.000', email: 'pakan@email.com', keterangan: 'Supplier pakan ternak' },
            { id: 7, nama: 'PT. Kayu Makmur', alamat: 'Jl. Kehutanan No. 77, Kalimantan', telepon: '0511-3210987', npwp: '77.777.777.7-777.000', email: 'kayu@email.com', keterangan: 'Supplier kayu & triplek' },
            { id: 8, nama: 'UD. Pasir Jaya', alamat: 'Jl. Quarry No. 99, Bogor', telepon: '0251-2109876', npwp: '88.888.888.8-888.000', email: 'pasir@email.com', keterangan: 'Supplier pasir & batu' }
        ];

        const sampleMasterBarang = [
            { id: 1, kode: 'SMN-001', nama: 'Semen Gresik 50kg', kategori: 'Bahan Bangunan', satuan: 'Sak', hargaBeli: 52000, hargaJual: 58000, keterangan: 'Semen portland' },
            { id: 2, kode: 'SMN-002', nama: 'Semen Tiga Roda 50kg', kategori: 'Bahan Bangunan', satuan: 'Sak', hargaBeli: 54000, hargaJual: 60000, keterangan: 'Semen portland' },
            { id: 3, kode: 'BSI-001', nama: 'Besi Beton 10mm', kategori: 'Besi', satuan: 'Batang', hargaBeli: 85000, hargaJual: 95000, keterangan: 'Besi beton polos' },
            { id: 4, kode: 'BSI-002', nama: 'Besi Beton 12mm', kategori: 'Besi', satuan: 'Batang', hargaBeli: 120000, hargaJual: 135000, keterangan: 'Besi beton polos' },
            { id: 5, kode: 'BSI-003', nama: 'Besi Beton 8mm', kategori: 'Besi', satuan: 'Batang', hargaBeli: 55000, hargaJual: 65000, keterangan: 'Besi beton polos' },
            { id: 6, kode: 'PSR-001', nama: 'Pasir Cor', kategori: 'Bahan Bangunan', satuan: 'Kubik', hargaBeli: 250000, hargaJual: 300000, keterangan: 'Pasir silika' },
            { id: 7, kode: 'BTU-001', nama: 'Batu Split', kategori: 'Bahan Bangunan', satuan: 'Kubik', hargaBeli: 280000, hargaJual: 350000, keterangan: 'Batu pecah 2-3cm' },
            { id: 8, kode: 'BTA-001', nama: 'Bata Merah', kategori: 'Bahan Bangunan', satuan: 'Buah', hargaBeli: 800, hargaJual: 1000, keterangan: 'Bata press' },
            { id: 9, kode: 'BTK-001', nama: 'Batako', kategori: 'Bahan Bangunan', satuan: 'Buah', hargaBeli: 3500, hargaJual: 4500, keterangan: 'Batako pres' },
            { id: 10, kode: 'KRM-001', nama: 'Keramik 40x40', kategori: 'Bahan Bangunan', satuan: 'Dus', hargaBeli: 55000, hargaJual: 68000, keterangan: 'Keramik lantai' },
            { id: 11, kode: 'KRM-002', nama: 'Keramik 60x60', kategori: 'Bahan Bangunan', satuan: 'Dus', hargaBeli: 85000, hargaJual: 105000, keterangan: 'Keramik granit' },
            { id: 12, kode: 'CAT-001', nama: 'Cat Tembok 5kg', kategori: 'Bahan Bangunan', satuan: 'Kaleng', hargaBeli: 75000, hargaJual: 95000, keterangan: 'Cat interior' },
            { id: 13, kode: 'PPA-001', nama: 'Pipa PVC 4"', kategori: 'Bahan Bangunan', satuan: 'Batang', hargaBeli: 45000, hargaJual: 58000, keterangan: 'Pipa AW' },
            { id: 14, kode: 'TRP-001', nama: 'Triplek 9mm', kategori: 'Bahan Bangunan', satuan: 'Lembar', hargaBeli: 125000, hargaJual: 150000, keterangan: 'Triplek meranti' },
            { id: 15, kode: 'PKN-001', nama: 'Pakan Ayam Layer', kategori: 'Pakan Ternak', satuan: 'Karung', hargaBeli: 320000, hargaJual: 360000, keterangan: 'Pakan petelur 50kg' },
            { id: 16, kode: 'PKN-002', nama: 'Pakan Ayam Broiler', kategori: 'Pakan Ternak', satuan: 'Karung', hargaBeli: 340000, hargaJual: 380000, keterangan: 'Pakan pedaging 50kg' },
            { id: 17, kode: 'PKN-003', nama: 'Dedak Padi', kategori: 'Pakan Ternak', satuan: 'Karung', hargaBeli: 85000, hargaJual: 100000, keterangan: 'Dedak halus 50kg' },
            { id: 18, kode: 'JSA-001', nama: 'Jasa Angkutan Truck', kategori: 'Jasa Angkutan', satuan: 'Trip', hargaBeli: 0, hargaJual: 350000, keterangan: 'Truck engkel' },
            { id: 19, kode: 'JSA-002', nama: 'Jasa Angkutan Pickup', kategori: 'Jasa Angkutan', satuan: 'Trip', hargaBeli: 0, hargaJual: 150000, keterangan: 'Pickup standar' },
            { id: 20, kode: 'SNG-001', nama: 'Seng Gelombang', kategori: 'Bahan Bangunan', satuan: 'Lembar', hargaBeli: 65000, hargaJual: 80000, keterangan: 'Seng BJLS 0.25mm' }
        ];

        // Load data dari localStorage & Supabase saat halaman dimuat
        window.onload = async function () {
            // Setup Login Listener
            document.getElementById('login-form').addEventListener('submit', handleAuth);

            // Wait until supabaseClient is initialized
            while (typeof supabaseClient === 'undefined' || !supabaseClient) {
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            // Check existing session
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('user-display').textContent = session.user.email;

                loadDataFromStorage(); // Load cepat dari lokal dulu
                await loadFromSupabase(); // Sinkronkan dari Cloud
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }

            setDefaultDates();
            generateNoFaktur();
            updateAllDisplays();
            populateDataLists(); // Populate autocomplete lists
            displayMasterCustomer();
            displayMasterSupplier();
            displayMasterBarang();
            displayKategori();  // Display kategori kas

            updateKategoriDropdowns(); // Aktifkan untuk populate dropdown kategori kas
            displayBatchKasMasuk();
            displayBatchKasKeluar();

            // Initialize date filters for Penjualan and Pembelian
            setDefaultDatesPenjualan();
            setDefaultDatesPembelian();

            // Setup event listeners setelah DOM selesai render dan data sudah dimuat
            setTimeout(function () {
                setupKategoriEventListeners();
                setupDataMasterEventListeners();

                // Reset flag dan setup ulang autocomplete
                autocompleteInitialized = {};

                // Force refresh cache sebelum setup autocomplete
                invalidateDropdownCache();
                preloadDropdownData();

                setupAllAutocomplete();
                setupKategoriKasHarianAutocomplete(); // Setup autocomplete kategori kas harian

                // Log untuk debugging
                console.log('Data Master dimuat:', {
                    customer: dataMasterCustomer.length,
                    supplier: dataMasterSupplier.length,
                    barang: dataMasterBarang.length
                });
                console.log('Dropdown cache:', {
                    customers: dropdownCache.customers?.length || 0,
                    suppliers: dropdownCache.suppliers?.length || 0,
                    barangJual: dropdownCache.barangJual?.length || 0
                });
            }, 300);
        };

        // Track autocomplete yang sudah di-setup
        let autocompleteInitialized = {};

        // Cache untuk data dropdown (untuk mempercepat akses)
        let dropdownCache = {
            customers: null,
            suppliers: null,
            barangJual: null,
            barangBeli: null,
            lastUpdate: 0
        };

        // Fungsi untuk invalidate cache (panggil setelah data berubah)
        function invalidateDropdownCache() {
            dropdownCache.customers = null;
            dropdownCache.suppliers = null;
            dropdownCache.barangJual = null;
            dropdownCache.barangBeli = null;
            dropdownCache.lastUpdate = Date.now();
            // Preload ulang data setelah invalidate
            preloadDropdownData();
        }

        // Fungsi debounce untuk input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Pre-load data untuk dropdown saat halaman dimuat
        function preloadDropdownData() {
            // Customer
            if (!dropdownCache.customers) {
                const customersFromMaster = dataMasterCustomer.map(c => ({
                    nama: c.nama,
                    alamat: c.alamat || '',
                    telepon: c.telepon || '',
                    npwp: c.npwp || ''
                })).filter(c => c.nama && c.nama.trim());

                const customersFromTrans = dataPenjualan.map(p => ({
                    nama: p.namaPelanggan,
                    alamat: p.alamatPelanggan || '',
                    telepon: p.teleponPelanggan || '',
                    npwp: p.npwpPelanggan || ''
                })).filter(c => c.nama && c.nama.trim());

                const allCustomers = [...customersFromMaster];
                customersFromTrans.forEach(ct => {
                    if (ct.nama && !allCustomers.find(c => c.nama.toLowerCase() === ct.nama.toLowerCase())) {
                        allCustomers.push(ct);
                    }
                });
                dropdownCache.customers = allCustomers.sort((a, b) => a.nama.localeCompare(b.nama));
            }

            // Supplier
            if (!dropdownCache.suppliers) {
                const suppliersFromMaster = dataMasterSupplier.map(s => ({
                    nama: s.nama,
                    alamat: s.alamat || '',
                    telepon: s.telepon || '',
                    npwp: s.npwp || ''
                })).filter(s => s.nama && s.nama.trim());

                const suppliersFromTrans = dataPembelian.map(p => ({
                    nama: p.namaSupplier,
                    alamat: p.alamatSupplier || '',
                    telepon: p.teleponSupplier || '',
                    npwp: p.npwpSupplier || ''
                })).filter(s => s.nama && s.nama.trim());

                const allSuppliers = [...suppliersFromMaster];
                suppliersFromTrans.forEach(st => {
                    if (st.nama && !allSuppliers.find(s => s.nama.toLowerCase() === st.nama.toLowerCase())) {
                        allSuppliers.push(st);
                    }
                });
                dropdownCache.suppliers = allSuppliers.sort((a, b) => a.nama.localeCompare(b.nama));
            }

            // Barang
            if (!dropdownCache.barangJual || !dropdownCache.barangBeli) {
                const barangFromMaster = dataMasterBarang.map(b => ({
                    nama: b.nama,
                    kode: b.kode || '',
                    hargaJual: b.hargaJual || 0,
                    hargaBeli: b.hargaBeli || 0,
                    satuan: b.satuan || ''
                })).filter(b => b.nama && b.nama.trim());

                const sortedBarang = barangFromMaster.sort((a, b) => a.nama.localeCompare(b.nama));

                dropdownCache.barangJual = sortedBarang.map(b => ({
                    nama: b.nama,
                    kode: b.kode,
                    harga: b.hargaJual,
                    satuan: b.satuan
                }));

                dropdownCache.barangBeli = sortedBarang.map(b => ({
                    nama: b.nama,
                    kode: b.kode,
                    harga: b.hargaBeli,
                    satuan: b.satuan
                }));
            }

            console.log('Dropdown cache preloaded:', {
                customers: dropdownCache.customers?.length || 0,
                suppliers: dropdownCache.suppliers?.length || 0,
                barang: dropdownCache.barangJual?.length || 0
            });
        }

        // Fungsi test untuk debugging autocomplete
        function testAutocomplete() {
            console.log('=== TEST AUTOCOMPLETE ===');
            console.log('Data Master Customer:', dataMasterCustomer.length);
            console.log('Data Master Supplier:', dataMasterSupplier.length);
            console.log('Data Master Barang:', dataMasterBarang.length);
            console.log('Dropdown Cache:', dropdownCache);
            console.log('Autocomplete Initialized:', autocompleteInitialized);

            // Force show dropdown pelanggan
            const dropdown = document.getElementById('dropdownPelanggan');
            if (dropdown) {
                // Populate dengan data test
                dropdown.innerHTML = '';
                const info = document.createElement('div');
                info.className = 'autocomplete-info';
                info.textContent = 'Test: Menampilkan ' + (dropdownCache.customers?.length || 0) + ' pelanggan';
                dropdown.appendChild(info);

                const customers = dropdownCache.customers || dataMasterCustomer;
                customers.slice(0, 5).forEach((c, i) => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.innerHTML = '<span>' + (c.nama || 'N/A') + '</span>';
                    div.onclick = function () {
                        document.getElementById('namaPelanggan').value = c.nama;
                        dropdown.classList.remove('show');
                    };
                    dropdown.appendChild(div);
                });

                dropdown.classList.add('show');
                console.log('Dropdown should now be visible');
                alert('Dropdown ditampilkan! Lihat di bawah field Nama Pelanggan.\n\nData: ' + (customers.length) + ' pelanggan');
            } else {
                alert('ERROR: Element dropdownPelanggan tidak ditemukan!');
            }
        }

        // Setup semua custom autocomplete
        function setupAllAutocomplete() {
            console.log('Setting up autocomplete...');
            console.log('Data tersedia - Customer:', dataMasterCustomer.length, 'Supplier:', dataMasterSupplier.length, 'Barang:', dataMasterBarang.length);

            // Preload data terlebih dahulu
            preloadDropdownData();

            // Verifikasi elemen ada
            console.log('Element check - namaPelanggan:', !!document.getElementById('namaPelanggan'));
            console.log('Element check - namaSupplier:', !!document.getElementById('namaSupplier'));
            console.log('Element check - namaBarangJual:', !!document.getElementById('namaBarangJual'));
            console.log('Element check - namaBarangBeli:', !!document.getElementById('namaBarangBeli'));

            // Setup untuk Barang (Penjualan & Pembelian)
            setupBarangAutocomplete('namaBarangJual', 'dropdownBarangJual', 'jual');
            setupBarangAutocomplete('namaBarangBeli', 'dropdownBarangBeli', 'beli');

            // Setup untuk Pelanggan
            setupPelangganAutocomplete('namaPelanggan', 'dropdownPelanggan');

            // Setup untuk Supplier
            setupSupplierAutocomplete('namaSupplier', 'dropdownSupplier');

            // Setup untuk Kategori Barang
            setupKategoriAutocomplete('masterKategoriBarang', 'dropdownKategori');

            // Setup untuk Kategori Kas Masuk dan Keluar
            setupKategoriKasAutocomplete('inputKategoriKasMasuk', 'dropdownKategoriKasMasuk', 'masuk');
            setupKategoriKasAutocomplete('inputKategoriKasKeluar', 'dropdownKategoriKasKeluar', 'keluar');

            console.log('Autocomplete setup selesai');
            console.log('Autocomplete initialized flags:', autocompleteInitialized);
        }

        // Autocomplete untuk Kategori Kas Masuk/Keluar
        function setupKategoriKasAutocomplete(inputId, dropdownId, jenis) {
            if (autocompleteInitialized[inputId]) return;
            autocompleteInitialized[inputId] = true;

            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (!input || !dropdown) return;

            let currentFocus = -1;

            function getKategoriData() {
                // Gunakan kategoriKas yang sudah unified
                return kategoriKas || [];
            }

            function showDropdown(items, searchText) {
                dropdown.innerHTML = '';
                currentFocus = -1;

                if (items.length === 0 && searchText) {
                    dropdown.innerHTML = `
                        <div class="autocomplete-item autocomplete-success">
                            <span>➕ Tambah kategori baru: "<strong>${searchText}</strong>"</span>
                        </div>
                    `;
                    dropdown.querySelector('.autocomplete-item').addEventListener('click', function () {
                        input.value = searchText;
                        dropdown.classList.remove('show');
                    });
                    dropdown.classList.add('show');
                    return;
                }

                const info = document.createElement('div');
                info.className = 'autocomplete-info';
                info.textContent = searchText
                    ? `Ditemukan ${items.length} kategori`
                    : `Pilih kategori ${jenis === 'masuk' ? 'kas masuk' : 'kas keluar'}`;
                dropdown.appendChild(info);

                items.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';

                    let displayName = item;
                    if (searchText) {
                        const regex = new RegExp(`(${searchText})`, 'gi');
                        displayName = item.replace(regex, '<strong>$1</strong>');
                    }

                    div.innerHTML = `<span>${displayName}</span>`;
                    div.addEventListener('click', function () {
                        input.value = item;
                        dropdown.classList.remove('show');
                    });
                    dropdown.appendChild(div);
                });

                if (searchText && !items.find(i => i.toLowerCase() === searchText.toLowerCase())) {
                    const addNew = document.createElement('div');
                    addNew.className = 'autocomplete-item autocomplete-success';
                    addNew.innerHTML = `<span>➕ Gunakan: "<strong>${searchText}</strong>"</span>`;
                    addNew.addEventListener('click', function () {
                        input.value = searchText;
                        dropdown.classList.remove('show');
                    });
                    dropdown.appendChild(addNew);
                }

                dropdown.classList.add('show');
            }

            const handleSearch = debounce(function (searchText) {
                const allKategori = getKategoriData();
                if (searchText === '') {
                    showDropdown(allKategori, '');
                } else {
                    const filtered = allKategori.filter(k => k.toLowerCase().includes(searchText.toLowerCase()));
                    showDropdown(filtered, searchText);
                }
            }, 50);

            input.addEventListener('input', function () {
                handleSearch(this.value.trim());
            });

            input.addEventListener('focus', function () {
                const searchText = this.value.trim();
                const allKategori = getKategoriData();
                if (searchText === '') {
                    showDropdown(allKategori, '');
                } else {
                    const filtered = allKategori.filter(k => k.toLowerCase().includes(searchText.toLowerCase()));
                    showDropdown(filtered, searchText);
                }
            });

            input.addEventListener('blur', function () {
                setTimeout(() => dropdown.classList.remove('show'), 200);
            });

            input.addEventListener('keydown', function (e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    items.forEach((item, i) => item.classList.toggle('active', i === currentFocus));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    items.forEach((item, i) => item.classList.toggle('active', i === currentFocus));
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Autocomplete untuk Kategori Barang
        function setupKategoriAutocomplete(inputId, dropdownId) {
            if (autocompleteInitialized[inputId]) return;
            autocompleteInitialized[inputId] = true;

            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (!input || !dropdown) return;

            let currentFocus = -1;

            // Kategori default + kategori dari data yang sudah ada
            function getKategoriData() {
                const defaultKategori = ['Bahan Bangunan', 'Besi', 'Pakan Ternak', 'Jasa Angkutan', 'Lainnya'];
                const kategoriFromData = dataMasterBarang
                    .map(b => b.kategori)
                    .filter(k => k && k.trim());

                // Gabungkan dan hapus duplikat
                const allKategori = [...new Set([...defaultKategori, ...kategoriFromData])];
                return allKategori.sort();
            }

            function showDropdown(items, searchText) {
                dropdown.innerHTML = '';
                currentFocus = -1;

                if (items.length === 0 && searchText) {
                    // Tampilkan opsi untuk membuat kategori baru
                    dropdown.innerHTML = `
                        <div class="autocomplete-item autocomplete-success">
                            <span>➕ Tambah kategori baru: "<strong>${searchText}</strong>"</span>
                        </div>
                    `;
                    dropdown.querySelector('.autocomplete-item').addEventListener('click', function () {
                        input.value = searchText;
                        dropdown.classList.remove('show');
                    });
                    dropdown.classList.add('show');
                    return;
                }

                // Info
                const info = document.createElement('div');
                info.className = 'autocomplete-info';
                info.textContent = searchText
                    ? `Ditemukan ${items.length} kategori`
                    : `Pilih kategori atau ketik untuk membuat baru`;
                dropdown.appendChild(info);

                items.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';

                    let displayName = item;
                    if (searchText) {
                        const regex = new RegExp(`(${searchText})`, 'gi');
                        displayName = item.replace(regex, '<strong>$1</strong>');
                    }

                    div.innerHTML = `<span>${displayName}</span>`;
                    div.addEventListener('click', function () {
                        input.value = item;
                        dropdown.classList.remove('show');
                    });
                    dropdown.appendChild(div);
                });

                // Tambahkan opsi untuk kategori baru jika pencarian tidak cocok persis
                if (searchText && !items.find(i => i.toLowerCase() === searchText.toLowerCase())) {
                    const addNew = document.createElement('div');
                    addNew.className = 'autocomplete-item autocomplete-success';
                    addNew.innerHTML = `<span>➕ Tambah: "<strong>${searchText}</strong>"</span>`;
                    addNew.addEventListener('click', function () {
                        input.value = searchText;
                        dropdown.classList.remove('show');
                    });
                    dropdown.appendChild(addNew);
                }

                dropdown.classList.add('show');
            }

            // Debounced search
            const handleSearch = debounce(function (searchText) {
                const allKategori = getKategoriData();
                if (searchText === '') {
                    showDropdown(allKategori, '');
                } else {
                    const filtered = allKategori.filter(k => k.toLowerCase().includes(searchText.toLowerCase()));
                    showDropdown(filtered, searchText);
                }
            }, 50);

            input.addEventListener('input', function () {
                handleSearch(this.value.trim());
            });

            input.addEventListener('focus', function () {
                const searchText = this.value.trim();
                const allKategori = getKategoriData();
                if (searchText === '') {
                    showDropdown(allKategori, '');
                } else {
                    const filtered = allKategori.filter(k => k.toLowerCase().includes(searchText.toLowerCase()));
                    showDropdown(filtered, searchText);
                }
            });

            input.addEventListener('blur', function () {
                setTimeout(() => dropdown.classList.remove('show'), 200);
            });

            input.addEventListener('keydown', function (e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    items.forEach((item, i) => item.classList.toggle('active', i === currentFocus));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    items.forEach((item, i) => item.classList.toggle('active', i === currentFocus));
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Autocomplete untuk Pelanggan
        function setupPelangganAutocomplete(inputId, dropdownId) {
            // Cegah multiple setup
            if (autocompleteInitialized[inputId]) {
                console.log('Pelanggan autocomplete sudah di-setup:', inputId);
                return;
            }
            autocompleteInitialized[inputId] = true;

            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (!input || !dropdown) {
                console.log('Element tidak ditemukan untuk pelanggan:', inputId, dropdownId);
                return;
            }

            console.log('Setup pelanggan autocomplete:', inputId);

            let currentFocus = -1;

            // Gunakan cache untuk data customer - selalu ambil dari dropdownCache langsung
            function getCustomerData() {
                // Force refresh jika cache null
                if (!dropdownCache.customers || dropdownCache.customers.length === 0) {
                    console.log('Cache customer kosong, refreshing...');
                    // Langsung buat dari data master
                    const customersFromMaster = dataMasterCustomer.map(c => ({
                        nama: c.nama,
                        alamat: c.alamat || '',
                        telepon: c.telepon || '',
                        npwp: c.npwp || ''
                    })).filter(c => c.nama && c.nama.trim());

                    const customersFromTrans = dataPenjualan.map(p => ({
                        nama: p.namaPelanggan,
                        alamat: p.alamatPelanggan || '',
                        telepon: p.teleponPelanggan || '',
                        npwp: p.npwpPelanggan || ''
                    })).filter(c => c.nama && c.nama.trim());

                    const allCustomers = [...customersFromMaster];
                    customersFromTrans.forEach(ct => {
                        if (ct.nama && !allCustomers.find(c => c.nama.toLowerCase() === ct.nama.toLowerCase())) {
                            allCustomers.push(ct);
                        }
                    });
                    dropdownCache.customers = allCustomers.sort((a, b) => a.nama.localeCompare(b.nama));
                }
                console.log('getCustomerData returning', dropdownCache.customers.length, 'items');
                return dropdownCache.customers || [];
            }

            function showDropdown(items, searchText) {
                console.log('showDropdown pelanggan called with', items.length, 'items');
                dropdown.innerHTML = '';
                currentFocus = -1;

                if (items.length === 0) {
                    dropdown.innerHTML = '<div class="autocomplete-no-result">Tidak ada pelanggan ditemukan. Silakan tambahkan di Data Master.</div>';
                    dropdown.classList.add('show');
                    return;
                }

                // Info jumlah hasil
                const info = document.createElement('div');
                info.className = 'autocomplete-info';
                info.textContent = searchText
                    ? `Ditemukan ${items.length} pelanggan untuk "${searchText}"`
                    : `Menampilkan ${items.length} pelanggan (klik untuk pilih)`;
                dropdown.appendChild(info);

                items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';

                    let displayName = item.nama;
                    if (searchText) {
                        const regex = new RegExp(`(${searchText})`, 'gi');
                        displayName = item.nama.replace(regex, '<strong>$1</strong>');
                    }

                    div.innerHTML = `<span>${displayName}</span>`;
                    if (item.telepon) {
                        div.innerHTML += `<span class="item-code">${item.telepon}</span>`;
                    }

                    div.addEventListener('click', function () {
                        input.value = item.nama;
                        dropdown.classList.remove('show');

                        // Auto-fill alamat, telepon, npwp
                        document.getElementById('alamatPelanggan').value = item.alamat || '';
                        document.getElementById('teleponPelanggan').value = item.telepon || '';
                        document.getElementById('npwpPelanggan').value = item.npwp || '';
                    });

                    dropdown.appendChild(div);
                });

                dropdown.classList.add('show');
            }

            // Fungsi pencarian dengan debounce untuk input yang cepat
            const handleSearch = debounce(function (searchText) {
                console.log('Searching customers for:', searchText, 'Total data:', getCustomerData().length);
                const allCustomers = getCustomerData();
                if (searchText === '') {
                    showDropdown(allCustomers.slice(0, 15), '');
                } else {
                    const filtered = allCustomers.filter(c => c.nama.toLowerCase().includes(searchText));
                    showDropdown(filtered, searchText);
                }
            }, 50); // 50ms debounce - sangat cepat

            input.addEventListener('input', function () {
                console.log('Input event triggered on:', inputId);
                const searchText = this.value.trim().toLowerCase();
                handleSearch(searchText);
            });

            input.addEventListener('focus', function () {
                console.log('Focus event triggered on:', inputId, 'Data count:', getCustomerData().length);
                const searchText = this.value.trim().toLowerCase();
                const allCustomers = getCustomerData();
                // Focus langsung tampilkan tanpa debounce
                if (searchText === '') {
                    showDropdown(allCustomers.slice(0, 15), '');
                } else {
                    const filtered = allCustomers.filter(c => c.nama.toLowerCase().includes(searchText));
                    showDropdown(filtered, searchText);
                }
            });

            input.addEventListener('blur', function () {
                setTimeout(() => dropdown.classList.remove('show'), 200);
            });

            input.addEventListener('keydown', function (e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    items.forEach((item, i) => item.classList.toggle('active', i === currentFocus));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    items.forEach((item, i) => item.classList.toggle('active', i === currentFocus));
                } else if (e.key === 'Enter' && currentFocus > -1) {
                    e.preventDefault();
                    items[currentFocus].click();
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Autocomplete untuk Supplier
        function setupSupplierAutocomplete(inputId, dropdownId) {
            // Cegah multiple setup
            if (autocompleteInitialized[inputId]) {
                console.log('Supplier autocomplete sudah di-setup:', inputId);
                return;
            }
            autocompleteInitialized[inputId] = true;

            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (!input || !dropdown) {
                console.log('Element tidak ditemukan untuk supplier:', inputId, dropdownId);
                return;
            }

            console.log('Setup supplier autocomplete:', inputId);

            let currentFocus = -1;

            // Gunakan cache untuk data supplier - selalu ambil dari dropdownCache langsung
            function getSupplierData() {
                // Force refresh jika cache null
                if (!dropdownCache.suppliers || dropdownCache.suppliers.length === 0) {
                    console.log('Cache supplier kosong, refreshing...');
                    const suppliersFromMaster = dataMasterSupplier.map(s => ({
                        nama: s.nama,
                        alamat: s.alamat || '',
                        telepon: s.telepon || '',
                        npwp: s.npwp || ''
                    })).filter(s => s.nama && s.nama.trim());

                    const suppliersFromTrans = dataPembelian.map(p => ({
                        nama: p.namaSupplier,
                        alamat: p.alamatSupplier || '',
                        telepon: p.teleponSupplier || '',
                        npwp: p.npwpSupplier || ''
                    })).filter(s => s.nama && s.nama.trim());

                    const allSuppliers = [...suppliersFromMaster];
                    suppliersFromTrans.forEach(st => {
                        if (st.nama && !allSuppliers.find(s => s.nama.toLowerCase() === st.nama.toLowerCase())) {
                            allSuppliers.push(st);
                        }
                    });
                    dropdownCache.suppliers = allSuppliers.sort((a, b) => a.nama.localeCompare(b.nama));
                }
                console.log('getSupplierData returning', dropdownCache.suppliers.length, 'items');
                return dropdownCache.suppliers || [];
            }

            function showDropdown(items, searchText) {
                dropdown.innerHTML = '';
                currentFocus = -1;

                if (items.length === 0) {
                    dropdown.innerHTML = '<div class="autocomplete-no-result">Tidak ada supplier ditemukan. Silakan tambahkan di Data Master.</div>';
                    dropdown.classList.add('show');
                    return;
                }

                // Info jumlah hasil
                const info = document.createElement('div');
                info.className = 'autocomplete-info';
                info.textContent = searchText
                    ? `Ditemukan ${items.length} supplier untuk "${searchText}"`
                    : `Menampilkan ${items.length} supplier (klik untuk pilih)`;
                dropdown.appendChild(info);

                items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';

                    let displayName = item.nama;
                    if (searchText) {
                        const regex = new RegExp(`(${searchText})`, 'gi');
                        displayName = item.nama.replace(regex, '<strong>$1</strong>');
                    }

                    div.innerHTML = `<span>${displayName}</span>`;
                    if (item.telepon) {
                        div.innerHTML += `<span class="item-code">${item.telepon}</span>`;
                    }

                    div.addEventListener('click', function () {
                        input.value = item.nama;
                        dropdown.classList.remove('show');

                        // Auto-fill alamat, telepon, npwp
                        document.getElementById('alamatSupplier').value = item.alamat || '';
                        document.getElementById('teleponSupplier').value = item.telepon || '';
                        document.getElementById('npwpSupplier').value = item.npwp || '';
                    });

                    dropdown.appendChild(div);
                });

                dropdown.classList.add('show');
            }

            // Fungsi pencarian dengan debounce untuk input yang cepat
            const handleSearch = debounce(function (searchText) {
                console.log('Searching suppliers for:', searchText, 'Total data:', getSupplierData().length);
                const allSuppliers = getSupplierData();
                if (searchText === '') {
                    showDropdown(allSuppliers.slice(0, 15), '');
                } else {
                    const filtered = allSuppliers.filter(s => s.nama.toLowerCase().includes(searchText));
                    showDropdown(filtered, searchText);
                }
            }, 50); // 50ms debounce - sangat cepat

            input.addEventListener('input', function () {
                console.log('Input event triggered on:', inputId);
                const searchText = this.value.trim().toLowerCase();
                handleSearch(searchText);
            });

            input.addEventListener('focus', function () {
                console.log('Focus event triggered on:', inputId, 'Data count:', getSupplierData().length);
                const searchText = this.value.trim().toLowerCase();
                const allSuppliers = getSupplierData();
                // Focus langsung tampilkan tanpa debounce
                if (searchText === '') {
                    showDropdown(allSuppliers.slice(0, 15), '');
                } else {
                    const filtered = allSuppliers.filter(s => s.nama.toLowerCase().includes(searchText));
                    showDropdown(filtered, searchText);
                }
            });

            input.addEventListener('blur', function () {
                setTimeout(() => dropdown.classList.remove('show'), 200);
            });

            input.addEventListener('keydown', function (e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    items.forEach((item, i) => item.classList.toggle('active', i === currentFocus));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    items.forEach((item, i) => item.classList.toggle('active', i === currentFocus));
                } else if (e.key === 'Enter' && currentFocus > -1) {
                    e.preventDefault();
                    items[currentFocus].click();
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Autocomplete untuk Barang
        function setupBarangAutocomplete(inputId, dropdownId, mode) {
            // Cegah multiple setup
            if (autocompleteInitialized[inputId]) {
                console.log('Barang autocomplete sudah di-setup:', inputId);
                return;
            }
            autocompleteInitialized[inputId] = true;

            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);

            if (!input || !dropdown) {
                console.log('Element tidak ditemukan untuk barang:', inputId, dropdownId);
                return;
            }

            console.log('Setup barang autocomplete:', inputId, 'mode:', mode);

            let currentFocus = -1;

            // Gunakan cache untuk data barang - force refresh jika kosong
            function getBarangData() {
                // Force refresh jika cache kosong
                if (!dropdownCache.barangJual || !dropdownCache.barangBeli ||
                    dropdownCache.barangJual.length === 0 || dropdownCache.barangBeli.length === 0) {
                    console.log('Cache barang kosong, refreshing...');
                    const barangFromMaster = dataMasterBarang.map(b => ({
                        nama: b.nama,
                        kode: b.kode || '',
                        hargaJual: b.hargaJual || 0,
                        hargaBeli: b.hargaBeli || 0,
                        satuan: b.satuan || ''
                    })).filter(b => b.nama && b.nama.trim());

                    const sortedBarang = barangFromMaster.sort((a, b) => a.nama.localeCompare(b.nama));

                    dropdownCache.barangJual = sortedBarang.map(b => ({
                        nama: b.nama,
                        kode: b.kode,
                        harga: b.hargaJual,
                        satuan: b.satuan
                    }));

                    dropdownCache.barangBeli = sortedBarang.map(b => ({
                        nama: b.nama,
                        kode: b.kode,
                        harga: b.hargaBeli,
                        satuan: b.satuan
                    }));
                }

                if (mode === 'jual') {
                    console.log('getBarangData (jual) returning', dropdownCache.barangJual.length, 'items');
                    return dropdownCache.barangJual || [];
                } else {
                    console.log('getBarangData (beli) returning', dropdownCache.barangBeli.length, 'items');
                    return dropdownCache.barangBeli || [];
                }
            }

            // Tampilkan dropdown
            function showDropdown(items, searchText) {
                dropdown.innerHTML = '';
                currentFocus = -1;

                if (items.length === 0) {
                    dropdown.innerHTML = '<div class="autocomplete-no-result">Tidak ada barang ditemukan. Silakan tambahkan di Data Master.</div>';
                    dropdown.classList.add('show');
                    return;
                }

                // Info jumlah hasil
                const info = document.createElement('div');
                info.className = 'autocomplete-info';
                info.textContent = searchText
                    ? `Ditemukan ${items.length} barang untuk "${searchText}"`
                    : `Menampilkan ${items.length} barang (klik atau ketik untuk mencari)`;
                dropdown.appendChild(info);

                items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';

                    // Highlight teks yang cocok
                    let displayName = item.nama;
                    if (searchText) {
                        const regex = new RegExp(`(${searchText})`, 'gi');
                        displayName = item.nama.replace(regex, '<strong>$1</strong>');
                    }

                    div.innerHTML = `
                        <span>${displayName}</span>
                        ${item.kode ? `<span class="item-code">[${item.kode}]</span>` : ''}
                        ${item.harga > 0 ? `<span class="item-price">${formatRupiah(item.harga)}</span>` : ''}
                    `;

                    div.addEventListener('click', function () {
                        selectItem(item);
                    });

                    dropdown.appendChild(div);
                });

                dropdown.classList.add('show');
            }

            // Pilih item
            function selectItem(item) {
                input.value = item.nama;
                dropdown.classList.remove('show');

                // Update harga otomatis
                if (mode === 'jual') {
                    if (item.harga > 0) {
                        document.getElementById('hargaJual').value = formatRupiah(item.harga);
                        calculateTotalJual();
                    }
                } else {
                    if (item.harga > 0) {
                        document.getElementById('hargaBeli').value = formatRupiah(item.harga);
                        calculateTotalBeli();
                    }
                }

                // Fokus ke field berikutnya (qty)
                const qtyField = mode === 'jual' ? document.getElementById('qtyJual') : document.getElementById('qtyBeli');
                if (qtyField) qtyField.focus();
            }

            // Sembunyikan dropdown
            function hideDropdown() {
                setTimeout(() => {
                    dropdown.classList.remove('show');
                }, 200);
            }

            // Fungsi pencarian dengan debounce untuk input yang cepat
            const handleSearch = debounce(function (searchText) {
                console.log('Searching barang for:', searchText, 'Mode:', mode, 'Total data:', getBarangData().length);
                const allBarang = getBarangData();
                if (searchText === '') {
                    showDropdown(allBarang.slice(0, 20), '');
                } else {
                    const filtered = allBarang.filter(b =>
                        b.nama.toLowerCase().includes(searchText) ||
                        (b.kode && b.kode.toLowerCase().includes(searchText))
                    );
                    showDropdown(filtered, searchText);
                }
            }, 50); // 50ms debounce - sangat cepat

            // Event: Input (saat mengetik)
            input.addEventListener('input', function () {
                console.log('Input event triggered on:', inputId);
                const searchText = this.value.trim().toLowerCase();
                handleSearch(searchText);
            });

            // Event: Focus (saat klik input)
            input.addEventListener('focus', function () {
                console.log('Focus event triggered on:', inputId, 'Data count:', getBarangData().length);
                const searchText = this.value.trim().toLowerCase();
                const allBarang = getBarangData();
                // Focus langsung tampilkan tanpa debounce
                if (searchText === '') {
                    showDropdown(allBarang.slice(0, 20), '');
                } else {
                    const filtered = allBarang.filter(b =>
                        b.nama.toLowerCase().includes(searchText) ||
                        (b.kode && b.kode.toLowerCase().includes(searchText))
                    );
                    showDropdown(filtered, searchText);
                }
            });

            // Event: Blur (saat keluar dari input)
            input.addEventListener('blur', hideDropdown);

            // Event: Keyboard navigation
            input.addEventListener('keydown', function (e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    setActive(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    setActive(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                } else if (e.key === 'Escape') {
                    hideDropdown();
                }
            });

            // Set item aktif
            function setActive(items) {
                items.forEach((item, index) => {
                    item.classList.remove('active');
                    if (index === currentFocus) {
                        item.classList.add('active');
                        item.scrollIntoView({ block: 'nearest' });
                    }
                });
            }
        }

        // Set tanggal default ke hari ini
        function setDefaultDates() {
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            const todayFormatted = `${dd}/${mm}/${yyyy}`;

            // Set tanggal transaksi dengan pengecekan null
            const tglPenjualan = document.getElementById('tglPenjualan');
            if (tglPenjualan) tglPenjualan.value = todayFormatted;

            const tglPembelian = document.getElementById('tglPembelian');
            if (tglPembelian) tglPembelian.value = todayFormatted;

            const tglKasMasuk = document.getElementById('tglKasMasuk');
            if (tglKasMasuk) tglKasMasuk.value = todayFormatted;

            const tglKasKeluar = document.getElementById('tglKasKeluar');
            if (tglKasKeluar) tglKasKeluar.value = todayFormatted;

            // Set tanggal batch kas
            const tglBatchKasMasuk = document.getElementById('tglBatchKasMasuk');
            if (tglBatchKasMasuk) tglBatchKasMasuk.value = todayFormatted;
            const tglBatchKasKeluar = document.getElementById('tglBatchKasKeluar');
            if (tglBatchKasKeluar) tglBatchKasKeluar.value = todayFormatted;

            // Set filter dates
            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            const dd1 = String(startOfMonth.getDate()).padStart(2, '0');
            const mm1 = String(startOfMonth.getMonth() + 1).padStart(2, '0');
            const yyyy1 = startOfMonth.getFullYear();
            const startFormatted = `${dd1}/${mm1}/${yyyy1}`;

            const filterTglMulai = document.getElementById('filterTglMulai');
            if (filterTglMulai) filterTglMulai.value = startFormatted;

            const filterTglSelesai = document.getElementById('filterTglSelesai');
            if (filterTglSelesai) filterTglSelesai.value = todayFormatted;

            const filterLabaRugiMulai = document.getElementById('filterLabaRugiMulai');
            if (filterLabaRugiMulai) filterLabaRugiMulai.value = startFormatted;

            const filterLabaRugiSelesai = document.getElementById('filterLabaRugiSelesai');
            if (filterLabaRugiSelesai) filterLabaRugiSelesai.value = todayFormatted;

            const filterKasMulai = document.getElementById('filterKasMulai');
            if (filterKasMulai) filterKasMulai.value = startFormatted;

            const filterKasSelesai = document.getElementById('filterKasSelesai');
            if (filterKasSelesai) filterKasSelesai.value = todayFormatted;

            const filterBukuBesarMulai = document.getElementById('filterBukuBesarMulai');
            if (filterBukuBesarMulai) filterBukuBesarMulai.value = startFormatted;

            const filterBukuBesarSelesai = document.getElementById('filterBukuBesarSelesai');
            if (filterBukuBesarSelesai) filterBukuBesarSelesai.value = todayFormatted;
        }

        // Generate nomor jurnal kas harian (satu nomor jurnal per hari)
        function generateNoJurnalKasHarian(tanggalISO, jenis) {
            // Format: JKM-YYYYMMDD (Jurnal Kas Masuk) atau JKK-YYYYMMDD (Jurnal Kas Keluar)
            const date = new Date(tanggalISO);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const prefix = jenis === 'masuk' ? 'JKM' : 'JKK';
            return `${prefix}-${year}${month}${day}`;
        }

        // Generate nomor transaksi kas (per item)
        function generateNoTransaksi(prefix, dataArray, tanggalInput) {
            // Gunakan tanggal input jika ada, kalau tidak pakai tanggal hari ini
            let year, month, day;

            if (tanggalInput) {
                const date = new Date(tanggalInput);
                year = date.getFullYear();
                month = String(date.getMonth() + 1).padStart(2, '0');
                day = String(date.getDate()).padStart(2, '0');
            } else {
                const date = new Date();
                year = date.getFullYear();
                month = String(date.getMonth() + 1).padStart(2, '0');
                day = String(date.getDate()).padStart(2, '0');
            }

            const tanggalStr = `${year}-${month}-${day}`;

            if (prefix === 'KM') {
                // Hitung berapa transaksi kas masuk pada tanggal yang sama
                const countToday = dataArray.filter(k =>
                    k.jenis === 'masuk' &&
                    k.tanggal && k.tanggal.startsWith(tanggalStr)
                ).length + 1;
                return `KM-${year}${month}${day}-${String(countToday).padStart(4, '0')}`;
            } else if (prefix === 'KK') {
                // Hitung berapa transaksi kas keluar pada tanggal yang sama
                const countToday = dataArray.filter(k =>
                    k.jenis === 'keluar' &&
                    k.tanggal && k.tanggal.startsWith(tanggalStr)
                ).length + 1;
                return `KK-${year}${month}${day}-${String(countToday).padStart(4, '0')}`;
            }
            return '';
        }

        // Generate nomor faktur otomatis
        function generateNoFaktur() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;

            // Helper to get next sequence number
            const getNextSequence = (data, prefix) => {
                let maxSeq = 0;
                const pattern = new RegExp(`^${prefix}-${dateStr}-(\\d{4})$`);

                data.forEach(item => {
                    const no = item.noFaktur || '';
                    const match = no.match(pattern);
                    if (match) {
                        const seq = parseInt(match[1], 10);
                        if (seq > maxSeq) maxSeq = seq;
                    }
                });
                return maxSeq + 1;
            };

            const kasMasukCount = dataTransaksiKas.filter(k => k.jenis === 'masuk').length + 1;
            const kasKeluarCount = dataTransaksiKas.filter(k => k.jenis === 'keluar').length + 1;

            // Generate nomor faktur penjualan berdasarkan jenis PPN
            const jenisPpnJualEl = document.getElementById('jenisPpnJual');
            const noFakturJualEl = document.getElementById('noFakturJual');
            if (jenisPpnJualEl && noFakturJualEl) {
                const jenisPpnJual = jenisPpnJualEl.value || 'nonppn';
                let prefix = jenisPpnJual === 'nonppn' ? 'NPP' : 'FJ';
                let nomorJual = getNextSequence(dataPenjualan, prefix);
                noFakturJualEl.value = `${prefix}-${dateStr}-${String(nomorJual).padStart(4, '0')}`;
            }

            // Generate nomor faktur pembelian berdasarkan jenis PPN
            const jenisPpnBeliEl = document.getElementById('jenisPpnBeli');
            const noFakturBeliEl = document.getElementById('noFakturBeli');
            if (jenisPpnBeliEl && noFakturBeliEl) {
                const jenisPpnBeli = jenisPpnBeliEl.value || 'nonppn';
                let prefix = jenisPpnBeli === 'nonppn' ? 'NPB' : 'FB';
                let nomorBeli = getNextSequence(dataPembelian, prefix);
                noFakturBeliEl.value = `${prefix}-${dateStr}-${String(nomorBeli).padStart(4, '0')}`;
            }

            // Kas Masuk & Keluar (Simple Counter is acceptable or apply similar logic if needed)
            // For now, keeping length-based for Kas as they are less critical for invoicing compliance, 
            // but for consistency let's fix them too if they have IDs.
            // However, the original code used global counters based on filter.
            // Let's stick to the Invoice fix primarily.

            const noKasMasukEl = document.getElementById('noKasMasuk');
            const noKasKeluarEl = document.getElementById('noKasKeluar');
            if (noKasMasukEl) noKasMasukEl.value = `KM-${dateStr}-${String(kasMasukCount).padStart(4, '0')}`;
            if (noKasKeluarEl) noKasKeluarEl.value = `KK-${dateStr}-${String(kasKeluarCount).padStart(4, '0')}`;
        }

        // Toggle metode pembayaran
        function toggleBayarJual() {
            const metode = document.getElementById('metodeBayarJual').value;
            const group = document.getElementById('groupBayarJual');
            // FIX: Hide jumlah bayar for Kredit, use DP instead.
            // If Kredit, we rely on DP field. groupBayarJual remains hidden.
            // Only show if we decided to use it, but for now we hide it to avoid confusion with DP.
            if (metode === 'kredit') {
                // group.classList.remove('d-none');
                // group.classList.add('d-grid');
                group.classList.remove('d-grid');
                group.classList.add('d-none');
                document.getElementById('bayarJual').value = '';
            } else {
                group.classList.remove('d-grid');
                group.classList.add('d-none');
                document.getElementById('bayarJual').value = '';
            }
        }

        function toggleBayarBeli() {
            const metode = document.getElementById('metodeBayarBeli').value;
            const group = document.getElementById('groupBayarBeli');
            // FIX: Hide jumlah bayar for Kredit, use DP instead.
            if (metode === 'kredit') {
                // group.classList.remove('d-none');
                // group.classList.add('d-grid');
                group.classList.remove('d-grid');
                group.classList.add('d-none');
                document.getElementById('bayarBeli').value = '';
            } else {
                group.classList.remove('d-grid');
                group.classList.add('d-none');
                document.getElementById('bayarBeli').value = '';
            }
        }

        // Helper functions untuk format input
        function formatRupiahInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            input.value = value;
        }

        function formatAngkaInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            input.value = value;
        }

        function parseRupiahValue(value) {
            if (typeof value === 'string') {
                return parseFloat(value.replace(/[^0-9]/g, '')) || 0;
            }
            return parseFloat(value) || 0;
        }

        // Alias untuk parseRupiah
        function parseRupiah(value) {
            return parseRupiahValue(value);
        }

        // Validate tanggal format DD/MM/YYYY
        function validateTanggal(tanggal) {
            if (!tanggal) return false;
            const regex = /^\d{2}\/\d{2}\/\d{4}$/;
            if (!regex.test(tanggal)) return false;

            const parts = tanggal.split('/');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);

            if (day < 1 || day > 31) return false;
            if (month < 1 || month > 12) return false;
            if (year < 1900 || year > 2100) return false;

            return true;
        }

        // Auto calculate total
        document.getElementById('jenisPpnJual').addEventListener('change', function () {
            calculateTotalJual();
            generateNoFaktur(); // Regenerate nomor faktur saat jenis PPN berubah
        });
        document.getElementById('jenisPpnBeli').addEventListener('change', function () {
            calculateTotalBeli();
            generateNoFaktur(); // Regenerate nomor faktur saat jenis PPN berubah
        });

        function calculateTotalJual() {
            const qty = parseRupiahValue(document.getElementById('qtyJual').value);
            const harga = parseRupiahValue(document.getElementById('hargaJual').value);
            const subtotal = qty * harga;

            // Diskon langsung dalam nilai rupiah
            const diskon = parseRupiahValue(document.getElementById('diskonJual').value);
            const subtotalSetelahDiskon = subtotal - diskon;

            // Hitung PPN dari subtotal setelah diskon
            const jenisPpn = document.getElementById('jenisPpnJual').value;
            let nilaiPpn = 0;

            if (jenisPpn === 'ppn11') {
                nilaiPpn = subtotalSetelahDiskon * 0.11;
            } else if (jenisPpn === 'ppn1') {
                nilaiPpn = subtotalSetelahDiskon * 0.011;
            }

            // Hitung total sebelum DP
            const totalSebelumDP = subtotalSetelahDiskon + nilaiPpn;

            // Kurangi DP dari total
            const dp = parseRupiahValue(document.getElementById('dpJual').value);
            const total = totalSebelumDP - dp;

            document.getElementById('subtotalJual').value = formatRupiah(subtotal);
            document.getElementById('totalJual').value = formatRupiah(total);
        }

        function calculateTotalBeli() {
            const qty = parseRupiahValue(document.getElementById('qtyBeli').value);
            const harga = parseRupiahValue(document.getElementById('hargaBeli').value);
            const subtotal = qty * harga;

            // Diskon langsung dalam nilai rupiah
            const diskon = parseRupiahValue(document.getElementById('diskonBeli').value);
            const subtotalSetelahDiskon = subtotal - diskon;

            // Hitung PPN dari subtotal setelah diskon
            const jenisPpn = document.getElementById('jenisPpnBeli').value;
            let nilaiPpn = 0;

            if (jenisPpn === 'ppn11') {
                nilaiPpn = subtotalSetelahDiskon * 0.11;
            } else if (jenisPpn === 'ppn1') {
                nilaiPpn = subtotalSetelahDiskon * 0.011;
            }

            // Hitung total sebelum DP
            const totalSebelumDP = subtotalSetelahDiskon + nilaiPpn;

            // Kurangi DP dari total
            const dp = parseRupiahValue(document.getElementById('dpBeli').value);
            const total = totalSebelumDP - dp;

            document.getElementById('subtotalBeli').value = formatRupiah(subtotal);
            document.getElementById('totalBeli').value = formatRupiah(total);
        }

        function toggleMenu() {
            document.querySelector('.tabs').classList.add('show-menu');
            document.querySelector('.menu-overlay').classList.add('show');
        }

        function closeMenu() {
            document.querySelector('.tabs').classList.remove('show-menu');
            document.querySelector('.menu-overlay').classList.remove('show');
        }

        // Tab switching
        function openTab(evt, tabName) {
            // Close menu on mobile
            if (window.innerWidth <= 1024) {
                closeMenu();
            }

            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }

            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }

            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');

            // Reset search boxes when switching tabs
            const searchBoxes = ['searchPenjualan', 'searchPembelian', 'searchPiutang', 'searchHutang', 'searchKas', 'searchJurnal', 'searchGlobal'];
            searchBoxes.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });

            // Update displays when switching tabs
            if (tabName === 'jurnal') {
                displayJurnal();
            } else if (tabName === 'data-master') {
                updateDataMasterStats();
                displayMasterCustomer();
                displayMasterSupplier();
                displayMasterBarang();
                updateKategoriDropdowns();
                setupKategoriEventListeners(); // Reinitialize event listeners
                setupDataMasterEventListeners(); // Reinitialize event listeners untuk data master
            } else if (tabName === 'penjualan' || tabName === 'pembelian') {
                // Refresh cache dropdown data saat buka tab penjualan/pembelian
                invalidateDropdownCache();
                console.log('Tab ' + tabName + ' dibuka - cache refreshed');
                console.log('Customer data count:', dropdownCache.customers?.length || 0);
                console.log('Supplier data count:', dropdownCache.suppliers?.length || 0);
            } else if (tabName === 'kas-harian') {
                displayKasHarian();
                setupKategoriKasHarianAutocomplete();
            } else if (tabName === 'transaksi-kas') {
                displayTransaksiKas();
                updateSaldoKas();
            } else if (tabName === 'piutang') {
                displayPiutang();
                populateDataLists(); // Refresh datalist untuk form piutang awal
            } else if (tabName === 'hutang') {
                displayHutang();
                populateDataLists(); // Refresh datalist untuk form hutang awal
            } else if (tabName === 'laporan-divisi') {
                setDefaultDatesDivisi();
                updateLaporanDivisi();
            } else if (tabName === 'laporan-non-ppn') {
                setDefaultDatesNonPPN();
                displayLaporanNonPPN();
            } else if (tabName === 'pencarian') {
                document.getElementById('searchGlobal').focus();
            }
        }

        // Sub-Tab switching untuk Data Master
        function openSubTab(evt, subTabName) {
            const subTabContents = document.getElementsByClassName('sub-tab-content');
            for (let i = 0; i < subTabContents.length; i++) {
                subTabContents[i].classList.remove('active');
            }

            const tabs = evt.currentTarget.parentElement.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }

            document.getElementById(subTabName).classList.add('active');
            evt.currentTarget.classList.add('active');

            // Reinitialize event listeners when kategori tab is opened
            if (subTabName === 'master-kategori') {
                setupKategoriEventListeners();
            } else if (subTabName === 'master-customer' || subTabName === 'master-supplier' || subTabName === 'master-barang') {
                setupDataMasterEventListeners();
            }
        }

        // Form Penjualan Submit
        document.getElementById('formPenjualan').addEventListener('submit', function (e) {
            e.preventDefault();
            if (detailBarangJual.length === 0) {
                alert('Isi minimal 1 barang!');
                return;
            }
            const metodeBayar = document.getElementById('metodeBayarJual').value;
            const dp = parseInt(document.getElementById('dpJual').value.replace(/[^\d]/g, '')) || 0;

            // Hitung total DPP dan PPN dari detail barang
            let totalDPP = 0;
            let totalPPN = 0;
            let hasPpn11 = false;
            let hasPpn1 = false;
            let hasDibebaskan = false;

            detailBarangJual.forEach(b => {
                const dpp = (b.qty * b.harga) - b.diskon;
                totalDPP += dpp;
                // Hitung PPN per item (subtotal - dpp)
                const ppnItem = b.subtotal - dpp;
                totalPPN += ppnItem;

                if (b.ppn === 'ppn11') hasPpn11 = true;
                else if (b.ppn === 'ppn1') hasPpn1 = true;
                else if (b.ppn === 'dibebaskan') hasDibebaskan = true;
            });

            let detectedJenisPpn = 'nonppn';
            if (hasPpn11) detectedJenisPpn = 'ppn11';
            else if (hasPpn1) detectedJenisPpn = 'ppn1';
            else if (hasDibebaskan) detectedJenisPpn = 'dibebaskan';

            const totalAkhir = totalDPP + totalPPN;
            const bayar = metodeBayar === 'kredit' ? (parseInt(document.getElementById('bayarJual').value.replace(/[^\d]/g, '')) || 0) : totalAkhir;

            const transaksi = {
                id: Date.now(),
                tanggal: convertToISODate(document.getElementById('tglPenjualan').value),
                divisi: document.getElementById('divisiJual').value,
                noFaktur: document.getElementById('noFakturJual').value,
                namaPelanggan: document.getElementById('namaPelanggan').value,
                alamatPelanggan: document.getElementById('alamatPelanggan').value || '-',
                teleponPelanggan: document.getElementById('teleponPelanggan').value || '-',
                npwpPelanggan: document.getElementById('npwpPelanggan').value || '-',
                detailBarang: [...detailBarangJual],
                dp: dp,
                subtotal: totalDPP,
                diskon: 0, // Diskon sudah diterapkan per item
                jenisPpn: detectedJenisPpn,
                nilaiPpn: totalPPN,
                total: totalAkhir,
                metodeBayar: metodeBayar,
                dibayar: bayar + dp, // Include DP in dibayar
                sisa: totalAkhir - dp - bayar
            };
            dataPenjualan.push(transaksi);
            // Buat jurnal otomatis untuk penjualan
            buatJurnalPenjualan(transaksi);

            // Posting ke piutang jika metode kredit dan ada sisa
            /* DUPLIKASI FIX: Tidak perlu push ke dataPiutangAwal karena displayPiutang sudah mengambil dari dataPenjualan
            if ((metodeBayar === 'kredit') && transaksi.sisa > 0) {
                const piutangBaru = {
                    id: Date.now() + 1,
                    tanggal: transaksi.tanggal,
                    noFaktur: transaksi.noFaktur,
                    namaPelanggan: transaksi.namaPelanggan,
                    keterangan: `Faktur ${transaksi.noFaktur} - ${transaksi.detailBarang.map(b => b.nama).join(', ')}`,
                    total: transaksi.sisa,
                    dibayar: 0
                };
                dataPiutangAwal.push(piutangBaru);
            }
            */

            // Simpan ke localStorage
            saveDataToStorage();
            // Update tampilan
            displayPenjualan();
            displayJurnal();
            displayPiutang();
            resetFormPenjualanCustom();
            showAlert('alertPenjualan', 'Penjualan berhasil disimpan!', 'success');
        });

        // Form Pembelian Submit (multi-item)
        document.getElementById('formPembelian').addEventListener('submit', function (e) {
            e.preventDefault();
            if (detailBarangBeli.length === 0) {
                alert('Isi minimal 1 barang!');
                return;
            }
            const metodeBayar = document.getElementById('metodeBayarBeli').value;
            const dp = parseInt(document.getElementById('dpBeli').value.replace(/[^\d]/g, '')) || 0;

            // Hitung total DPP dan PPN dari detail barang
            let totalDPP = 0;
            let totalPPN = 0;
            let hasPpn11 = false;
            let hasPpn1 = false;
            let hasDibebaskan = false;

            detailBarangBeli.forEach(b => {
                const dpp = (b.qty * b.harga) - b.diskon;
                totalDPP += dpp;
                // Hitung PPN per item (subtotal - dpp)
                const ppnItem = b.subtotal - dpp;
                totalPPN += ppnItem;

                if (b.ppn === 'ppn11') hasPpn11 = true;
                else if (b.ppn === 'ppn1') hasPpn1 = true;
                else if (b.ppn === 'dibebaskan') hasDibebaskan = true;
            });

            let detectedJenisPpn = 'nonppn';
            if (hasPpn11) detectedJenisPpn = 'ppn11';
            else if (hasPpn1) detectedJenisPpn = 'ppn1';
            else if (hasDibebaskan) detectedJenisPpn = 'dibebaskan';

            const total = totalDPP + totalPPN;
            const bayar = metodeBayar === 'kredit' ? (parseInt(document.getElementById('bayarBeli').value.replace(/[^\d]/g, '')) || 0) : total;
            const transaksi = {
                id: Date.now(),
                tanggal: convertToISODate(document.getElementById('tglPembelian').value),
                divisi: document.getElementById('divisiBeli').value,
                noFaktur: document.getElementById('noFakturBeli').value,
                namaSupplier: document.getElementById('namaSupplier').value,
                alamatSupplier: document.getElementById('alamatSupplier').value || '-',
                teleponSupplier: document.getElementById('teleponSupplier').value || '-',
                npwpSupplier: document.getElementById('npwpSupplier').value || '-',
                detailBarang: [...detailBarangBeli],
                dp: dp,
                subtotal: totalDPP,
                diskon: 0,
                jenisPpn: detectedJenisPpn,
                nilaiPpn: totalPPN,
                total: total,
                metodeBayar: metodeBayar,
                dibayar: bayar + dp, // Include DP in dibayar
                sisa: total - dp - bayar
            };
            dataPembelian.push(transaksi);
            // Buat jurnal otomatis untuk pembelian
            buatJurnalPembelian(transaksi);

            // Posting ke hutang jika metode kredit dan ada sisa
            /* DUPLIKASI FIX: Tidak perlu push ke dataHutangAwal karena displayHutang sudah mengambil dari dataPembelian
            if ((metodeBayar === 'kredit') && transaksi.sisa > 0) {
                const hutangBaru = {
                    id: Date.now() + 1,
                    tanggal: transaksi.tanggal,
                    divisi: transaksi.divisi,
                    noFaktur: transaksi.noFaktur,
                    namaSupplier: transaksi.namaSupplier,
                    keterangan: `Faktur ${transaksi.noFaktur} - ${transaksi.detailBarang.map(b => b.nama).join(', ')}`,
                    total: transaksi.sisa,
                    dibayar: 0
                };
                dataHutangAwal.push(hutangBaru);
            }
            */

            // Simpan ke localStorage
            saveDataToStorage();
            // Update tampilan
            displayPembelian();
            displayJurnal();
            displayHutang();
            resetFormPembelianCustom();
            showAlert('alertPembelian', 'Pembelian berhasil disimpan!', 'success');
        });

        // Buat jurnal penjualan (Double Entry)
        function buatJurnalPenjualan(transaksi, skipKasHarian = false) {
            const dp = transaksi.dp || 0;
            const isKredit = (transaksi.metodeBayar || '').toLowerCase() === 'kredit';
            // Jika kredit, bayar = dp. Jika tunai, bayar = total (atau dibayar).
            const bayar = isKredit ? dp : (transaksi.dibayar !== undefined ? transaksi.dibayar : transaksi.total);

            const pelanggan = transaksi.namaPelanggan || transaksi.pelanggan || '-';
            // Ambil nama barang dari detailBarang (array)
            let barang = '-';
            if (transaksi.detailBarang && transaksi.detailBarang.length > 0) {
                barang = transaksi.detailBarang.map(b => b.nama).join(', ');
            } else if (transaksi.namaBarang) {
                barang = transaksi.namaBarang;
            } else if (transaksi.barang) {
                barang = transaksi.barang;
            }

            const jurnal = {
                id: Date.now(),
                tanggal: transaksi.tanggal,
                noRef: transaksi.noFaktur,
                divisi: transaksi.divisi,
                keterangan: `Penjualan kepada ${pelanggan} - ${barang}`,
                entries: []
            };

            // LOGIKA BARU: SEMUA MASUK PIUTANG DULU (GROSS METHOD)

            // 1. Catat Piutang (Debit) vs Pendapatan (Kredit) -> Sebesar Total Faktur
            const nilaiPpn = transaksi.nilaiPpn || 0;
            const pendapatan = transaksi.total - nilaiPpn;

            jurnal.entries.push({
                akun: 'Piutang Usaha',
                debit: transaksi.total,
                kredit: 0
            });

            jurnal.entries.push({
                akun: 'Pendapatan Penjualan',
                debit: 0,
                kredit: pendapatan
            });

            if (nilaiPpn > 0) {
                jurnal.entries.push({
                    akun: 'Hutang PPN',
                    debit: 0,
                    kredit: nilaiPpn
                });
            }

            // 2. Jika ada pembayaran (DP atau Tunai), Catat Kas (Debit) vs Piutang (Kredit)
            if (bayar > 0) {
                jurnal.entries.push({
                    akun: 'Kas',
                    debit: bayar,
                    kredit: 0
                });

                jurnal.entries.push({
                    akun: 'Piutang Usaha',
                    debit: 0,
                    kredit: bayar
                });

                // Catat ke Kas Harian (jika tidak diskip)
                if (!skipKasHarian) {
                    const metodeBayarStr = (transaksi.metodeBayar || 'Tunai').toLowerCase();
                    const labelBayar = metodeBayarStr === 'kredit' ? 'DP' : (metodeBayarStr.charAt(0).toUpperCase() + metodeBayarStr.slice(1));

                    const kasEntry = {
                        id: Date.now() + 1,
                        tanggal: transaksi.tanggal,
                        divisi: transaksi.divisi,
                        jenis: 'masuk',
                        kategori: 'Penjualan',
                        keterangan: `${transaksi.noFaktur} - ${pelanggan} (${labelBayar})`,
                        jumlah: bayar
                    };
                    dataKasHarian.push(kasEntry);
                }
            }

            dataJurnal.push(jurnal);
        }

        // Buat jurnal pembelian (Double Entry)
        function buatJurnalPembelian(transaksi, skipKasHarian = false) {
            const dp = transaksi.dp || 0;
            const isKredit = (transaksi.metodeBayar || '').toLowerCase() === 'kredit';
            // Jika kredit, bayar = dp. Jika tunai, bayar = total (atau dibayar).
            const bayar = isKredit ? dp : (transaksi.dibayar !== undefined ? transaksi.dibayar : transaksi.total);

            const supplier = transaksi.namaSupplier || transaksi.supplier || '-';
            // Ambil nama barang dari detailBarang (array)
            let barang = '-';
            if (transaksi.detailBarang && transaksi.detailBarang.length > 0) {
                barang = transaksi.detailBarang.map(b => b.nama).join(', ');
            } else if (transaksi.namaBarang) {
                barang = transaksi.namaBarang;
            } else if (transaksi.barang) {
                barang = transaksi.barang;
            }

            const jurnal = {
                id: Date.now(),
                tanggal: transaksi.tanggal,
                noRef: transaksi.noFaktur,
                divisi: transaksi.divisi,
                keterangan: `Pembelian dari ${supplier} - ${barang}`,
                entries: []
            };

            // LOGIKA BARU: SEMUA MASUK HUTANG DULU (GROSS METHOD)

            // 1. Catat Persediaan (Debit) vs Hutang (Kredit) -> Sebesar Total Faktur
            jurnal.entries.push({
                akun: 'Persediaan Barang',
                debit: transaksi.total,
                kredit: 0
            });

            jurnal.entries.push({
                akun: 'Hutang Usaha',
                debit: 0,
                kredit: transaksi.total
            });

            // 2. Jika ada pembayaran (DP atau Tunai), Catat Hutang (Debit) vs Kas (Kredit)
            if (bayar > 0) {
                jurnal.entries.push({
                    akun: 'Hutang Usaha',
                    debit: bayar,
                    kredit: 0
                });

                jurnal.entries.push({
                    akun: 'Kas',
                    debit: 0,
                    kredit: bayar
                });

                // Catat ke Kas Harian (jika tidak diskip)
                if (!skipKasHarian) {
                    const metodeBayarStr = (transaksi.metodeBayar || 'Tunai').toLowerCase();
                    const labelBayar = metodeBayarStr === 'kredit' ? 'DP' : (metodeBayarStr.charAt(0).toUpperCase() + metodeBayarStr.slice(1));

                    const kasEntry = {
                        id: Date.now() + 1,
                        tanggal: transaksi.tanggal,
                        divisi: transaksi.divisi,
                        jenis: 'keluar',
                        kategori: 'Pembelian',
                        keterangan: `${transaksi.noFaktur} - ${supplier} (${labelBayar})`,
                        jumlah: bayar
                    };
                    dataKasHarian.push(kasEntry);
                }
            }

            dataJurnal.push(jurnal);
        }

        // Buat jurnal kas masuk (Double Entry)
        function buatJurnalKasMasuk(transaksi) {
            let akunKredit = transaksi.kategori;
            if (transaksi.kategori === 'Lainnya') {
                akunKredit = 'Pendapatan Lain-lain';
            }

            const jurnal = {
                id: Date.now(),
                tanggal: transaksi.tanggal,
                noRef: transaksi.noTransaksi,
                divisi: transaksi.divisi,
                keterangan: `Kas Masuk - ${transaksi.kategori}: ${transaksi.keterangan}`,
                entries: [
                    {
                        akun: 'Kas',
                        debit: transaksi.jumlah,
                        kredit: 0
                    },
                    {
                        akun: akunKredit,
                        debit: 0,
                        kredit: transaksi.jumlah
                    }
                ]
            };

            dataJurnal.push(jurnal);
        }

        // Buat jurnal kas keluar (Double Entry)
        function buatJurnalKasKeluar(transaksi) {
            let akunDebit = transaksi.kategori;
            if (transaksi.kategori === 'Lainnya') {
                akunDebit = 'Beban Lain-lain';
            }

            const jurnal = {
                id: Date.now(),
                tanggal: transaksi.tanggal,
                noRef: transaksi.noTransaksi,
                divisi: transaksi.divisi,
                keterangan: `Kas Keluar - ${transaksi.kategori}: ${transaksi.keterangan}`,
                entries: [
                    {
                        akun: akunDebit,
                        debit: transaksi.jumlah,
                        kredit: 0
                    },
                    {
                        akun: 'Kas',
                        debit: 0,
                        kredit: transaksi.jumlah
                    }
                ]
            };

            dataJurnal.push(jurnal);
        }

        // Display Penjualan
        function displayPenjualan() {
            const tbody = document.getElementById('bodyPenjualan');
            let html = '';
            let grandTotal = 0;

            if (dataPenjualan.length === 0) {
                html = '<tr><td colspan="14" class="center">Belum ada data penjualan</td></tr>';
            } else {
                dataPenjualan.forEach((item, index) => {
                    const dp = item.dp || 0;
                    const total = item.total;
                    grandTotal += total;

                    // Logic fix for dibayar/sisa
                    let dibayar = item.dibayar;
                    if (dibayar === undefined || dibayar === null) {
                        dibayar = total; // Default to paid if undefined
                    } else if (item.metodeBayar === 'kredit' && dibayar === 0 && dp > 0) {
                        // Fix for old records where dibayar was 0 but DP existed
                        dibayar = dp;
                    }

                    const sisa = total - dibayar;
                    const divisiIcon = item.divisi === 'Angkutan' ? '🚛' : item.divisi === 'Besi' ? '🔩' : '🌾';

                    const detail = item.detailBarang || [];
                    const rowSpan = detail.length > 0 ? detail.length : 1;

                    // First row
                    html += `<tr>`;
                    html += `<td class="center" rowspan="${rowSpan}">${index + 1}</td>`;
                    html += `<td rowspan="${rowSpan}">${formatTanggal(item.tanggal)}</td>`;
                    html += `<td rowspan="${rowSpan}"><span class="badge-divisi">${divisiIcon} ${item.divisi || '-'}</span></td>`;
                    html += `<td rowspan="${rowSpan}">${item.noFaktur}</td>`;
                    html += `<td rowspan="${rowSpan}">${item.namaPelanggan || item.pelanggan || '-'}</td>`;

                    if (detail.length > 0) {
                        const first = detail[0];
                        html += `<td>${first.nama}</td>`;
                        html += `<td class="center">${first.qty}</td>`;
                        html += `<td class="number">${formatRupiah(first.harga)}</td>`;
                        html += `<td class="number">${formatRupiah(first.diskon)}</td>`;
                        html += `<td>${first.ppn}</td>`;
                    } else {
                        html += `<td colspan="5" class="center">-</td>`;
                    }

                    html += `<td class="number" rowspan="${rowSpan}">${dp > 0 ? formatRupiah(dp) : '-'}</td>`;
                    html += `<td class="number font-bold" rowspan="${rowSpan}">${formatRupiah(total)}</td>`;
                    html += `<td class="number font-bold ${sisa > 0 ? 'text-red-600' : 'text-green-600'}" rowspan="${rowSpan}">${formatRupiah(sisa)}</td>`;
                    html += `<td class="center action-col" rowspan="${rowSpan}">
                                <div class="action-buttons">
                                    <button class="print-btn" onclick="cetakFakturJual(${item.id})">🖨️</button>
                                    <button class="edit-btn" onclick="editPenjualan(${item.id})">✏️</button>
                                    <button class="delete-btn" onclick="hapusPenjualan(${item.id})">🗑️</button>
                                </div>
                             </td>`;
                    html += `</tr>`;

                    // Subsequent rows
                    for (let i = 1; i < detail.length; i++) {
                        const b = detail[i];
                        html += `<tr>`;
                        html += `<td>${b.nama}</td>`;
                        html += `<td class="center">${b.qty}</td>`;
                        html += `<td class="number">${formatRupiah(b.harga)}</td>`;
                        html += `<td class="number">${formatRupiah(b.diskon)}</td>`;
                        html += `<td>${b.ppn}</td>`;
                        html += `</tr>`;
                    }
                });
            }

            tbody.innerHTML = html;
            document.getElementById('grandTotalJual').textContent = formatRupiah(grandTotal);
        }

        // Display Transaksi Kas
        function displayTransaksiKas() {
            const tbody = document.getElementById('bodyKas');
            // Skip jika elemen tidak ada (form transaksi kas dihapus)
            if (!tbody) return;

            let html = '';
            let totalMasuk = 0;
            let totalKeluar = 0;
            let saldo = 0;

            // Filter - cek apakah elemen ada
            const filterJenisEl = document.getElementById('filterJenisKas');
            const filterMulaiEl = document.getElementById('filterKasMulai');
            const filterSelesaiEl = document.getElementById('filterKasSelesai');

            const jenisFilter = filterJenisEl ? filterJenisEl.value : 'semua';
            const tglMulai = filterMulaiEl ? convertToISODate(filterMulaiEl.value) : null;
            const tglSelesai = filterSelesaiEl ? convertToISODate(filterSelesaiEl.value) : null;

            let filteredData = dataTransaksiKas;

            if (jenisFilter !== 'semua') {
                filteredData = filteredData.filter(k => k.jenis === jenisFilter);
            }

            if (tglMulai && tglSelesai) {
                filteredData = filteredData.filter(k => k.tanggal >= tglMulai && k.tanggal <= tglSelesai);
            }

            // Sort by date
            filteredData.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            if (filteredData.length === 0) {
                html = '<tr><td colspan="9" class="center">Belum ada transaksi kas</td></tr>';
            } else {
                filteredData.forEach((item, index) => {
                    if (item.jenis === 'masuk') {
                        saldo += item.jumlah;
                        totalMasuk += item.jumlah;
                    } else {
                        saldo -= item.jumlah;
                        totalKeluar += item.jumlah;
                    }

                    const badgeClass = item.jenis === 'masuk' ? 'badge-masuk' : 'badge-keluar';
                    const badgeText = item.jenis === 'masuk' ? '➕ MASUK' : '➖ KELUAR';
                    const noJurnal = item.noJurnalHarian || generateNoJurnalKasHarian(item.tanggal, item.jenis);

                    html += `
                        <tr>
                            <td class="center">${index + 1}</td>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td class="text-mono-blue">${noJurnal}</td>
                            <td class="text-mono-blue-small">${item.noTransaksi}</td>
                            <td class="center"><span class="${badgeClass}">${badgeText}</span></td>
                            <td>${item.kategori}</td>
                            <td>${item.keterangan}</td>
                            <td class="number">${item.jenis === 'masuk' ? formatRupiah(item.jumlah) : '-'}</td>
                            <td class="number">${item.jenis === 'keluar' ? formatRupiah(item.jumlah) : '-'}</td>
                            <td class="number font-bold ${saldo >= 0 ? 'bg-success-light' : 'bg-danger-light'}">${formatRupiah(saldo)}</td>
                            <td class="center">
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="editTransaksiKas(${item.id})">✏️</button>
                                    <button class="delete-btn" onclick="hapusTransaksiKas(${item.id})">🗑️</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = html;
            document.getElementById('footerKasMasuk').textContent = formatRupiah(totalMasuk);
            document.getElementById('footerKasKeluar').textContent = formatRupiah(totalKeluar);
            document.getElementById('footerSaldoKas').textContent = formatRupiah(saldo);
        }

        // Update Saldo Kas
        function updateSaldoKas() {
            // Skip jika elemen tidak ada (form transaksi kas dihapus)
            if (!document.getElementById('saldoKas')) return;

            const totalMasuk = dataTransaksiKas
                .filter(k => k.jenis === 'masuk')
                .reduce((sum, item) => sum + item.jumlah, 0);

            const totalKeluar = dataTransaksiKas
                .filter(k => k.jenis === 'keluar')
                .reduce((sum, item) => sum + item.jumlah, 0);

            const saldo = totalMasuk - totalKeluar;

            // Update main cards
            document.getElementById('saldoKas').textContent = formatRupiah(saldo);
            document.getElementById('totalKasMasuk').textContent = formatRupiah(totalMasuk);
            document.getElementById('totalKasKeluar').textContent = formatRupiah(totalKeluar);

            // Update info box
            const saldoKasInfo = document.getElementById('saldoKasInfo');
            if (saldoKasInfo) {
                saldoKasInfo.textContent = formatRupiah(saldo);
                document.getElementById('infoKasMasuk').textContent = formatRupiah(totalMasuk);
                document.getElementById('infoKasKeluar').textContent = formatRupiah(totalKeluar);
            }

            // Update status badge
            const statusBadge = document.getElementById('saldoKasStatus');
            if (statusBadge) {
                if (saldo > 1000000) {
                    statusBadge.textContent = '✓ Sehat';
                    statusBadge.className = 'badge-sehat';
                } else if (saldo >= 0) {
                    statusBadge.textContent = '⚠ Normal';
                    statusBadge.className = 'badge-normal';
                } else {
                    statusBadge.textContent = '✗ Minus';
                    statusBadge.className = 'badge-minus';
                }
            }

            // Update card color based on saldo
            const cardSaldo = document.getElementById('saldoKas').parentElement;
            if (cardSaldo) {
                if (saldo >= 0) {
                    cardSaldo.className = 'card success';
                } else {
                    cardSaldo.className = 'card danger';
                }
            }
        }

        // Hapus Transaksi Kas
        function hapusTransaksiKas(id) {
            if (confirm('Yakin ingin menghapus transaksi kas ini?')) {
                const transaksi = dataTransaksiKas.find(k => k.id === id);
                if (transaksi) {
                    // Hapus jurnal terkait
                    dataJurnal = dataJurnal.filter(j => j.noRef !== transaksi.noTransaksi);
                }

                dataTransaksiKas = dataTransaksiKas.filter(item => item.id !== id);
                saveDataToStorage();
                displayTransaksiKas();
                updateSaldoKas();
                displayJurnal();
                showAlert('alertKas', 'Transaksi kas berhasil dihapus dan jurnal telah diperbarui!', 'danger');
            }
        }

        // Display Pembelian
        function displayPembelian() {
            const tbody = document.getElementById('bodyPembelian');
            let html = '';
            let grandTotal = 0;
            if (dataPembelian.length === 0) {
                html = '<tr><td colspan="14" class="center">Belum ada data pembelian</td></tr>';
            } else {
                dataPembelian.forEach((item, index) => {
                    const dp = item.dp || 0;
                    const total = item.total;
                    grandTotal += total;

                    let dibayar = item.dibayar;
                    if (dibayar === undefined || dibayar === null) {
                        dibayar = total;
                    } else if (item.metodeBayar === 'kredit' && dibayar === 0 && dp > 0) {
                        dibayar = dp;
                    }

                    const sisa = total - dibayar;
                    const divisiIcon = item.divisi === 'Angkutan' ? '🚛' : item.divisi === 'Besi' ? '🔩' : '🌾';

                    const detail = item.detailBarang || [];
                    const rowSpan = detail.length > 0 ? detail.length : 1;

                    // First row
                    html += `<tr>`;
                    html += `<td class="center" rowspan="${rowSpan}">${index + 1}</td>`;
                    html += `<td rowspan="${rowSpan}">${formatTanggal(item.tanggal)}</td>`;
                    html += `<td rowspan="${rowSpan}"><span class="badge-gradient-purple">${divisiIcon} ${item.divisi || '-'}</span></td>`;
                    html += `<td rowspan="${rowSpan}">${item.noFaktur}</td>`;
                    html += `<td rowspan="${rowSpan}">${item.namaSupplier || item.supplier || '-'}</td>`;

                    if (detail.length > 0) {
                        const first = detail[0];
                        html += `<td>${first.nama}</td>`;
                        html += `<td class="center">${first.qty}</td>`;
                        html += `<td class="number">${formatRupiah(first.harga)}</td>`;
                        html += `<td class="number">${formatRupiah(first.diskon)}</td>`;
                        html += `<td>${first.ppn}</td>`;
                    } else {
                        html += `<td colspan="5" class="center">-</td>`;
                    }

                    html += `<td class="number" rowspan="${rowSpan}">${dp > 0 ? formatRupiah(dp) : '-'}</td>`;
                    html += `<td class="number font-bold" rowspan="${rowSpan}">${formatRupiah(total)}</td>`;
                    html += `<td class="number font-bold ${sisa > 0 ? 'text-red-600' : 'text-green-600'}" rowspan="${rowSpan}">${formatRupiah(sisa)}</td>`;
                    html += `<td class="center action-col" rowspan="${rowSpan}">
                                <div class="action-buttons">
                                    <button class="print-btn" onclick="cetakFakturBeli(${item.id})">🖨️</button>
                                    <button class="edit-btn" onclick="editPembelian(${item.id})">✏️</button>
                                    <button class="delete-btn" onclick="hapusPembelian(${item.id})">🗑️</button>
                                </div>
                             </td>`;
                    html += `</tr>`;

                    // Subsequent rows
                    for (let i = 1; i < detail.length; i++) {
                        const b = detail[i];
                        html += `<tr>`;
                        html += `<td>${b.nama}</td>`;
                        html += `<td class="center">${b.qty}</td>`;
                        html += `<td class="number">${formatRupiah(b.harga)}</td>`;
                        html += `<td class="number">${formatRupiah(b.diskon)}</td>`;
                        html += `<td>${b.ppn}</td>`;
                        html += `</tr>`;
                    }
                });
            }
            tbody.innerHTML = html;
            document.getElementById('grandTotalBeli').textContent = formatRupiah(grandTotal);
        }

        // Cetak Jurnal dalam format Excel-like yang rapi
        function cetakJurnalLengkap() {
            const tglMulai = convertToISODate(document.getElementById('filterTglMulai').value);
            const tglSelesai = convertToISODate(document.getElementById('filterTglSelesai').value);

            // Buat array gabungan dari penjualan, pembelian, jurnal, dan transaksi kas
            let allTransactions = [];

            // Tambahkan dari dataPenjualan (sebagai kas masuk)
            let filteredPenjualan = dataPenjualan;
            if (tglMulai && tglSelesai) {
                filteredPenjualan = dataPenjualan.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
            }

            filteredPenjualan.forEach(penjualan => {
                allTransactions.push({
                    tanggal: penjualan.tanggal,
                    noRef: penjualan.noFaktur,
                    keterangan: `Penjualan - ${penjualan.namaPelanggan || penjualan.pelanggan || '-'}`,
                    kategori: 'Penjualan',
                    jenis: 'masuk',
                    jumlah: penjualan.total,
                    source: 'penjualan',
                    id: penjualan.id
                });
            });

            // Tambahkan dari dataPembelian (sebagai kas keluar)
            let filteredPembelian = dataPembelian;
            if (tglMulai && tglSelesai) {
                filteredPembelian = dataPembelian.filter(b => b.tanggal >= tglMulai && b.tanggal <= tglSelesai);
            }

            filteredPembelian.forEach(pembelian => {
                allTransactions.push({
                    tanggal: pembelian.tanggal,
                    noRef: pembelian.noFaktur || pembelian.noPO,
                    keterangan: `Pembelian - ${pembelian.namaSupplier || pembelian.supplier || '-'}`,
                    kategori: 'Pembelian',
                    jenis: 'keluar',
                    jumlah: pembelian.total,
                    source: 'pembelian',
                    id: pembelian.id
                });
            });

            // Tambahkan dari dataJurnal (penjualan, pembelian, dll)
            let filteredJurnal = dataJurnal;
            if (tglMulai && tglSelesai) {
                filteredJurnal = dataJurnal.filter(j => j.tanggal >= tglMulai && j.tanggal <= tglSelesai);
            }

            filteredJurnal.forEach(jurnal => {
                // Hindari duplikasi: Jangan tambahkan jurnal jika transaksi aslinya sudah ada di list (dari Penjualan/Pembelian/Kas)
                if (jurnal.noRef && allTransactions.some(t => t.noRef === jurnal.noRef && (t.source === 'penjualan' || t.source === 'pembelian' || t.source === 'kas'))) return;

                // Dari jurnal, hanya ambil total kas (debit untuk masuk, kredit untuk keluar)
                let totalJumlah = 0;
                let jenisKas = null;

                jurnal.entries.forEach(entry => {
                    if (entry.akun === 'Kas') {
                        if (entry.debit > 0) {
                            jenisKas = 'masuk';
                            totalJumlah = entry.debit;
                        } else if (entry.kredit > 0) {
                            jenisKas = 'keluar';
                            totalJumlah = entry.kredit;
                        }
                    }
                });

                if (totalJumlah > 0 && jenisKas) {
                    allTransactions.push({
                        tanggal: jurnal.tanggal,
                        noRef: jurnal.noRef,
                        keterangan: jurnal.keterangan,
                        kategori: 'Jurnal',
                        jenis: jenisKas,
                        jumlah: totalJumlah,
                        source: 'jurnal',
                        id: jurnal.id
                    });
                }
            });

            // Tambahkan dari dataTransaksiKas
            let filteredKas = dataTransaksiKas;
            if (tglMulai && tglSelesai) {
                filteredKas = dataTransaksiKas.filter(k => k.tanggal >= tglMulai && k.tanggal <= tglSelesai);
            }

            filteredKas.forEach(kas => {
                allTransactions.push({
                    tanggal: kas.tanggal,
                    noRef: kas.noTransaksi || kas.noJurnalHarian,
                    keterangan: `${kas.jenis === 'masuk' ? 'Kas Masuk' : 'Kas Keluar'} - ${kas.keterangan}`,
                    kategori: kas.kategori,
                    jenis: kas.jenis,
                    jumlah: kas.jumlah,
                    source: 'kas',
                    id: kas.id
                });
            });

            // Sort by date
            allTransactions.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            // Kalkulasi totals
            let totalMasuk = 0;
            let totalKeluar = 0;
            let saldo = 0;

            allTransactions.forEach(trans => {
                if (trans.jenis === 'masuk') {
                    totalMasuk += trans.jumlah;
                    saldo += trans.jumlah;
                } else {
                    totalKeluar += trans.jumlah;
                    saldo -= trans.jumlah;
                }
            });

            // Buat HTML cetak
            const tglSekarang = new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
            const tglMulaiStr = tglMulai ? formatTanggal(tglMulai) : 'Awal';
            const tglSelesaiStr = tglSelesai ? formatTanggal(tglSelesai) : 'Akhir';

            let printHTML = `
                <!DOCTYPE html>
                <html lang="id">
                <head>
                    <meta charset="UTF-8">
                    <title>Laporan Jurnal Umum - PT. Sumber Ganda Mekar</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: "Inter", "Segoe UI", Arial, sans-serif; padding: 20px; background: white; color: #1e293b; }
                        h1 { font-size: 18pt; margin: 0 0 5px 0; text-align: center; color: #1e293b; font-weight: 700; }
                        h2 { font-size: 14pt; margin: 0 0 5px 0; text-align: center; color: #64748b; font-weight: 600; }
                        .periode { text-align: center; color: #64748b; margin-bottom: 20px; font-size: 10pt; }
                        
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10pt; }
                        th, td { border: 1px solid #e2e8f0; padding: 8px 12px; text-align: left; }
                        th { background-color: #f8fafc; color: #1e293b; font-weight: 600; text-transform: uppercase; font-size: 9pt; letter-spacing: 0.05em; }
                        
                        .number { text-align: right; font-family: "JetBrains Mono", Consolas, monospace; }
                        .center { text-align: center; }
                        .text-mono-xs { font-family: "JetBrains Mono", monospace; font-size: 9px; color: #64748b; }
                        .text-red { color: #ef4444; }
                        
                        .total-row { background-color: #f1f5f9 !important; font-weight: bold; border-top: 2px solid #cbd5e1; }
                        
                        .badge { padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: bold; display: inline-block; }
                        .badge-masuk { background-color: #dcfce7; color: #166534; border: 1px solid #bbb; }
                        .badge-keluar { background-color: #fee2e2; color: #991b1b; border: 1px solid #bbb; }
                        
                        .summary { margin-top: 20px; display: flex; justify-content: space-around; gap: 20px; }
                        .summary-card { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; flex: 1; }
                        .summary-card strong { display: block; font-size: 0.9em; color: #64748b; margin-bottom: 5px; }
                        .summary-card div { font-size: 1.2em; font-weight: bold; color: #1e293b; font-family: "JetBrains Mono", monospace; }
                        
                        .bg-green-light { background-color: #f0fdf4; }
                        .bg-red-light { background-color: #fef2f2; }
                        
                        .footer { margin-top: 30px; text-align: right; font-size: 9pt; color: #94a3b8; font-style: italic; }
                        .signature-row { display: flex; justify-content: space-around; margin-top: 50px; font-size: 10pt; }
                        .signature-box { text-align: center; width: 200px; }
                        .signature-line { border-top: 1px solid #333; margin-top: 60px; margin-bottom: 5px; height: 1px; }

                        /* Utility Widths */
                        .w-4 { width: 40px; }
                        .w-10 { width: 100px; }
                        .w-12 { width: 120px; }
                        .w-25 { width: 25%; }
                        
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none; }
                            .summary-card { border: 1px solid #cbd5e1; }
                            th { background-color: #f1f5f9 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .badge-masuk { border: 1px solid #166534; }
                            .badge-keluar { border: 1px solid #991b1b; }
                            .bg-green-light { background-color: #f0fdf4 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .bg-red-light { background-color: #fef2f2 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .total-row { background-color: #f1f5f9 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <h1>PT. SUMBER GANDA MEKAR</h1>
                    <h2>LAPORAN BUKU JURNAL UMUM</h2>
                    <div class="periode">Periode: ${tglMulaiStr} s/d ${tglSelesaiStr}</div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th class="center w-4">No</th>
                                <th class="center w-10">Tanggal</th>
                                <th class="center w-10">No.Ref</th>
                                <th class="w-25">Keterangan</th>
                                <th class="center w-10">Kategori</th>
                                <th class="center w-10">Jenis</th>
                                <th class="number w-12">Kas Masuk</th>
                                <th class="number w-12">Kas Keluar</th>
                                <th class="number w-12">Saldo</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            let no = 1;
            saldo = 0;

            allTransactions.forEach((trans) => {
                if (trans.jenis === 'masuk') {
                    saldo += trans.jumlah;
                } else {
                    saldo -= trans.jumlah;
                }

                const masukRp = trans.jenis === 'masuk' ? formatRupiah(trans.jumlah) : '-';
                const keluarRp = trans.jenis === 'keluar' ? formatRupiah(trans.jumlah) : '-';
                const saldoRp = formatRupiah(saldo);
                const saldoClass = saldo >= 0 ? '' : 'text-red';
                const badgeClass = trans.jenis === 'masuk' ? 'badge badge-masuk' : 'badge badge-keluar';

                printHTML += `
                    <tr>
                        <td class="center">${no}</td>
                        <td class="center">${formatTanggal(trans.tanggal)}</td>
                        <td class="center text-mono-xs">${trans.noRef || '-'}</td>
                        <td>${trans.keterangan}</td>
                        <td class="center">${trans.kategori || '-'}</td>
                        <td class="center"><span class="${badgeClass}">${trans.jenis === 'masuk' ? 'MASUK' : 'KELUAR'}</span></td>
                        <td class="number">${masukRp}</td>
                        <td class="number">${keluarRp}</td>
                        <td class="number ${saldoClass}"><strong>${saldoRp}</strong></td>
                    </tr>
                `;
                no++;
            });

            const totalMasukRp = formatRupiah(totalMasuk);
            const totalKeluarRp = formatRupiah(totalKeluar);
            const saldoAkhirRp = formatRupiah(saldo);

            printHTML += `
                    <tr class="total-row">
                        <td colspan="6" class="center">TOTAL</td>
                        <td class="number">${totalMasukRp}</td>
                        <td class="number">${totalKeluarRp}</td>
                        <td class="number">${saldoAkhirRp}</td>
                    </tr>
                </tbody>
            </table>

            <div class="summary">
                <div class="summary-card bg-green-light">
                    <strong>Total Kas Masuk</strong>
                    <div>${totalMasukRp}</div>
                </div>
                <div class="summary-card bg-red-light">
                    <strong>Total Kas Keluar</strong>
                    <div>${totalKeluarRp}</div>
                </div>
                <div class="summary-card">
                    <strong>Saldo Akhir</strong>
                    <div class="${saldo < 0 ? 'text-red' : ''}">${saldoAkhirRp}</div>
                </div>
            </div>

            <div class="signature-row">
                <div class="signature-box">
                    <p>Pembuat Jurnal,</p>
                    <div class="signature-line"></div>
                    <p>(__________________)</p>
                </div>
                <div class="signature-box">
                    <p>Diperiksa,</p>
                    <div class="signature-line"></div>
                    <p>(__________________)</p>
                </div>
                <div class="signature-box">
                    <p>Disetujui,</p>
                    <div class="signature-line"></div>
                    <p>(__________________)</p>
                </div>
            </div>
            
            <div class="footer">Dicetak pada: ${tglSekarang}</div>

            </body>
            </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHTML);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // Display Jurnal
        function displayJurnal() {
            const tbody = document.getElementById('bodyJurnal');
            // Skip jika elemen tidak ada (form jurnal dihapus)
            if (!tbody) return;

            let html = '';
            let totalMasuk = 0;
            let totalKeluar = 0;
            let saldo = 0;
            let no = 1;

            // Filter jurnal - cek apakah elemen ada
            const filterMulaiEl = document.getElementById('filterTglMulai');
            const filterSelesaiEl = document.getElementById('filterTglSelesai');
            const tglMulai = filterMulaiEl ? convertToISODate(filterMulaiEl.value) : null;
            const tglSelesai = filterSelesaiEl ? convertToISODate(filterSelesaiEl.value) : null;

            // Buat array gabungan dari penjualan, pembelian, jurnal, dan transaksi kas
            let allTransactions = [];

            // Tambahkan dari dataPenjualan (sebagai kas masuk)
            let filteredPenjualan = dataPenjualan;
            if (tglMulai && tglSelesai) {
                filteredPenjualan = dataPenjualan.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
            }

            filteredPenjualan.forEach(penjualan => {
                allTransactions.push({
                    tanggal: penjualan.tanggal,
                    noRef: penjualan.noFaktur,
                    keterangan: `Penjualan - ${penjualan.namaPelanggan || penjualan.pelanggan || '-'}`,
                    kategori: 'Penjualan',
                    jenis: 'masuk',
                    jumlah: penjualan.total,
                    source: 'penjualan',
                    id: penjualan.id
                });
            });

            // Tambahkan dari dataPembelian (sebagai kas keluar)
            let filteredPembelian = dataPembelian;
            if (tglMulai && tglSelesai) {
                filteredPembelian = dataPembelian.filter(b => b.tanggal >= tglMulai && b.tanggal <= tglSelesai);
            }

            filteredPembelian.forEach(pembelian => {
                allTransactions.push({
                    tanggal: pembelian.tanggal,
                    noRef: pembelian.noFaktur || pembelian.noPO,
                    keterangan: `Pembelian - ${pembelian.namaSupplier || pembelian.supplier || '-'}`,
                    kategori: 'Pembelian',
                    jenis: 'keluar',
                    jumlah: pembelian.total,
                    source: 'pembelian',
                    id: pembelian.id
                });
            });

            // Tambahkan dari dataJurnal (penjualan, pembelian, dll)
            let filteredJurnal = dataJurnal;
            if (tglMulai && tglSelesai) {
                filteredJurnal = dataJurnal.filter(j => j.tanggal >= tglMulai && j.tanggal <= tglSelesai);
            }

            filteredJurnal.forEach(jurnal => {
                // Hindari duplikasi: Jangan tambahkan jurnal jika transaksi aslinya sudah ada di list (dari Penjualan/Pembelian/Kas)
                if (jurnal.noRef && allTransactions.some(t => t.noRef === jurnal.noRef && (t.source === 'penjualan' || t.source === 'pembelian' || t.source === 'kas'))) return;

                // Dari jurnal, hanya ambil total kas (debit untuk masuk, kredit untuk keluar)
                let totalJumlah = 0;
                let jenisKas = null;

                jurnal.entries.forEach(entry => {
                    if (entry.akun === 'Kas') {
                        if (entry.debit > 0) {
                            jenisKas = 'masuk';
                            totalJumlah = entry.debit;
                        } else if (entry.kredit > 0) {
                            jenisKas = 'keluar';
                            totalJumlah = entry.kredit;
                        }
                    }
                });

                if (totalJumlah > 0 && jenisKas) {
                    allTransactions.push({
                        tanggal: jurnal.tanggal,
                        noRef: jurnal.noRef,
                        keterangan: jurnal.keterangan,
                        kategori: 'Jurnal',
                        jenis: jenisKas,
                        jumlah: totalJumlah,
                        source: 'jurnal',
                        id: jurnal.id
                    });
                }
            });

            // Tambahkan dari dataTransaksiKas
            let filteredKas = dataTransaksiKas;
            if (tglMulai && tglSelesai) {
                filteredKas = dataTransaksiKas.filter(k => k.tanggal >= tglMulai && k.tanggal <= tglSelesai);
            }

            filteredKas.forEach(kas => {
                allTransactions.push({
                    tanggal: kas.tanggal,
                    noRef: kas.noTransaksi || kas.noJurnalHarian,
                    keterangan: `${kas.jenis === 'masuk' ? 'Kas Masuk' : 'Kas Keluar'} - ${kas.keterangan}`,
                    kategori: kas.kategori,
                    jenis: kas.jenis,
                    jumlah: kas.jumlah,
                    source: 'kas',
                    id: kas.id
                });
            });

            // Sort by date
            allTransactions.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            if (allTransactions.length === 0) {
                html = '<tr><td colspan="10" class="center">Belum ada transaksi</td></tr>';
            } else {
                allTransactions.forEach((trans) => {
                    if (trans.jenis === 'masuk') {
                        totalMasuk += trans.jumlah;
                        saldo += trans.jumlah;
                    } else {
                        totalKeluar += trans.jumlah;
                        saldo -= trans.jumlah;
                    }

                    const badgeClass = trans.jenis === 'masuk' ? 'badge-masuk' : 'badge-keluar';
                    const badgeText = trans.jenis === 'masuk' ? '➕ MASUK' : '➖ KELUAR';
                    const bgSaldo = saldo >= 0 ? 'bg-success-light' : 'bg-danger-light';

                    html += `
                        <tr>
                            <td class="center">${no}</td>
                            <td>${formatTanggal(trans.tanggal)}</td>
                            <td class="text-mono-blue">${trans.noRef || '-'}</td>
                            <td>${trans.keterangan}</td>
                            <td>${trans.kategori || '-'}</td>
                            <td class="center"><span class="${badgeClass}">${badgeText}</span></td>
                            <td class="number">${trans.jenis === 'masuk' ? formatRupiah(trans.jumlah) : '-'}</td>
                            <td class="number">${trans.jenis === 'keluar' ? formatRupiah(trans.jumlah) : '-'}</td>
                            <td class="number font-bold ${bgSaldo}">${formatRupiah(saldo)}</td>
                            <td class="center">
                                <div class="action-buttons">
                                    ${trans.source === 'penjualan' ? `<button class="edit-btn" onclick="editPenjualan(${trans.id})" title="Edit">✏️</button>` : ''}
                                    ${trans.source === 'pembelian' ? `<button class="edit-btn" onclick="editPembelian(${trans.id})" title="Edit">✏️</button>` : ''}
                                    ${trans.source === 'jurnal' ? `<button class="delete-btn" onclick="hapusJurnal(${trans.id})" title="Hapus">🗑️</button>` : ''}
                                    ${trans.source === 'kas' ? `<button class="edit-btn" onclick="editTransaksiKas(${trans.id})" title="Edit">✏️</button><button class="delete-btn" onclick="hapusTransaksiKas(${trans.id})" title="Hapus">🗑️</button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `;

                    no++;
                });
            }

            tbody.innerHTML = html;
            document.getElementById('totalDebit').textContent = formatRupiah(totalMasuk);
            document.getElementById('totalKredit').textContent = formatRupiah(totalKeluar);
            document.getElementById('totalSaldo').textContent = formatRupiah(saldo);
        }

        // Edit Jurnal
        function editJurnal(id) {
            const jurnal = dataJurnal.find(j => j.id === id);
            if (!jurnal) {
                alert('Data jurnal tidak ditemukan!');
                return;
            }

            document.getElementById('editIdJurnal').value = jurnal.id;
            document.getElementById('editTglJurnal').value = formatTanggal(jurnal.tanggal);
            document.getElementById('editNoRefJurnal').value = jurnal.noRef;
            document.getElementById('editKetJurnal').value = jurnal.keterangan;

            // Render entries
            renderEntryJurnal(jurnal.entries);

            openModal('modalEditJurnal');
        }

        // Render entry jurnal dalam modal edit
        function renderEntryJurnal(entries) {
            const container = document.getElementById('containerEntryJurnal');
            let html = '';

            entries.forEach((entry, index) => {
                html += `
                    <div class="entry-row jurnal-entry-grid">
                        <input type="text" class="entry-akun p-2" value="${entry.akun}" placeholder="Nama Akun" required>
                        <input type="text" class="entry-debit p-2" value="${entry.debit > 0 ? formatRupiah(entry.debit) : ''}" placeholder="Debit" oninput="formatRupiahInput(this); hitungTotalEntryJurnal()">
                        <input type="text" class="entry-kredit p-2" value="${entry.kredit > 0 ? formatRupiah(entry.kredit) : ''}" placeholder="Kredit" oninput="formatRupiahInput(this); hitungTotalEntryJurnal()">
                        <button type="button" class="btn btn-danger btn-sm" onclick="hapusEntryJurnal(this)">✕</button>
                    </div>
                `;
            });

            container.innerHTML = html;
            hitungTotalEntryJurnal();
        }

        // Tambah entry baru
        function tambahEntryJurnal() {
            const container = document.getElementById('containerEntryJurnal');
            const div = document.createElement('div');
            div.className = 'entry-row jurnal-entry-grid';
            div.innerHTML = `
                <input type="text" class="entry-akun p-2" value="" placeholder="Nama Akun" required>
                <input type="text" class="entry-debit p-2" value="" placeholder="Debit" oninput="formatRupiahInput(this); hitungTotalEntryJurnal()">
                <input type="text" class="entry-kredit p-2" value="" placeholder="Kredit" oninput="formatRupiahInput(this); hitungTotalEntryJurnal()">
                <button type="button" class="btn btn-danger btn-sm" onclick="hapusEntryJurnal(this)">✕</button>
            `;
            container.appendChild(div);
        }

        // Hapus entry
        function hapusEntryJurnal(btn) {
            const container = document.getElementById('containerEntryJurnal');
            if (container.querySelectorAll('.entry-row').length > 1) {
                btn.parentElement.remove();
                hitungTotalEntryJurnal();
            } else {
                alert('Minimal harus ada 1 entry!');
            }
        }

        // Hitung total debit dan kredit
        function hitungTotalEntryJurnal() {
            const debits = document.querySelectorAll('.entry-debit');
            const kredits = document.querySelectorAll('.entry-kredit');

            let totalDebit = 0;
            let totalKredit = 0;

            debits.forEach(input => {
                totalDebit += parseRupiah(input.value) || 0;
            });

            kredits.forEach(input => {
                totalKredit += parseRupiah(input.value) || 0;
            });

            document.getElementById('editTotalDebit').textContent = formatRupiah(totalDebit);
            document.getElementById('editTotalKredit').textContent = formatRupiah(totalKredit);

            // Warning jika tidak balance
            const debitEl = document.getElementById('editTotalDebit');
            const kreditEl = document.getElementById('editTotalKredit');

            if (totalDebit !== totalKredit) {
                debitEl.classList.remove('text-primary', 'text-success');
                debitEl.classList.add('text-danger');

                kreditEl.classList.remove('text-primary', 'text-success');
                kreditEl.classList.add('text-danger');
            } else {
                debitEl.classList.remove('text-danger');
                debitEl.classList.add('text-primary');

                kreditEl.classList.remove('text-danger');
                kreditEl.classList.add('text-success');
            }
        }

        // Submit edit jurnal
        function submitEditJurnal(e) {
            e.preventDefault();

            const id = parseInt(document.getElementById('editIdJurnal').value);
            const index = dataJurnal.findIndex(j => j.id === id);

            if (index === -1) {
                alert('Data jurnal tidak ditemukan!');
                return false;
            }

            // Collect entries
            const entries = [];
            const rows = document.querySelectorAll('#containerEntryJurnal .entry-row');

            rows.forEach(row => {
                const akun = row.querySelector('.entry-akun').value.trim();
                const debit = parseRupiah(row.querySelector('.entry-debit').value) || 0;
                const kredit = parseRupiah(row.querySelector('.entry-kredit').value) || 0;

                if (akun && (debit > 0 || kredit > 0)) {
                    entries.push({ akun, debit, kredit });
                }
            });

            if (entries.length === 0) {
                alert('Minimal harus ada 1 entry dengan nilai!');
                return false;
            }

            // Check balance
            const totalDebit = entries.reduce((sum, e) => sum + e.debit, 0);
            const totalKredit = entries.reduce((sum, e) => sum + e.kredit, 0);

            if (totalDebit !== totalKredit) {
                if (!confirm(`Total Debit (${formatRupiah(totalDebit)}) tidak sama dengan Total Kredit (${formatRupiah(totalKredit)}).\n\nYakin ingin menyimpan jurnal yang tidak balance?`)) {
                    return false;
                }
            }

            // Update jurnal
            const tglInput = document.getElementById('editTglJurnal').value;
            dataJurnal[index].tanggal = convertToISODate(tglInput);
            dataJurnal[index].noRef = document.getElementById('editNoRefJurnal').value;
            dataJurnal[index].keterangan = document.getElementById('editKetJurnal').value;
            dataJurnal[index].entries = entries;

            saveDataToStorage();
            displayJurnal();
            closeModal('modalEditJurnal');
            alert('✅ Data jurnal berhasil diupdate!');

            return false;
        }

        // Hapus Jurnal
        function hapusJurnal(id) {
            const jurnal = dataJurnal.find(j => j.id === id);
            if (!jurnal) {
                alert('Data jurnal tidak ditemukan!');
                return;
            }

            if (confirm(`Yakin ingin menghapus jurnal?\n\nNo. Ref: ${jurnal.noRef}\nKeterangan: ${jurnal.keterangan}`)) {
                dataJurnal = dataJurnal.filter(j => j.id !== id);
                saveDataToStorage();
                displayJurnal();
                alert('✅ Data jurnal berhasil dihapus!');
            }
        }

        // Hapus Semua Jurnal
        function hapusSemuaJurnal() {
            if (!confirm('⚠️ PERHATIAN!\n\nAnda akan menghapus SEMUA data jurnal.\nTindakan ini tidak dapat dibatalkan.\n\nYakin ingin melanjutkan?')) {
                return;
            }

            if (!confirm('Hapus ' + dataJurnal.length + ' jurnal?\n\nKlik OK untuk konfirmasi akhir.')) {
                return;
            }

            dataJurnal = [];
            saveDataToStorage();
            displayJurnal();
            alert('✅ Semua data jurnal berhasil dihapus!');
        }

        // Generate Ulang Jurnal dari semua transaksi
        function generateUlangJurnal() {
            if (!confirm('Generate ulang jurnal akan menghapus semua data jurnal yang ada dan membuat ulang dari semua transaksi.\n\nLanjutkan?')) {
                return;
            }

            // Kosongkan jurnal
            dataJurnal = [];

            // 1. Generate jurnal dari semua penjualan
            dataPenjualan.forEach(transaksi => {
                buatJurnalPenjualan(transaksi);
            });

            // 2. Generate jurnal dari semua pembelian
            dataPembelian.forEach(transaksi => {
                buatJurnalPembelian(transaksi);
            });

            // 3. Generate jurnal dari semua kas masuk
            dataTransaksiKas.filter(k => k.jenis === 'masuk').forEach(transaksi => {
                buatJurnalKasMasuk(transaksi);
            });

            // 4. Generate jurnal dari semua kas keluar
            dataTransaksiKas.filter(k => k.jenis === 'keluar').forEach(transaksi => {
                buatJurnalKasKeluar(transaksi);
            });

            // 5. Generate jurnal dari pembayaran piutang
            dataPembayaranPiutang.forEach(pembayaran => {
                const jurnal = {
                    id: Date.now() + Math.random(),
                    tanggal: pembayaran.tanggal,
                    noRef: `BP-${pembayaran.noFaktur}`,
                    keterangan: `Pembayaran piutang ${pembayaran.pelanggan} - ${pembayaran.noFaktur}`,
                    entries: [
                        {
                            akun: 'Kas',
                            debit: pembayaran.jumlah,
                            kredit: 0
                        },
                        {
                            akun: 'Piutang Usaha',
                            debit: 0,
                            kredit: pembayaran.jumlah
                        }
                    ]
                };
                dataJurnal.push(jurnal);
            });

            // 6. Generate jurnal dari pembayaran hutang
            dataPembayaranHutang.forEach(pembayaran => {
                const jurnal = {
                    id: Date.now() + Math.random(),
                    tanggal: pembayaran.tanggal,
                    noRef: `BH-${pembayaran.noFaktur}`,
                    keterangan: `Pembayaran hutang ${pembayaran.supplier} - ${pembayaran.noFaktur}`,
                    entries: [
                        {
                            akun: 'Hutang Usaha',
                            debit: pembayaran.jumlah,
                            kredit: 0
                        },
                        {
                            akun: 'Kas',
                            debit: 0,
                            kredit: pembayaran.jumlah
                        }
                    ]
                };
                dataJurnal.push(jurnal);
            });

            // Urutkan jurnal berdasarkan tanggal
            dataJurnal.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            // Simpan dan update tampilan
            saveDataToStorage();
            displayJurnal();

            alert(`Berhasil generate ${dataJurnal.length} jurnal dari semua transaksi!`);
        }

        // Display Buku Besar
        function displayBukuBesar() {
            // Skip jika elemen tidak ada (form buku besar dihapus)
            const filterAkunEl = document.getElementById('filterAkunBukuBesar');
            if (!filterAkunEl) return;

            const filterAkun = filterAkunEl.value;
            const filterMulaiEl = document.getElementById('filterBukuBesarMulai');
            const filterSelesaiEl = document.getElementById('filterBukuBesarSelesai');
            const tglMulai = filterMulaiEl ? convertToISODate(filterMulaiEl.value) : null;
            const tglSelesai = filterSelesaiEl ? convertToISODate(filterSelesaiEl.value) : null;

            // Update periode label
            let periodeText = 'Semua Periode';
            if (tglMulai && tglSelesai) {
                periodeText = `Periode ${formatTanggal(tglMulai)} s/d ${formatTanggal(tglSelesai)}`;
            }
            const periodeLabel = document.getElementById('periodeBukuBesar');
            if (periodeLabel) periodeLabel.textContent = periodeText;

            // Filter jurnal berdasarkan periode
            let filteredJurnal = dataJurnal;
            if (tglMulai && tglSelesai) {
                filteredJurnal = dataJurnal.filter(j => j.tanggal >= tglMulai && j.tanggal <= tglSelesai);
            }

            // Kumpulkan semua transaksi per akun
            const bukuBesar = {};

            filteredJurnal.forEach(jurnal => {
                jurnal.entries.forEach(entry => {
                    if (!bukuBesar[entry.akun]) {
                        bukuBesar[entry.akun] = [];
                    }

                    bukuBesar[entry.akun].push({
                        tanggal: jurnal.tanggal,
                        noRef: jurnal.noRef,
                        keterangan: jurnal.keterangan,
                        debit: entry.debit,
                        kredit: entry.kredit,
                        sumber: 'Jurnal'
                    });
                });
            });

            // Tambahkan transaksi dari penjualan
            let filteredPenjualan = dataPenjualan;
            if (tglMulai && tglSelesai) {
                filteredPenjualan = dataPenjualan.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
            }

            filteredPenjualan.forEach(penjualan => {
                // Ambil nama barang dari detailBarang
                let namaBarang = '';
                if (penjualan.detailBarang && penjualan.detailBarang.length > 0) {
                    namaBarang = ' (' + penjualan.detailBarang.map(b => b.nama).join(', ') + ')';
                }

                if (!bukuBesar['Penjualan']) bukuBesar['Penjualan'] = [];
                bukuBesar['Penjualan'].push({
                    tanggal: penjualan.tanggal,
                    noRef: penjualan.noFaktur,
                    keterangan: `Penjualan - ${penjualan.namaPelanggan || '-'}${namaBarang}`,
                    debit: 0,
                    kredit: penjualan.total,
                    sumber: 'Penjualan',
                    divisi: penjualan.divisi
                });

                if (!bukuBesar['Kas']) bukuBesar['Kas'] = [];
                if (penjualan.metodeBayar === 'tunai') {
                    bukuBesar['Kas'].push({
                        tanggal: penjualan.tanggal,
                        noRef: penjualan.noFaktur,
                        keterangan: `Penjualan Tunai - ${penjualan.namaPelanggan || '-'}${namaBarang}`,
                        debit: penjualan.total,
                        kredit: 0,
                        sumber: 'Penjualan',
                        divisi: penjualan.divisi
                    });
                }

                // Tambahkan piutang jika kredit
                if (penjualan.metodeBayar === 'kredit' && penjualan.sisa > 0) {
                    if (!bukuBesar['Piutang Usaha']) bukuBesar['Piutang Usaha'] = [];
                    bukuBesar['Piutang Usaha'].push({
                        tanggal: penjualan.tanggal,
                        noRef: penjualan.noFaktur,
                        keterangan: `Piutang - ${penjualan.namaPelanggan || '-'}${namaBarang}`,
                        debit: penjualan.sisa,
                        kredit: 0,
                        sumber: 'Penjualan',
                        divisi: penjualan.divisi
                    });
                }
            });

            // Tambahkan transaksi dari pembelian
            let filteredPembelian = dataPembelian;
            if (tglMulai && tglSelesai) {
                filteredPembelian = dataPembelian.filter(b => b.tanggal >= tglMulai && b.tanggal <= tglSelesai);
            }

            filteredPembelian.forEach(pembelian => {
                // Ambil nama barang dari detailBarang
                let namaBarang = '';
                if (pembelian.detailBarang && pembelian.detailBarang.length > 0) {
                    namaBarang = ' (' + pembelian.detailBarang.map(b => b.nama).join(', ') + ')';
                }

                if (!bukuBesar['Pembelian']) bukuBesar['Pembelian'] = [];
                bukuBesar['Pembelian'].push({
                    tanggal: pembelian.tanggal,
                    noRef: pembelian.noFaktur || pembelian.noPO,
                    keterangan: `Pembelian - ${pembelian.namaSupplier || '-'}${namaBarang}`,
                    debit: pembelian.total,
                    kredit: 0,
                    sumber: 'Pembelian',
                    divisi: pembelian.divisi
                });

                if (!bukuBesar['Kas']) bukuBesar['Kas'] = [];
                if (pembelian.metodeBayar === 'tunai') {
                    bukuBesar['Kas'].push({
                        tanggal: pembelian.tanggal,
                        noRef: pembelian.noFaktur || pembelian.noPO,
                        keterangan: `Pembelian Tunai - ${pembelian.namaSupplier || '-'}${namaBarang}`,
                        debit: 0,
                        kredit: pembelian.total,
                        sumber: 'Pembelian',
                        divisi: pembelian.divisi
                    });
                }

                // Tambahkan hutang jika kredit
                if (pembelian.metodeBayar === 'kredit' && pembelian.sisa > 0) {
                    if (!bukuBesar['Hutang Usaha']) bukuBesar['Hutang Usaha'] = [];
                    bukuBesar['Hutang Usaha'].push({
                        tanggal: pembelian.tanggal,
                        noRef: pembelian.noFaktur || pembelian.noPO,
                        keterangan: `Hutang - ${pembelian.namaSupplier || '-'}${namaBarang}`,
                        debit: 0,
                        kredit: pembelian.sisa,
                        sumber: 'Pembelian',
                        divisi: pembelian.divisi
                    });
                }
            });

            // Tambahkan transaksi dari transaksi kas
            let filteredKas = dataTransaksiKas;
            if (tglMulai && tglSelesai) {
                filteredKas = dataTransaksiKas.filter(k => k.tanggal >= tglMulai && k.tanggal <= tglSelesai);
            }

            filteredKas.forEach(kas => {
                if (!bukuBesar['Kas']) bukuBesar['Kas'] = [];
                if (kas.jenis === 'masuk') {
                    bukuBesar['Kas'].push({
                        tanggal: kas.tanggal,
                        noRef: kas.noTransaksi,
                        keterangan: `Kas Masuk - ${kas.kategori}: ${kas.keterangan}`,
                        debit: kas.jumlah,
                        kredit: 0,
                        sumber: 'Kas Masuk',
                        divisi: kas.divisi || '-'
                    });
                } else {
                    bukuBesar['Kas'].push({
                        tanggal: kas.tanggal,
                        noRef: kas.noTransaksi,
                        keterangan: `Kas Keluar - ${kas.kategori}: ${kas.keterangan}`,
                        debit: 0,
                        kredit: kas.jumlah,
                        sumber: 'Kas Keluar',
                        divisi: kas.divisi || '-'
                    });
                }
            });

            // Generate HTML untuk setiap akun
            // Simpan data untuk keperluan ekspor
            window.currentBukuBesarData = bukuBesar;
            window.currentBukuBesarSelected = selectedAkun;

            const container = document.getElementById('bukuBesarAkun');
            let html = '';

            // Urutkan akun dengan urutan tertentu
            const urutanAkun = ['Kas', 'Piutang Usaha', 'Hutang Usaha', 'Penjualan', 'Pembelian', 'Pendapatan Penjualan', 'Persediaan Barang', 'Beban Operasional'];
            const akunList = Object.keys(bukuBesar).sort((a, b) => {
                const idxA = urutanAkun.indexOf(a);
                const idxB = urutanAkun.indexOf(b);
                if (idxA === -1 && idxB === -1) return a.localeCompare(b);
                if (idxA === -1) return 1;
                if (idxB === -1) return -1;
                return idxA - idxB;
            });

            // Filter akun jika dipilih
            const selectedAkun = filterAkun === 'semua' ? akunList : akunList.filter(a => a === filterAkun);

            if (selectedAkun.length === 0) {
                html = '<div class="text-center p-40px text-muted"><h3>📭 Tidak ada data untuk akun yang dipilih</h3><p>Silakan pilih akun lain atau reset filter</p></div>';
            } else {
                let grandTotalDebit = 0;
                let grandTotalKredit = 0;
                let grandSaldoAkhir = 0;
                let akunNo = 1;

                selectedAkun.forEach(akun => {
                    const transaksi = bukuBesar[akun];
                    let saldo = 0;
                    let saldoAwal = 0;
                    let totalDebit = 0;
                    let totalKredit = 0;

                    // Urutkan transaksi berdasarkan tanggal
                    transaksi.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

                    // Hitung total dulu untuk summary
                    transaksi.forEach(item => {
                        totalDebit += item.debit;
                        totalKredit += item.kredit;
                    });
                    let saldoAkhir = totalDebit - totalKredit;

                    // Tentukan icon dan warna berdasarkan jenis akun
                    let akunIcon = '📊';
                    let akunClass = 'header-default';

                    if (akun === 'Kas') { akunIcon = '💵'; akunClass = 'header-kas'; }
                    else if (akun === 'Piutang Usaha') { akunIcon = '📋'; akunClass = 'header-piutang'; }
                    else if (akun === 'Hutang Usaha') { akunIcon = '📝'; akunClass = 'header-hutang'; }
                    else if (akun === 'Penjualan' || akun === 'Pendapatan Penjualan') { akunIcon = '💰'; akunClass = 'header-penjualan'; }
                    else if (akun === 'Pembelian' || akun === 'Persediaan Barang') { akunIcon = '🛒'; akunClass = 'header-pembelian'; }
                    else if (akun.includes('Beban')) { akunIcon = '💸'; akunClass = 'header-beban'; }

                    html += `
                        <div class="card mb-4 overflow-hidden shadow-sm border-bbb">
                            <!-- Header Akun -->
                            <div class="${akunClass} text-white p-3 d-flex justify-between items-center">
                                <div>
                                    <span class="text-xl mr-2">${akunIcon}</span>
                                    <span class="font-bold text-uppercase text-md tracking-wide">
                                        ${akunNo}. AKUN: ${akun}
                                    </span>
                                </div>
                                <div class="text-xs opacity-90">
                                    ${transaksi.length} transaksi
                                </div>
                            </div>
                            
                            <!-- Summary Cards -->
                            <div class="grid-4-cols border-bottom">
                                <div class="bg-blue-light p-3 center border-right">
                                    <div class="text-grey-400 text-uppercase mb-1 text-xxs">Saldo Awal</div>
                                    <div class="font-bold text-md text-mono-blue">${formatRupiah(saldoAwal)}</div>
                                </div>
                                <div class="bg-green-light p-3 center border-right">
                                    <div class="text-grey-400 text-uppercase mb-1 text-xxs">Total Debit</div>
                                    <div class="font-bold text-md text-green-600">${formatRupiah(totalDebit)}</div>
                                </div>
                                <div class="bg-red-light p-3 center border-right">
                                    <div class="text-grey-400 text-uppercase mb-1 text-xxs">Total Kredit</div>
                                    <div class="font-bold text-md text-red-600">${formatRupiah(totalKredit)}</div>
                                </div>
                                <div class="p-3 center ${saldoAkhir >= 0 ? 'bg-orange-light' : 'bg-red-light'}">
                                    <div class="text-grey-400 text-uppercase mb-1 text-xxs">Saldo Akhir</div>
                                    <div class="font-bold text-md ${saldoAkhir >= 0 ? 'text-orange-dark' : 'text-red-600'}">${formatRupiah(Math.abs(saldoAkhir))} ${saldoAkhir < 0 ? '(K)' : '(D)'}</div>
                                </div>
                            </div>
                            
                            <!-- Tabel Transaksi -->
                            <div class="table-wrapper h-400-scroll">
                                <table class="excel-table table-excel">
                                    <thead class="sticky-top">
                                        <tr class="bg-dark-header">
                                            <th class="w-35px text-center">No</th>
                                            <th class="w-90px">Tanggal</th>
                                            <th class="w-100px">No. Ref</th>
                                            <th class="w-70px">Divisi</th>
                                            <th>Keterangan</th>
                                            <th class="w-80px">Sumber</th>
                                            <th class="w-120px text-right">Debit (Rp)</th>
                                            <th class="w-120px text-right">Kredit (Rp)</th>
                                            <th class="w-120px text-right">Saldo (Rp)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    // Reset saldo untuk running balance
                    saldo = 0;
                    transaksi.forEach((item, index) => {
                        // Hitung saldo running
                        saldo += item.debit - item.kredit;

                        const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-grey-light';
                        const saldoClass = saldo >= 0 ? 'text-green-800 bg-green-light' : 'text-red-800 bg-red-light';

                        // Badge sumber
                        let sumberBadge = '';
                        if (item.sumber === 'Penjualan') sumberBadge = '<span class="badge-sumber-jual">JUAL</span>';
                        else if (item.sumber === 'Pembelian') sumberBadge = '<span class="badge-sumber-beli">BELI</span>';
                        else if (item.sumber === 'Kas Masuk') sumberBadge = '<span class="badge-sumber-kas-in">KAS +</span>';
                        else if (item.sumber === 'Kas Keluar') sumberBadge = '<span class="badge-sumber-kas-out">KAS -</span>';
                        else sumberBadge = '<span class="badge-sumber-jurnal">JURNAL</span>';

                        // Icon divisi
                        let divisiIcon = '';
                        if (item.divisi === 'Angkutan') divisiIcon = '🚛';
                        else if (item.divisi === 'Besi') divisiIcon = '🔩';
                        else if (item.divisi === 'Pakan') divisiIcon = '🌾';

                        html += `
                            <tr class="${rowClass}">
                                <td class="text-center font-bold">${index + 1}</td>
                                <td class="whitespace-nowrap">${formatTanggal(item.tanggal)}</td>
                                <td class="text-mono-blue">${item.noRef || '-'}</td>
                                <td class="text-center text-xs">${divisiIcon} ${item.divisi || '-'}</td>
                                <td class="text-xs text-truncate max-w-250px" title="${item.keterangan}">${item.keterangan}</td>
                                <td class="text-center">${sumberBadge}</td>
                                <td class="text-right ${item.debit > 0 ? 'text-green-600 font-bold' : 'text-grey-400'}">${item.debit > 0 ? formatRupiah(item.debit) : '-'}</td>
                                <td class="text-right ${item.kredit > 0 ? 'text-red-600 font-bold' : 'text-grey-400'}">${item.kredit > 0 ? formatRupiah(item.kredit) : '-'}</td>
                                <td class="text-right font-bold ${saldoClass}">${formatRupiah(Math.abs(saldo))}</td>
                            </tr>
                        `;
                    });

                    html += `
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-gradient-warning font-bold">
                                            <td colspan="6" class="text-right p-right-15 text-grey-800 text-xs">
                                                TOTAL AKUN ${akun.toUpperCase()}:
                                            </td>
                                            <td class="text-right text-sm text-green-800">${formatRupiah(totalDebit)}</td>
                                            <td class="text-right text-sm text-red-800">${formatRupiah(totalKredit)}</td>
                                            <td class="text-right text-sm bg-yellow-light ${saldoAkhir >= 0 ? 'text-green-800' : 'text-red-800'}">
                                                ${formatRupiah(Math.abs(saldoAkhir))} ${saldoAkhir < 0 ? '(K)' : '(D)'}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    `;

                    akunNo++;
                    grandTotalDebit += totalDebit;
                    grandTotalKredit += totalKredit;
                    grandSaldoAkhir += saldoAkhir;
                });

                // Tambahkan Grand Total di akhir
                if (selectedAkun.length > 1) {
                    html += `
                        <div class="mt-20px bg-gradient-blue text-white p-3 rounded-md shadow-md">
                            <h3 class="m-0 mb-3 text-sm text-uppercase tracking-wide">📊 RINGKASAN BUKU BESAR</h3>
                            <div class="grid-3-cols">
                                <div class="card-bb-item">
                                    <div class="text-xs opacity-80 mb-1">GRAND TOTAL DEBIT</div>
                                    <div class="text-lg font-bold">${formatRupiah(grandTotalDebit)}</div>
                                </div>
                                <div class="card-bb-item">
                                    <div class="text-xs opacity-80 mb-1">GRAND TOTAL KREDIT</div>
                                    <div class="text-lg font-bold">${formatRupiah(grandTotalKredit)}</div>
                                </div>
                                <div class="card-bb-item ${grandSaldoAkhir >= 0 ? 'bg-success-light-2' : 'bg-danger-light-2'}">
                                    <div class="text-xs opacity-80 mb-1">SALDO AKHIR</div>
                                    <div class="text-lg font-bold">${formatRupiah(Math.abs(grandSaldoAkhir))} ${grandSaldoAkhir < 0 ? '(KREDIT)' : '(DEBIT)'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Update summary cards
                document.getElementById('saldoAwalBukuBesar').textContent = formatRupiah(0);
                document.getElementById('totalDebitBukuBesar').textContent = formatRupiah(grandTotalDebit);
                document.getElementById('totalKreditBukuBesar').textContent = formatRupiah(grandTotalKredit);
                document.getElementById('saldoAkhirBukuBesar').textContent = formatRupiah(Math.abs(grandSaldoAkhir));
            }

            container.innerHTML = html;
        }

        // Search Buku Besar
        function searchBukuBesar() {
            const searchTerm = document.getElementById('searchBukuBesar').value.toLowerCase();
            const tables = document.querySelectorAll('#bukuBesarAkun .excel-table tbody');
            let totalVisible = 0;
            let totalRows = 0;

            tables.forEach(tbody => {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    totalRows++;
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.classList.remove('d-none');
                        totalVisible++;
                    } else {
                        row.classList.add('d-none');
                    }
                });
            });

            const resultsDiv = document.getElementById('resultsBukuBesar');
            if (searchTerm) {
                resultsDiv.textContent = `Menampilkan ${totalVisible} dari ${totalRows} transaksi`;
                resultsDiv.classList.remove('d-none');
            } else {
                resultsDiv.classList.add('d-none');
            }
        }

        // Reset Filter Buku Besar
        function resetFilterBukuBesar() {
            document.getElementById('filterAkunBukuBesar').value = 'semua';
            document.getElementById('filterBukuBesarMulai').value = '';
            document.getElementById('filterBukuBesarSelesai').value = '';
            document.getElementById('searchBukuBesar').value = '';
            displayBukuBesar();
        }

        // Ekspor Buku Besar ke Excel
        function eksporBukuBesarExcel() {
            const filterAkun = document.getElementById('filterAkunBukuBesar').value;
            const tglMulai = convertToISODate(document.getElementById('filterBukuBesarMulai').value);
            const tglSelesai = convertToISODate(document.getElementById('filterBukuBesarSelesai').value);

            let fileName = 'Buku_Besar';
            if (filterAkun !== 'semua') {
                fileName += `_${filterAkun.replace(/ /g, '_')}`;
            }
            if (tglMulai && tglSelesai) {
                fileName += `_${tglMulai.replace(/\//g, '-')}_sd_${tglSelesai.replace(/\//g, '-')}`;
            }

            const tglMulaiStr = tglMulai ? formatTanggal(tglMulai) : 'Awal';
            const tglSelesaiStr = tglSelesai ? formatTanggal(tglSelesai) : 'Akhir';
            fileName += '.xls';

            // Use captured data if available, otherwise try to use displayBukuBesar (which sets it)
            if (!window.currentBukuBesarData) {
                displayBukuBesar(); // Ensure data is populated
            }

            const bukuBesar = window.currentBukuBesarData || {};
            const selectedAkun = window.currentBukuBesarSelected || [];

            let html = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta http-equiv="content-type" content="text/plain; charset=UTF-8"/>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Buku Besar</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #000; padding: 5px; }
                        .header { background-color: #f0f0f0; font-weight: bold; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .title { font-size: 16px; font-weight: bold; text-align: center; margin-bottom: 10px; }
                        .subtitle { font-size: 14px; text-align: center; margin-bottom: 20px; }
                        .akun-header { background-color: #d9edf7; font-weight: bold; font-size: 14px; padding: 10px; }
                        .summary-row { background-color: #fff3cd; font-weight: bold; }
                        .w-40px { width: 40px; }
                        .w-100px { width: 100px; }
                        .w-80px { width: 80px; }
                        .w-120px { width: 120px; }
                    </style>
                </head>
                <body>
                    <div class="title">BUKU BESAR - PT. Sumber Ganda Mekar</div>
                    <div class="subtitle">Periode: ${tglMulaiStr} s/d ${tglSelesaiStr}</div>
                    <br>
            `;

            selectedAkun.forEach((akun, idx) => {
                const transaksi = bukuBesar[akun] || [];

                let totalDebit = 0;
                let totalKredit = 0;
                transaksi.forEach(item => {
                    totalDebit += item.debit;
                    totalKredit += item.kredit;
                });
                let saldoAkhir = totalDebit - totalKredit;
                let saldo = 0;

                html += `
                    <table>
                        <tr>
                            <td colspan="9" class="akun-header">${idx + 1}. AKUN: ${akun} (${transaksi.length} transaksi)</td>
                        </tr>
                        <tr class="header">
                            <th class="w-40px">No</th>
                            <th class="w-100px">Tanggal</th>
                            <th class="w-100px">No. Ref</th>
                            <th class="w-80px">Divisi</th>
                            <th>Keterangan</th>
                            <th class="w-80px">Sumber</th>
                            <th class="w-120px">Debit</th>
                            <th class="w-120px">Kredit</th>
                            <th class="w-120px">Saldo</th>
                        </tr>
                `;

                transaksi.forEach((item, index) => {
                    saldo += item.debit - item.kredit;
                    html += `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td>${item.noRef || '-'}</td>
                            <td class="text-center">${item.divisi || '-'}</td>
                            <td>${item.keterangan}</td>
                            <td class="text-center">${item.sumber}</td>
                            <td class="text-right">${item.debit > 0 ? formatRupiah(item.debit) : '-'}</td>
                            <td class="text-right">${item.kredit > 0 ? formatRupiah(item.kredit) : '-'}</td>
                            <td class="text-right">${formatRupiah(Math.abs(saldo))} ${saldo < 0 ? '(K)' : '(D)'}</td>
                        </tr>
                    `;
                });

                html += `
                        <tr class="summary-row">
                            <td colspan="6" class="text-right">TOTAL AKUN ${akun.toUpperCase()}:</td>
                            <td class="text-right">${formatRupiah(totalDebit)}</td>
                            <td class="text-right">${formatRupiah(totalKredit)}</td>
                            <td class="text-right">${formatRupiah(Math.abs(saldoAkhir))} ${saldoAkhir < 0 ? '(K)' : '(D)'}</td>
                        </tr>
                    </table>
                    <br><br>
                `;
            });

            html += '</body></html>';

            const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Hitung Laba Rugi


        // Filter Jurnal
        function filterJurnal() {
            displayJurnal();
        }

        function resetFilter() {
            const today = new Date().toISOString().split('T')[0];
            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            document.getElementById('filterTglMulai').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('filterTglSelesai').value = today;
            displayJurnal();
        }

        function generateUlangJurnal() {
            if (!confirm('Generate ulang jurnal akan menghapus semua data jurnal yang ada dan membuat ulang dari semua transaksi.\n\nLanjutkan?')) {
                return;
            }

            // Kosongkan jurnal
            dataJurnal = [];

            // 1. Generate jurnal dari semua penjualan
            dataPenjualan.forEach(transaksi => {
                buatJurnalPenjualan(transaksi);
            });

            // 2. Generate jurnal dari semua pembelian
            dataPembelian.forEach(transaksi => {
                buatJurnalPembelian(transaksi);
            });

            saveDataToStorage();
            displayJurnal();
            alert('Jurnal berhasil di-generate ulang!');
        }

        // Hapus data
        function hapusPenjualan(id) {
            if (confirm('Yakin ingin menghapus data ini?')) {
                dataPenjualan = dataPenjualan.filter(item => item.id !== id);
                dataJurnal = dataJurnal.filter(item => !item.noRef.startsWith('FJ-') || item.noRef !== dataPenjualan.find(p => p.id === id)?.noFaktur);
                saveDataToStorage();
                displayPenjualan();
                showAlert('alertPenjualan', 'Data berhasil dihapus!', 'danger');
            }
        }

        function hapusPembelian(id) {
            if (confirm('Yakin ingin menghapus data ini?')) {
                dataPembelian = dataPembelian.filter(item => item.id !== id);
                dataJurnal = dataJurnal.filter(item => !item.noRef.startsWith('FB-') || item.noRef !== dataPembelian.find(p => p.id === id)?.noFaktur);
                saveDataToStorage();
                displayPembelian();
                showAlert('alertPembelian', 'Data berhasil dihapus!', 'danger');
            }
        }

        function hapusSemuaData() {
            if (confirm('PERHATIAN! Ini akan menghapus SEMUA data penjualan, pembelian, transaksi kas, piutang, hutang, dan jurnal.\n\nYakin ingin melanjutkan?')) {
                dataPenjualan = [];
                dataPembelian = [];
                dataTransaksiKas = [];
                dataPembayaranPiutang = [];
                dataPembayaranHutang = [];
                dataJurnal = [];
                saveDataToStorage();
                updateAllDisplays();
                alert('Semua data berhasil dihapus!');
            }
        }

        // Update all displays
        function updateAllDisplays() {
            displayPenjualan();
            displayPembelian();
            displayTransaksiKas();
            updateSaldoKas();
            displayPiutang();
            displayHutang();
            displayJurnal();
            displayBukuBesar();

            displayKasHarian();
            updateDataMasterStats();
        }

        // ==================================================
        // FUNGSI FILTER TANGGAL UNTUK PENJUALAN & PEMBELIAN
        // ==================================================

        // Set default dates untuk filter Penjualan - KOSONG untuk tampilkan semua data
        function setDefaultDatesPenjualan() {
            const mulaiInput = document.getElementById('filterPenjualanMulai');
            const selesaiInput = document.getElementById('filterPenjualanSelesai');

            if (!mulaiInput || !selesaiInput) return;

            // Biarkan kosong agar menampilkan semua data secara default
            mulaiInput.value = '';
            selesaiInput.value = '';
        }

        // Set default dates untuk filter Pembelian - KOSONG untuk tampilkan semua data
        function setDefaultDatesPembelian() {
            const mulaiInput = document.getElementById('filterPembelianMulai');
            const selesaiInput = document.getElementById('filterPembelianSelesai');

            if (!mulaiInput || !selesaiInput) return;

            // Biarkan kosong agar menampilkan semua data secara default
            mulaiInput.value = '';
            selesaiInput.value = '';
        }

        // Filter Daftar Penjualan berdasarkan tanggal
        function filterDaftarPenjualan() {
            const mulaiValue = document.getElementById('filterPenjualanMulai').value.trim();
            const selesaiValue = document.getElementById('filterPenjualanSelesai').value.trim();

            let filtered = [...dataPenjualan];

            // Hanya filter jika KEDUA tanggal diisi
            if (mulaiValue && selesaiValue) {
                const tglMulai = convertToISODate(mulaiValue);
                const tglSelesai = convertToISODate(selesaiValue);
                filtered = filtered.filter(item => {
                    return item.tanggal >= tglMulai && item.tanggal <= tglSelesai;
                });
            }
            // Jika kosong atau hanya satu yang diisi, tampilkan SEMUA data

            // Render table dengan data yang sudah difilter (atau semua data)
            renderPenjualanTable(filtered);
        }

        // Reset Filter Penjualan
        function resetFilterPenjualan() {
            setDefaultDatesPenjualan();
            filterDaftarPenjualan();
        }

        // Filter Daftar Pembelian berdasarkan tanggal
        function filterDaftarPembelian() {
            const mulaiValue = document.getElementById('filterPembelianMulai').value.trim();
            const selesaiValue = document.getElementById('filterPembelianSelesai').value.trim();

            let filtered = [...dataPembelian];

            // Hanya filter jika KEDUA tanggal diisi
            if (mulaiValue && selesaiValue) {
                const tglMulai = convertToISODate(mulaiValue);
                const tglSelesai = convertToISODate(selesaiValue);
                filtered = filtered.filter(item => {
                    return item.tanggal >= tglMulai && item.tanggal <= tglSelesai;
                });
            }
            // Jika kosong atau hanya satu yang diisi, tampilkan SEMUA data

            // Render table dengan data yang sudah difilter (atau semua data)
            renderPembelianTable(filtered);
        }

        // Reset Filter Pembelian
        function resetFilterPembelian() {
            setDefaultDatesPembelian();
            filterDaftarPembelian();
        }

        // Helper function untuk render tabel Penjualan
        function renderPenjualanTable(data) {
            const tbody = document.getElementById('bodyPenjualan');
            if (!tbody) return;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="text-center">Tidak ada data untuk periode ini</td></tr>';
                document.getElementById('grandTotalJual').textContent = 'Rp 0';
                return;
            }

            let html = '';
            let grandTotal = 0;

            data.forEach((item, index) => {
                const ppnBadge = getPPNBadge(item.jenisPpn);

                // Extract pelanggan name (handle different property names)
                const pelangganName = item.namaPelanggan || item.pelanggan || '-';

                // Extract barang names and qty from detailBarang array if exists
                let barangNames = '-';
                let totalQty = 0;
                let avgHarga = 0;

                if (item.detailBarang && item.detailBarang.length > 0) {
                    barangNames = item.detailBarang.map(b => b.nama || b.namaBarang || '-').join(', ');
                    totalQty = item.detailBarang.reduce((sum, b) => sum + (parseFloat(b.qty) || 0), 0);
                    const totalHarga = item.detailBarang.reduce((sum, b) => sum + (parseFloat(b.harga) || 0), 0);
                    avgHarga = item.detailBarang.length > 0 ? totalHarga / item.detailBarang.length : 0;
                } else {
                    // Fallback for legacy data without detailBarang
                    barangNames = item.namaBarang || item.barang || '-';
                    totalQty = item.qty || 0;
                    avgHarga = item.harga || 0;
                }

                html += `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td class="center">${item.divisi || '-'}</td>
                        <td class="font-mono text-mono-blue">${item.noFaktur}</td>
                        <td>${pelangganName}</td>
                        <td>${barangNames}</td>
                        <td class="number">${totalQty}</td>
                        <td class="number">${formatRupiah(avgHarga)}</td>
                        <td class="number">${formatRupiah(item.diskon || item.nilaiDiskon || 0)}</td>
                        <td class="center">${ppnBadge}</td>
                        <td class="number">${formatRupiah(item.dp || 0)}</td>
                        <td class="number font-bold">${formatRupiah(item.total)}</td>
                        <td class="number ${(item.sisa || 0) > 0 ? 'text-danger' : 'text-success'}">${formatRupiah(item.sisa || 0)}</td>
                        <td class="action-buttons">
                            <button class="print-btn" onclick="cetakFaktur('${item.noFaktur}', 'jual')" title="Cetak Faktur">🖨️</button>
                            <button class="edit-btn" onclick="editPenjualan(${item.id})" title="Edit">✏️</button>
                            <button class="delete-btn" onclick="hapusPenjualan(${item.id})" title="Hapus">🗑️</button>
                        </td>
                    </tr>
                `;
                grandTotal += item.total || 0;
            });

            tbody.innerHTML = html;
            document.getElementById('grandTotalJual').textContent = formatRupiah(grandTotal);
        }

        // Helper function untuk render tabel Pembelian
        function renderPembelianTable(data) {
            const tbody = document.getElementById('bodyPembelian');
            if (!tbody) return;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="text-center">Tidak ada data untuk periode ini</td></tr>';
                document.getElementById('grandTotalBeli').textContent = 'Rp 0';
                return;
            }

            let html = '';
            let grandTotal = 0;

            data.forEach((item, index) => {
                const ppnBadge = getPPNBadge(item.jenisPpn);

                // Extract supplier name (handle different property names)
                const supplierName = item.namaSupplier || item.supplier || '-';

                // Extract barang names and qty from detailBarang array if exists
                let barangNames = '-';
                let totalQty = 0;
                let avgHarga = 0;

                if (item.detailBarang && item.detailBarang.length > 0) {
                    barangNames = item.detailBarang.map(b => b.nama || b.namaBarang || '-').join(', ');
                    totalQty = item.detailBarang.reduce((sum, b) => sum + (parseFloat(b.qty) || 0), 0);
                    const totalHarga = item.detailBarang.reduce((sum, b) => sum + (parseFloat(b.harga) || 0), 0);
                    avgHarga = item.detailBarang.length > 0 ? totalHarga / item.detailBarang.length : 0;
                } else {
                    // Fallback for legacy data without detailBarang
                    barangNames = item.namaBarang || item.barang || '-';
                    totalQty = item.qty || 0;
                    avgHarga = item.harga || 0;
                }

                html += `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td class="center">${item.divisi || '-'}</td>
                        <td class="font-mono text-mono-blue">${item.noFaktur}</td>
                        <td>${supplierName}</td>
                        <td>${barangNames}</td>
                        <td class="number">${totalQty}</td>
                        <td class="number">${formatRupiah(avgHarga)}</td>
                        <td class="number">${formatRupiah(item.diskon || item.nilaiDiskon || 0)}</td>
                        <td class="center">${ppnBadge}</td>
                        <td class="number">${formatRupiah(item.dp || 0)}</td>
                        <td class="number font-bold">${formatRupiah(item.total)}</td>
                        <td class="number ${(item.sisa || 0) > 0 ? 'text-danger' : 'text-success'}">${formatRupiah(item.sisa || 0)}</td>
                        <td class="action-buttons">
                            <button class="print-btn" onclick="cetakFaktur('${item.noFaktur}', 'beli')" title="Cetak Faktur">🖨️</button>
                            <button class="edit-btn" onclick="editPembelian(${item.id})" title="Edit">✏️</button>
                            <button class="delete-btn" onclick="hapusPembelian(${item.id})" title="Hapus">🗑️</button>
                        </td>
                    </tr>
                `;
                grandTotal += item.total || 0;
            });

            tbody.innerHTML = html;
            document.getElementById('grandTotalBeli').textContent = formatRupiah(grandTotal);
        }

        // Helper untuk PPN Badge
        function getPPNBadge(jenisPpn) {
            switch (jenisPpn) {
                case 'ppn11':
                    return '<span class="badge" style="background:#e0e7ff;color:#4338ca;">PPN 11%</span>';
                case 'ppn1':
                    return '<span class="badge" style="background:#fef3c7;color:#d97706;">PPN 1.1%</span>';
                case 'dibebaskan':
                    return '<span class="badge" style="background:#d1fae5;color:#059669;">Dibebaskan</span>';
                default:
                    return '<span class="badge" style="background:#f1f5f9;color:#64748b;">Non PPN</span>';
            }
        }

        // Display functions yang dipanggil dari updateAllDisplays
        function displayPenjualan() {
            filterDaftarPenjualan();
        }

        function displayPembelian() {
            filterDaftarPembelian();
        }


        // Update Data Master Stats
        function updateDataMasterStats() {
            document.getElementById('totalTransaksiJual').textContent = dataPenjualan.length;
            document.getElementById('totalTransaksiBeli').textContent = dataPembelian.length;
            document.getElementById('totalJurnalEntry').textContent = dataJurnal.length + dataTransaksiKas.length;
        }

        // ===== KAS HARIAN FUNCTIONS =====

        // Flag untuk mencegah duplikasi event listener
        let kategoriKasHarianAutocompleteInitialized = false;

        // Variable untuk tracking edit kas harian
        let editingKasHarianId = null;

        // Setup autocomplete kategori kas harian
        function setupKategoriKasHarianAutocomplete() {
            const input = document.getElementById('kategoriKasHarian');
            const dropdown = document.getElementById('dropdownKategoriKasHarian');

            if (!input || !dropdown) return;

            // Cegah duplikasi event listener
            if (kategoriKasHarianAutocompleteInitialized) return;
            kategoriKasHarianAutocompleteInitialized = true;

            // Event saat mengetik
            input.addEventListener('input', function () {
                const value = this.value.toLowerCase().trim();
                showKategoriDropdown(value);
            });

            // Event saat fokus
            input.addEventListener('focus', function () {
                showKategoriDropdown(this.value.toLowerCase().trim());
            });

            // Event saat blur (delay untuk memungkinkan klik)
            input.addEventListener('blur', function () {
                setTimeout(() => {
                    dropdown.classList.remove('show');
                }, 200);
            });

            // Event keyboard navigation
            input.addEventListener('keydown', function (e) {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                const activeItem = dropdown.querySelector('.autocomplete-item.active');
                let currentIndex = -1;

                items.forEach((item, index) => {
                    if (item.classList.contains('active')) currentIndex = index;
                });

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (currentIndex < items.length - 1) {
                        if (activeItem) activeItem.classList.remove('active');
                        items[currentIndex + 1].classList.add('active');
                        items[currentIndex + 1].scrollIntoView({ block: 'nearest' });
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (currentIndex > 0) {
                        if (activeItem) activeItem.classList.remove('active');
                        items[currentIndex - 1].classList.add('active');
                        items[currentIndex - 1].scrollIntoView({ block: 'nearest' });
                    }
                } else if (e.key === 'Enter' && activeItem) {
                    e.preventDefault();
                    input.value = activeItem.textContent;
                    dropdown.classList.remove('show');
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Tampilkan dropdown kategori
        function showKategoriDropdown(searchValue) {
            const dropdown = document.getElementById('dropdownKategoriKasHarian');
            if (!dropdown) return;

            // Filter kategori berdasarkan pencarian
            let filteredKategori = kategoriKas;
            if (searchValue) {
                filteredKategori = kategoriKas.filter(kat =>
                    kat.toLowerCase().includes(searchValue)
                );
            }

            if (filteredKategori.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item text-muted">Tidak ada kategori ditemukan</div>';
                dropdown.classList.add('show');
                return;
            }

            let html = '';
            filteredKategori.forEach((kat, index) => {
                html += `<div class="autocomplete-item${index === 0 ? ' active' : ''}" onclick="pilihKategori('${kat}')">${kat}</div>`;
            });

            dropdown.innerHTML = html;
            dropdown.classList.add('show');
        }

        // Pilih kategori dari dropdown
        function pilihKategori(kategori) {
            const input = document.getElementById('kategoriKasHarian');
            const dropdown = document.getElementById('dropdownKategoriKasHarian');

            if (input) input.value = kategori;
            if (dropdown) dropdown.classList.remove('show');
        }

        // Submit Kas Harian
        function submitKasHarian(event) {
            event.preventDefault();

            const tanggalRaw = document.getElementById('tglKasHarian').value;
            const divisi = document.getElementById('divisiKasHarian').value;
            const jenis = document.getElementById('jenisKasHarian').value;
            const kategori = document.getElementById('kategoriKasHarian').value;
            const keterangan = document.getElementById('ketKasHarian').value;
            const jumlahStr = document.getElementById('jumlahKasHarian').value;

            const tanggal = convertToISODate(tanggalRaw);
            const jumlah = parseRupiahValue(jumlahStr);

            if (!tanggal || !divisi || !kategori || !keterangan || jumlah <= 0) {
                alert('Lengkapi semua field dengan benar!');
                return false;
            }

            let currentKasId = null;

            if (editingKasHarianId) {
                // Update existing record
                currentKasId = editingKasHarianId;
                const index = dataKasHarian.findIndex(k => k.id === editingKasHarianId);
                if (index !== -1) {
                    dataKasHarian[index] = {
                        id: editingKasHarianId,
                        tanggal: tanggal,
                        divisi: divisi,
                        jenis: jenis,
                        kategori: kategori,
                        keterangan: keterangan,
                        jumlah: jumlah
                    };
                }
                editingKasHarianId = null;
                showAlert('alertKasHarian', 'Transaksi kas berhasil diupdate!', 'success');

                // Reset button text
                const btnSubmit = document.querySelector('#formKasHarian button[type="submit"]');
                if (btnSubmit) btnSubmit.innerHTML = '💾 Simpan';

                // Hide cancel button
                const btnCancel = document.getElementById('btnCancelEditKasHarian');
                if (btnCancel) btnCancel.classList.add('d-none');
            } else {
                // Add new record
                currentKasId = Date.now();
                const kasHarian = {
                    id: currentKasId,
                    tanggal: tanggal,
                    divisi: divisi,
                    jenis: jenis,
                    kategori: kategori,
                    keterangan: keterangan,
                    jumlah: jumlah
                };

                dataKasHarian.push(kasHarian);
                showAlert('alertKasHarian', 'Transaksi kas berhasil disimpan!', 'success');
            }

            // --- INTEGRASI JURNAL ---
            const noRef = `KH-${currentKasId}`;

            // 1. Hapus jurnal lama jika ada (untuk update/re-entry)
            dataJurnal = dataJurnal.filter(j => j.noRef !== noRef);

            // 2. Buat jurnal baru
            const transaksiJurnal = {
                tanggal: tanggal,
                noTransaksi: noRef,
                divisi: divisi,
                kategori: kategori,
                keterangan: keterangan,
                jumlah: jumlah
            };

            if (jenis === 'masuk') {
                buatJurnalKasMasuk(transaksiJurnal);
            } else {
                buatJurnalKasKeluar(transaksiJurnal);
            }
            // ------------------------

            saveDataToStorage();
            displayKasHarian();

            // Reset form
            document.getElementById('formKasHarian').reset();
            return false;
        }

        // Edit Kas Harian
        function editKasHarian(id) {
            const item = dataKasHarian.find(k => k.id === id);
            if (!item) return;

            editingKasHarianId = id;

            // Fill form with existing data
            document.getElementById('tglKasHarian').value = convertToDisplayDate(item.tanggal);
            document.getElementById('divisiKasHarian').value = item.divisi || '';
            document.getElementById('jenisKasHarian').value = item.jenis;
            document.getElementById('kategoriKasHarian').value = item.kategori;
            document.getElementById('ketKasHarian').value = item.keterangan;
            document.getElementById('jumlahKasHarian').value = formatRupiah(item.jumlah);

            // Change button text
            const btnSubmit = document.querySelector('#formKasHarian button[type="submit"]');
            if (btnSubmit) btnSubmit.innerHTML = '💾 Update';

            // Show cancel button
            const btnCancel = document.getElementById('btnCancelEditKasHarian');
            if (btnCancel) btnCancel.classList.remove('d-none');

            // Scroll to form
            document.getElementById('formKasHarian').scrollIntoView({ behavior: 'smooth' });
        }

        // Cancel Edit Kas Harian
        function cancelEditKasHarian() {
            editingKasHarianId = null;
            document.getElementById('formKasHarian').reset();

            // Reset button text
            const btnSubmit = document.querySelector('#formKasHarian button[type="submit"]');
            if (btnSubmit) btnSubmit.innerHTML = '💾 Simpan';

            // Hide cancel button
            const btnCancel = document.getElementById('btnCancelEditKasHarian');
            if (btnCancel) btnCancel.classList.add('d-none');
        }

        // Display Kas Harian
        function displayKasHarian() {
            const tbody = document.getElementById('bodyKasHarian');
            if (!tbody) return;

            // Get filter values
            const filterMulaiEl = document.getElementById('filterKasHarianMulai');
            const filterSelesaiEl = document.getElementById('filterKasHarianSelesai');
            const filterJenisEl = document.getElementById('filterJenisKasHarian');
            const filterDivisiEl = document.getElementById('filterDivisiKasHarian');

            const tglMulai = filterMulaiEl && filterMulaiEl.value ? convertToISODate(filterMulaiEl.value) : null;
            const tglSelesai = filterSelesaiEl && filterSelesaiEl.value ? convertToISODate(filterSelesaiEl.value) : null;
            const jenisFilter = filterJenisEl ? filterJenisEl.value : 'semua';
            const divisiFilter = filterDivisiEl ? filterDivisiEl.value : 'semua';

            // Gabungkan data dari berbagai sumber
            let allKasData = [];

            // 1. Data Kas Harian manual
            dataKasHarian.forEach(item => {
                allKasData.push({
                    id: item.id,
                    tanggal: item.tanggal,
                    divisi: item.divisi || '-',
                    jenis: item.jenis,
                    kategori: item.kategori,
                    keterangan: item.keterangan,
                    jumlah: item.jumlah,
                    sumber: 'manual',
                    editable: true
                });
            });

            // 2. Data Penjualan Tunai/Transfer → Kas Masuk
            /* DINONAKTIFKAN UNTUK MENCEGAH DUPLIKASI
               Data penjualan sudah dicatat langsung ke Kas Harian via buatJurnalPenjualan.
            dataPenjualan.forEach(p => {
                const metodeBayar = (p.metodeBayar || '').toLowerCase();
                if (metodeBayar === 'tunai' || metodeBayar === 'transfer') {
                    const jumlah = p.dibayar || p.total || 0;
                    if (jumlah > 0) {
                        allKasData.push({
                            id: 'penjualan_' + p.id,
                            tanggal: p.tanggal,
                            divisi: p.divisi || '-',
                            jenis: 'masuk',
                            kategori: 'Penjualan',
                            keterangan: `${p.noFaktur} - ${p.namaPelanggan} (${metodeBayar.charAt(0).toUpperCase() + metodeBayar.slice(1)})`,
                            jumlah: jumlah,
                            sumber: 'penjualan',
                            editable: false,
                            refId: p.id
                        });
                    }
                }
            });
            */

            // 3. Data Pembelian Tunai/Transfer → Kas Keluar
            /* DINONAKTIFKAN UNTUK MENCEGAH DUPLIKASI
               Data pembelian sudah dicatat langsung ke Kas Harian via buatJurnalPembelian.
            dataPembelian.forEach(p => {
                const metodeBayar = (p.metodeBayar || '').toLowerCase();
                if (metodeBayar === 'tunai' || metodeBayar === 'transfer') {
                    const jumlah = p.dibayar || p.total || 0;
                    if (jumlah > 0) {
                        allKasData.push({
                            id: 'pembelian_' + p.id,
                            tanggal: p.tanggal,
                            divisi: p.divisi || '-',
                            jenis: 'keluar',
                            kategori: 'Pembelian',
                            keterangan: `${p.noFaktur} - ${p.namaSupplier} (${metodeBayar.charAt(0).toUpperCase() + metodeBayar.slice(1)})`,
                            jumlah: jumlah,
                            sumber: 'pembelian',
                            editable: false,
                            refId: p.id
                        });
                    }
                }
            });
            */

            // Filter data
            let filteredData = [...allKasData];

            if (tglMulai && tglSelesai) {
                filteredData = filteredData.filter(k => k.tanggal >= tglMulai && k.tanggal <= tglSelesai);
            }

            if (jenisFilter !== 'semua') {
                filteredData = filteredData.filter(k => k.jenis === jenisFilter);
            }

            if (divisiFilter !== 'semua') {
                filteredData = filteredData.filter(k => k.divisi === divisiFilter);
            }

            // Urutkan sesuai urutan input (berdasarkan ID - data pertama sampai terakhir)
            filteredData.sort((a, b) => {
                // Extract numeric ID for comparison
                const getNumericId = (id) => {
                    if (typeof id === 'number') return id;
                    if (typeof id === 'string') {
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return 0;
                };
                return getNumericId(a.id) - getNumericId(b.id);
            });

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="center p-20 text-muted">Belum ada data kas harian</td></tr>';
                document.getElementById('totalKasHarianMasuk').textContent = 'Rp 0';
                document.getElementById('totalKasHarianKeluar').textContent = 'Rp 0';
                document.getElementById('saldoKasHarian').textContent = 'Rp 0';
                document.getElementById('footerKasMasuk').textContent = 'Rp 0';
                document.getElementById('footerKasKeluar').textContent = 'Rp 0';
                document.getElementById('footerSaldoAkhir').textContent = 'Rp 0';
                return;
            }

            let html = '';
            let totalMasuk = 0;
            let totalKeluar = 0;
            let saldo = 0;

            filteredData.forEach((item, index) => {
                const kasMasuk = item.jenis === 'masuk' ? item.jumlah : 0;
                const kasKeluar = item.jenis === 'keluar' ? item.jumlah : 0;
                saldo += kasMasuk - kasKeluar;
                totalMasuk += kasMasuk;
                totalKeluar += kasKeluar;

                const rowClass = item.jenis === 'masuk' ? 'kas-masuk' : 'kas-keluar';
                const badgeClass = item.jenis === 'masuk' ? 'badge-masuk' : 'badge-keluar';
                const saldoClass = saldo >= 0 ? 'positif' : 'negatif';

                // Tambahkan ikon sumber
                let sumberIcon = '';
                if (item.sumber === 'penjualan') sumberIcon = '💰';
                else if (item.sumber === 'pembelian') sumberIcon = '🛒';
                else sumberIcon = '📝';

                // Tombol aksi hanya untuk data manual
                let aksiHtml = '';
                if (item.editable) {
                    aksiHtml = `
                        <button class="btn-edit" onclick="editKasHarian(${item.id})" title="Edit">✏️</button>
                        <button class="btn-hapus" onclick="hapusKasHarian(${item.id})" title="Hapus">🗑️</button>
                    `;
                } else {
                    aksiHtml = `<span class="text-muted text-xxs">${sumberIcon} Auto</span>`;
                }

                html += `
                    <tr class="${rowClass}">
                        <td class="col-no">${index + 1}</td>
                        <td class="col-tanggal">${formatTanggalShort(item.tanggal)}</td>
                        <td class="col-divisi">${item.divisi || '-'}</td>
                        <td class="col-kategori"><span class="badge-kategori ${badgeClass}">${item.kategori || '-'}</span></td>
                        <td class="col-keterangan">${sumberIcon} ${item.keterangan}</td>
                        <td class="col-angka col-masuk">${kasMasuk > 0 ? formatRupiah(kasMasuk) : '-'}</td>
                        <td class="col-angka col-keluar">${kasKeluar > 0 ? formatRupiah(kasKeluar) : '-'}</td>
                        <td class="col-angka col-saldo ${saldoClass}">${formatRupiah(saldo)}</td>
                        <td class="col-aksi">${aksiHtml}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Update summary cards
            document.getElementById('totalKasHarianMasuk').textContent = formatRupiah(totalMasuk);
            document.getElementById('totalKasHarianKeluar').textContent = formatRupiah(totalKeluar);
            document.getElementById('saldoKasHarian').textContent = formatRupiah(saldo);

            // Update footer
            document.getElementById('footerKasMasuk').textContent = formatRupiah(totalMasuk);
            document.getElementById('footerKasKeluar').textContent = formatRupiah(totalKeluar);
            document.getElementById('footerSaldoAkhir').textContent = formatRupiah(saldo);

            // Update card color based on saldo
            const cardSaldo = document.getElementById('cardSaldoKasHarian');
            if (cardSaldo) {
                cardSaldo.className = saldo >= 0 ? 'card success' : 'card danger';
            }

            // Re-apply search if exists
            const searchInput = document.getElementById('searchKasHarian');
            if (searchInput && searchInput.value) {
                searchTable('searchKasHarian', 'bodyKasHarian');
            }
        }

        // Hapus Kas Harian
        function hapusKasHarian(id) {
            if (confirm('Yakin ingin menghapus transaksi kas ini?')) {
                // Hapus dari dataKasHarian
                dataKasHarian = dataKasHarian.filter(k => k.id !== id);

                // Hapus dari dataJurnal (Integrasi)
                const noRef = `KH-${id}`;
                dataJurnal = dataJurnal.filter(j => j.noRef !== noRef);

                saveDataToStorage();
                displayKasHarian();
                showAlert('alertKasHarian', 'Transaksi kas berhasil dihapus!', 'success');
            }
        }

        // Reset Filter Kas Harian
        function resetFilterKasHarian() {
            document.getElementById('filterKasHarianMulai').value = '';
            document.getElementById('filterKasHarianSelesai').value = '';
            document.getElementById('filterJenisKasHarian').value = 'semua';

            // Reset search box
            const searchInput = document.getElementById('searchKasHarian');
            if (searchInput) {
                searchInput.value = '';
                const resultsInfo = document.getElementById('resultsKasHarian');
                if (resultsInfo) resultsInfo.innerHTML = '';
            }

            displayKasHarian();
        }

        // ===== CETAK & EXPORT KAS HARIAN =====

        // Fungsi untuk mendapatkan data kas gabungan (manual + penjualan + pembelian)
        function getKasHarianGabungan() {
            let allKasData = [];

            // 1. Data Kas Harian manual
            dataKasHarian.forEach(item => {
                allKasData.push({
                    id: item.id,
                    tanggal: item.tanggal,
                    divisi: item.divisi || '-',
                    jenis: item.jenis,
                    kategori: item.kategori,
                    keterangan: item.keterangan,
                    jumlah: item.jumlah,
                    sumber: 'manual'
                });
            });

            // 2. Data Penjualan Tunai/Transfer → Kas Masuk
            dataPenjualan.forEach(p => {
                const metodeBayar = (p.metodeBayar || '').toLowerCase();
                if (metodeBayar === 'tunai' || metodeBayar === 'transfer') {
                    const jumlah = p.dibayar || p.total || 0;
                    if (jumlah > 0) {
                        allKasData.push({
                            id: 'penjualan_' + p.id,
                            tanggal: p.tanggal,
                            divisi: p.divisi || '-',
                            jenis: 'masuk',
                            kategori: 'Penjualan',
                            keterangan: `${p.noFaktur} - ${p.namaPelanggan} (${metodeBayar.charAt(0).toUpperCase() + metodeBayar.slice(1)})`,
                            jumlah: jumlah,
                            sumber: 'penjualan'
                        });
                    }
                }
            });

            // 3. Data Pembelian Tunai/Transfer → Kas Keluar
            dataPembelian.forEach(p => {
                const metodeBayar = (p.metodeBayar || '').toLowerCase();
                if (metodeBayar === 'tunai' || metodeBayar === 'transfer') {
                    const jumlah = p.dibayar || p.total || 0;
                    if (jumlah > 0) {
                        allKasData.push({
                            id: 'pembelian_' + p.id,
                            tanggal: p.tanggal,
                            divisi: p.divisi || '-',
                            jenis: 'keluar',
                            kategori: 'Pembelian',
                            keterangan: `${p.noFaktur} - ${p.namaSupplier} (${metodeBayar.charAt(0).toUpperCase() + metodeBayar.slice(1)})`,
                            jumlah: jumlah,
                            sumber: 'pembelian'
                        });
                    }
                }
            });

            return allKasData;
        }

        // Print Kas Harian
        function printKasHarian() {
            // Get filter values for period info
            const filterMulaiEl = document.getElementById('filterKasHarianMulai');
            const filterSelesaiEl = document.getElementById('filterKasHarianSelesai');
            const filterJenisEl = document.getElementById('filterJenisKasHarian');

            const tglMulai = filterMulaiEl && filterMulaiEl.value ? convertToISODate(filterMulaiEl.value) : null;
            const tglSelesai = filterSelesaiEl && filterSelesaiEl.value ? convertToISODate(filterSelesaiEl.value) : null;
            const jenisFilter = filterJenisEl ? filterJenisEl.value : 'semua';

            // Gunakan data gabungan
            let filteredData = getKasHarianGabungan();

            if (tglMulai && tglSelesai) {
                filteredData = filteredData.filter(k => k.tanggal >= tglMulai && k.tanggal <= tglSelesai);
            }

            if (jenisFilter !== 'semua') {
                filteredData = filteredData.filter(k => k.jenis === jenisFilter);
            }

            // Urutkan sesuai urutan input (berdasarkan ID)
            filteredData.sort((a, b) => {
                const getNumericId = (id) => {
                    if (typeof id === 'number') return id;
                    if (typeof id === 'string') {
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return 0;
                };
                return getNumericId(a.id) - getNumericId(b.id);
            });

            if (filteredData.length === 0) {
                alert('Tidak ada data kas harian untuk dicetak!');
                return;
            }

            // Calculate totals
            let totalMasuk = 0, totalKeluar = 0, saldo = 0;
            let rowsHtml = '';

            filteredData.forEach((item, index) => {
                const kasMasuk = item.jenis === 'masuk' ? item.jumlah : 0;
                const kasKeluar = item.jenis === 'keluar' ? item.jumlah : 0;
                saldo += kasMasuk - kasKeluar;
                totalMasuk += kasMasuk;
                totalKeluar += kasKeluar;

                const rowBg = item.jenis === 'masuk' ? '#e2efda' : '#fce4d6';
                let sumberIcon = item.sumber === 'penjualan' ? '💰' : (item.sumber === 'pembelian' ? '🛒' : '📝');

                rowsHtml += `
                    <tr class="${item.jenis === 'masuk' ? 'bg-row-masuk' : 'bg-row-keluar'}">
                        <td class="center p-1 border-bbb">${index + 1}</td>
                        <td class="center p-1 border-bbb font-mono">${formatTanggalShort(item.tanggal)}</td>
                        <td class="center p-1 border-bbb">${item.divisi || '-'}</td>
                        <td class="p-1 border-bbb">${item.kategori || '-'}</td>
                        <td class="p-1 border-bbb">${sumberIcon} ${item.keterangan}</td>
                        <td class="text-right p-1 border-bbb font-mono text-dark-green">${kasMasuk > 0 ? formatRupiah(kasMasuk) : '-'}</td>
                        <td class="text-right p-1 border-bbb font-mono text-dark-red">${kasKeluar > 0 ? formatRupiah(kasKeluar) : '-'}</td>
                        <td class="text-right p-1 border-bbb font-mono font-bold ${saldo >= 0 ? 'text-dark-green' : 'text-dark-red'}">${formatRupiah(saldo)}</td>
                    </tr>
                `;
            });

            // Period text
            let periodText = 'Semua Periode';
            if (tglMulai && tglSelesai) {
                periodText = `${formatTanggal(tglMulai)} s/d ${formatTanggal(tglSelesai)}`;
            }

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Kas Harian - SGM</title>
                    <style>
                        @page { size: A4 landscape; margin: 10mm; }
                        body { font-family: Arial, sans-serif; font-size: 11px; margin: 0; padding: 10px; }
                        .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #217346; padding-bottom: 10px; }
                        .header h1 { margin: 0; font-size: 16px; color: #217346; }
                        .header h2 { margin: 5px 0; font-size: 14px; color: #333; }
                        .header p { margin: 3px 0; font-size: 11px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th { background: #217346; color: white; padding: 6px; border: 1px solid #185a34; font-size: 10px; }
                        .footer-row td { background: #217346; color: white; font-weight: bold; padding: 6px; border: 1px solid #185a34; }
                        .summary { margin-top: 15px; display: flex; justify-content: space-between; }
                        .summary-box { border: 2px solid #217346; padding: 10px; border-radius: 5px; text-align: center; width: 30%; }
                        .summary-box h4 { margin: 0; font-size: 11px; color: #666; }
                        .summary-box p { margin: 5px 0 0 0; font-size: 14px; font-weight: bold; }
                        .print-date { text-align: right; font-size: 9px; color: #999; margin-top: 15px; }
                        
                        /* Utility Classes */
                        .w-30px { width: 30px; }
                        .w-80px { width: 80px; }
                        .w-120px { width: 120px; }
                        .w-100px { width: 100px; }
                        .text-right { text-align: right; }
                        .p-right-10 { padding-right: 10px; }
                        .font-mono { font-family: monospace; }
                        .center { text-align: center; }
                        .p-1 { padding: 4px; }
                        .border-bbb { border: 1px solid #bbb; }
                        .bg-row-masuk { background-color: #e2efda; }
                        .bg-row-keluar { background-color: #fce4d6; }
                        .text-dark-green { color: #006400; }
                        .text-dark-red { color: #8b0000; }
                        .text-success { color: #28a745; }
                        .text-danger { color: #dc3545; }
                        
                        .summary-box-green { border: 2px solid #28a745; padding: 10px; border-radius: 5px; text-align: center; width: 30%; }
                        .summary-box-red { border: 2px solid #dc3545; padding: 10px; border-radius: 5px; text-align: center; width: 30%; }
                        .summary-box-dark-green { border: 2px solid #217346; padding: 10px; border-radius: 5px; text-align: center; width: 30%; }
                        .summary-box-green h4, .summary-box-red h4, .summary-box-dark-green h4 { margin: 0; font-size: 11px; color: #666; }
                        .summary-box-green p, .summary-box-red p, .summary-box-dark-green p { margin: 5px 0 0 0; font-size: 14px; font-weight: bold; }

                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>📊 BUKU KAS HARIAN</h1>
                        <h2>SGM - Sistem Pembukuan</h2>
                        <p>Periode: ${periodText}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th class="w-30px">No</th>
                                <th class="w-80px">Tanggal</th>
                                <th class="w-80px">Divisi</th>
                                <th class="w-120px">Kategori</th>
                                <th>Keterangan</th>
                                <th class="w-100px">Kas Masuk</th>
                                <th class="w-100px">Kas Keluar</th>
                                <th class="w-100px">Saldo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHtml}
                        </tbody>
                        <tfoot>
                            <tr class="footer-row">
                                <td colspan="5" class="text-right p-right-10">TOTAL :</td>
                                <td class="text-right font-mono">${formatRupiah(totalMasuk)}</td>
                                <td class="text-right font-mono">${formatRupiah(totalKeluar)}</td>
                                <td class="text-right font-mono">${formatRupiah(saldo)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="summary">
                        <div class="summary-box-green">
                            <h4>Total Kas Masuk</h4>
                            <p class="text-success">${formatRupiah(totalMasuk)}</p>
                        </div>
                        <div class="summary-box-red">
                            <h4>Total Kas Keluar</h4>
                            <p class="text-danger">${formatRupiah(totalKeluar)}</p>
                        </div>
                        <div class="summary-box-dark-green">
                            <h4>Saldo Akhir</h4>
                            <p class="${saldo >= 0 ? 'text-success' : 'text-danger'}">${formatRupiah(saldo)}</p>
                        </div>
                    </div>
                    
                    <div class="print-date">
                        Dicetak pada: ${new Date().toLocaleString('id-ID')} | Total ${filteredData.length} transaksi
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 300);
        }

        // Export Kas Harian to Excel
        function exportKasHarianExcel() {
            // Get filter values
            const filterMulaiEl = document.getElementById('filterKasHarianMulai');
            const filterSelesaiEl = document.getElementById('filterKasHarianSelesai');
            const filterJenisEl = document.getElementById('filterJenisKasHarian');

            const tglMulai = filterMulaiEl && filterMulaiEl.value ? convertToISODate(filterMulaiEl.value) : null;
            const tglSelesai = filterSelesaiEl && filterSelesaiEl.value ? convertToISODate(filterSelesaiEl.value) : null;
            const jenisFilter = filterJenisEl ? filterJenisEl.value : 'semua';

            // Gunakan data gabungan
            let filteredData = getKasHarianGabungan();

            if (tglMulai && tglSelesai) {
                filteredData = filteredData.filter(k => k.tanggal >= tglMulai && k.tanggal <= tglSelesai);
            }

            if (jenisFilter !== 'semua') {
                filteredData = filteredData.filter(k => k.jenis === jenisFilter);
            }

            // Urutkan sesuai urutan input (berdasarkan ID)
            filteredData.sort((a, b) => {
                const getNumericId = (id) => {
                    if (typeof id === 'number') return id;
                    if (typeof id === 'string') {
                        const match = id.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    }
                    return 0;
                };
                return getNumericId(a.id) - getNumericId(b.id);
            });

            if (filteredData.length === 0) {
                alert('Tidak ada data kas harian untuk diekspor!');
                return;
            }

            // Create Excel content
            let csvContent = "\uFEFF"; // BOM for UTF-8
            csvContent += "BUKU KAS HARIAN - SGM\n";
            csvContent += "\n";
            csvContent += "No,Tanggal,Divisi,Jenis,Kategori,Keterangan,Kas Masuk,Kas Keluar,Saldo\n";

            let saldo = 0;
            let totalMasuk = 0, totalKeluar = 0;

            filteredData.forEach((item, index) => {
                const kasMasuk = item.jenis === 'masuk' ? item.jumlah : 0;
                const kasKeluar = item.jenis === 'keluar' ? item.jumlah : 0;
                saldo += kasMasuk - kasKeluar;
                totalMasuk += kasMasuk;
                totalKeluar += kasKeluar;

                const row = [
                    index + 1,
                    formatTanggalShort(item.tanggal),
                    '"' + (item.divisi || '-').replace(/"/g, '""') + '"',
                    item.jenis === 'masuk' ? 'MASUK' : 'KELUAR',
                    '"' + (item.kategori || '-').replace(/"/g, '""') + '"',
                    '"' + item.keterangan.replace(/"/g, '""') + '"',
                    kasMasuk,
                    kasKeluar,
                    saldo
                ];
                csvContent += row.join(',') + "\n";
            });

            csvContent += "\n";
            csvContent += ",,,,,TOTAL," + totalMasuk + "," + totalKeluar + "," + saldo + "\n";

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'Kas_Harian_SGM_' + new Date().toISOString().slice(0, 10) + '.csv');
            link.classList.add('invisible');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ===== REKAP KAS HARIAN PER AKUN =====

        function showRekapKasHarian() {
            // Get filter values
            const filterMulaiEl = document.getElementById('filterKasHarianMulai');
            const filterSelesaiEl = document.getElementById('filterKasHarianSelesai');
            const filterJenisEl = document.getElementById('filterJenisKasHarian');
            const filterDivisiEl = document.getElementById('filterDivisiKasHarian');

            const tglMulai = filterMulaiEl && filterMulaiEl.value ? convertToISODate(filterMulaiEl.value) : null;
            const tglSelesai = filterSelesaiEl && filterSelesaiEl.value ? convertToISODate(filterSelesaiEl.value) : null;
            const jenisFilter = filterJenisEl ? filterJenisEl.value : 'semua';
            const divisiFilter = filterDivisiEl ? filterDivisiEl.value : 'semua';

            // Gunakan data gabungan
            let filteredData = getKasHarianGabungan();

            if (tglMulai && tglSelesai) {
                filteredData = filteredData.filter(k => k.tanggal >= tglMulai && k.tanggal <= tglSelesai);
            }

            if (jenisFilter !== 'semua') {
                filteredData = filteredData.filter(k => k.jenis === jenisFilter);
            }

            if (divisiFilter !== 'semua') {
                filteredData = filteredData.filter(k => k.divisi === divisiFilter);
            }

            // Group by Kategori
            const rekap = {};
            let totalMasuk = 0;
            let totalKeluar = 0;

            filteredData.forEach(item => {
                const kategori = item.kategori || 'Tanpa Kategori';
                if (!rekap[kategori]) {
                    rekap[kategori] = { masuk: 0, keluar: 0 };
                }

                if (item.jenis === 'masuk') {
                    rekap[kategori].masuk += item.jumlah;
                    totalMasuk += item.jumlah;
                } else {
                    rekap[kategori].keluar += item.jumlah;
                    totalKeluar += item.jumlah;
                }
            });

            // Generate HTML
            // Sort: Uang Masuk first, then Uang Keluar
            const sortedKategori = Object.keys(rekap).sort((a, b) => {
                const itemA = rekap[a];
                const itemB = rekap[b];

                // Determine type: Masuk if masuk > keluar, else Keluar
                const isMasukA = itemA.masuk > itemA.keluar;
                const isMasukB = itemB.masuk > itemB.keluar;

                if (isMasukA && !isMasukB) return -1; // A (Masuk) comes before B (Keluar)
                if (!isMasukA && isMasukB) return 1;  // B (Masuk) comes before A (Keluar)

                // If same type, sort alphabetically
                return a.localeCompare(b);
            });

            let html = `
                <div id="modalRekapKas" class="modal modal-show modal-bg-dark">
                    <div class="modal-content-custom">
                        <div class="modal-header-custom">
                            <h2 class="m-0 text-dark-blue">📊 Rekap Kas Harian per Akun</h2>
                            <span onclick="document.getElementById('modalRekapKas').remove()" class="close-custom">&times;</span>
                        </div>
                        
                        <div class="modal-info">
                            Periode: <strong>${tglMulai ? formatTanggal(tglMulai) : 'Awal'}</strong> s/d <strong>${tglSelesai ? formatTanggal(tglSelesai) : 'Akhir'}</strong>
                            <br>Divisi: <strong>${divisiFilter === 'semua' ? 'Semua Divisi' : divisiFilter}</strong>
                        </div>

                        <div class="table-wrapper">
                            <table class="excel-table">
                                <thead>
                                    <tr>
                                        <th class="w-50px">No</th>
                                        <th>Kategori / Akun</th>
                                        <th class="w-150px">Total Masuk</th>
                                        <th class="w-150px">Total Keluar</th>
                                        <th class="w-150px">Selisih (Net)</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            if (sortedKategori.length === 0) {
                html += '<tr><td colspan="5" class="center p-3">Tidak ada data untuk ditampilkan</td></tr>';
            } else {
                sortedKategori.forEach((kat, idx) => {
                    const r = rekap[kat];
                    const net = r.masuk - r.keluar;
                    const colorClass = net >= 0 ? 'text-green-bold' : 'text-red-bold';

                    html += `
                        <tr>
                            <td class="center">${idx + 1}</td>
                            <td>${kat}</td>
                            <td class="number text-green">${formatRupiah(r.masuk)}</td>
                            <td class="number text-red">${formatRupiah(r.keluar)}</td>
                            <td class="number font-bold ${colorClass}">${formatRupiah(net)}</td>
                        </tr>
                    `;
                });
            }

            html += `
                                </tbody>
                                <tfoot>
                                    <tr class="bg-grey-light font-bold">
                                        <td colspan="2" class="text-right p-right-15">TOTAL :</td>
                                        <td class="number text-green">${formatRupiah(totalMasuk)}</td>
                                        <td class="number text-red">${formatRupiah(totalKeluar)}</td>
                                        <td class="number text-blue-bold">${formatRupiah(totalMasuk - totalKeluar)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="mt-20px text-right">
                             <button class="btn btn-primary" onclick="printRekapKasHarian('${tglMulai || ''}', '${tglSelesai || ''}')">🖨️ Cetak Rekap</button>
                             <button class="btn btn-secondary" onclick="document.getElementById('modalRekapKas').remove()">Tutup</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', html);
        }

        function printRekapKasHarian(mulai, selesai) {
            const content = document.querySelector('#modalRekapKas .table-wrapper').innerHTML;
            const win = window.open('', '', 'height=800,width=1000');
            win.document.write('<html><head><title>Rekap Kas Harian - PT. Sumber Ganda Mekar</title>');
            win.document.write('<style>');
            win.document.write('body { font-family: Arial, sans-serif; padding: 20px; }');
            win.document.write('table { border-collapse: collapse; width: 100%; font-size: 10pt; }');
            win.document.write('th, td { border: 1px solid #333; padding: 6px 8px; }');
            win.document.write('th { background-color: #eee; text-align: center; font-weight: bold; }');
            win.document.write('td.number { text-align: right; }');
            win.document.write('td.center { text-align: center; }');
            win.document.write('.text-green { color: green; }');
            win.document.write('.text-red { color: red; }');
            win.document.write('.text-green-bold { color: green; font-weight: bold; }');
            win.document.write('.text-red-bold { color: red; font-weight: bold; }');
            win.document.write('.text-blue-bold { color: blue; font-weight: bold; }');
            win.document.write('.bg-grey-light { background-color: #f9f9f9; }');
            win.document.write('.text-right { text-align: right; }');
            win.document.write('.p-right-15 { padding-right: 15px; }');
            win.document.write('.header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }');
            win.document.write('h2 { margin: 0; color: #333; }');
            win.document.write('</style>');
            win.document.write('</head><body>');
            win.document.write('<div class="header">');
            win.document.write('<h2>REKAP KAS HARIAN PER AKUN</h2>');
            win.document.write(`<p>Periode: ${mulai ? formatTanggal(mulai) : 'Awal'} s/d ${selesai ? formatTanggal(selesai) : 'Akhir'}</p>`);
            win.document.write('</div>');
            win.document.write(content);
            win.document.write('</body></html>');
            win.document.close();
            win.print();
        }

        // ===== MASTER KATEGORI FUNCTIONS =====

        // Tambah/Edit Kategori
        function tambahKategori(event) {
            event.preventDefault();
            const input = document.getElementById('inputKategori');
            const nama = input.value.trim();
            const editIndex = input.dataset.editIndex;

            if (!nama) {
                alert('Nama kategori tidak boleh kosong!');
                return false;
            }

            // Cek duplikat (kecuali jika sedang edit kategori yang sama)
            const isDuplicate = kategoriKas.some((k, i) => k.toLowerCase() === nama.toLowerCase() && i != editIndex);

            if (isDuplicate) {
                alert('Kategori sudah ada!');
                return false;
            }

            if (editIndex !== undefined && editIndex !== null && editIndex !== '') {
                // Update
                kategoriKas[editIndex] = nama;
                cancelEditKategori(); // Reset form
            } else {
                // Add
                kategoriKas.push(nama);
                input.value = '';
            }

            saveDataToStorage();
            displayKategori();
            return false;
        }

        // Edit Kategori
        function editKategori(index) {
            const nama = kategoriKas[index];
            const input = document.getElementById('inputKategori');
            input.value = nama;
            input.dataset.editIndex = index;

            // Ubah tombol simpan
            const form = document.getElementById('formTambahKategori');
            const btnSubmit = form.querySelector('button[type="submit"]');
            btnSubmit.textContent = '💾 Simpan Perubahan';
            btnSubmit.className = 'btn btn-primary';

            // Tambah tombol batal jika belum ada
            let btnCancel = document.getElementById('btnCancelKategori');
            if (!btnCancel) {
                btnCancel = document.createElement('button');
                btnCancel.id = 'btnCancelKategori';
                btnCancel.type = 'button';
                btnCancel.className = 'btn btn-secondary';
                btnCancel.textContent = '❌ Batal';
                btnCancel.onclick = cancelEditKategori;
                form.appendChild(btnCancel);
            }

            input.focus();
        }

        // Batal Edit Kategori
        function cancelEditKategori() {
            const input = document.getElementById('inputKategori');
            input.value = '';
            delete input.dataset.editIndex;

            const form = document.getElementById('formTambahKategori');
            const btnSubmit = form.querySelector('button[type="submit"]');
            btnSubmit.textContent = '➕ Tambah';
            btnSubmit.className = 'btn btn-success';

            const btnCancel = document.getElementById('btnCancelKategori');
            if (btnCancel) {
                btnCancel.remove();
            }
        }

        // Hapus Kategori
        function hapusKategori(index) {
            if (confirm('Yakin ingin menghapus kategori ini?')) {
                kategoriKas.splice(index, 1);

                // Jika semua kategori dihapus, kembalikan default
                if (kategoriKas.length === 0) {
                    kategoriKas = [...kategoriKasDefault];
                }

                saveDataToStorage();
                displayKategori();
            }
        }

        // Display Kategori
        function displayKategori() {
            const tbody = document.getElementById('bodyKategori');
            if (!tbody) return;

            if (kategoriKas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="center">Tidak ada kategori</td></tr>';
                return;
            }

            let html = '';
            kategoriKas.forEach((kat, index) => {
                html += `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${kat}</td>
                        <td class="center">
                            <button class="edit-btn" onclick="editKategori(${index})" title="Edit">✏️</button>
                            <button class="delete-btn" onclick="hapusKategori(${index})" title="Hapus">🗑️</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // ===== DATA MASTER FUNCTIONS =====

        // Submit handler untuk form master customer
        function submitMasterCustomer(e) {
            e.preventDefault();
            const form = document.getElementById('formMasterCustomer');
            const editId = form.dataset.editId;
            const customerData = {
                nama: document.getElementById('masterNamaCustomer').value,
                alamat: document.getElementById('masterAlamatCustomer').value,
                telepon: document.getElementById('masterTeleponCustomer').value,
                npwp: document.getElementById('masterNpwpCustomer').value,
                email: document.getElementById('masterEmailCustomer').value,
                keterangan: document.getElementById('masterKetCustomer').value
            };

            if (editId) {
                const index = dataMasterCustomer.findIndex(item => item.id === parseInt(editId));
                if (index !== -1) {
                    dataMasterCustomer[index] = { ...dataMasterCustomer[index], ...customerData };
                    alert('✅ Data customer berhasil diupdate!');
                }
                delete form.dataset.editId;
            } else {
                const customer = { id: Date.now(), ...customerData };
                dataMasterCustomer.push(customer);
                alert('✅ Data customer berhasil disimpan!');
            }

            saveDataToStorage();
            displayMasterCustomer();
            populateDataLists();
            invalidateDropdownCache();
            preloadDropdownData(); // Refresh cache data dropdown
            form.reset();

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '💾 Simpan';
            submitBtn.className = 'btn btn-primary';
            return false;
        }

        // Submit handler untuk form master supplier
        function submitMasterSupplier(e) {
            e.preventDefault();
            const form = document.getElementById('formMasterSupplier');
            const editId = form.dataset.editId;
            const supplierData = {
                nama: document.getElementById('masterNamaSupplier').value,
                alamat: document.getElementById('masterAlamatSupplier').value,
                telepon: document.getElementById('masterTeleponSupplier').value,
                npwp: document.getElementById('masterNpwpSupplier').value,
                email: document.getElementById('masterEmailSupplier').value,
                keterangan: document.getElementById('masterKetSupplier').value
            };

            if (editId) {
                const index = dataMasterSupplier.findIndex(item => item.id === parseInt(editId));
                if (index !== -1) {
                    dataMasterSupplier[index] = { ...dataMasterSupplier[index], ...supplierData };
                    alert('✅ Data supplier berhasil diupdate!');
                }
                delete form.dataset.editId;
            } else {
                const supplier = { id: Date.now(), ...supplierData };
                dataMasterSupplier.push(supplier);
                alert('✅ Data supplier berhasil disimpan!');
            }

            saveDataToStorage();
            displayMasterSupplier();
            populateDataLists();
            invalidateDropdownCache();
            preloadDropdownData(); // Refresh cache data dropdown
            form.reset();

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '💾 Simpan';
            submitBtn.className = 'btn btn-primary';
            return false;
        }

        // Submit handler untuk form master barang
        function submitMasterBarang(e) {
            e.preventDefault();
            const form = document.getElementById('formMasterBarang');
            const editId = form.dataset.editId;
            const barangData = {
                kode: document.getElementById('masterKodeBarang').value,
                nama: document.getElementById('masterNamaBarang').value,
                kategori: document.getElementById('masterKategoriBarang').value,
                satuan: document.getElementById('masterSatuanBarang').value,
                hargaBeli: parseRupiah(document.getElementById('masterHargaBeliBarang').value),
                hargaJual: parseRupiah(document.getElementById('masterHargaJualBarang').value),
                keterangan: document.getElementById('masterKetBarang').value
            };

            if (editId) {
                const index = dataMasterBarang.findIndex(item => item.id === parseInt(editId));
                if (index !== -1) {
                    dataMasterBarang[index] = { ...dataMasterBarang[index], ...barangData };
                    alert('✅ Data barang berhasil diupdate!');
                }
                delete form.dataset.editId;
            } else {
                const barang = { id: Date.now(), ...barangData };
                dataMasterBarang.push(barang);
                alert('✅ Data barang berhasil disimpan!');
            }

            saveDataToStorage();
            displayMasterBarang();
            populateDataLists();
            invalidateDropdownCache();
            preloadDropdownData(); // Refresh cache data dropdown
            form.reset();

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '💾 Simpan';
            submitBtn.className = 'btn btn-primary';
            return false;
        }

        // Submit handler untuk form kategori kas masuk
        function submitKategoriKasMasuk(e) {
            e.preventDefault();
            const namaKategori = document.getElementById('namaKategoriKasMasuk').value.trim();

            if (namaKategori && !kategoriKasMasuk.includes(namaKategori)) {
                kategoriKasMasuk.push(namaKategori);
                saveDataToStorage();
                displayKategoriKasMasuk();
                updateKategoriDropdowns();
                document.getElementById('formKategoriKasMasuk').reset();
                alert('✅ Kategori kas masuk berhasil ditambahkan!');
            } else if (kategoriKasMasuk.includes(namaKategori)) {
                alert('❌ Kategori sudah ada!');
            } else {
                alert('❌ Nama kategori tidak boleh kosong!');
            }
            return false;
        }

        // Submit handler untuk form kategori kas keluar
        function submitKategoriKasKeluar(e) {
            e.preventDefault();
            const namaKategori = document.getElementById('namaKategoriKasKeluar').value.trim();

            if (namaKategori && !kategoriKasKeluar.includes(namaKategori)) {
                kategoriKasKeluar.push(namaKategori);
                saveDataToStorage();
                displayKategoriKasKeluar();
                updateKategoriDropdowns();
                document.getElementById('formKategoriKasKeluar').reset();
                alert('✅ Kategori kas keluar berhasil ditambahkan!');
            } else if (kategoriKasKeluar.includes(namaKategori)) {
                alert('❌ Kategori sudah ada!');
            } else {
                alert('❌ Nama kategori tidak boleh kosong!');
            }
            return false;
        }

        // Setup event listeners untuk data master forms (dummy - forms now use onsubmit attribute)
        function setupDataMasterEventListeners() {
            // Event listeners sudah di-handle via onsubmit attribute di HTML
        }

        // Display Master Customer
        function displayMasterCustomer() {
            const tbody = document.getElementById('bodyMasterCustomer');
            if (dataMasterCustomer.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="center">Belum ada data customer. Klik "Muat Sample Data" untuk memuat contoh data.</td></tr>';
                const totalEl = document.getElementById('totalMasterCustomer');
                if (totalEl) totalEl.textContent = '0';
                return;
            }

            let html = '';
            dataMasterCustomer.forEach((item, index) => {
                html += `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${item.nama}</td>
                        <td>${item.alamat || '-'}</td>
                        <td>${item.telepon || '-'}</td>
                        <td>${item.npwp || '-'}</td>
                        <td>${item.email || '-'}</td>
                        <td>${item.keterangan || '-'}</td>
                        <td class="center">
                            <button class="btn btn-warning btn-xs mr-5" onclick="editMasterCustomer(${item.id})">✏️</button>
                            <button class="delete-btn btn-xs" onclick="deleteMasterCustomer(${item.id})">🗑️</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;

            // Update total counter
            const totalEl = document.getElementById('totalMasterCustomer');
            if (totalEl) totalEl.textContent = dataMasterCustomer.length;
        }

        // Display Master Supplier
        function displayMasterSupplier() {
            const tbody = document.getElementById('bodyMasterSupplier');
            if (dataMasterSupplier.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="center">Belum ada data supplier</td></tr>';
                const totalEl = document.getElementById('totalMasterSupplier');
                if (totalEl) totalEl.textContent = '0';
                return;
            }

            let html = '';
            dataMasterSupplier.forEach((item, index) => {
                html += `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${item.nama}</td>
                        <td>${item.alamat || '-'}</td>
                        <td>${item.telepon || '-'}</td>
                        <td>${item.npwp || '-'}</td>
                        <td>${item.email || '-'}</td>
                        <td>${item.keterangan || '-'}</td>
                        <td class="center">
                            <button class="btn btn-warning btn-xs mr-5" onclick="editMasterSupplier(${item.id})">✏️</button>
                            <button class="delete-btn btn-xs" onclick="deleteMasterSupplier(${item.id})">🗑️</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;

            // Update total counter
            const totalEl = document.getElementById('totalMasterSupplier');
            if (totalEl) totalEl.textContent = dataMasterSupplier.length;
        }

        // Display Master Barang
        function displayMasterBarang() {
            const tbody = document.getElementById('bodyMasterBarang');
            if (dataMasterBarang.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="center">Belum ada data barang</td></tr>';
                const totalEl = document.getElementById('totalMasterBarang');
                if (totalEl) totalEl.textContent = '0';
                return;
            }

            let html = '';
            dataMasterBarang.forEach((item, index) => {
                html += `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${item.kode || '-'}</td>
                        <td>${item.nama}</td>
                        <td>${item.kategori || '-'}</td>
                        <td>${item.satuan || '-'}</td>
                        <td class="number">${formatRupiah(item.hargaBeli || 0)}</td>
                        <td class="number">${formatRupiah(item.hargaJual || 0)}</td>
                        <td>${item.keterangan || '-'}</td>
                        <td class="center">
                            <button class="btn btn-warning btn-xs mr-5" onclick="editMasterBarang(${item.id})">✏️</button>
                            <button class="delete-btn btn-xs" onclick="deleteMasterBarang(${item.id})">🗑️</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;

            // Update total counter
            const totalEl = document.getElementById('totalMasterBarang');
            if (totalEl) totalEl.textContent = dataMasterBarang.length;
        }

        // Load Sample Data Functions
        function loadSampleCustomer() {
            if (confirm('Muat sample data customer? Data yang ada akan digabungkan.')) {
                const existingIds = dataMasterCustomer.map(c => c.nama.toLowerCase());
                let added = 0;
                sampleMasterCustomer.forEach(sample => {
                    if (!existingIds.includes(sample.nama.toLowerCase())) {
                        dataMasterCustomer.push({ ...sample, id: Date.now() + added });
                        added++;
                    }
                });
                saveDataToStorage();
                displayMasterCustomer();
                populateDataLists();
                alert(`✅ ${added} sample customer berhasil ditambahkan!`);
            }
        }

        function loadSampleSupplier() {
            if (confirm('Muat sample data supplier? Data yang ada akan digabungkan.')) {
                const existingIds = dataMasterSupplier.map(s => s.nama.toLowerCase());
                let added = 0;
                sampleMasterSupplier.forEach(sample => {
                    if (!existingIds.includes(sample.nama.toLowerCase())) {
                        dataMasterSupplier.push({ ...sample, id: Date.now() + added });
                        added++;
                    }
                });
                saveDataToStorage();
                displayMasterSupplier();
                populateDataLists();
                alert(`✅ ${added} sample supplier berhasil ditambahkan!`);
            }
        }

        function loadSampleBarang() {
            if (confirm('Muat sample data barang? Data yang ada akan digabungkan.')) {
                const existingIds = dataMasterBarang.map(b => b.nama.toLowerCase());
                let added = 0;
                sampleMasterBarang.forEach(sample => {
                    if (!existingIds.includes(sample.nama.toLowerCase())) {
                        dataMasterBarang.push({ ...sample, id: Date.now() + added });
                        added++;
                    }
                });
                saveDataToStorage();
                displayMasterBarang();
                populateDataLists();
                alert(`✅ ${added} sample barang berhasil ditambahkan!`);
            }
        }

        // Reset Data Master ke Default
        function resetDataMasterToDefault() {
            if (confirm('⚠️ PERHATIAN!\n\nApakah Anda yakin ingin mereset SEMUA data master (Customer, Supplier, Barang) ke data default?\n\nData yang sudah ditambahkan akan HILANG!')) {
                // Reset Customer
                dataMasterCustomer = JSON.parse(JSON.stringify(sampleMasterCustomer));

                // Reset Supplier
                dataMasterSupplier = JSON.parse(JSON.stringify(sampleMasterSupplier));

                // Reset Barang
                dataMasterBarang = JSON.parse(JSON.stringify(sampleMasterBarang));

                // Simpan ke localStorage
                saveDataToStorage();

                // Refresh tampilan
                displayMasterCustomer();
                displayMasterSupplier();
                displayMasterBarang();
                populateDataLists();
                setupAllAutocomplete();

                alert('✅ Semua data master berhasil direset ke data default!\n\nCustomer: ' + dataMasterCustomer.length +
                    '\nSupplier: ' + dataMasterSupplier.length +
                    '\nBarang: ' + dataMasterBarang.length);
            }
        }

        // Delete Master Customer
        function deleteMasterCustomer(id) {
            if (confirm('Yakin ingin menghapus customer ini?')) {
                dataMasterCustomer = dataMasterCustomer.filter(item => item.id !== id);
                saveDataToStorage();
                displayMasterCustomer();
                populateDataLists();
                invalidateDropdownCache();
                preloadDropdownData(); // Refresh cache data dropdown
            }
        }

        // Edit Master Customer
        function editMasterCustomer(id) {
            const customer = dataMasterCustomer.find(item => item.id === id);
            if (!customer) return;

            document.getElementById('masterNamaCustomer').value = customer.nama;
            document.getElementById('masterAlamatCustomer').value = customer.alamat || '';
            document.getElementById('masterTeleponCustomer').value = customer.telepon || '';
            document.getElementById('masterNpwpCustomer').value = customer.npwp || '';
            document.getElementById('masterEmailCustomer').value = customer.email || '';
            document.getElementById('masterKetCustomer').value = customer.keterangan || '';

            // Ubah form menjadi mode edit
            const form = document.getElementById('formMasterCustomer');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '✏️ Update Customer';
            submitBtn.className = 'btn btn-warning';

            // Simpan ID yang sedang diedit
            form.dataset.editId = id;

            // Scroll ke form
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Delete Master Supplier
        function deleteMasterSupplier(id) {
            if (confirm('Yakin ingin menghapus supplier ini?')) {
                dataMasterSupplier = dataMasterSupplier.filter(item => item.id !== id);
                saveDataToStorage();
                displayMasterSupplier();
                populateDataLists();
                invalidateDropdownCache();
                preloadDropdownData(); // Refresh cache data dropdown
            }
        }

        // Edit Master Supplier
        function editMasterSupplier(id) {
            const supplier = dataMasterSupplier.find(item => item.id === id);
            if (!supplier) return;

            document.getElementById('masterNamaSupplier').value = supplier.nama;
            document.getElementById('masterAlamatSupplier').value = supplier.alamat || '';
            document.getElementById('masterTeleponSupplier').value = supplier.telepon || '';
            document.getElementById('masterNpwpSupplier').value = supplier.npwp || '';
            document.getElementById('masterEmailSupplier').value = supplier.email || '';
            document.getElementById('masterKetSupplier').value = supplier.keterangan || '';

            const form = document.getElementById('formMasterSupplier');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '✏️ Update Supplier';
            submitBtn.className = 'btn btn-warning';
            form.dataset.editId = id;
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Delete Master Barang
        function deleteMasterBarang(id) {
            if (confirm('Yakin ingin menghapus barang ini?')) {
                dataMasterBarang = dataMasterBarang.filter(item => item.id !== id);
                saveDataToStorage();
                displayMasterBarang();
                populateDataLists();
                invalidateDropdownCache();
                preloadDropdownData(); // Refresh cache data dropdown
            }
        }

        // Edit Master Barang
        function editMasterBarang(id) {
            const barang = dataMasterBarang.find(item => item.id === id);
            if (!barang) return;

            document.getElementById('masterKodeBarang').value = barang.kode || '';
            document.getElementById('masterNamaBarang').value = barang.nama;
            document.getElementById('masterKategoriBarang').value = barang.kategori || '';
            document.getElementById('masterSatuanBarang').value = barang.satuan || '';
            document.getElementById('masterHargaBeliBarang').value = formatRupiah(barang.hargaBeli || 0);
            document.getElementById('masterHargaJualBarang').value = formatRupiah(barang.hargaJual || 0);
            document.getElementById('masterKetBarang').value = barang.keterangan || '';

            const form = document.getElementById('formMasterBarang');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = '✏️ Update Barang';
            submitBtn.className = 'btn btn-warning';
            form.dataset.editId = id;
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ===== EXPORT/IMPORT BARANG EXCEL =====

        // Export data barang ke Excel
        function exportBarangToExcel() {
            if (dataMasterBarang.length === 0) {
                alert('❌ Tidak ada data barang untuk di-export!');
                return;
            }

            // Siapkan data untuk export
            const exportData = dataMasterBarang.map((item, index) => ({
                'No': index + 1,
                'Kode': item.kode || '',
                'Nama Barang': item.nama || '',
                'Kategori': item.kategori || '',
                'Satuan': item.satuan || '',
                'Harga Beli': item.hargaBeli || 0,
                'Harga Jual': item.hargaJual || 0,
                'Keterangan': item.keterangan || ''
            }));

            // Buat workbook dan worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Barang');

            // Set lebar kolom
            ws['!cols'] = [
                { wch: 5 },   // No
                { wch: 15 },  // Kode
                { wch: 35 },  // Nama Barang
                { wch: 20 },  // Kategori
                { wch: 10 },  // Satuan
                { wch: 15 },  // Harga Beli
                { wch: 15 },  // Harga Jual
                { wch: 30 }   // Keterangan
            ];

            // Generate nama file dengan tanggal
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
            const fileName = `Data_Barang_SGM_${dateStr}.xlsx`;

            // Download file
            XLSX.writeFile(wb, fileName);
            alert('✅ Data barang berhasil di-export ke ' + fileName);
        }

        // Import data barang dari Excel
        function importBarangFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validasi tipe file
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
            if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)) {
                alert('❌ Format file tidak valid! Gunakan file Excel (.xlsx atau .xls)');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Ambil sheet pertama
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Convert ke JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

                    if (jsonData.length === 0) {
                        alert('❌ File Excel kosong atau format tidak sesuai!');
                        event.target.value = '';
                        return;
                    }

                    // Konfirmasi import
                    const confirmMsg = `Ditemukan ${jsonData.length} baris data.\n\nPilih mode import:\n- OK: Tambahkan ke data yang sudah ada\n- Cancel: Batalkan import`;
                    if (!confirm(confirmMsg)) {
                        event.target.value = '';
                        return;
                    }

                    // Tanya apakah mau replace atau append
                    const replaceData = confirm('Apakah ingin MENGGANTI semua data barang yang ada?\n\n- OK: Ganti semua data (data lama akan dihapus)\n- Cancel: Tambahkan ke data yang sudah ada');

                    if (replaceData) {
                        dataMasterBarang = [];
                    }

                    // Parse dan masukkan data
                    let imported = 0;
                    let skipped = 0;
                    const maxId = dataMasterBarang.length > 0 ? Math.max(...dataMasterBarang.map(b => b.id)) : 0;

                    jsonData.forEach((row, index) => {
                        // Cari nama barang dari berbagai kemungkinan header
                        const namaBarang = row['Nama Barang'] || row['NAMA BARANG'] || row['nama barang'] ||
                            row['Nama'] || row['NAMA'] || row['nama'] ||
                            row['Barang'] || row['BARANG'] || row['barang'] || '';

                        if (!namaBarang || namaBarang.toString().trim() === '') {
                            skipped++;
                            return;
                        }

                        // Parse harga (handle format dengan koma atau titik)
                        const parseHarga = (val) => {
                            if (!val) return 0;
                            const str = val.toString().replace(/[^\d]/g, '');
                            return parseInt(str) || 0;
                        };

                        const barangData = {
                            id: maxId + index + 1,
                            kode: (row['Kode'] || row['KODE'] || row['kode'] || '').toString().trim(),
                            nama: namaBarang.toString().trim(),
                            kategori: (row['Kategori'] || row['KATEGORI'] || row['kategori'] || '').toString().trim(),
                            satuan: (row['Satuan'] || row['SATUAN'] || row['satuan'] || row['Unit'] || '').toString().trim(),
                            hargaBeli: parseHarga(row['Harga Beli'] || row['HARGA BELI'] || row['harga beli'] || row['HargaBeli'] || 0),
                            hargaJual: parseHarga(row['Harga Jual'] || row['HARGA JUAL'] || row['harga jual'] || row['HargaJual'] || 0),
                            keterangan: (row['Keterangan'] || row['KETERANGAN'] || row['keterangan'] || row['Ket'] || '').toString().trim()
                        };

                        dataMasterBarang.push(barangData);
                        imported++;
                    });

                    // Simpan dan refresh
                    saveDataToStorage();
                    displayMasterBarang();
                    populateDataLists();
                    invalidateDropdownCache();
                    preloadDropdownData(); // Refresh cache data dropdown

                    alert(`✅ Import selesai!\n\n- Berhasil: ${imported} barang\n- Dilewati: ${skipped} baris (nama kosong)\n- Total data barang: ${dataMasterBarang.length}`);

                } catch (error) {
                    console.error('Import error:', error);
                    alert('❌ Gagal membaca file Excel!\nPastikan format file benar.\n\nError: ' + error.message);
                }

                // Reset input file
                event.target.value = '';
            };

            reader.onerror = function () {
                alert('❌ Gagal membaca file!');
                event.target.value = '';
            };

            reader.readAsArrayBuffer(file);
        }

        // Download template Excel untuk import barang
        function downloadTemplateBarang() {
            // Buat data template dengan contoh
            const templateData = [
                {
                    'Kode': 'BRG001',
                    'Nama Barang': 'Contoh Barang 1',
                    'Kategori': 'Bahan Bangunan',
                    'Satuan': 'Sak',
                    'Harga Beli': 50000,
                    'Harga Jual': 55000,
                    'Keterangan': 'Contoh keterangan'
                },
                {
                    'Kode': 'BRG002',
                    'Nama Barang': 'Contoh Barang 2',
                    'Kategori': 'Besi',
                    'Satuan': 'Batang',
                    'Harga Beli': 75000,
                    'Harga Jual': 85000,
                    'Keterangan': ''
                }
            ];

            // Buat workbook dan worksheet
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template Barang');

            // Set lebar kolom
            ws['!cols'] = [
                { wch: 15 },  // Kode
                { wch: 35 },  // Nama Barang
                { wch: 20 },  // Kategori
                { wch: 10 },  // Satuan
                { wch: 15 },  // Harga Beli
                { wch: 15 },  // Harga Jual
                { wch: 30 }   // Keterangan
            ];

            // Download file
            XLSX.writeFile(wb, 'Template_Import_Barang.xlsx');
            alert('✅ Template berhasil di-download!\n\nPetunjuk:\n1. Isi data barang sesuai kolom yang tersedia\n2. Kolom "Nama Barang" wajib diisi\n3. Hapus baris contoh sebelum import\n4. Simpan sebagai file .xlsx');
        }

        // ===== EXPORT/IMPORT CUSTOMER EXCEL =====

        // Export data customer ke Excel
        function exportCustomerToExcel() {
            if (dataMasterCustomer.length === 0) {
                alert('❌ Tidak ada data customer untuk di-export!');
                return;
            }

            const exportData = dataMasterCustomer.map((item, index) => ({
                'No': index + 1,
                'Nama Customer': item.nama || '',
                'Alamat': item.alamat || '',
                'Telepon': item.telepon || '',
                'NPWP/NIK': item.npwp || '',
                'Email': item.email || '',
                'Keterangan': item.keterangan || ''
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Customer');

            ws['!cols'] = [
                { wch: 5 },   // No
                { wch: 30 },  // Nama Customer
                { wch: 40 },  // Alamat
                { wch: 15 },  // Telepon
                { wch: 20 },  // NPWP/NIK
                { wch: 25 },  // Email
                { wch: 30 }   // Keterangan
            ];

            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
            const fileName = `Data_Customer_SGM_${dateStr}.xlsx`;

            XLSX.writeFile(wb, fileName);
            alert('✅ Data customer berhasil di-export ke ' + fileName);
        }

        // Import data customer dari Excel
        function importCustomerFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

                    if (jsonData.length === 0) {
                        alert('❌ File Excel kosong atau format tidak sesuai!');
                        event.target.value = '';
                        return;
                    }

                    if (!confirm(`Ditemukan ${jsonData.length} baris data.\n\nLanjutkan import?`)) {
                        event.target.value = '';
                        return;
                    }

                    const replaceData = confirm('Apakah ingin MENGGANTI semua data customer yang ada?\n\n- OK: Ganti semua data\n- Cancel: Tambahkan ke data yang sudah ada');

                    if (replaceData) dataMasterCustomer = [];

                    let imported = 0;
                    let skipped = 0;
                    const maxId = dataMasterCustomer.length > 0 ? Math.max(...dataMasterCustomer.map(c => c.id)) : 0;

                    jsonData.forEach((row, index) => {
                        const namaCustomer = row['Nama Customer'] || row['NAMA CUSTOMER'] || row['nama customer'] ||
                            row['Nama'] || row['NAMA'] || row['nama'] || '';

                        if (!namaCustomer || namaCustomer.toString().trim() === '') {
                            skipped++;
                            return;
                        }

                        const customerData = {
                            id: maxId + index + 1,
                            nama: namaCustomer.toString().trim(),
                            alamat: (row['Alamat'] || row['ALAMAT'] || row['alamat'] || '').toString().trim(),
                            telepon: (row['Telepon'] || row['TELEPON'] || row['telepon'] || row['HP'] || '').toString().trim(),
                            npwp: (row['NPWP/NIK'] || row['NPWP'] || row['NIK'] || row['npwp'] || '').toString().trim(),
                            email: (row['Email'] || row['EMAIL'] || row['email'] || '').toString().trim(),
                            keterangan: (row['Keterangan'] || row['KETERANGAN'] || row['keterangan'] || '').toString().trim()
                        };

                        dataMasterCustomer.push(customerData);
                        imported++;
                    });

                    saveDataToStorage();
                    displayMasterCustomer();
                    populateDataLists();
                    invalidateDropdownCache();

                    alert(`✅ Import selesai!\n\n- Berhasil: ${imported} customer\n- Dilewati: ${skipped} baris\n- Total data: ${dataMasterCustomer.length}`);

                } catch (error) {
                    alert('❌ Gagal membaca file Excel!\n\nError: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // Download template Excel untuk import customer
        function downloadTemplateCustomer() {
            const templateData = [
                {
                    'Nama Customer': 'Contoh Customer 1',
                    'Alamat': 'Jl. Contoh No. 1',
                    'Telepon': '081234567890',
                    'NPWP/NIK': '12.345.678.9-012.345',
                    'Email': 'contoh@email.com',
                    'Keterangan': 'Pelanggan tetap'
                }
            ];

            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template Customer');

            ws['!cols'] = [
                { wch: 30 },  // Nama Customer
                { wch: 40 },  // Alamat
                { wch: 15 },  // Telepon
                { wch: 20 },  // NPWP/NIK
                { wch: 25 },  // Email
                { wch: 30 }   // Keterangan
            ];

            XLSX.writeFile(wb, 'Template_Import_Customer.xlsx');
            alert('✅ Template berhasil di-download!\n\nKolom "Nama Customer" wajib diisi.');
        }

        // ===== EXPORT/IMPORT SUPPLIER EXCEL =====

        // Export data supplier ke Excel
        function exportSupplierToExcel() {
            if (dataMasterSupplier.length === 0) {
                alert('❌ Tidak ada data supplier untuk di-export!');
                return;
            }

            const exportData = dataMasterSupplier.map((item, index) => ({
                'No': index + 1,
                'Nama Supplier': item.nama || '',
                'Alamat': item.alamat || '',
                'Telepon': item.telepon || '',
                'NPWP/NIK': item.npwp || '',
                'Email': item.email || '',
                'Keterangan': item.keterangan || ''
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Supplier');

            ws['!cols'] = [
                { wch: 5 },   // No
                { wch: 30 },  // Nama Supplier
                { wch: 40 },  // Alamat
                { wch: 15 },  // Telepon
                { wch: 20 },  // NPWP/NIK
                { wch: 25 },  // Email
                { wch: 30 }   // Keterangan
            ];

            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
            const fileName = `Data_Supplier_SGM_${dateStr}.xlsx`;

            XLSX.writeFile(wb, fileName);
            alert('✅ Data supplier berhasil di-export ke ' + fileName);
        }

        // Import data supplier dari Excel
        function importSupplierFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

                    if (jsonData.length === 0) {
                        alert('❌ File Excel kosong atau format tidak sesuai!');
                        event.target.value = '';
                        return;
                    }

                    if (!confirm(`Ditemukan ${jsonData.length} baris data.\n\nLanjutkan import?`)) {
                        event.target.value = '';
                        return;
                    }

                    const replaceData = confirm('Apakah ingin MENGGANTI semua data supplier yang ada?\n\n- OK: Ganti semua data\n- Cancel: Tambahkan ke data yang sudah ada');

                    if (replaceData) dataMasterSupplier = [];

                    let imported = 0;
                    let skipped = 0;
                    const maxId = dataMasterSupplier.length > 0 ? Math.max(...dataMasterSupplier.map(s => s.id)) : 0;

                    jsonData.forEach((row, index) => {
                        const namaSupplier = row['Nama Supplier'] || row['NAMA SUPPLIER'] || row['nama supplier'] ||
                            row['Nama'] || row['NAMA'] || row['nama'] || '';

                        if (!namaSupplier || namaSupplier.toString().trim() === '') {
                            skipped++;
                            return;
                        }

                        const supplierData = {
                            id: maxId + index + 1,
                            nama: namaSupplier.toString().trim(),
                            alamat: (row['Alamat'] || row['ALAMAT'] || row['alamat'] || '').toString().trim(),
                            telepon: (row['Telepon'] || row['TELEPON'] || row['telepon'] || row['HP'] || '').toString().trim(),
                            npwp: (row['NPWP/NIK'] || row['NPWP'] || row['NIK'] || row['npwp'] || '').toString().trim(),
                            email: (row['Email'] || row['EMAIL'] || row['email'] || '').toString().trim(),
                            keterangan: (row['Keterangan'] || row['KETERANGAN'] || row['keterangan'] || '').toString().trim()
                        };

                        dataMasterSupplier.push(supplierData);
                        imported++;
                    });

                    saveDataToStorage();
                    displayMasterSupplier();
                    populateDataLists();
                    invalidateDropdownCache();

                    alert(`✅ Import selesai!\n\n- Berhasil: ${imported} supplier\n- Dilewati: ${skipped} baris\n- Total data: ${dataMasterSupplier.length}`);

                } catch (error) {
                    alert('❌ Gagal membaca file Excel!\n\nError: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // Download template Excel untuk import supplier
        function downloadTemplateSupplier() {
            const templateData = [
                {
                    'Nama Supplier': 'Contoh Supplier 1',
                    'Alamat': 'Jl. Supplier No. 1',
                    'Telepon': '081234567890',
                    'NPWP/NIK': '12.345.678.9-012.345',
                    'Email': 'supplier@email.com',
                    'Keterangan': 'Pemasok utama'
                }
            ];

            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template Supplier');

            ws['!cols'] = [
                { wch: 30 },  // Nama Supplier
                { wch: 40 },  // Alamat
                { wch: 15 },  // Telepon
                { wch: 20 },  // NPWP/NIK
                { wch: 25 },  // Email
                { wch: 30 }   // Keterangan
            ];

            XLSX.writeFile(wb, 'Template_Import_Supplier.xlsx');
            alert('✅ Template berhasil di-download!\n\nKolom "Nama Supplier" wajib diisi.');
        }

        // ===== KATEGORI AKUN FUNCTIONS =====

        // Setup event listeners setelah DOM ready (dummy - forms now use onsubmit attribute)
        function setupKategoriEventListeners() {
            // Event listeners sudah di-handle via onsubmit attribute di HTML
        }

        // Edit Kategori Kas Masuk
        function editKategoriKasMasuk(oldName) {
            if (kategoriDefault.kasMasuk.includes(oldName)) {
                alert('❌ Kategori default tidak bisa diedit!');
                return;
            }

            const newName = prompt('Edit nama kategori:', oldName);
            if (newName && newName.trim() !== '' && newName !== oldName) {
                const trimmedName = newName.trim();
                if (kategoriKasMasuk.includes(trimmedName)) {
                    alert('❌ Kategori dengan nama tersebut sudah ada!');
                    return;
                }
                const index = kategoriKasMasuk.indexOf(oldName);
                if (index !== -1) {
                    kategoriKasMasuk[index] = trimmedName;
                    saveDataToStorage();
                    displayKategoriKasMasuk();
                    updateKategoriDropdowns();
                    alert('✅ Kategori berhasil diubah!');
                }
            }
        }

        // Edit Kategori Kas Keluar
        function editKategoriKasKeluar(oldName) {
            if (kategoriDefault.kasKeluar.includes(oldName)) {
                alert('❌ Kategori default tidak bisa diedit!');
                return;
            }

            const newName = prompt('Edit nama kategori:', oldName);
            if (newName && newName.trim() !== '' && newName !== oldName) {
                const trimmedName = newName.trim();
                if (kategoriKasKeluar.includes(trimmedName)) {
                    alert('❌ Kategori dengan nama tersebut sudah ada!');
                    return;
                }
                const index = kategoriKasKeluar.indexOf(oldName);
                if (index !== -1) {
                    kategoriKasKeluar[index] = trimmedName;
                    saveDataToStorage();
                    displayKategoriKasKeluar();
                    updateKategoriDropdowns();
                    alert('✅ Kategori berhasil diubah!');
                }
            }
        }

        // Display Kategori Kas Masuk
        function displayKategoriKasMasuk() {
            const tbody = document.getElementById('bodyKategoriKasMasuk');
            if (kategoriKasMasuk.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="center">Belum ada kategori</td></tr>';
                return;
            }

            let html = '';
            kategoriKasMasuk.forEach((item, index) => {
                const isDefault = kategoriDefault.kasMasuk.includes(item);
                const escapedItem = item.replace(/'/g, "\\'");
                html += `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${item} ${isDefault ? '<span class="text-muted text-xxs">(default)</span>' : ''}</td>
                        <td class="center">
                            ${!isDefault ? `
                                <button class="btn btn-warning btn-xs mr-5" onclick="editKategoriKasMasuk('${escapedItem}')">✏️ Edit</button>
                                <button class="delete-btn btn-xs" onclick="deleteKategoriKasMasuk('${escapedItem}')">🗑️</button>
                            ` : '<span class="text-muted">-</span>'}
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // Display Kategori Kas Keluar
        function displayKategoriKasKeluar() {
            const tbody = document.getElementById('bodyKategoriKasKeluar');
            if (kategoriKasKeluar.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="center">Belum ada kategori</td></tr>';
                return;
            }

            let html = '';
            kategoriKasKeluar.forEach((item, index) => {
                const isDefault = kategoriDefault.kasKeluar.includes(item);
                const escapedItem = item.replace(/'/g, "\\'");
                html += `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${item} ${isDefault ? '<span class="text-muted text-xxs">(default)</span>' : ''}</td>
                        <td class="center">
                            ${!isDefault ? `
                                <button class="btn btn-warning btn-xs mr-5" onclick="editKategoriKasKeluar('${escapedItem}')">✏️ Edit</button>
                                <button class="delete-btn btn-xs" onclick="deleteKategoriKasKeluar('${escapedItem}')">🗑️</button>
                            ` : '<span class="text-muted">-</span>'}
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // Delete Kategori Kas Masuk
        function deleteKategoriKasMasuk(nama) {
            if (kategoriDefault.kasMasuk.includes(nama)) {
                alert('❌ Kategori default tidak bisa dihapus!');
                return;
            }

            if (confirm(`Yakin ingin menghapus kategori "${nama}"?`)) {
                kategoriKasMasuk = kategoriKasMasuk.filter(item => item !== nama);
                saveDataToStorage();
                displayKategoriKasMasuk();
                updateKategoriDropdowns();
            }
        }

        // Delete Kategori Kas Keluar
        function deleteKategoriKasKeluar(nama) {
            if (kategoriDefault.kasKeluar.includes(nama)) {
                alert('❌ Kategori default tidak bisa dihapus!');
                return;
            }

            if (confirm(`Yakin ingin menghapus kategori "${nama}"?`)) {
                kategoriKasKeluar = kategoriKasKeluar.filter(item => item !== nama);
                saveDataToStorage();
                displayKategoriKasKeluar();
                updateKategoriDropdowns();
            }
        }

        // Update Kategori Dropdowns
        function updateKategoriDropdowns() {
            // Fungsi ini sudah tidak diperlukan karena kategori sekarang menggunakan 
            // sistem autocomplete dengan array kategoriKas yang tunggal
            // Display kategori sudah dihandle oleh displayKategori() di Data Master
            console.log('updateKategoriDropdowns called - using unified kategoriKas');
        }

        // Update populateDataLists untuk menggunakan data master
        function populateDataLists() {
            // Dapatkan customer dari data master + transaksi + piutang awal
            const customersFromMaster = dataMasterCustomer.map(c => c.nama).filter(n => n && n.trim());
            const customersFromTrans = [...new Set(dataPenjualan.map(p => p.namaPelanggan).filter(n => n && n.trim()))];
            const customersFromPiutang = [...new Set(dataPiutangAwal.map(p => p.namaPelanggan).filter(n => n && n.trim()))];
            const customers = [...new Set([...customersFromMaster, ...customersFromTrans, ...customersFromPiutang])].sort();
            const listCustomer = document.getElementById('listCustomer');
            if (listCustomer) {
                listCustomer.innerHTML = '';
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer;
                    listCustomer.appendChild(option);
                });
            }

            // Dapatkan supplier dari data master + transaksi + hutang awal
            const suppliersFromMaster = dataMasterSupplier.map(s => s.nama).filter(n => n && n.trim());
            const suppliersFromTrans = [...new Set(dataPembelian.map(p => p.namaSupplier).filter(n => n && n.trim()))];
            const suppliersFromHutang = [...new Set(dataHutangAwal.map(h => h.namaSupplier).filter(n => n && n.trim()))];
            const suppliers = [...new Set([...suppliersFromMaster, ...suppliersFromTrans, ...suppliersFromHutang])].sort();
            const listSupplier = document.getElementById('listSupplier');
            if (listSupplier) {
                listSupplier.innerHTML = '';
                suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier;
                    listSupplier.appendChild(option);
                });
            }

            // Dapatkan barang dari data master + transaksi
            const barangFromMaster = dataMasterBarang.map(b => b.nama).filter(n => n && n.trim());
            const barangJual = dataPenjualan.map(p => p.namaBarang).filter(n => n && n.trim());
            const barangBeli = dataPembelian.map(p => p.namaBarang).filter(n => n && n.trim());
            const barang = [...new Set([...barangFromMaster, ...barangJual, ...barangBeli])].sort();

            // Populate listBarang (untuk form penjualan)
            const listBarang = document.getElementById('listBarang');
            if (listBarang) {
                listBarang.innerHTML = '';
                barang.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    listBarang.appendChild(option);
                });
            }

            // Populate listBarangBeli (untuk form pembelian)
            const listBarangBeli = document.getElementById('listBarangBeli');
            if (listBarangBeli) {
                listBarangBeli.innerHTML = '';
                barang.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    listBarangBeli.appendChild(option);
                });
            }

            // Log untuk debugging (bisa dihapus nanti)
            console.log('DataLists populated:', {
                customers: customers.length,
                suppliers: suppliers.length,
                barang: barang.length
            });
        }

        // Update updateCustomerInfo untuk cek data master dulu
        function updateCustomerInfo() {
            const customerName = document.getElementById('namaPelanggan').value;

            // Cek di data master dulu
            const masterCustomer = dataMasterCustomer.find(c => c.nama === customerName);
            if (masterCustomer) {
                document.getElementById('alamatPelanggan').value = masterCustomer.alamat || '';
                document.getElementById('teleponPelanggan').value = masterCustomer.telepon || '';
                document.getElementById('npwpPelanggan').value = masterCustomer.npwp || '';
                return;
            }

            // Jika tidak ada di master, cari di transaksi
            const lastCustomer = dataPenjualan.slice().reverse().find(p => p.namaPelanggan === customerName);
            if (lastCustomer) {
                document.getElementById('alamatPelanggan').value = lastCustomer.alamatPelanggan || '';
                document.getElementById('teleponPelanggan').value = lastCustomer.teleponPelanggan || '';
                document.getElementById('npwpPelanggan').value = lastCustomer.npwpPelanggan || '';
            }
        }

        // Update updateSupplierInfo untuk cek data master dulu
        function updateSupplierInfo() {
            const supplierName = document.getElementById('namaSupplier').value;

            // Cek di data master dulu
            const masterSupplier = dataMasterSupplier.find(s => s.nama === supplierName);
            if (masterSupplier) {
                document.getElementById('alamatSupplier').value = masterSupplier.alamat || '';
                document.getElementById('teleponSupplier').value = masterSupplier.telepon || '';
                document.getElementById('npwpSupplier').value = masterSupplier.npwp || '';
                return;
            }

            // Jika tidak ada di master, cari di transaksi
            const lastSupplier = dataPembelian.slice().reverse().find(p => p.namaSupplier === supplierName);
            if (lastSupplier) {
                document.getElementById('alamatSupplier').value = lastSupplier.alamatSupplier || '';
                document.getElementById('teleponSupplier').value = lastSupplier.teleponSupplier || '';
                document.getElementById('npwpSupplier').value = lastSupplier.npwpSupplier || '';
            }
        }

        // Auto-fill harga barang saat memilih dari list (Penjualan)
        function updateBarangInfoJual() {
            const barangName = document.getElementById('namaBarangJual').value;

            // Cek di data master barang
            const masterBarang = dataMasterBarang.find(b => b.nama === barangName);
            if (masterBarang) {
                if (masterBarang.hargaJual) {
                    document.getElementById('hargaJual').value = formatRupiah(masterBarang.hargaJual);
                    calculateTotalJual();
                }
            }
        }

        // Auto-fill harga barang saat memilih dari list (Pembelian)
        function updateBarangInfoBeli() {
            const barangName = document.getElementById('namaBarangBeli').value;

            // Cek di data master barang
            const masterBarang = dataMasterBarang.find(b => b.nama === barangName);
            if (masterBarang) {
                if (masterBarang.hargaBeli) {
                    document.getElementById('hargaBeli').value = formatRupiah(masterBarang.hargaBeli);
                    calculateTotalBeli();
                }
            }
        }

        // Reset form
        function resetForm(formId) {
            if (formId === 'formPenjualan') {
                resetFormPenjualanCustom();
            } else if (formId === 'formPembelian') {
                resetFormPembelianCustom();
            } else {
                document.getElementById(formId).reset();
            }
            setDefaultDates();
            generateNoFaktur();
        }

        // Show alert
        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 3000);
        }

        // Format Rupiah
        function formatRupiah(angka) {
            if (angka === undefined || angka === null) return 'Rp 0';
            return 'Rp ' + Number(angka).toLocaleString('id-ID');
        }

        // Format Angka
        function formatAngka(angka) {
            if (angka === undefined || angka === null) return '0';
            return Number(angka).toLocaleString('id-ID');
        }

        // Fungsi Terbilang
        function terbilang(angka) {
            const bilangan = ['', 'Satu', 'Dua', 'Tiga', 'Empat', 'Lima', 'Enam', 'Tujuh', 'Delapan', 'Sembilan', 'Sepuluh', 'Sebelas'];

            if (angka < 12) {
                return bilangan[angka];
            } else if (angka < 20) {
                return bilangan[angka - 10] + ' Belas';
            } else if (angka < 100) {
                return bilangan[Math.floor(angka / 10)] + ' Puluh ' + bilangan[angka % 10];
            } else if (angka < 200) {
                return 'Seratus ' + terbilang(angka - 100);
            } else if (angka < 1000) {
                return bilangan[Math.floor(angka / 100)] + ' Ratus ' + terbilang(angka % 100);
            } else if (angka < 2000) {
                return 'Seribu ' + terbilang(angka - 1000);
            } else if (angka < 1000000) {
                return terbilang(Math.floor(angka / 1000)) + ' Ribu ' + terbilang(angka % 1000);
            } else if (angka < 1000000000) {
                return terbilang(Math.floor(angka / 1000000)) + ' Juta ' + terbilang(angka % 1000000);
            } else if (angka < 1000000000000) {
                return terbilang(Math.floor(angka / 1000000000)) + ' Miliar ' + terbilang(angka % 1000000000);
            } else if (angka < 1000000000000000) {
                return terbilang(Math.floor(angka / 1000000000000)) + ' Triliun ' + terbilang(angka % 1000000000000);
            } else {
                return 'Angka terlalu besar';
            }
        }

        function terbilangRupiah(angka) {
            if (angka === 0) return 'Nol Rupiah';
            const hasil = terbilang(Math.floor(angka)).trim();
            return hasil + ' Rupiah';
        }

        // Template HTML untuk laporan Excel-like
        function getStyleCetakLaporan() {
            return `
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    }
                    body {
                        background: white;
                        padding: 20px;
                    }
                    .container {
                        max-width: 100%;
                        background: white;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #000;
                        padding-bottom: 10px;
                    }
                    .header h1 {
                        font-size: 18px;
                        font-weight: bold;
                        margin-bottom: 5px;
                    }
                    .header p {
                        font-size: 12px;
                        margin: 2px 0;
                        color: #333;
                    }
                    .periode {
                        text-align: center;
                        font-size: 11px;
                        margin-bottom: 15px;
                        font-weight: bold;
                        color: #555;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 10px;
                        font-size: 10px;
                    }
                    th {
                        background-color: #2E7D32;
                        color: white;
                        padding: 8px;
                        text-align: left;
                        font-weight: bold;
                        border: 1px solid #000;
                    }
                    td {
                        padding: 6px 8px;
                        border: 1px solid #ddd;
                        font-size: 10px;
                    }
                    tr:nth-child(even) {
                        background-color: #f9f9f9;
                    }
                    tr:nth-child(odd) {
                        background-color: #ffffff;
                    }
                    .number {
                        text-align: right;
                        font-family: 'Courier New', monospace;
                    }
                    .center {
                        text-align: center;
                    }
                    .total-row {
                        background-color: #fff3e0;
                        font-weight: bold;
                        border-top: 2px solid #000;
                        border-bottom: 2px solid #000;
                    }
                    .header-row {
                        background-color: #e3f2fd;
                        font-weight: bold;
                        border: 1px solid #000;
                    }
                    .summary {
                        margin-top: 20px;
                        padding: 10px;
                        background-color: #f5f5f5;
                        border: 1px solid #ddd;
                        font-size: 10px;
                    }
                    .summary-row {
                        display: flex;
                        justify-content: space-between;
                        margin: 5px 0;
                        padding: 3px 0;
                    }
                    .summary-label {
                        font-weight: bold;
                    }
                    .summary-value {
                        font-family: 'Courier New', monospace;
                        text-align: right;
                        min-width: 150px;
                    }
                    .footer {
                        margin-top: 30px;
                        text-align: right;
                        font-size: 10px;
                    }
                    .signature-row {
                        display: flex;
                        justify-content: space-around;
                        margin-top: 40px;
                        font-size: 10px;
                    }
                    .signature-box {
                        text-align: center;
                        width: 150px;
                    }
                    .signature-line {
                        border-top: 1px solid #000;
                        margin-top: 40px;
                        margin-bottom: 5px;
                        height: 1px;
                    }
                    .badge {
                        padding: 2px 5px;
                        border-radius: 3px;
                        font-size: 9px;
                        font-weight: bold;
                        color: white;
                    }
                    .badge-masuk {
                        background-color: #4CAF50;
                    }
                    .badge-keluar {
                        background-color: #f44336;
                    }
                    .badge-lunas {
                        background-color: #4CAF50;
                    }
                    .badge-belum {
                        background-color: #ff9800;
                    }
                    h2 {
                        text-align: center;
                        margin-bottom: 5px;
                        font-size: 14px;
                    }
                    h3 {
                        text-align: center;
                        margin-bottom: 2px;
                        font-size: 11px;
                        color: #666;
                    }
                    @media print {
                        body {
                            margin: 0;
                            padding: 10px;
                        }
                        .no-print {
                            display: none;
                        }
                        .signature-row {
                            page-break-inside: avoid;
                        }
                        table {
                            page-break-inside: avoid;
                        }
                    }
                </style>
            `;
        }

        // Format Tanggal
        function formatTanggal(tanggal) {
            if (!tanggal) return '-';

            // Jika format DD/MM/YYYY, tampilkan apa adanya
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(tanggal)) {
                const parts = tanggal.split('/');
                if (parts.length === 3) {
                    // Jika bulan > 12, berarti input DD/MM/YYYY, swap
                    if (parseInt(parts[1], 10) > 12) {
                        return `${parts[1].padStart(2, '0')}/${parts[0].padStart(2, '0')}/${parts[2]}`;
                    }
                    // Jika hari > 12, pasti DD/MM/YYYY
                    if (parseInt(parts[0], 10) > 12) {
                        return tanggal;
                    }
                    // Jika keduanya <= 12, default ke DD/MM/YYYY (Indonesia)
                    return tanggal;
                }
            }

            // Jika format YYYY-MM-DD, parse manual untuk hindari timezone issue
            if (tanggal.includes('-')) {
                const parts = tanggal.split('-');
                if (parts.length === 3) {
                    const year = parts[0];
                    const month = parts[1].padStart(2, '0');
                    const day = parts[2].padStart(2, '0');
                    return `${day}/${month}/${year}`;
                }
            }

            // Fallback menggunakan Date object
            const date = new Date(tanggal);
            if (isNaN(date.getTime())) return tanggal;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Konversi DD/MM/YYYY ke YYYY-MM-DD untuk internal storage
        function convertToISODate(ddmmyyyy) {
            if (!ddmmyyyy) return '';
            const parts = ddmmyyyy.split('/');
            if (parts.length === 3) {
                const d = parts[0].padStart(2, '0');
                const m = parts[1].padStart(2, '0');
                const y = parts[2];
                return `${y}-${m}-${d}`;
            }
            return ddmmyyyy;
        }

        // Konversi YYYY-MM-DD ke DD/MM/YYYY untuk display
        function convertToDisplayDate(isoDate) {
            if (!isoDate) return '';
            const parts = isoDate.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return isoDate;
        }

        // Format input tanggal otomatis DD/MM/YYYY
        function formatTanggalInput(input) {
            let value = input.value.replace(/\D/g, ''); // Hapus non-digit
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }
            input.value = value;
        }

        // LocalStorage & Supabase functions
        function saveDataToStorage() {
            // Simpan ke LocalStorage (Offline Backup)
            localStorage.setItem('dataPenjualan', JSON.stringify(dataPenjualan));
            localStorage.setItem('dataPembelian', JSON.stringify(dataPembelian));
            localStorage.setItem('dataTransaksiKas', JSON.stringify(dataTransaksiKas));
            localStorage.setItem('dataPembayaranPiutang', JSON.stringify(dataPembayaranPiutang));
            localStorage.setItem('dataPembayaranHutang', JSON.stringify(dataPembayaranHutang));
            localStorage.setItem('dataJurnal', JSON.stringify(dataJurnal));
            localStorage.setItem('dataMasterCustomer', JSON.stringify(dataMasterCustomer));
            localStorage.setItem('dataMasterSupplier', JSON.stringify(dataMasterSupplier));
            localStorage.setItem('dataMasterBarang', JSON.stringify(dataMasterBarang));
            localStorage.setItem('dataPiutangAwal', JSON.stringify(dataPiutangAwal));
            localStorage.setItem('dataHutangAwal', JSON.stringify(dataHutangAwal));
            localStorage.setItem('dataKasHarian', JSON.stringify(dataKasHarian));
            localStorage.setItem('kategoriKas', JSON.stringify(kategoriKas));
            localStorage.setItem('kategoriKasMasuk', JSON.stringify(kategoriKasMasuk));
            localStorage.setItem('kategoriKasKeluar', JSON.stringify(kategoriKasKeluar));

            // Sinkronisasi ke Supabase (Online Sync)
            syncToSupabase('dataPenjualan', dataPenjualan);
            syncToSupabase('dataPembelian', dataPembelian);
            syncToSupabase('dataTransaksiKas', dataTransaksiKas);
            syncToSupabase('dataPembayaranPiutang', dataPembayaranPiutang);
            syncToSupabase('dataPembayaranHutang', dataPembayaranHutang);
            syncToSupabase('dataJurnal', dataJurnal);
            syncToSupabase('dataMasterCustomer', dataMasterCustomer);
            syncToSupabase('dataMasterSupplier', dataMasterSupplier);
            syncToSupabase('dataMasterBarang', dataMasterBarang);
            syncToSupabase('dataPiutangAwal', dataPiutangAwal);
            syncToSupabase('dataHutangAwal', dataHutangAwal);
            syncToSupabase('dataKasHarian', dataKasHarian);
            syncToSupabase('kategoriKas', kategoriKas);
            syncToSupabase('kategoriKasMasuk', kategoriKasMasuk);
            syncToSupabase('kategoriKasKeluar', kategoriKasKeluar);
        }

        function loadDataFromStorage() {
            const savedPenjualan = localStorage.getItem('dataPenjualan');
            const savedPembelian = localStorage.getItem('dataPembelian');
            const savedKas = localStorage.getItem('dataTransaksiKas');
            const savedPiutang = localStorage.getItem('dataPembayaranPiutang');
            const savedHutang = localStorage.getItem('dataPembayaranHutang');
            const savedJurnal = localStorage.getItem('dataJurnal');
            const savedMasterCustomer = localStorage.getItem('dataMasterCustomer');
            const savedMasterSupplier = localStorage.getItem('dataMasterSupplier');
            const savedMasterBarang = localStorage.getItem('dataMasterBarang');
            const savedPiutangAwal = localStorage.getItem('dataPiutangAwal');
            const savedHutangAwal = localStorage.getItem('dataHutangAwal');
            const savedKategoriKas = localStorage.getItem('kategoriKas');

            if (savedPenjualan) dataPenjualan = JSON.parse(savedPenjualan);
            if (savedPembelian) dataPembelian = JSON.parse(savedPembelian);
            if (savedKas) dataTransaksiKas = JSON.parse(savedKas);
            if (savedPiutang) dataPembayaranPiutang = JSON.parse(savedPiutang);
            if (savedHutang) dataPembayaranHutang = JSON.parse(savedHutang);
            if (savedJurnal) dataJurnal = JSON.parse(savedJurnal);

            // Assignment untuk variabel yang sebelumnya hanya di-get tapi tidak di-assign
            if (savedPiutangAwal) dataPiutangAwal = JSON.parse(savedPiutangAwal);
            if (savedHutangAwal) dataHutangAwal = JSON.parse(savedHutangAwal);
            if (savedKategoriKas) kategoriKas = JSON.parse(savedKategoriKas);

            // Load kategori spesifik
            const savedKategoriKasMasuk = localStorage.getItem('kategoriKasMasuk');
            const savedKategoriKasKeluar = localStorage.getItem('kategoriKasKeluar');
            if (savedKategoriKasMasuk) kategoriKasMasuk = JSON.parse(savedKategoriKasMasuk);
            if (savedKategoriKasKeluar) kategoriKasKeluar = JSON.parse(savedKategoriKasKeluar);

            const savedKasHarian = localStorage.getItem('dataKasHarian');
            if (savedKasHarian) {
                dataKasHarian = JSON.parse(savedKasHarian);
                // CLEANUP DUPLIKASI KAS HARIAN (Fix User Request)
                // Hapus duplikasi persis (Tanggal, Jenis, Kategori, Jumlah, Keterangan sama)
                const uniqueKas = [];
                const seenKas = new Set();
                let dupeCount = 0;

                dataKasHarian.forEach(item => {
                    // Normalisasi string untuk comparison
                    const desc = (item.keterangan || '').trim();
                    const key = `${item.tanggal}|${item.jenis}|${item.kategori}|${item.jumlah}|${desc}`;

                    if (!seenKas.has(key)) {
                        seenKas.add(key);
                        uniqueKas.push(item);
                    } else {
                        dupeCount++;
                    }
                });

                if (dupeCount > 0) {
                    console.log(`Membersihkan ${dupeCount} data duplikat di Kas Harian.`);
                    dataKasHarian = uniqueKas;
                }

                // MIGRASI DESKRIPSI (Update format lama ke baru agar konsisten dan lebih detail)
                let migrationCount = 0;
                dataKasHarian.forEach(item => {
                    if (item.kategori === 'Penjualan' && item.keterangan && item.keterangan.startsWith('Penjualan tunai/DP - ')) {
                        const noFaktur = item.keterangan.replace('Penjualan tunai/DP - ', '').trim();
                        const penjualan = dataPenjualan.find(p => p.noFaktur === noFaktur);
                        if (penjualan) {
                            const pelanggan = penjualan.namaPelanggan || penjualan.pelanggan || '-';
                            const metodeBayarStr = (penjualan.metodeBayar || 'Tunai').toLowerCase();
                            const labelBayar = metodeBayarStr === 'kredit' ? 'DP' : (metodeBayarStr.charAt(0).toUpperCase() + metodeBayarStr.slice(1));

                            item.keterangan = `${noFaktur} - ${pelanggan} (${labelBayar})`;
                            migrationCount++;
                        }
                    } else if (item.kategori === 'Pembelian' && item.keterangan && item.keterangan.startsWith('Pembelian tunai/DP - ')) {
                        const noFaktur = item.keterangan.replace('Pembelian tunai/DP - ', '').trim();
                        const pembelian = dataPembelian.find(p => p.noFaktur === noFaktur);
                        if (pembelian) {
                            const supplier = pembelian.namaSupplier || pembelian.supplier || '-';
                            const metodeBayarStr = (pembelian.metodeBayar || 'Tunai').toLowerCase();
                            const labelBayar = metodeBayarStr === 'kredit' ? 'DP' : (metodeBayarStr.charAt(0).toUpperCase() + metodeBayarStr.slice(1));

                            item.keterangan = `${noFaktur} - ${supplier} (${labelBayar})`;
                            migrationCount++;
                        }
                    }
                });

                if (migrationCount > 0) {
                    console.log(`Migrasi ${migrationCount} deskripsi Kas Harian ke format baru.`);
                }
            }

            // Auto-generate jurnal jika kosong tapi ada data penjualan/pembelian/kas
            if ((!dataJurnal || dataJurnal.length === 0) && (dataPenjualan.length > 0 || dataPembelian.length > 0 || dataTransaksiKas.length > 0 || dataKasHarian.length > 0)) {
                dataJurnal = [];
                // Jika dataKasHarian sudah ada isinya, jangan generate ulang entry kas dari penjualan/pembelian
                const skipKas = dataKasHarian && dataKasHarian.length > 0;

                dataPenjualan.forEach(transaksi => {
                    buatJurnalPenjualan(transaksi, skipKas);
                });
                dataPembelian.forEach(transaksi => {
                    buatJurnalPembelian(transaksi, skipKas);
                });
                dataTransaksiKas.forEach(transaksi => {
                    if (transaksi.jenis === 'masuk') {
                        buatJurnalKasMasuk(transaksi);
                    } else {
                        buatJurnalKasKeluar(transaksi);
                    }
                });
                dataKasHarian.forEach(k => {
                    const transaksi = {
                        tanggal: k.tanggal,
                        noTransaksi: `KH-${k.id}`,
                        kategori: k.kategori,
                        keterangan: k.keterangan,
                        jumlah: k.jumlah
                    };
                    if (k.jenis === 'masuk') {
                        buatJurnalKasMasuk(transaksi);
                    } else {
                        buatJurnalKasKeluar(transaksi);
                    }
                });
            }

            // Load Master Customer - hanya timpa jika ada data valid di localStorage
            if (savedMasterCustomer) {
                const parsed = JSON.parse(savedMasterCustomer);
                if (parsed && parsed.length > 0) {
                    dataMasterCustomer = parsed;
                }
            }
            // Simpan data default ke localStorage jika belum ada
            if (!savedMasterCustomer) {
                localStorage.setItem('dataMasterCustomer', JSON.stringify(dataMasterCustomer));
            }

            // Load Master Supplier - hanya timpa jika ada data valid di localStorage
            if (savedMasterSupplier) {
                const parsed = JSON.parse(savedMasterSupplier);
                if (parsed && parsed.length > 0) {
                    dataMasterSupplier = parsed;
                }
            }
            // Simpan data default ke localStorage jika belum ada
            if (!savedMasterSupplier) {
                localStorage.setItem('dataMasterSupplier', JSON.stringify(dataMasterSupplier));
            }

            // Load Master Barang - hanya timpa jika ada data valid di localStorage
            if (savedMasterBarang) {
                const parsed = JSON.parse(savedMasterBarang);
                if (parsed && parsed.length > 0) {
                    dataMasterBarang = parsed;
                }
            }
            // Simpan data default ke localStorage jika belum ada
            if (!savedMasterBarang) {
                localStorage.setItem('dataMasterBarang', JSON.stringify(dataMasterBarang));
            }

            if (savedPiutangAwal) {
                dataPiutangAwal = JSON.parse(savedPiutangAwal);
                // CLEANUP DUPLIKASI: Hapus data di Piutang Awal jika sudah ada di Penjualan (akibat bug sebelumnya)
                if (dataPenjualan && dataPenjualan.length > 0) {
                    const penjualanFakturs = new Set(dataPenjualan.filter(p => p.noFaktur && p.noFaktur !== '-').map(p => p.noFaktur));
                    const sebelumCleanup = dataPiutangAwal.length;
                    dataPiutangAwal = dataPiutangAwal.filter(p => !p.noFaktur || p.noFaktur === '-' || !penjualanFakturs.has(p.noFaktur));
                    if (dataPiutangAwal.length < sebelumCleanup) {
                        console.log(`Dibersihkan ${sebelumCleanup - dataPiutangAwal.length} duplikasi piutang.`);
                    }
                }
            }

            if (savedHutangAwal) {
                dataHutangAwal = JSON.parse(savedHutangAwal);
                // CLEANUP DUPLIKASI: Hapus data di Hutang Awal jika sudah ada di Pembelian (akibat bug sebelumnya)
                if (dataPembelian && dataPembelian.length > 0) {
                    const pembelianFakturs = new Set(dataPembelian.filter(p => p.noFaktur && p.noFaktur !== '-').map(p => p.noFaktur));
                    const sebelumCleanup = dataHutangAwal.length;
                    dataHutangAwal = dataHutangAwal.filter(h => !h.noFaktur || h.noFaktur === '-' || !pembelianFakturs.has(h.noFaktur));
                    if (dataHutangAwal.length < sebelumCleanup) {
                        console.log(`Dibersihkan ${sebelumCleanup - dataHutangAwal.length} duplikasi hutang.`);
                    }
                }
            }

            if (savedKategoriKas) {
                kategoriKas = JSON.parse(savedKategoriKas);
                // Pastikan Beban Konsumsi ada (untuk update fitur baru)
                if (!kategoriKas.includes('Beban Konsumsi')) {
                    const idx = kategoriKas.indexOf('Beban Transport');
                    if (idx !== -1) {
                        kategoriKas.splice(idx + 1, 0, 'Beban Konsumsi');
                    } else {
                        kategoriKas.push('Beban Konsumsi');
                    }
                }
            }

            // --- SINKRONISASI PEMBAYARAN KE KAS HARIAN ---
            /* SINKRONISASI DINONAKTIFKAN UNTUK MENCEGAH DUPLIKASI
               Data pembayaran sekarang dicatat langsung ke Kas Harian saat transaksi.
               Logika sinkronisasi di bawah ini menyebabkan duplikasi jika data sedikit berbeda.
            
            // Memastikan data pembayaran piutang lama masuk ke kas harian
            if (dataPembayaranPiutang && dataPembayaranPiutang.length > 0) {
                let changesMade = false;
                dataPembayaranPiutang.forEach((bayar, idx) => {
                    // Cek apakah sudah ada di kas harian
                    const exists = dataKasHarian.some(kas => 
                        kas.jenis === 'masuk' && 
                        Math.abs(kas.jumlah - bayar.jumlah) < 1 && // Toleransi selisih floating point
                        kas.tanggal === bayar.tanggal && 
                        (
                            // Match by No Faktur if available
                            (bayar.noFaktur && kas.keterangan && kas.keterangan.includes(bayar.noFaktur)) ||
                            // OR Match by Customer Name if available
                            (bayar.pelanggan && kas.keterangan && kas.keterangan.includes(bayar.pelanggan)) ||
                            // OR Match by Customer Name (alternative field)
                            (bayar.namaPelanggan && kas.keterangan && kas.keterangan.includes(bayar.namaPelanggan))
                        )
                    );
                    
                    if (!exists) {
                        dataKasHarian.push({
                            id: Date.now() + idx,
                            tanggal: bayar.tanggal,
                            jenis: 'masuk',
                            kategori: 'Pelunasan Piutang',
                            keterangan: `Pembayaran piutang ${bayar.pelanggan || bayar.namaPelanggan || '-'} - ${bayar.noFaktur || '-'}`,
                            jumlah: bayar.jumlah
                        });
                        changesMade = true;
                    }
                });
                if (changesMade) {
                    console.log('Sinkronisasi: Menambahkan data pembayaran piutang ke kas harian');
                    saveDataToStorage();
                }
            }

            // Memastikan data pembayaran hutang lama masuk ke kas harian
            if (dataPembayaranHutang && dataPembayaranHutang.length > 0) {
                let changesMade = false;
                dataPembayaranHutang.forEach((bayar, idx) => {
                    const exists = dataKasHarian.some(kas => 
                        kas.jenis === 'keluar' && 
                        Math.abs(kas.jumlah - bayar.jumlah) < 1 && 
                        kas.tanggal === bayar.tanggal && 
                        (
                            (bayar.noFaktur && kas.keterangan && kas.keterangan.includes(bayar.noFaktur)) ||
                            (bayar.supplier && kas.keterangan && kas.keterangan.includes(bayar.supplier)) ||
                            (bayar.namaSupplier && kas.keterangan && kas.keterangan.includes(bayar.namaSupplier))
                        )
                    );
                    
                    if (!exists) {
                        dataKasHarian.push({
                            id: Date.now() + 1000 + idx, // Offset ID
                            tanggal: bayar.tanggal,
                            jenis: 'keluar',
                            kategori: 'Bayar Hutang',
                            keterangan: `Pembayaran hutang ${bayar.supplier || bayar.namaSupplier || '-'} - ${bayar.noFaktur || '-'}`,
                            jumlah: bayar.jumlah
                        });
                        changesMade = true;
                    }
                });
                if (changesMade) {
                    console.log('Sinkronisasi: Menambahkan data pembayaran hutang ke kas harian');
                    saveDataToStorage();
                }
            }

            // Sinkronisasi dari Jurnal (untuk backup jika data pembayaran hilang/saldo awal)
            if (dataJurnal && dataJurnal.length > 0) {
                // (Dinonaktifkan juga untuk konsistensi)
            }
            */
            // ---------------------------------------------

            // Log untuk debugging
            console.log('Data loaded from storage:', {
                customer: dataMasterCustomer.length,
                supplier: dataMasterSupplier.length,
                barang: dataMasterBarang.length
            });
        }

        // Fungsi untuk clear localStorage data master dan reload
        function clearAndReloadMasterData() {
            if (confirm('⚠️ Ini akan menghapus data master dari localStorage dan memuat ulang data default.\n\nLanjutkan?')) {
                // Hapus data master dari localStorage
                localStorage.removeItem('dataMasterCustomer');
                localStorage.removeItem('dataMasterSupplier');
                localStorage.removeItem('dataMasterBarang');

                // Reload halaman
                window.location.reload();
            }
        }

        // Export Data
        function exportData() {
            const data = {
                penjualan: dataPenjualan,
                pembelian: dataPembelian,
                transaksiKas: dataTransaksiKas,
                pembayaranPiutang: dataPembayaranPiutang,
                pembayaranHutang: dataPembayaranHutang,
                jurnal: dataJurnal,
                kasHarian: dataKasHarian,
                piutangAwal: dataPiutangAwal,
                hutangAwal: dataHutangAwal,
                masterCustomer: dataMasterCustomer,
                masterSupplier: dataMasterSupplier,
                masterBarang: dataMasterBarang,
                kategoriKas: kategoriKas,
                kategoriKasMasuk: kategoriKasMasuk,
                kategoriKasKeluar: kategoriKasKeluar,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-pembukuan-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert('Data berhasil diexport!');
        }

        // Import Data
        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.penjualan && data.pembelian && data.jurnal) {
                            if (confirm('Import data akan mengganti semua data yang ada. Lanjutkan?')) {
                                dataPenjualan = data.penjualan;
                                dataPembelian = data.pembelian;
                                dataTransaksiKas = data.transaksiKas || [];
                                dataPembayaranPiutang = data.pembayaranPiutang || [];
                                dataPembayaranHutang = data.pembayaranHutang || [];
                                dataJurnal = data.jurnal;
                                dataKasHarian = data.kasHarian || [];
                                dataPiutangAwal = data.piutangAwal || [];
                                dataHutangAwal = data.hutangAwal || [];
                                dataMasterCustomer = data.masterCustomer || [];
                                dataMasterSupplier = data.masterSupplier || [];
                                dataMasterBarang = data.masterBarang || [];
                                kategoriKas = data.kategoriKas || kategoriKasDefault;
                                kategoriKasMasuk = data.kategoriKasMasuk || ['Penjualan', 'Pelunasan Piutang', 'Pendapatan Harian', 'Lainnya'];
                                kategoriKasKeluar = data.kategoriKasKeluar || ['Pembelian', 'Bayar Hutang', 'Beban Gaji', 'Beban Operasional', 'Lainnya'];
                                saveDataToStorage();
                                updateAllDisplays();
                                displayMasterCustomer();
                                displayMasterSupplier();
                                displayMasterBarang();
                                updateKategoriDropdowns();
                                populateDataLists();
                                invalidateDropdownCache();
                                preloadDropdownData(); // Refresh cache data dropdown
                                alert('Data berhasil diimport!');
                            }
                        } else {
                            alert('Format file tidak valid!');
                        }
                    } catch (error) {
                        alert('Error membaca file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        // ========== FUNGSI PIUTANG & HUTANG ==========

        // Display Piutang
        function displayPiutang() {
            const tbody = document.getElementById('bodyPiutang');
            let html = '';
            let totalPiutang = 0;
            let totalBayar = 0;
            let totalPenjualanKredit = 0;
            let no = 0;
            const pelangganSet = new Set();

            // Data dari penjualan (SEMUA DATA MASUK PIUTANG)
            const penjualanKredit = [...dataPenjualan];

            // Gabungkan data piutang awal
            const allPiutang = [];

            // Tambahkan dari penjualan kredit
            penjualanKredit.forEach(item => {
                allPiutang.push({
                    ...item,
                    sumber: 'Penjualan',
                    keterangan: item.namaBarang || item.barang || '-',
                    nama: item.namaPelanggan || item.pelanggan || '-',
                    tipe: 'penjualan'
                });
            });

            // Tambahkan dari piutang awal
            dataPiutangAwal.forEach(item => {
                allPiutang.push({
                    ...item,
                    sumber: 'Saldo Awal',
                    noFaktur: item.noFaktur || '-',
                    nama: item.namaPelanggan || item.pelanggan || '-',
                    tipe: 'awal'
                });
            });

            // Sort by tanggal
            allPiutang.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            if (allPiutang.length === 0) {
                html = '<tr><td colspan="11" class="center">Belum ada piutang</td></tr>';
            } else {
                allPiutang.forEach((item, index) => {
                    const dibayar = item.dibayar || 0;
                    const sisa = item.total - dibayar;
                    totalPiutang += sisa;
                    pelangganSet.add(item.nama);
                    totalBayar += dibayar;
                    totalPenjualanKredit += item.total;
                    no++;

                    const statusBadge = sisa === 0 ?
                        '<span class="badge badge-lunas">✓ LUNAS</span>' :
                        '<span class="badge badge-belum">⚠ BELUM LUNAS</span>';

                    const sumberBadge = item.sumber === 'Saldo Awal' ?
                        '<span class="badge-awal">Awal</span>' :
                        '<span class="badge-jual">Jual</span>';

                    let aksiHtml = '-';
                    if (sisa > 0) {
                        if (item.tipe === 'penjualan') {
                            aksiHtml = `<button class="btn btn-success btn-sm" onclick="bayarPiutang(${item.id})">💰 Bayar</button>`;
                        } else {
                            aksiHtml = `<button class="btn btn-success btn-xs" onclick="bayarPiutangAwal(${item.id})">💰 Bayar</button>`;
                        }
                    }
                    if (item.tipe === 'awal') {
                        aksiHtml += ` <button class="btn btn-danger btn-xs" onclick="hapusPiutangAwal(${item.id})">🗑️</button>`;
                    }

                    html += `
                        <tr>
                            <td class="text-center">${no}</td>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td class="text-center">${sumberBadge}</td>
                            <td>${item.noFaktur || '-'}</td>
                            <td>${item.nama}</td>
                            <td>${item.keterangan || '-'}</td>
                            <td class="number">${formatRupiah(item.total)}</td>
                            <td class="number">${formatRupiah(dibayar)}</td>
                            <td class="number">${formatRupiah(sisa)}</td>
                            <td class="text-center">${statusBadge}</td>
                            <td class="text-center">${aksiHtml}</td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = html;
            document.getElementById('totalPiutang').textContent = formatRupiah(totalPiutang);
            document.getElementById('totalBayarPiutang').textContent = formatRupiah(totalBayar);
            document.getElementById('totalPenjualanKredit').textContent = formatRupiah(totalPenjualanKredit);
            document.getElementById('jumlahPelangganPiutang').textContent = pelangganSet.size;

            // Update footer totals
            document.getElementById('footerTotalPiutang').textContent = formatRupiah(totalPenjualanKredit);
            document.getElementById('footerDibayarPiutang').textContent = formatRupiah(totalBayar);
            document.getElementById('footerSisaPiutang').textContent = formatRupiah(totalPiutang);

            // Update rekap
            displayRekapPiutang(allPiutang);
        }

        // Display Hutang
        function displayHutang() {
            const tbody = document.getElementById('bodyHutang');
            let html = '';
            let totalHutang = 0;
            let totalBayar = 0;
            let totalPembelianKredit = 0;
            let no = 0;
            const supplierSet = new Set();

            // Data dari pembelian (SEMUA DATA MASUK HUTANG)
            const pembelianKredit = [...dataPembelian];

            // Gabungkan data hutang awal
            const allHutang = [];

            // Tambahkan dari pembelian kredit
            pembelianKredit.forEach(item => {
                let dibayar = item.dibayar || 0;
                const dp = item.dp || 0;
                const total = item.total || 0;

                // 1. Log-Based Validation (Prioritas Utama)
                const cicilanLogs = dataPembayaranHutang.filter(p => p.noFaktur === item.noFaktur);
                const totalCicilan = cicilanLogs.reduce((sum, p) => sum + (p.jumlah || 0), 0);
                const shouldUseLogLogic = item.noFaktur && item.noFaktur !== '-';

                if (shouldUseLogLogic) {
                    if ((Math.abs(dibayar - totalCicilan) < 50 && dp > 0) || (dibayar === 0 && (totalCicilan > 0 || dp > 0))) {
                        if (Math.abs(dibayar - (totalCicilan + dp)) > 50) {
                            dibayar = totalCicilan + dp;
                        }
                    }
                }

                // 2. Sisa-Based Heuristic (Fallback)
                if (item.metodeBayar === 'kredit' && dp > 0) {
                    const storedSisa = item.sisa !== undefined ? item.sisa : (total - dibayar - dp);
                    if (Math.abs((storedSisa + dibayar + dp) - total) < 50) {
                        dibayar += dp;
                    }
                    else if (dibayar < dp) {
                        dibayar = dp + (dibayar > 0 ? dibayar : 0);
                    }
                }

                allHutang.push({
                    ...item,
                    dibayar: dibayar,
                    sumber: 'Pembelian',
                    keterangan: item.namaBarang || item.barang || '-',
                    nama: item.namaSupplier || item.supplier || '-',
                    tipe: 'pembelian'
                });
            });

            // Tambahkan dari hutang awal
            dataHutangAwal.forEach(item => {
                allHutang.push({
                    ...item,
                    sumber: 'Saldo Awal',
                    noFaktur: item.noFaktur || '-',
                    nama: item.namaSupplier || item.supplier || '-',
                    tipe: 'awal'
                });
            });

            // Sort by tanggal
            allHutang.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            if (allHutang.length === 0) {
                html = '<tr><td colspan="11" class="center">Belum ada hutang</td></tr>';
            } else {
                allHutang.forEach((item, index) => {
                    const dibayar = item.dibayar || 0;
                    const sisa = item.total - dibayar;
                    totalHutang += sisa;
                    totalBayar += dibayar;
                    totalPembelianKredit += item.total;
                    supplierSet.add(item.nama);
                    no++;

                    const statusBadge = sisa === 0 ?
                        '<span class="badge badge-lunas">✓ LUNAS</span>' :
                        '<span class="badge badge-belum">⚠ BELUM LUNAS</span>';

                    const sumberBadge = item.sumber === 'Saldo Awal' ?
                        '<span class="badge-awal">Awal</span>' :
                        '<span class="badge-beli">Beli</span>';

                    let aksiHtml = '-';
                    if (sisa > 0) {
                        if (item.tipe === 'pembelian') {
                            aksiHtml = `<button class="btn btn-success btn-xs" onclick="bayarHutang(${item.id})">💰 Bayar</button>`;
                        } else {
                            aksiHtml = `<button class="btn btn-success btn-xs" onclick="bayarHutangAwal(${item.id})">💰 Bayar</button>`;
                        }
                    }
                    if (item.tipe === 'awal') {
                        aksiHtml += ` <button class="btn btn-danger btn-xs" onclick="hapusHutangAwal(${item.id})">🗑️</button>`;
                    }

                    html += `
                        <tr>
                            <td class="text-center">${no}</td>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td class="text-center">${sumberBadge}</td>
                            <td>${item.noFaktur || '-'}</td>
                            <td>${item.nama}</td>
                            <td>${item.keterangan || '-'}</td>
                            <td class="number">${formatRupiah(item.total)}</td>
                            <td class="number">${formatRupiah(dibayar)}</td>
                            <td class="number">${formatRupiah(sisa)}</td>
                            <td class="text-center">${statusBadge}</td>
                            <td class="text-center">${aksiHtml}</td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = html;
            document.getElementById('totalHutang').textContent = formatRupiah(totalHutang);
            document.getElementById('totalBayarHutang').textContent = formatRupiah(totalBayar);
            document.getElementById('totalPembelianKredit').textContent = formatRupiah(totalPembelianKredit);
            document.getElementById('jumlahSupplierHutang').textContent = supplierSet.size;

            // Update footer totals
            document.getElementById('footerTotalHutang').textContent = formatRupiah(totalPembelianKredit);
            document.getElementById('footerDibayarHutang').textContent = formatRupiah(totalBayar);
            document.getElementById('footerSisaHutang').textContent = formatRupiah(totalHutang);

            // Update rekap
            displayRekapHutang(allHutang);
        }

        // ========== FUNGSI LAPORAN PIUTANG ==========

        // Helper function untuk mendapatkan semua data piutang
        function getAllPiutangData() {
            const penjualanKredit = [...dataPenjualan];
            const allPiutang = [];

            penjualanKredit.forEach(item => {
                let dibayar = item.dibayar || 0;
                const dp = item.dp || 0;
                const total = item.total || 0;
                const storedSisa = item.sisa;

                // Sisa-Based Heuristic for Legacy Data
                // Fix data where DP was separated or ignored
                if (item.metodeBayar === 'kredit' && dp > 0 && storedSisa !== undefined) {
                    // Case A: DP detached from dibayar but accounted in Sisa (Sisa + Dibayar + DP == Total)
                    // Means dibayar excludes DP, but Sisa was calculated as (Total - Dibayar - DP)
                    if (Math.abs((storedSisa + dibayar + dp) - total) < 50) {
                        dibayar += dp;
                    }
                    // Case B: DP ignored completely (Sisa + Dibayar == Total)
                    // Means Sisa = Total - Dibayar. And Dibayar likely excludes DP.
                    else if (Math.abs((storedSisa + dibayar) - total) < 50) {
                        if (dibayar < dp) { // Safety check: only add if dibayar is clearly missing DP
                            dibayar += dp;
                        }
                    }
                }

                allPiutang.push({
                    ...item,
                    dibayar: dibayar,
                    sumber: 'Penjualan',
                    keterangan: item.namaBarang || item.barang || '-',
                    nama: item.namaPelanggan || item.pelanggan || '-',
                    tipe: 'penjualan'
                });
            });

            dataPiutangAwal.forEach(item => {
                allPiutang.push({
                    ...item,
                    sumber: 'Saldo Awal',
                    noFaktur: item.noFaktur || '-',
                    nama: item.namaPelanggan || item.pelanggan || '-',
                    tipe: 'awal'
                });
            });

            return allPiutang.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
        }

        // Helper function untuk mendapatkan semua data hutang
        function getAllHutangData() {
            const pembelianKredit = [...dataPembelian];
            const allHutang = [];

            pembelianKredit.forEach(item => {
                let dibayar = item.dibayar || 0;
                const dp = item.dp || 0;
                const total = item.total || 0;
                const storedSisa = item.sisa;

                // Sisa-Based Heuristic for Legacy Data
                if (item.metodeBayar === 'kredit' && dp > 0 && storedSisa !== undefined) {
                    // Case A: DP detached from dibayar but accounted in Sisa
                    if (Math.abs((storedSisa + dibayar + dp) - total) < 50) {
                        dibayar += dp;
                    }
                    // Case B: DP ignored completely
                    else if (Math.abs((storedSisa + dibayar) - total) < 50) {
                        if (dibayar < dp) {
                            dibayar += dp;
                        }
                    }
                }

                allHutang.push({
                    ...item,
                    dibayar: dibayar,
                    sumber: 'Pembelian',
                    keterangan: item.namaBarang || item.barang || '-',
                    nama: item.namaSupplier || item.supplier || '-',
                    tipe: 'pembelian'
                });
            });

            dataHutangAwal.forEach(item => {
                allHutang.push({
                    ...item,
                    sumber: 'Saldo Awal',
                    noFaktur: item.noFaktur || '-',
                    nama: item.namaSupplier || item.supplier || '-',
                    tipe: 'awal'
                });
            });

            return allHutang.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
        }

        // Filter Laporan Piutang
        function filterLaporanPiutang() {
            const tglMulai = document.getElementById('filterPiutangMulai').value;
            const tglSelesai = document.getElementById('filterPiutangSelesai').value;
            const status = document.getElementById('filterPiutangStatus').value;
            const pelanggan = document.getElementById('filterPiutangPelanggan').value.toLowerCase();

            let allPiutang = getAllPiutangData();

            // Filter berdasarkan tanggal
            if (tglMulai) {
                const tglMulaiParsed = parseTanggal(tglMulai);
                allPiutang = allPiutang.filter(item => {
                    const tglItem = parseTanggal(item.tanggal);
                    return tglItem >= tglMulaiParsed;
                });
            }
            if (tglSelesai) {
                const tglSelesaiParsed = parseTanggal(tglSelesai);
                allPiutang = allPiutang.filter(item => {
                    const tglItem = parseTanggal(item.tanggal);
                    return tglItem <= tglSelesaiParsed;
                });
            }

            // Filter berdasarkan status
            if (status === 'belum') {
                allPiutang = allPiutang.filter(item => (item.total - (item.dibayar || 0)) > 0);
            } else if (status === 'lunas') {
                allPiutang = allPiutang.filter(item => (item.total - (item.dibayar || 0)) === 0);
            }

            // Filter berdasarkan pelanggan
            if (pelanggan) {
                allPiutang = allPiutang.filter(item => item.nama.toLowerCase().includes(pelanggan));
            }

            displayFilteredPiutang(allPiutang);
            displayRekapPiutang(allPiutang);
        }

        // Reset Filter Piutang
        function resetFilterPiutang() {
            document.getElementById('filterPiutangMulai').value = '';
            document.getElementById('filterPiutangSelesai').value = '';
            document.getElementById('filterPiutangStatus').value = 'semua';
            document.getElementById('filterPiutangPelanggan').value = '';
            displayPiutang();
            displayRekapPiutang(getAllPiutangData());
        }

        // Display Filtered Piutang
        function displayFilteredPiutang(allPiutang) {
            const tbody = document.getElementById('bodyPiutang');
            let html = '';
            let totalPiutang = 0;
            let totalBayar = 0;
            let totalPenjualanKredit = 0;
            let no = 0;
            const pelangganSet = new Set();

            if (allPiutang.length === 0) {
                html = '<tr><td colspan="11" class="center">Tidak ada data piutang yang sesuai filter</td></tr>';
            } else {
                allPiutang.forEach((item) => {
                    let dibayar = item.dibayar || 0;
                    const sisa = item.total - dibayar;
                    totalPiutang += sisa;
                    totalBayar += dibayar;
                    totalPenjualanKredit += item.total;
                    pelangganSet.add(item.nama);
                    no++;

                    const statusBadge = sisa === 0 ?
                        '<span class="badge badge-lunas">✓ LUNAS</span>' :
                        '<span class="badge badge-belum">⚠ BELUM LUNAS</span>';

                    const sumberBadge = item.sumber === 'Saldo Awal' ?
                        '<span class="badge-awal">Awal</span>' :
                        '<span class="badge-jual">Jual</span>';

                    let aksiHtml = '-';
                    if (sisa > 0) {
                        if (item.tipe === 'penjualan') {
                            aksiHtml = `<button class="btn btn-success btn-xs" onclick="bayarPiutang(${item.id})">💰 Bayar</button>`;
                        } else {
                            aksiHtml = `<button class="btn btn-success btn-xs" onclick="bayarPiutangAwal(${item.id})">💰 Bayar</button>`;
                        }
                    }
                    if (item.tipe === 'awal') {
                        aksiHtml += ` <button class="btn btn-danger btn-xs" onclick="hapusPiutangAwal(${item.id})">🗑️</button>`;
                    }

                    html += `
                        <tr>
                            <td class="text-center">${no}</td>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td class="text-center">${sumberBadge}</td>
                            <td>${item.noFaktur || '-'}</td>
                            <td>${item.nama}</td>
                            <td>${item.keterangan || '-'}</td>
                            <td class="number">${formatRupiah(item.total)}</td>
                            <td class="number">${formatRupiah(dibayar)}</td>
                            <td class="number">${formatRupiah(sisa)}</td>
                            <td class="text-center">${statusBadge}</td>
                            <td class="text-center">${aksiHtml}</td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = html;
            document.getElementById('totalPiutang').textContent = formatRupiah(totalPiutang);
            document.getElementById('totalBayarPiutang').textContent = formatRupiah(totalBayar);
            document.getElementById('totalPenjualanKredit').textContent = formatRupiah(totalPenjualanKredit);
            document.getElementById('jumlahPelangganPiutang').textContent = pelangganSet.size;

            // Update footer
            document.getElementById('footerTotalPiutang').textContent = formatRupiah(totalPenjualanKredit);
            document.getElementById('footerDibayarPiutang').textContent = formatRupiah(totalBayar);
            document.getElementById('footerSisaPiutang').textContent = formatRupiah(totalPiutang);
        }

        // Display Rekap Piutang Per Pelanggan
        function displayRekapPiutang(allPiutang) {
            const tbody = document.getElementById('bodyRekapPiutang');
            const tfoot = document.getElementById('footerRekapPiutang');

            // Group by pelanggan
            const rekapByPelanggan = {};
            allPiutang.forEach(item => {
                const nama = item.nama || 'Tidak diketahui';
                if (!rekapByPelanggan[nama]) {
                    rekapByPelanggan[nama] = {
                        nama: nama,
                        jumlahTransaksi: 0,
                        totalPiutang: 0,
                        totalDibayar: 0
                    };
                }
                rekapByPelanggan[nama].jumlahTransaksi++;
                rekapByPelanggan[nama].totalPiutang += item.total;

                let dibayar = item.dibayar || 0;
                rekapByPelanggan[nama].totalDibayar += dibayar;
            });

            const rekapArray = Object.values(rekapByPelanggan).sort((a, b) =>
                (b.totalPiutang - b.totalDibayar) - (a.totalPiutang - a.totalDibayar)
            );

            let html = '';
            let grandTotalPiutang = 0;
            let grandTotalDibayar = 0;
            let grandSisa = 0;

            if (rekapArray.length === 0) {
                html = '<tr><td colspan="7" class="text-center">Belum ada data</td></tr>';
            } else {
                rekapArray.forEach((item, idx) => {
                    const sisa = item.totalPiutang - item.totalDibayar;
                    grandTotalPiutang += item.totalPiutang;
                    grandTotalDibayar += item.totalDibayar;
                    grandSisa += sisa;

                    const statusBadge = sisa === 0 ?
                        '<span class="badge badge-lunas">LUNAS</span>' :
                        '<span class="badge badge-belum">BELUM</span>';

                    html += `
                        <tr>
                            <td class="text-center">${idx + 1}</td>
                            <td>${item.nama}</td>
                            <td class="text-center">${item.jumlahTransaksi}</td>
                            <td class="number">${formatRupiah(item.totalPiutang)}</td>
                            <td class="number">${formatRupiah(item.totalDibayar)}</td>
                            <td class="number font-bold ${sisa > 0 ? 'text-red-600' : 'text-green-600'}">${formatRupiah(sisa)}</td>
                            <td class="text-center">${statusBadge}</td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = html;

            // Footer total
            tfoot.innerHTML = `
                <tr class="bg-yellow-light-bold">
                    <td colspan="3" class="text-right pr-15">GRAND TOTAL:</td>
                    <td class="number">${formatRupiah(grandTotalPiutang)}</td>
                    <td class="number">${formatRupiah(grandTotalDibayar)}</td>
                    <td class="number font-bold ${grandSisa > 0 ? 'text-red-600' : 'text-green-600'}">${formatRupiah(grandSisa)}</td>
                    <td></td>
                </tr>
            `;

            // Update jumlah pelanggan
            document.getElementById('jumlahPelangganPiutang').textContent = rekapArray.length;
        }

        // Print Laporan Piutang
        function printLaporanPiutang() {
            const tglMulai = document.getElementById('filterPiutangMulai').value;
            const tglSelesai = document.getElementById('filterPiutangSelesai').value;
            const status = document.getElementById('filterPiutangStatus').value;
            const pelanggan = document.getElementById('filterPiutangPelanggan').value;

            let allPiutang = getAllPiutangData();

            // Apply filters
            if (tglMulai) {
                const tglMulaiParsed = parseTanggal(tglMulai);
                allPiutang = allPiutang.filter(item => parseTanggal(item.tanggal) >= tglMulaiParsed);
            }
            if (tglSelesai) {
                const tglSelesaiParsed = parseTanggal(tglSelesai);
                allPiutang = allPiutang.filter(item => parseTanggal(item.tanggal) <= tglSelesaiParsed);
            }
            if (status === 'belum') {
                allPiutang = allPiutang.filter(item => (item.total - (item.dibayar || 0)) > 0);
            } else if (status === 'lunas') {
                allPiutang = allPiutang.filter(item => (item.total - (item.dibayar || 0)) === 0);
            }
            if (pelanggan) {
                allPiutang = allPiutang.filter(item => item.nama.toLowerCase().includes(pelanggan.toLowerCase()));
            }

            // Calculate totals
            let totalPiutang = 0, totalBayar = 0, totalSisa = 0;
            allPiutang.forEach(item => {
                let dibayar = item.dibayar || 0;

                totalPiutang += item.total;
                totalBayar += dibayar;
                totalSisa += item.total - dibayar;
            });

            const periode = (tglMulai && tglSelesai) ? `Periode: ${formatTanggal(tglMulai)} s/d ${formatTanggal(tglSelesai)}` : 'Semua Periode';
            const statusText = status === 'belum' ? ' - Status: Belum Lunas' : (status === 'lunas' ? ' - Status: Sudah Lunas' : '');
            const pelangganText = pelanggan ? ` - Pelanggan: ${pelanggan}` : '';

            let html = `
                <html>
                <head>
                    <title>Laporan Piutang - PT. Sumber Ganda Mekar</title>
                    <style>
                        body { font-family: "Inter", "Segoe UI", Arial, sans-serif; padding: 20px; background: white; color: #1e293b; }
                        h1 { font-size: 18pt; margin: 0 0 5px 0; text-align: center; color: #1e293b; font-weight: 700; }
                        h2 { font-size: 14pt; margin: 0 0 5px 0; text-align: center; color: #64748b; font-weight: 600; }
                        .periode { text-align: center; color: #64748b; margin-bottom: 20px; font-size: 10pt; }
                        
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10pt; }
                        th, td { border: 1px solid #e2e8f0; padding: 8px 12px; text-align: left; }
                        th { background-color: #f8fafc; color: #1e293b; font-weight: 600; text-transform: uppercase; font-size: 9pt; letter-spacing: 0.05em; }
                        
                        .number { text-align: right; font-family: "JetBrains Mono", Consolas, monospace; }
                        .text-center { text-align: center; }
                        .total-row { background-color: #f1f5f9 !important; font-weight: bold; border-top: 2px solid #cbd5e1; }
                        
                        .badge { padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: bold; display: inline-block; }
                        .badge-lunas { background-color: #dcfce7; color: #166534; border: 1px solid #bbb; }
                        .badge-belum { background-color: #fee2e2; color: #991b1b; border: 1px solid #bbb; }
                        
                        .summary { margin-top: 20px; display: flex; justify-content: space-around; gap: 20px; }
                        .summary-card { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; flex: 1; }
                        .summary-card strong { display: block; font-size: 0.9em; color: #64748b; margin-bottom: 5px; }
                        .summary-card div { font-size: 1.2em; font-weight: bold; color: #1e293b; font-family: "JetBrains Mono", monospace; }
                        .bg-danger-light { background-color: #fff1f2; border-color: #fecdd3; }
                        .bg-danger-light div { color: #be123c; }
                        
                        /* Width Utilities */
                        .w-30px { width: 30px; }
                        .w-60px { width: 60px; }
                        .w-70px { width: 70px; }
                        .w-80px { width: 80px; }
                        .w-90px { width: 90px; }
                        .w-100px { width: 100px; }
                        .pr-15 { padding-right: 15px; }
                        .text-right { text-align: right; }
                        .mt-30px { margin-top: 30px; }
                        .text-xs { font-size: 10px; color: #94a3b8; }
                        
                        tr:nth-child(even) { background-color: #f8fafc; }
                        
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none; }
                            .summary-card { border: 1px solid #cbd5e1; }
                            .bg-danger-light { background-color: #fff1f2 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            th { background-color: #f1f5f9 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .badge-lunas { border: 1px solid #166534; }
                            .badge-belum { border: 1px solid #991b1b; }
                        }
                    </style>
                </head>
                <body>
                    <h1>PT. SUMBER GANDA MEKAR</h1>
                    <h2>LAPORAN PIUTANG</h2>
                    <p class="periode">${periode}${statusText}${pelangganText}</p>
                    
                    <div class="summary">
                        <div class="summary-card">
                            <strong>Total Piutang</strong>
                            <div>${formatRupiah(totalPiutang)}</div>
                        </div>
                        <div class="summary-card">
                            <strong>Total Dibayar</strong>
                            <div>${formatRupiah(totalBayar)}</div>
                        </div>
                        <div class="summary-card bg-danger-light">
                            <strong>Sisa Piutang</strong>
                            <div>${formatRupiah(totalSisa)}</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th class="w-30px text-center">No</th>
                                <th class="w-80px">Tanggal</th>
                                <th class="w-60px text-center">Sumber</th>
                                <th class="w-90px">No. Faktur</th>
                                <th>Pelanggan</th>
                                <th>Keterangan</th>
                                <th class="w-100px number">Total</th>
                                <th class="w-100px number">Dibayar</th>
                                <th class="w-100px number">Sisa</th>
                                <th class="w-70px text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            allPiutang.forEach((item, idx) => {
                const dibayar = item.dibayar || 0;
                const sisa = item.total - dibayar;
                const statusBadge = sisa === 0 ?
                    '<span class="badge badge-lunas">LUNAS</span>' :
                    '<span class="badge badge-belum">BELUM</span>';

                html += `
                    <tr>
                        <td class="text-center">${idx + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td class="text-center">${item.sumber === 'Saldo Awal' ? 'Awal' : 'Jual'}</td>
                        <td>${item.noFaktur || '-'}</td>
                        <td>${item.nama}</td>
                        <td>${item.keterangan || '-'}</td>
                        <td class="number">${formatRupiah(item.total)}</td>
                        <td class="number">${formatRupiah(dibayar)}</td>
                        <td class="number">${formatRupiah(sisa)}</td>
                        <td class="text-center">${statusBadge}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="6" class="text-right pr-15">TOTAL:</td>
                                <td class="number">${formatRupiah(totalPiutang)}</td>
                                <td class="number">${formatRupiah(totalBayar)}</td>
                                <td class="number">${formatRupiah(totalSisa)}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <p class="mt-30px text-right text-xs">
                        Dicetak pada: ${formatTanggal(new Date())}
                    </p>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            // Tunggu load image/resource jika ada (saat ini text only)
            setTimeout(() => {
                printWindow.print();
                // printWindow.close(); // Optional: auto close
            }, 500);
        }

        // Ekspor Piutang ke Excel
        function eksporPiutangExcel() {
            const tglMulai = document.getElementById('filterPiutangMulai').value;
            const tglSelesai = document.getElementById('filterPiutangSelesai').value;
            const status = document.getElementById('filterPiutangStatus').value;
            const pelanggan = document.getElementById('filterPiutangPelanggan').value;

            let allPiutang = getAllPiutangData();

            // Apply filters
            if (tglMulai) {
                const tglMulaiParsed = parseTanggal(tglMulai);
                allPiutang = allPiutang.filter(item => parseTanggal(item.tanggal) >= tglMulaiParsed);
            }
            if (tglSelesai) {
                const tglSelesaiParsed = parseTanggal(tglSelesai);
                allPiutang = allPiutang.filter(item => parseTanggal(item.tanggal) <= tglSelesaiParsed);
            }
            if (status === 'belum') {
                allPiutang = allPiutang.filter(item => (item.total - (item.dibayar || 0)) > 0);
            } else if (status === 'lunas') {
                allPiutang = allPiutang.filter(item => (item.total - (item.dibayar || 0)) === 0);
            }
            if (pelanggan) {
                allPiutang = allPiutang.filter(item => item.nama.toLowerCase().includes(pelanggan.toLowerCase()));
            }

            // Calculate totals
            let totalPiutang = 0, totalBayar = 0, totalSisa = 0;
            allPiutang.forEach(item => {
                totalPiutang += item.total;
                totalBayar += item.dibayar || 0;
                totalSisa += item.total - (item.dibayar || 0);
            });

            const periode = (tglMulai && tglSelesai) ? `Periode_${tglMulai}_${tglSelesai}` : 'Semua_Periode';

            let html = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta http-equiv="content-type" content="text/plain; charset=UTF-8"/>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Laporan Piutang</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <style>
                        .bg-purple-header { background-color: #667eea; color: white; }
                        .bg-yellow-light-bold { background-color: #fff3cd; font-weight: bold; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .p-15px { padding: 15px; }
                        .pr-15 { padding-right: 15px; }
                        .font-size-16 { font-size: 16px; }
                    </style>
                </head>
                <body>
                <table border="1">
                    <tr class="bg-purple-header">
                        <th colspan="10" class="text-center p-15px font-size-16">
                            LAPORAN PIUTANG - PT. SUMBER GANDA MEKAR<br>
                            ${periode.replace(/_/g, ' ')}
                        </th>
                    </tr>
                    <tr class="bg-purple-header">
                        <th>No</th>
                        <th>Tanggal</th>
                        <th>Sumber</th>
                        <th>No. Faktur</th>
                        <th>Pelanggan</th>
                        <th>Keterangan</th>
                        <th>Total Piutang</th>
                        <th>Dibayar</th>
                        <th>Sisa</th>
                        <th>Status</th>
                    </tr>
            `;

            allPiutang.forEach((item, idx) => {
                const dibayar = item.dibayar || 0;
                const sisa = item.total - dibayar;
                const statusText = sisa === 0 ? 'LUNAS' : 'BELUM LUNAS';

                html += `
                    <tr>
                        <td class="text-center">${idx + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td class="text-center">${item.sumber === 'Saldo Awal' ? 'Saldo Awal' : 'Penjualan'}</td>
                        <td>${item.noFaktur || '-'}</td>
                        <td>${item.nama}</td>
                        <td>${item.keterangan || '-'}</td>
                        <td class="text-right">${formatRupiah(item.total)}</td>
                        <td class="text-right">${formatRupiah(dibayar)}</td>
                        <td class="text-right">${formatRupiah(sisa)}</td>
                        <td class="text-center">${statusText}</td>
                    </tr>
                `;
            });

            html += `
                    <tr class="bg-yellow-light-bold">
                        <td colspan="6" class="text-right pr-15">TOTAL:</td>
                        <td class="text-right">${formatRupiah(totalPiutang)}</td>
                        <td class="text-right">${formatRupiah(totalBayar)}</td>
                        <td class="text-right">${formatRupiah(totalSisa)}</td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
            `;

            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = `Laporan_Piutang_${periode}.xls`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // Print Rekap Piutang Per Pelanggan
        function printRekapPiutang() {
            const tglMulai = document.getElementById('filterPiutangMulai').value;
            const tglSelesai = document.getElementById('filterPiutangSelesai').value;

            let allPiutang = getAllPiutangData();

            if (tglMulai) {
                const tglMulaiParsed = parseTanggal(tglMulai);
                allPiutang = allPiutang.filter(item => parseTanggal(item.tanggal) >= tglMulaiParsed);
            }
            if (tglSelesai) {
                const tglSelesaiParsed = parseTanggal(tglSelesai);
                allPiutang = allPiutang.filter(item => parseTanggal(item.tanggal) <= tglSelesaiParsed);
            }

            // Group by pelanggan
            const rekapByPelanggan = {};
            allPiutang.forEach(item => {
                const nama = item.nama || 'Tidak diketahui';
                if (!rekapByPelanggan[nama]) {
                    rekapByPelanggan[nama] = {
                        nama: nama,
                        jumlahTransaksi: 0,
                        totalPiutang: 0,
                        totalDibayar: 0
                    };
                }
                rekapByPelanggan[nama].jumlahTransaksi++;
                rekapByPelanggan[nama].totalPiutang += item.total;

                let dibayar = item.dibayar || 0;
                rekapByPelanggan[nama].totalDibayar += dibayar;
            });

            const rekapArray = Object.values(rekapByPelanggan).sort((a, b) =>
                (b.totalPiutang - b.totalDibayar) - (a.totalPiutang - a.totalDibayar)
            );

            let grandTotal = 0, grandDibayar = 0, grandSisa = 0;

            const periode = (tglMulai && tglSelesai) ? `Periode: ${formatTanggal(tglMulai)} s/d ${formatTanggal(tglSelesai)}` : 'Semua Periode';

            let html = `
                <html>
                <head>
                    <title>Rekap Piutang Per Pelanggan - PT. Sumber Ganda Mekar</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1, h2 { text-align: center; margin-bottom: 5px; }
                        .periode { text-align: center; color: #666; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #333; padding: 10px; text-align: left; font-size: 12px; }
                        th { background-color: #1565c0; color: white; }
                        .number { text-align: right; }
                        .text-center { text-align: center; }
                        .total-row { background-color: #fff3cd; font-weight: bold; }
                        .sisa-merah { color: #dc3545; font-weight: bold; }
                        .sisa-hijau { color: #28a745; font-weight: bold; }
                        .w-40 { width: 40px; }
                        .w-80 { width: 80px; }
                        .w-130 { width: 130px; }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <h1>PT. SUMBER GANDA MEKAR</h1>
                    <h2>REKAP PIUTANG PER PELANGGAN</h2>
                    <p class="periode">${periode}</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th class="w-40">No</th>
                                <th>Nama Pelanggan</th>
                                <th class="w-80">Jml Trans</th>
                                <th class="w-130">Total Piutang</th>
                                <th class="w-130">Total Dibayar</th>
                                <th class="w-130">Sisa Piutang</th>
                                <th class="w-80">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            rekapArray.forEach((item, idx) => {
                const sisa = item.totalPiutang - item.totalDibayar;
                grandTotal += item.totalPiutang;
                grandDibayar += item.totalDibayar;
                grandSisa += sisa;

                const statusText = sisa === 0 ? 'LUNAS' : 'BELUM';
                const sisaClass = sisa > 0 ? 'sisa-merah' : 'sisa-hijau';

                html += `
                    <tr>
                        <td class="text-center">${idx + 1}</td>
                        <td>${item.nama}</td>
                        <td class="text-center">${item.jumlahTransaksi}</td>
                        <td class="number">${formatRupiah(item.totalPiutang)}</td>
                        <td class="number">${formatRupiah(item.totalDibayar)}</td>
                        <td class="number ${sisaClass}">${formatRupiah(sisa)}</td>
                        <td class="text-center">${statusText}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3" class="text-right pr-15">GRAND TOTAL:</td>
                                <td class="number">${formatRupiah(grandTotal)}</td>
                                <td class="number">${formatRupiah(grandDibayar)}</td>
                                <td class="number ${grandSisa > 0 ? 'sisa-merah' : 'sisa-hijau'}">${formatRupiah(grandSisa)}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <p class="mt-30px text-right text-xs">
                        Dicetak pada: ${new Date().toLocaleString('id-ID')}
                    </p>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }

        // ========== FUNGSI LAPORAN HUTANG ==========

        // Filter Laporan Hutang
        function filterLaporanHutang() {
            const tglMulai = document.getElementById('filterHutangMulai').value;
            const tglSelesai = document.getElementById('filterHutangSelesai').value;
            const status = document.getElementById('filterHutangStatus').value;
            const supplier = document.getElementById('filterHutangSupplier').value.toLowerCase();

            let allHutang = getAllHutangData();

            // Filter berdasarkan tanggal
            if (tglMulai) {
                const tglMulaiParsed = parseTanggal(tglMulai);
                allHutang = allHutang.filter(item => {
                    const tglItem = parseTanggal(item.tanggal);
                    return tglItem >= tglMulaiParsed;
                });
            }
            if (tglSelesai) {
                const tglSelesaiParsed = parseTanggal(tglSelesai);
                allHutang = allHutang.filter(item => {
                    const tglItem = parseTanggal(item.tanggal);
                    return tglItem <= tglSelesaiParsed;
                });
            }

            // Filter berdasarkan status
            if (status === 'belum') {
                allHutang = allHutang.filter(item => (item.total - (item.dibayar || 0)) > 0);
            } else if (status === 'lunas') {
                allHutang = allHutang.filter(item => (item.total - (item.dibayar || 0)) === 0);
            }

            // Filter berdasarkan supplier
            if (supplier) {
                allHutang = allHutang.filter(item => item.nama.toLowerCase().includes(supplier));
            }

            displayFilteredHutang(allHutang);
            displayRekapHutang(allHutang);
        }

        // Reset Filter Hutang
        function resetFilterHutang() {
            document.getElementById('filterHutangMulai').value = '';
            document.getElementById('filterHutangSelesai').value = '';
            document.getElementById('filterHutangStatus').value = 'semua';
            document.getElementById('filterHutangSupplier').value = '';
            displayHutang();
            displayRekapHutang(getAllHutangData());
        }

        // Display Filtered Hutang
        function displayFilteredHutang(allHutang) {
            const tbody = document.getElementById('bodyHutang');
            let html = '';
            let totalHutang = 0;
            let totalBayar = 0;
            let totalPembelianKredit = 0;
            let no = 0;
            const supplierSet = new Set();

            if (allHutang.length === 0) {
                html = '<tr><td colspan="11" class="text-center">Tidak ada data hutang yang sesuai filter</td></tr>';
            } else {
                allHutang.forEach((item) => {
                    let dibayar = item.dibayar || 0;
                    const sisa = item.total - dibayar;
                    totalHutang += sisa;
                    totalBayar += dibayar;
                    totalPembelianKredit += item.total;
                    supplierSet.add(item.nama);
                    no++;

                    const statusBadge = sisa === 0 ?
                        '<span class="badge badge-lunas">✓ LUNAS</span>' :
                        '<span class="badge badge-belum">⚠ BELUM LUNAS</span>';

                    const sumberBadge = item.sumber === 'Saldo Awal' ?
                        '<span class="badge-awal">Awal</span>' :
                        '<span class="badge-beli">Beli</span>';

                    let aksiHtml = '-';
                    if (sisa > 0) {
                        if (item.tipe === 'pembelian') {
                            aksiHtml = `<button class="btn btn-danger btn-xs" onclick="bayarHutang(${item.id})">💰 Bayar</button>`;
                        } else {
                            aksiHtml = `<button class="btn btn-danger btn-xs" onclick="bayarHutangAwal(${item.id})">💰 Bayar</button>`;
                        }
                    }
                    if (item.tipe === 'awal') {
                        aksiHtml += ` <button class="btn btn-danger btn-sm" onclick="hapusHutangAwal(${item.id})">🗑️</button>`;
                    }

                    html += `
                        <tr>
                            <td class="text-center">${no}</td>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td class="text-center">${sumberBadge}</td>
                            <td>${item.noFaktur || '-'}</td>
                            <td>${item.nama}</td>
                            <td>${item.keterangan || '-'}</td>
                            <td class="number">${formatRupiah(item.total)}</td>
                            <td class="number">${formatRupiah(dibayar)}</td>
                            <td class="number">${formatRupiah(sisa)}</td>
                            <td class="text-center">${statusBadge}</td>
                            <td class="text-center">${aksiHtml}</td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = html;
            document.getElementById('totalHutang').textContent = formatRupiah(totalHutang);
            document.getElementById('totalBayarHutang').textContent = formatRupiah(totalBayar);
            document.getElementById('totalPembelianKredit').textContent = formatRupiah(totalPembelianKredit);
            document.getElementById('jumlahSupplierHutang').textContent = supplierSet.size;

            // Update footer
            document.getElementById('footerTotalHutang').textContent = formatRupiah(totalPembelianKredit);
            document.getElementById('footerDibayarHutang').textContent = formatRupiah(totalBayar);
            document.getElementById('footerSisaHutang').textContent = formatRupiah(totalHutang);
        }

        // Display Rekap Hutang Per Supplier
        function displayRekapHutang(allHutang) {
            const tbody = document.getElementById('bodyRekapHutang');
            const tfoot = document.getElementById('footerRekapHutang');

            // Group by supplier
            const rekapBySupplier = {};
            allHutang.forEach(item => {
                const nama = item.nama || 'Tidak diketahui';
                if (!rekapBySupplier[nama]) {
                    rekapBySupplier[nama] = {
                        nama: nama,
                        jumlahTransaksi: 0,
                        totalHutang: 0,
                        totalDibayar: 0
                    };
                }
                rekapBySupplier[nama].jumlahTransaksi++;
                rekapBySupplier[nama].totalHutang += item.total;

                let dibayar = item.dibayar || 0;
                rekapBySupplier[nama].totalDibayar += dibayar;
            });

            const rekapArray = Object.values(rekapBySupplier).sort((a, b) =>
                (b.totalHutang - b.totalDibayar) - (a.totalHutang - a.totalDibayar)
            );

            let html = '';
            let grandTotalHutang = 0;
            let grandTotalDibayar = 0;
            let grandSisa = 0;

            if (rekapArray.length === 0) {
                html = '<tr><td colspan="7" class="text-center">Belum ada data</td></tr>';
            } else {
                rekapArray.forEach((item, idx) => {
                    const sisa = item.totalHutang - item.totalDibayar;
                    grandTotalHutang += item.totalHutang;
                    grandTotalDibayar += item.totalDibayar;
                    grandSisa += sisa;

                    const statusBadge = sisa === 0 ?
                        '<span class="badge badge-lunas">LUNAS</span>' :
                        '<span class="badge badge-belum">BELUM</span>';

                    html += `
                        <tr>
                            <td class="text-center">${idx + 1}</td>
                            <td>${item.nama}</td>
                            <td class="text-center">${item.jumlahTransaksi}</td>
                            <td class="number">${formatRupiah(item.totalHutang)}</td>
                            <td class="number">${formatRupiah(item.totalDibayar)}</td>
                            <td class="number ${sisa > 0 ? 'text-danger-bold' : 'text-success-bold'}">${formatRupiah(sisa)}</td>
                            <td class="text-center">${statusBadge}</td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = html;

            // Footer total
            tfoot.innerHTML = `
                <tr class="bg-yellow-light-bold">
                    <td colspan="3" class="text-right pr-15">GRAND TOTAL:</td>
                    <td class="number">${formatRupiah(grandTotalHutang)}</td>
                    <td class="number">${formatRupiah(grandTotalDibayar)}</td>
                    <td class="number ${grandSisa > 0 ? 'text-danger-bold' : 'text-success-bold'}">${formatRupiah(grandSisa)}</td>
                    <td></td>
                </tr>
            `;

            // Update jumlah supplier
            document.getElementById('jumlahSupplierHutang').textContent = rekapArray.length;
        }

        // Print Laporan Hutang
        function printLaporanHutang() {
            const tglMulai = document.getElementById('filterHutangMulai').value;
            const tglSelesai = document.getElementById('filterHutangSelesai').value;
            const status = document.getElementById('filterHutangStatus').value;
            const supplier = document.getElementById('filterHutangSupplier').value;

            let allHutang = getAllHutangData();

            // Apply filters
            if (tglMulai) {
                const tglMulaiParsed = parseTanggal(tglMulai);
                allHutang = allHutang.filter(item => parseTanggal(item.tanggal) >= tglMulaiParsed);
            }
            if (tglSelesai) {
                const tglSelesaiParsed = parseTanggal(tglSelesai);
                allHutang = allHutang.filter(item => parseTanggal(item.tanggal) <= tglSelesaiParsed);
            }
            if (status === 'belum') {
                allHutang = allHutang.filter(item => (item.total - (item.dibayar || 0)) > 0);
            } else if (status === 'lunas') {
                allHutang = allHutang.filter(item => (item.total - (item.dibayar || 0)) === 0);
            }
            if (supplier) {
                allHutang = allHutang.filter(item => item.nama.toLowerCase().includes(supplier.toLowerCase()));
            }

            // Calculate totals
            let totalHutang = 0, totalBayar = 0, totalSisa = 0;
            allHutang.forEach(item => {
                let dibayar = item.dibayar || 0;

                totalHutang += item.total;
                totalBayar += dibayar;
                totalSisa += item.total - dibayar;
            });

            const periode = (tglMulai && tglSelesai) ? `Periode: ${formatTanggal(tglMulai)} s/d ${formatTanggal(tglSelesai)}` : 'Semua Periode';
            const statusText = status === 'belum' ? ' - Status: Belum Lunas' : (status === 'lunas' ? ' - Status: Sudah Lunas' : '');
            const supplierText = supplier ? ` - Supplier: ${supplier}` : '';

            let html = `
                <html>
                <head>
                    <title>Laporan Hutang - PT. Sumber Ganda Mekar</title>
                    <style>
                        body { font-family: "Inter", "Segoe UI", Arial, sans-serif; padding: 20px; background: white; color: #1e293b; }
                        h1 { font-size: 18pt; margin: 0 0 5px 0; text-align: center; color: #1e293b; font-weight: 700; }
                        h2 { font-size: 14pt; margin: 0 0 5px 0; text-align: center; color: #64748b; font-weight: 600; }
                        .periode { text-align: center; color: #64748b; margin-bottom: 20px; font-size: 10pt; }
                        
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10pt; }
                        th, td { border: 1px solid #e2e8f0; padding: 8px 12px; text-align: left; }
                        th { background-color: #f8fafc; color: #1e293b; font-weight: 600; text-transform: uppercase; font-size: 9pt; letter-spacing: 0.05em; }
                        
                        .number { text-align: right; font-family: "JetBrains Mono", Consolas, monospace; }
                        .text-center { text-align: center; }
                        .total-row { background-color: #f1f5f9 !important; font-weight: bold; border-top: 2px solid #cbd5e1; }
                        
                        .badge { padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: bold; display: inline-block; }
                        .badge-lunas { background-color: #dcfce7; color: #166534; border: 1px solid #bbb; }
                        .badge-belum { background-color: #fee2e2; color: #991b1b; border: 1px solid #bbb; }
                        
                        .summary { margin-top: 20px; display: flex; justify-content: space-around; gap: 20px; }
                        .summary-card { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; flex: 1; }
                        .summary-card strong { display: block; font-size: 0.9em; color: #64748b; margin-bottom: 5px; }
                        .summary-card div { font-size: 1.2em; font-weight: bold; color: #1e293b; font-family: "JetBrains Mono", monospace; }
                        .bg-danger-light { background-color: #fff1f2; border-color: #fecdd3; }
                        .bg-danger-light div { color: #be123c; }
                        
                        /* Width Utilities */
                        .w-30px { width: 30px; }
                        .w-60px { width: 60px; }
                        .w-70px { width: 70px; }
                        .w-80px { width: 80px; }
                        .w-90px { width: 90px; }
                        .w-100px { width: 100px; }
                        .pr-15 { padding-right: 15px; }
                        .text-right { text-align: right; }
                        .mt-30px { margin-top: 30px; }
                        .text-xs { font-size: 10px; color: #94a3b8; }
                        
                        tr:nth-child(even) { background-color: #f8fafc; }
                        
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none; }
                            .summary-card { border: 1px solid #cbd5e1; }
                            .bg-danger-light { background-color: #fff1f2 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            th { background-color: #f1f5f9 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .badge-lunas { border: 1px solid #166534; }
                            .badge-belum { border: 1px solid #991b1b; }
                        }
                    </style>
                </head>
                <body>
                    <h1>PT. SUMBER GANDA MEKAR</h1>
                    <h2>LAPORAN HUTANG</h2>
                    <p class="periode">${periode}${statusText}${supplierText}</p>
                    
                    <div class="summary">
                        <div class="summary-card">
                            <strong>Total Hutang</strong>
                            <div>${formatRupiah(totalHutang)}</div>
                        </div>
                        <div class="summary-card">
                            <strong>Total Dibayar</strong>
                            <div>${formatRupiah(totalBayar)}</div>
                        </div>
                        <div class="summary-card bg-danger-light">
                            <strong>Sisa Hutang</strong>
                            <div>${formatRupiah(totalSisa)}</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th class="w-30px text-center">No</th>
                                <th class="w-80px">Tanggal</th>
                                <th class="w-60px text-center">Sumber</th>
                                <th class="w-90px">No. Faktur</th>
                                <th>Supplier</th>
                                <th>Keterangan</th>
                                <th class="w-100px number">Total</th>
                                <th class="w-100px number">Dibayar</th>
                                <th class="w-100px number">Sisa</th>
                                <th class="w-70px text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            allHutang.forEach((item, idx) => {
                const dibayar = item.dibayar || 0;
                const sisa = item.total - dibayar;
                const statusBadge = sisa === 0 ?
                    '<span class="badge badge-lunas">LUNAS</span>' :
                    '<span class="badge badge-belum">BELUM</span>';

                html += `
                    <tr>
                        <td class="text-center">${idx + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td class="text-center">${item.sumber === 'Saldo Awal' ? 'Awal' : 'Beli'}</td>
                        <td>${item.noFaktur || '-'}</td>
                        <td>${item.nama}</td>
                        <td>${item.keterangan || '-'}</td>
                        <td class="number">${formatRupiah(item.total)}</td>
                        <td class="number">${formatRupiah(dibayar)}</td>
                        <td class="number">${formatRupiah(sisa)}</td>
                        <td class="text-center">${statusBadge}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="6" class="text-right pr-15">TOTAL:</td>
                                <td class="number">${formatRupiah(totalHutang)}</td>
                                <td class="number">${formatRupiah(totalBayar)}</td>
                                <td class="number">${formatRupiah(totalSisa)}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <p class="mt-30px text-right text-xs">
                        Dicetak pada: ${formatTanggal(new Date())}
                    </p>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // Ekspor Hutang ke Excel
        function eksporHutangExcel() {
            const tglMulai = document.getElementById('filterHutangMulai').value;
            const tglSelesai = document.getElementById('filterHutangSelesai').value;
            const status = document.getElementById('filterHutangStatus').value;
            const supplier = document.getElementById('filterHutangSupplier').value;

            let allHutang = getAllHutangData();

            // Apply filters
            if (tglMulai) {
                const tglMulaiParsed = parseTanggal(tglMulai);
                allHutang = allHutang.filter(item => parseTanggal(item.tanggal) >= tglMulaiParsed);
            }
            if (tglSelesai) {
                const tglSelesaiParsed = parseTanggal(tglSelesai);
                allHutang = allHutang.filter(item => parseTanggal(item.tanggal) <= tglSelesaiParsed);
            }
            if (status === 'belum') {
                allHutang = allHutang.filter(item => (item.total - (item.dibayar || 0)) > 0);
            } else if (status === 'lunas') {
                allHutang = allHutang.filter(item => (item.total - (item.dibayar || 0)) === 0);
            }
            if (supplier) {
                allHutang = allHutang.filter(item => item.nama.toLowerCase().includes(supplier.toLowerCase()));
            }

            // Calculate totals
            let totalHutang = 0, totalBayar = 0, totalSisa = 0;
            allHutang.forEach(item => {
                totalHutang += item.total;
                totalBayar += item.dibayar || 0;
                totalSisa += item.total - (item.dibayar || 0);
            });

            const periode = (tglMulai && tglSelesai) ? `Periode_${tglMulai}_${tglSelesai}` : 'Semua_Periode';

            let html = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta http-equiv="content-type" content="text/plain; charset=UTF-8"/>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Laporan Hutang</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #000; padding: 5px; }
                        .bg-purple-header { background-color: #c2185b; color: white; }
                        .bg-yellow-light-bold { background-color: #fff3cd; font-weight: bold; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .font-size-16 { font-size: 16px; }
                        .p-15px { padding: 15px; }
                        .pr-15 { padding-right: 15px; }
                    </style>
                </head>
                <body>
                <table border="1">
                    <tr class="bg-purple-header">
                        <th colspan="10" class="text-center p-15px font-size-16">
                            LAPORAN HUTANG - PT. SUMBER GANDA MEKAR<br>
                            ${periode.replace(/_/g, ' ')}
                        </th>
                    </tr>
                    <tr class="bg-purple-header">
                        <th>No</th>
                        <th>Tanggal</th>
                        <th>Sumber</th>
                        <th>No. Faktur</th>
                        <th>Supplier</th>
                        <th>Keterangan</th>
                        <th>Total Hutang</th>
                        <th>Dibayar</th>
                        <th>Sisa</th>
                        <th>Status</th>
                    </tr>
            `;

            allHutang.forEach((item, idx) => {
                const dibayar = item.dibayar || 0;
                const sisa = item.total - dibayar;
                const statusText = sisa === 0 ? 'LUNAS' : 'BELUM LUNAS';

                html += `
                    <tr>
                        <td class="text-center">${idx + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td class="text-center">${item.sumber === 'Saldo Awal' ? 'Saldo Awal' : 'Pembelian'}</td>
                        <td>${item.noFaktur || '-'}</td>
                        <td>${item.nama}</td>
                        <td>${item.keterangan || '-'}</td>
                        <td class="text-right">${formatRupiah(item.total)}</td>
                        <td class="text-right">${formatRupiah(dibayar)}</td>
                        <td class="text-right">${formatRupiah(sisa)}</td>
                        <td class="text-center">${statusText}</td>
                    </tr>
                `;
            });

            html += `
                    <tr class="bg-yellow-light-bold">
                        <td colspan="6" class="text-right pr-15">TOTAL:</td>
                        <td class="text-right">${formatRupiah(totalHutang)}</td>
                        <td class="text-right">${formatRupiah(totalBayar)}</td>
                        <td class="text-right">${formatRupiah(totalSisa)}</td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
            `;

            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = `Laporan_Hutang_${periode}.xls`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // Print Rekap Hutang Per Supplier
        function printRekapHutang() {
            const tglMulai = document.getElementById('filterHutangMulai').value;
            const tglSelesai = document.getElementById('filterHutangSelesai').value;

            let allHutang = getAllHutangData();

            if (tglMulai) {
                const tglMulaiParsed = parseTanggal(tglMulai);
                allHutang = allHutang.filter(item => parseTanggal(item.tanggal) >= tglMulaiParsed);
            }
            if (tglSelesai) {
                const tglSelesaiParsed = parseTanggal(tglSelesai);
                allHutang = allHutang.filter(item => parseTanggal(item.tanggal) <= tglSelesaiParsed);
            }

            // Group by supplier
            const rekapBySupplier = {};
            allHutang.forEach(item => {
                const nama = item.nama || 'Tidak diketahui';
                if (!rekapBySupplier[nama]) {
                    rekapBySupplier[nama] = {
                        nama: nama,
                        jumlahTransaksi: 0,
                        totalHutang: 0,
                        totalDibayar: 0
                    };
                }
                rekapBySupplier[nama].jumlahTransaksi++;
                rekapBySupplier[nama].totalHutang += item.total;
                rekapBySupplier[nama].totalDibayar += item.dibayar || 0;
            });

            const rekapArray = Object.values(rekapBySupplier).sort((a, b) =>
                (b.totalHutang - b.totalDibayar) - (a.totalHutang - a.totalDibayar)
            );

            let grandTotal = 0, grandDibayar = 0, grandSisa = 0;

            const periode = (tglMulai && tglSelesai) ? `Periode: ${formatTanggal(tglMulai)} s/d ${formatTanggal(tglSelesai)}` : 'Semua Periode';

            let html = `
                <html>
                <head>
                    <title>Rekap Hutang Per Supplier - PT. Sumber Ganda Mekar</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1, h2 { text-align: center; margin-bottom: 5px; }
                        .periode { text-align: center; color: #666; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #333; padding: 10px; text-align: left; font-size: 12px; }
                        th { background-color: #7b1fa2; color: white; }
                        .number { text-align: right; }
                        .center { text-align: center; }
                        .total-row { background-color: #fff3cd; font-weight: bold; }
                        .sisa-merah { color: #dc3545; font-weight: bold; }
                        .sisa-hijau { color: #28a745; font-weight: bold; }
                        .w-40 { width: 40px; }
                        .w-80 { width: 80px; }
                        .w-130 { width: 130px; }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <h1>PT. SUMBER GANDA MEKAR</h1>
                    <h2>REKAP HUTANG PER SUPPLIER</h2>
                    <p class="periode">${periode}</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th class="w-40">No</th>
                                <th>Nama Supplier</th>
                                <th class="w-80">Jml Trans</th>
                                <th class="w-130">Total Hutang</th>
                                <th class="w-130">Total Dibayar</th>
                                <th class="w-130">Sisa Hutang</th>
                                <th class="w-80">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            rekapArray.forEach((item, idx) => {
                const sisa = item.totalHutang - item.totalDibayar;
                grandTotal += item.totalHutang;
                grandDibayar += item.totalDibayar;
                grandSisa += sisa;

                const statusText = sisa === 0 ? 'LUNAS' : 'BELUM';
                const sisaClass = sisa > 0 ? 'sisa-merah' : 'sisa-hijau';

                html += `
                    <tr>
                        <td class="center">${idx + 1}</td>
                        <td>${item.nama}</td>
                        <td class="center">${item.jumlahTransaksi}</td>
                        <td class="number">${formatRupiah(item.totalHutang)}</td>
                        <td class="number">${formatRupiah(item.totalDibayar)}</td>
                        <td class="number ${sisaClass}">${formatRupiah(sisa)}</td>
                        <td class="center">${statusText}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3" class="text-right pr-15">GRAND TOTAL:</td>
                                <td class="number">${formatRupiah(grandTotal)}</td>
                                <td class="number">${formatRupiah(grandDibayar)}</td>
                                <td class="number ${grandSisa > 0 ? 'sisa-merah' : 'sisa-hijau'}">${formatRupiah(grandSisa)}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <p class="mt-30px text-right text-xs">
                        Dicetak pada: ${new Date().toLocaleString('id-ID')}
                    </p>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }

        // ========== FUNGSI MODAL ==========

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            if (event.target.classList.contains('modal') || event.target.classList.contains('modal-faktur')) {
                event.target.classList.remove('show');
            }
        }

        // ========== FUNGSI EDIT ==========

        function calculateEditTotalJual() {
            const qty = parseFloat(document.getElementById('editQtyJual').value) || 0;
            const harga = parseFloat(document.getElementById('editHargaJual').value) || 0;
            const subtotal = qty * harga;
            const jenisPpn = document.getElementById('editJenisPpnJual').value;

            let nilaiPpn = 0;
            if (jenisPpn === 'ppn11') nilaiPpn = subtotal * 0.11;
            else if (jenisPpn === 'ppn1') nilaiPpn = subtotal * 0.011;

            // Simpan total di atribut untuk akses mudah
            const total = subtotal + nilaiPpn;
            document.getElementById('formEditPenjualan').dataset.total = total;

            calculateEditSisaTagihanJual();
        }

        function calculateEditSisaTagihanJual() {
            const total = parseFloat(document.getElementById('formEditPenjualan').dataset.total) || 0;
            const dp = parseRupiahValue(document.getElementById('editDpJual').value);
            const sisa = Math.max(0, total - dp);
            document.getElementById('editSisaJual').value = formatRupiah(sisa);
        }

        function calculateEditTotalBeli() {
            const qty = parseFloat(document.getElementById('editQtyBeli').value) || 0;
            const harga = parseFloat(document.getElementById('editHargaBeli').value) || 0;
            const subtotal = qty * harga;
            const jenisPpn = document.getElementById('editJenisPpnBeli').value;

            let nilaiPpn = 0;
            if (jenisPpn === 'ppn11') nilaiPpn = subtotal * 0.11;
            else if (jenisPpn === 'ppn1') nilaiPpn = subtotal * 0.011;

            // Simpan total di atribut untuk akses mudah
            const total = subtotal + nilaiPpn;
            document.getElementById('formEditPembelian').dataset.total = total;

            calculateEditSisaTagihanBeli();
        }

        function calculateEditSisaTagihanBeli() {
            const total = parseFloat(document.getElementById('formEditPembelian').dataset.total) || 0;
            const dp = parseRupiahValue(document.getElementById('editDpBeli').value);
            const paymentsOnly = parseFloat(document.getElementById('formEditPembelian').dataset.paymentsOnly) || 0;

            const sisa = Math.max(0, total - dp - paymentsOnly);
            document.getElementById('editSisaBeli').value = formatRupiah(sisa);
        }

        // Edit Penjualan
        function editPenjualan(id) {
            const item = dataPenjualan.find(p => p.id === id);
            if (item) {
                document.getElementById('editIdJual').value = item.id;
                document.getElementById('editTglJual').value = convertToDisplayDate(item.tanggal);
                document.getElementById('editDivisiJual').value = item.divisi || 'Angkutan';
                document.getElementById('editPelanggan').value = item.namaPelanggan || item.pelanggan || '';
                document.getElementById('editAlamatPelanggan').value = item.alamatPelanggan || '';
                document.getElementById('editTeleponPelanggan').value = item.teleponPelanggan || '';
                document.getElementById('editNpwpPelanggan').value = item.npwpPelanggan || '';
                document.getElementById('editBarangJual').value = item.namaBarang || item.barang || '';
                document.getElementById('editQtyJual').value = item.qty;
                document.getElementById('editHargaJual').value = item.harga;
                document.getElementById('editJenisPpnJual').value = item.jenisPpn || 'non';

                // Set initial total for calculation
                document.getElementById('formEditPenjualan').dataset.total = item.total;

                // Calculate and store paymentsOnly (Total Paid - Old DP) for dynamic sisa calculation
                const oldDp = item.dp || 0;
                const currentDibayar = item.dibayar || 0;
                const paymentsOnly = Math.max(0, currentDibayar - oldDp);
                document.getElementById('formEditPenjualan').dataset.paymentsOnly = paymentsOnly;

                // Populate DP and Sisa
                const dp = item.dp || 0;
                const sisa = item.sisa !== undefined ? item.sisa : Math.max(0, item.total - dp);

                document.getElementById('editDpJual').value = formatRupiah(dp);
                document.getElementById('editSisaJual').value = formatRupiah(sisa);

                openModal('modalEditPenjualan');
            }
        }

        // Submit Edit Penjualan
        document.getElementById('formEditPenjualan').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('editIdJual').value);
            const index = dataPenjualan.findIndex(p => p.id === id);

            if (index !== -1) {
                const qty = parseFloat(document.getElementById('editQtyJual').value);
                const harga = parseFloat(document.getElementById('editHargaJual').value);
                const subtotal = qty * harga;
                const jenisPpn = document.getElementById('editJenisPpnJual').value;

                let nilaiPpn = 0;
                if (jenisPpn === 'ppn11') nilaiPpn = subtotal * 0.11;
                else if (jenisPpn === 'ppn1') nilaiPpn = subtotal * 0.011;

                const total = subtotal + nilaiPpn;

                dataPenjualan[index].tanggal = document.getElementById('editTglJual').value;
                dataPenjualan[index].divisi = document.getElementById('editDivisiJual').value;
                dataPenjualan[index].namaPelanggan = document.getElementById('editPelanggan').value;
                dataPenjualan[index].alamatPelanggan = document.getElementById('editAlamatPelanggan').value || '-';
                dataPenjualan[index].teleponPelanggan = document.getElementById('editTeleponPelanggan').value || '-';
                dataPenjualan[index].npwpPelanggan = document.getElementById('editNpwpPelanggan').value || '-';
                dataPenjualan[index].namaBarang = document.getElementById('editBarangJual').value;
                dataPenjualan[index].qty = qty;
                dataPenjualan[index].harga = harga;
                dataPenjualan[index].subtotal = subtotal;
                dataPenjualan[index].jenisPpn = jenisPpn;
                dataPenjualan[index].nilaiPpn = nilaiPpn;
                dataPenjualan[index].total = total;

                // Update DP dan Dibayar
                const oldDp = dataPenjualan[index].dp || 0;
                const newDp = parseRupiahValue(document.getElementById('editDpJual').value);

                // Adjust dibayar: remove old DP, add new DP
                let currentDibayar = dataPenjualan[index].dibayar || 0;
                // Asumsi dibayar >= dp. Jika tidak, reset ke 0 (prevent negative)
                let paymentsOnly = Math.max(0, currentDibayar - oldDp);
                let newDibayar = paymentsOnly + newDp;

                dataPenjualan[index].dp = newDp;
                dataPenjualan[index].dibayar = newDibayar;
                dataPenjualan[index].sisa = Math.max(0, total - newDibayar);

                // --- FIX: Update Jurnal & Kas Harian (Delete Old -> Create New) ---
                const updatedTransaksi = dataPenjualan[index];
                const noFaktur = updatedTransaksi.noFaktur;

                // 1. Hapus Jurnal Lama (berdasarkan No Faktur)
                dataJurnal = dataJurnal.filter(j => j.noRef !== noFaktur);

                // 2. Hapus Kas Harian Lama (DP/Tunai dari transaksi ini)
                // Filter: Kategori Penjualan AND Keterangan contains No Faktur
                dataKasHarian = dataKasHarian.filter(k => {
                    const isRelated = (k.kategori === 'Penjualan') && (k.keterangan.includes(noFaktur));
                    return !isRelated;
                });

                // 3. Buat Jurnal & Kas Baru
                buatJurnalPenjualan(updatedTransaksi);
                // -----------------------------------------------------------------

                saveDataToStorage();
                displayPenjualan();
                displayJurnal(); // Refresh Jurnal
                displayKasHarian(); // Refresh Kas
                displayPiutang();
                closeModal('modalEditPenjualan');
                alert('Data penjualan berhasil diupdate!');
            }
        });

        // Edit Pembelian
        function editPembelian(id) {
            const item = dataPembelian.find(p => p.id === id);
            if (item) {
                document.getElementById('editIdBeli').value = item.id;
                document.getElementById('editTglBeli').value = convertToDisplayDate(item.tanggal);
                document.getElementById('editDivisiBeli').value = item.divisi || 'Angkutan';
                document.getElementById('editSupplier').value = item.namaSupplier || item.supplier || '';
                document.getElementById('editAlamatSupplier').value = item.alamatSupplier || '';
                document.getElementById('editTeleponSupplier').value = item.teleponSupplier || '';
                document.getElementById('editNpwpSupplier').value = item.npwpSupplier || '';
                document.getElementById('editBarangBeli').value = item.namaBarang || item.barang || '';
                document.getElementById('editQtyBeli').value = item.qty;
                document.getElementById('editHargaBeli').value = item.harga;
                document.getElementById('editJenisPpnBeli').value = item.jenisPpn || 'non';

                // Set initial total for calculation
                document.getElementById('formEditPembelian').dataset.total = item.total;

                // Populate DP and Sisa
                const dp = item.dp || 0;
                const sisa = item.sisa !== undefined ? item.sisa : Math.max(0, item.total - dp);

                document.getElementById('editDpBeli').value = formatRupiah(dp);
                document.getElementById('editSisaBeli').value = formatRupiah(sisa);

                openModal('modalEditPembelian');
            }
        }

        // Submit Edit Pembelian
        document.getElementById('formEditPembelian').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('editIdBeli').value);
            const index = dataPembelian.findIndex(p => p.id === id);

            if (index !== -1) {
                const qty = parseFloat(document.getElementById('editQtyBeli').value);
                const harga = parseFloat(document.getElementById('editHargaBeli').value);
                const subtotal = qty * harga;
                const jenisPpn = document.getElementById('editJenisPpnBeli').value;

                let nilaiPpn = 0;
                if (jenisPpn === 'ppn11') nilaiPpn = subtotal * 0.11;
                else if (jenisPpn === 'ppn1') nilaiPpn = subtotal * 0.011;

                const total = subtotal + nilaiPpn;

                dataPembelian[index].tanggal = document.getElementById('editTglBeli').value;
                dataPembelian[index].divisi = document.getElementById('editDivisiBeli').value;
                dataPembelian[index].namaSupplier = document.getElementById('editSupplier').value;
                dataPembelian[index].alamatSupplier = document.getElementById('editAlamatSupplier').value || '-';
                dataPembelian[index].teleponSupplier = document.getElementById('editTeleponSupplier').value || '-';
                dataPembelian[index].npwpSupplier = document.getElementById('editNpwpSupplier').value || '-';
                dataPembelian[index].namaBarang = document.getElementById('editBarangBeli').value;
                dataPembelian[index].qty = qty;
                dataPembelian[index].harga = harga;
                dataPembelian[index].subtotal = subtotal;
                dataPembelian[index].jenisPpn = jenisPpn;
                dataPembelian[index].nilaiPpn = nilaiPpn;
                dataPembelian[index].total = total;

                // Update DP dan Dibayar
                const oldDp = dataPembelian[index].dp || 0;
                const newDp = parseRupiahValue(document.getElementById('editDpBeli').value);

                // Adjust dibayar: remove old DP, add new DP
                let currentDibayar = dataPembelian[index].dibayar || 0;
                let paymentsOnly = Math.max(0, currentDibayar - oldDp);
                let newDibayar = paymentsOnly + newDp;

                dataPembelian[index].dp = newDp;
                dataPembelian[index].dibayar = newDibayar;
                dataPembelian[index].sisa = Math.max(0, total - newDibayar);

                // --- FIX: Update Jurnal & Kas Harian (Delete Old -> Create New) ---
                const updatedTransaksi = dataPembelian[index];
                const noFaktur = updatedTransaksi.noFaktur;

                // 1. Hapus Jurnal Lama (berdasarkan No Faktur)
                dataJurnal = dataJurnal.filter(j => j.noRef !== noFaktur);

                // 2. Hapus Kas Harian Lama (DP/Tunai dari transaksi ini)
                // Filter: Kategori Pembelian AND Keterangan contains No Faktur
                dataKasHarian = dataKasHarian.filter(k => {
                    const isRelated = (k.kategori === 'Pembelian') && (k.keterangan.includes(noFaktur));
                    return !isRelated;
                });

                // 3. Buat Jurnal & Kas Baru
                buatJurnalPembelian(updatedTransaksi);
                // -----------------------------------------------------------------

                saveDataToStorage();
                displayPembelian();
                displayJurnal(); // Refresh Jurnal
                displayKasHarian(); // Refresh Kas
                displayHutang();
                closeModal('modalEditPembelian');
                alert('Data pembelian berhasil diupdate!');
            }
        });

        // Edit Transaksi Kas
        function editTransaksiKas(id) {
            const item = dataTransaksiKas.find(k => k.id === id);
            if (item) {
                document.getElementById('editIdKas').value = item.id;

                // Format tanggal untuk tampilan
                const tglFormatted = formatTanggal(item.tanggal);
                document.getElementById('editTglKas').value = tglFormatted;

                // Tampilkan nomor jurnal dan transaksi
                const noJurnal = item.noJurnalHarian || generateNoJurnalKasHarian(item.tanggal, item.jenis);
                document.getElementById('editNoJurnalKas').value = noJurnal;
                document.getElementById('editNoTransaksiKas').value = item.noTransaksi || '-';
                document.getElementById('editJenisKas').value = item.jenis === 'masuk' ? 'KAS MASUK' : 'KAS KELUAR';

                // Populate dropdown kategori
                const selectKategori = document.getElementById('editKategoriKas');
                selectKategori.innerHTML = '<option value="">-- Pilih Kategori --</option>';
                const kategoriList = item.jenis === 'masuk' ? kategoriKasMasuk : kategoriKasKeluar;
                kategoriList.forEach(kat => {
                    const option = document.createElement('option');
                    option.value = kat;
                    option.textContent = kat;
                    if (kat === item.kategori) option.selected = true;
                    selectKategori.appendChild(option);
                });

                document.getElementById('editKeteranganKas').value = item.keterangan;
                document.getElementById('editJumlahKas').value = formatRupiah(item.jumlah);

                openModal('modalEditKas');
            }
        }

        // Submit Edit Kas
        document.getElementById('formEditKas').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('editIdKas').value);
            const index = dataTransaksiKas.findIndex(k => k.id === id);

            if (index !== -1) {
                const tanggalBaru = convertToISODate(document.getElementById('editTglKas').value);
                const kategoriBaru = document.getElementById('editKategoriKas').value;
                const keteranganBaru = document.getElementById('editKeteranganKas').value;
                const jumlahBaru = parseRupiah(document.getElementById('editJumlahKas').value);
                const jenisKas = dataTransaksiKas[index].jenis; // ambil jenis kas (masuk/keluar)

                if (!tanggalBaru) {
                    alert('⚠️ Tanggal tidak valid!');
                    return;
                }
                if (!kategoriBaru) {
                    alert('⚠️ Pilih kategori!');
                    return;
                }
                if (!jumlahBaru || jumlahBaru <= 0) {
                    alert('⚠️ Jumlah harus lebih dari 0!');
                    return;
                }

                // Hapus jurnal lama yang terkait dengan transaksi kas ini
                const noRefLama = dataTransaksiKas[index].noTransaksi;
                dataJurnal = dataJurnal.filter(j => j.noRef !== noRefLama);

                // Update data
                dataTransaksiKas[index].tanggal = tanggalBaru;
                dataTransaksiKas[index].kategori = kategoriBaru;
                dataTransaksiKas[index].keterangan = keteranganBaru;
                dataTransaksiKas[index].jumlah = jumlahBaru;

                // Update nomor jurnal harian jika tanggal berubah
                dataTransaksiKas[index].noJurnalHarian = generateNoJurnalKasHarian(tanggalBaru, jenisKas);

                // Generate jurnal baru berdasarkan jenis kas
                const transaksiUpdated = dataTransaksiKas[index];
                if (jenisKas === 'masuk') {
                    buatJurnalKasMasuk(transaksiUpdated);
                } else {
                    buatJurnalKasKeluar(transaksiUpdated);
                }

                saveDataToStorage();
                displayTransaksiKas();
                updateSaldoKas();
                displayJurnal();
                closeModal('modalEditKas');
                alert('✅ Data transaksi kas berhasil diupdate dan jurnal telah diperbarui!');
            }
        });

        // ========== FUNGSI CETAK FAKTUR ==========

        function closeModalFaktur() {
            document.getElementById('modalFaktur').classList.remove('show');
            document.getElementById('modalFaktur').style.display = '';
        }

        function cetakFakturJual(id) {
            try {
                const item = dataPenjualan.find(p => p.id === id);
                if (!item) {
                    alert('Data penjualan tidak ditemukan!');
                    return;
                }

                currentFakturData = { type: 'penjualan', ...item };
                generateFakturPDF(item, 'penjualan');
                openModal('modalFaktur');
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function cetakFakturBeli(id) {
            try {
                const item = dataPembelian.find(p => p.id === id);
                if (!item) {
                    alert('Data pembelian tidak ditemukan!');
                    return;
                }

                currentFakturData = { type: 'pembelian', ...item };
                generateFakturPDF(item, 'pembelian');
                openModal('modalFaktur');
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function generateFakturPDF(data, type) {
            currentFakturMode = 'pdf';
            // Clone item and fix PPN type for display if needed
            const item = { ...data };

            // Recalculate PPN if needed (for old data or missing values)
            if (item.detailBarang && item.detailBarang.length > 0) {
                let hasPpn11 = false;
                let hasPpn1 = false;
                let hasDibebaskan = false;
                let calculatedPpn = 0;

                item.detailBarang.forEach(b => {
                    if (b.ppn === 'ppn11') hasPpn11 = true;
                    else if (b.ppn === 'ppn1') hasPpn1 = true;
                    else if (b.ppn === 'dibebaskan') hasDibebaskan = true;

                    // Calculate PPN per item if not present in transaction total
                    if (b.subtotal && b.qty && b.harga) {
                        const dpp = (b.qty * b.harga) - (b.diskon || 0);
                        const itemSubtotal = b.subtotal;
                        // PPN is difference between subtotal and DPP
                        if (itemSubtotal > dpp) {
                            calculatedPpn += (itemSubtotal - dpp);
                        }
                    }
                });

                // Update jenisPpn based on content if currently nonppn
                if (item.jenisPpn === 'nonppn' || !item.jenisPpn) {
                    if (hasPpn11) item.jenisPpn = 'ppn11';
                    else if (hasPpn1) item.jenisPpn = 'ppn1';
                    else if (hasDibebaskan) item.jenisPpn = 'dibebaskan';
                }

                // Update nilaiPpn if 0 but we found PPN in items
                if ((!item.nilaiPpn || item.nilaiPpn === 0) && calculatedPpn > 0) {
                    item.nilaiPpn = calculatedPpn;
                }
            }

            const isPenjualan = type === 'penjualan';
            const dibayar = item.dibayar !== undefined ? item.dibayar : (item.total || 0);
            const dp = item.dp || 0;
            const sisa = item.sisa !== undefined ? item.sisa : (item.total - dp - dibayar);
            const statusText = sisa <= 0 ? 'LUNAS' : 'BELUM LUNAS';
            const metodeBayar = item.metodeBayar === 'kredit' ? 'Transfer' : 'Tunai';

            // Logo SGM dari file lokal
            const logoSGM = 'logo sgm.jpg';

            const html = `
                <div class="invoice-box">
                    
                    <!-- HEADER -->
                    <table class="invoice-header-table">
                        <tr>
                            <td class="w-70pct align-top">
                                <div class="invoice-company-desc">
                                    <strong class="invoice-company-name">PT. SUMBER GANDA MEKAR</strong><br>
                                    <strong>JUAL BELI BESI TUA/BARU - RANGKA BETON/LOGAM - TIANG<br>
                                    LISTRIK/TELP - KONSTRUKSI BAJA DAN PAKAN TERNAK</strong><br>
                                    Jl. Raya Gedebage No. 95 Bandung<br>
                                    CP. Irwan : 082117800626, CP. Uwem : 082318188863
                                </div>
                            </td>
                            <td class="w-30pct align-top text-right">
                                <img src="${logoSGM}" alt="Logo SGM" class="invoice-logo">
                                <div class="invoice-meta">
                                    ${new Date().toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' })}, ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}<br>
                                    Sistem Akuntansi SGM
                                </div>
                            </td>
                        </tr>
                    </table>

                    <div class="invoice-divider"></div>

                    <!-- JUDUL -->
                    <div class="invoice-title-container">
                        <div class="invoice-title-box">
                            <strong class="invoice-title-text">${isPenjualan ? 'INVOICE PENJUALAN' : 'INVOICE PEMBELIAN'}</strong>
                        </div>
                    </div>

                    <!-- INFO BOX -->
                    <div class="invoice-info-box">
                        <table class="invoice-info-table">
                            <tr>
                                <td class="w-50pct align-top">
                                    <table class="w-100pct">
                                        <tr>
                                            <td class="p-2px-0 w-80px">Kepada Yth.</td>
                                            <td class="p-2px-0">: <strong>${isPenjualan ? (item.namaPelanggan || item.pelanggan || '-') : (item.namaSupplier || item.supplier || '-')}</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0 align-top">Alamat</td>
                                            <td class="p-2px-0">: ${isPenjualan ? (item.alamatPelanggan || '-') : (item.alamatSupplier || '-')}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0">Telepon</td>
                                            <td class="p-2px-0">: ${isPenjualan ? (item.teleponPelanggan || '-') : (item.teleponSupplier || '-')}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0">NPWP/NIK</td>
                                            <td class="p-2px-0">: ${isPenjualan ? (item.npwpPelanggan || '-') : (item.npwpSupplier || '-')}</td>
                                        </tr>
                                    </table>
                                </td>
                                <td class="w-50pct align-top pl-20px">
                                    <table class="w-100pct">
                                        <tr>
                                            <td class="p-2px-0 w-120px">No. Invoice</td>
                                            <td class="p-2px-0">: <strong>${item.noFaktur}</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0">Tanggal</td>
                                            <td class="p-2px-0">: ${formatTanggal(item.tanggal)}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0">Metode</td>
                                            <td class="p-2px-0">: ${metodeBayar}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0">Pembayaran</td>
                                            <td class="p-2px-0"></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- TABEL BARANG -->
                    <table class="invoice-items-table">
                        <thead>
                            <tr>
                                <th class="invoice-items-th w-30px">No</th>
                                <th class="invoice-items-th-left">Nama Barang</th>
                                <th class="invoice-items-th w-60px">Qty</th>
                                <th class="invoice-items-th w-60px">Satuan</th>
                                <th class="invoice-items-th-right w-110px">Harga Satuan</th>
                                <th class="invoice-items-th-right w-130px">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(item.detailBarang && item.detailBarang.length > 0) ? item.detailBarang.map((barang, index) => `
                            <tr>
                                <td class="invoice-items-td-center">${index + 1}</td>
                                <td class="invoice-items-td">${barang.nama || barang.namaBarang || '-'}</td>
                                <td class="invoice-items-td-center">${barang.qty}</td>
                                <td class="invoice-items-td-center">${barang.satuan || 'Kg'}</td>
                                <td class="invoice-items-td-right">${formatRupiah(barang.harga)}</td>
                                <td class="invoice-items-td-right"><strong>${formatRupiah(barang.subtotal)}</strong></td>
                            </tr>
                            `).join('') : `
                            <tr>
                                <td class="invoice-items-td-center">1</td>
                                <td class="invoice-items-td">${item.namaBarang || item.barang || '-'}</td>
                                <td class="invoice-items-td-center">${item.qty}</td>
                                <td class="invoice-items-td-center">Kg</td>
                                <td class="invoice-items-td-right">${formatRupiah(item.harga)}</td>
                                <td class="invoice-items-td-right"><strong>${formatRupiah(item.subtotal || (item.qty * item.harga))}</strong></td>
                            </tr>
                            `}
                        </tbody>
                    </table>

                    <!-- TOTAL SECTION -->
                    <table class="invoice-summary-table">
                        <tr>
                            <td class="w-55pct"></td>
                            <td class="w-45pct">
                                <table class="w-100pct">
                                    <tr>
                                        <td class="p-4px-8px text-right">Subtotal</td>
                                        <td class="p-4px-8px text-right w-130px">${formatRupiah(item.subtotal || item.total)}</td>
                                    </tr>
                                    ${(item.diskon || item.nilaiDiskon || 0) > 0 ? `
                                    <tr>
                                        <td class="p-4px-8px text-right">Diskon</td>
                                        <td class="p-4px-8px text-right">- ${formatRupiah(item.diskon || item.nilaiDiskon || 0)}</td>
                                    </tr>
                                    ` : ''}
                                    ${(item.jenisPpn === 'ppn11' || item.jenisPpn === 'ppn1' || item.jenisPpn === 'dibebaskan' || (item.nilaiPpn || 0) > 0) ? `
                                    <tr>
                                        <td class="p-4px-8px text-right">
                                            ${item.jenisPpn === 'ppn11' ? 'PPN 11%' :
                        item.jenisPpn === 'ppn1' ? 'PPN 1.1%' :
                            item.jenisPpn === 'dibebaskan' ? 'PPN (Dibebaskan)' :
                                'PPN'}
                                        </td>
                                        <td class="p-4px-8px text-right">${formatRupiah(item.nilaiPpn || 0)}</td>
                                    </tr>
                                    ` : ''}
                                    <tr class="border-top-black">
                                        <td class="p-6px-8px text-right"><strong>Total Tagihan</strong></td>
                                        <td class="p-6px-8px text-right"><strong>${formatRupiah(item.total)}</strong></td>
                                    </tr>
                                    ${(item.dp || 0) > 0 ? `
                                    <tr>
                                        <td class="p-4px-8px text-right">Uang Muka (DP)</td>
                                        <td class="p-4px-8px text-right">- ${formatRupiah(item.dp)}</td>
                                    </tr>
                                    <tr>
                                        <td class="p-4px-8px text-right"><strong>Sisa Tagihan</strong></td>
                                        <td class="p-4px-8px text-right"><strong>${formatRupiah(item.total - item.dp)}</strong></td>
                                    </tr>
                                    ` : ''}
                                </table>
                            </td>
                        </tr>
                    </table>

                    <!-- TERBILANG -->
                    <div class="invoice-terbilang-box">
                        Terbilang: # ${terbilangRupiah(Number(item.total) || 0)} #
                    </div>

                    <!-- INFO PEMBAYARAN -->
                    <div class="invoice-payment-info">
                        Pembayaran mohon di transfer ke rekening <strong>BANK BCA No. Rek: 2803024545</strong> a.n <strong>PT. SUMBER GANDA MEKAR</strong>
                    </div>

                    <!-- TANDA TANGAN -->
                    <table class="invoice-signature-table">
                        <tr>
                            <td class="w-50pct text-center align-top">
                                <div>Penerima,</div>
                                <div class="invoice-spacer-60"></div>
                                <div class="invoice-signature-line"></div>
                            </td>
                            <td class="w-50pct text-center align-top">
                                <div>Hormat Kami,</div>
                                <div class="invoice-spacer-60"></div>
                                <div class="invoice-signature-line"></div>
                            </td>
                        </tr>
                    </table>
                </div>
            `;

            const fakturContent = document.getElementById('fakturContent');
            if (fakturContent) {
                fakturContent.innerHTML = html;
            }
        }

        function generateFakturDotMatrix(data, type) {
            currentFakturMode = 'dotmatrix';
            // Clone item and fix PPN type for display if needed
            const item = { ...data };

            // Recalculate PPN if needed (for old data or missing values)
            if (item.detailBarang && item.detailBarang.length > 0) {
                let hasPpn11 = false;
                let hasPpn1 = false;
                let hasDibebaskan = false;
                let calculatedPpn = 0;

                item.detailBarang.forEach(b => {
                    if (b.ppn === 'ppn11') hasPpn11 = true;
                    else if (b.ppn === 'ppn1') hasPpn1 = true;
                    else if (b.ppn === 'dibebaskan') hasDibebaskan = true;

                    // Calculate PPN per item if not present in transaction total
                    if (b.subtotal && b.qty && b.harga) {
                        const dpp = (b.qty * b.harga) - (b.diskon || 0);
                        const itemSubtotal = b.subtotal;
                        // PPN is difference between subtotal and DPP
                        if (itemSubtotal > dpp) {
                            calculatedPpn += (itemSubtotal - dpp);
                        }
                    }
                });

                // Update jenisPpn based on content if currently nonppn
                if (item.jenisPpn === 'nonppn' || !item.jenisPpn) {
                    if (hasPpn11) item.jenisPpn = 'ppn11';
                    else if (hasPpn1) item.jenisPpn = 'ppn1';
                    else if (hasDibebaskan) item.jenisPpn = 'dibebaskan';
                }

                // Update nilaiPpn if 0 but we found PPN in items
                if ((!item.nilaiPpn || item.nilaiPpn === 0) && calculatedPpn > 0) {
                    item.nilaiPpn = calculatedPpn;
                }
            }

            const isPenjualan = type === 'penjualan';
            const dibayar = item.dibayar !== undefined ? item.dibayar : (item.total || 0);
            const dp = item.dp || 0;
            const sisa = item.sisa !== undefined ? item.sisa : (item.total - dp - dibayar);
            const statusText = sisa <= 0 ? 'LUNAS' : 'BELUM LUNAS';
            const metodeBayar = item.metodeBayar === 'kredit' ? 'Transfer' : 'Tunai';

            // Logo SGM dari file lokal
            const logoSGM = 'logo sgm.jpg';

            const html = `
                <div class="invoice-box invoice-box-dotmatrix">
                    
                    <!-- HEADER -->
                    <table class="invoice-header-table">
                        <tr>
                            <td class="w-70pct align-top">
                                <div class="invoice-company-desc">
                                    <strong class="invoice-company-name">PT. SUMBER GANDA MEKAR</strong><br>
                                    <strong>JUAL BELI BESI TUA/BARU - RANGKA BETON/LOGAM - TIANG<br>
                                    LISTRIK/TELP - KONSTRUKSI BAJA DAN PAKAN TERNAK</strong><br>
                                    Jl. Raya Gedebage No. 95 Bandung<br>
                                    CP. Irwan : 082117800626, CP. Uwem : 082318188863
                                </div>
                            </td>
                            <td class="w-30pct align-top text-right">
                                <!-- Logo hidden for dot matrix -->
                                <div class="invoice-meta">
                                    ${new Date().toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' })}, ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}<br>
                                    Sistem Akuntansi SGM
                                </div>
                            </td>
                        </tr>
                    </table>

                    <div class="invoice-divider"></div>

                    <!-- JUDUL -->
                    <div class="invoice-title-container">
                        <div class="invoice-title-box">
                            <strong class="invoice-title-text">${isPenjualan ? 'INVOICE PENJUALAN' : 'INVOICE PEMBELIAN'}</strong>
                        </div>
                    </div>

                    <!-- INFO BOX -->
                    <div class="invoice-info-box">
                        <table class="invoice-info-table">
                            <tr>
                                <td class="w-50pct align-top">
                                    <table class="w-100pct">
                                        <tr>
                                            <td class="p-2px-0 w-80px">Kepada Yth.</td>
                                            <td class="p-2px-0">: <strong>${isPenjualan ? (item.namaPelanggan || item.pelanggan || '-') : (item.namaSupplier || item.supplier || '-')}</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0 align-top">Alamat</td>
                                            <td class="p-2px-0">: ${isPenjualan ? (item.alamatPelanggan || '-') : (item.alamatSupplier || '-')}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0">Telepon</td>
                                            <td class="p-2px-0">: ${isPenjualan ? (item.teleponPelanggan || '-') : (item.teleponSupplier || '-')}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0">NPWP/NIK</td>
                                            <td class="p-2px-0">: ${isPenjualan ? (item.npwpPelanggan || '-') : (item.npwpSupplier || '-')}</td>
                                        </tr>
                                    </table>
                                </td>
                                <td class="w-50pct align-top pl-20px">
                                    <table class="w-100pct">
                                        <tr>
                                            <td class="p-2px-0 w-120px">No. Invoice</td>
                                            <td class="p-2px-0">: <strong>${item.noFaktur}</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0">Tanggal</td>
                                            <td class="p-2px-0">: ${formatTanggal(item.tanggal)}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0">Metode</td>
                                            <td class="p-2px-0">: ${metodeBayar}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-2px-0">Pembayaran</td>
                                            <td class="p-2px-0"></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- TABEL BARANG -->
                    <table class="invoice-items-table">
                        <thead>
                            <tr>
                                <th class="invoice-items-th w-30px">No</th>
                                <th class="invoice-items-th-left">Nama Barang</th>
                                <th class="invoice-items-th w-60px">Qty</th>
                                <th class="invoice-items-th w-60px">Satuan</th>
                                <th class="invoice-items-th-right w-110px">Harga Satuan</th>
                                <th class="invoice-items-th-right w-130px">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(item.detailBarang && item.detailBarang.length > 0) ? item.detailBarang.map((barang, index) => `
                            <tr>
                                <td class="invoice-items-td-center">${index + 1}</td>
                                <td class="invoice-items-td">${barang.nama || barang.namaBarang || '-'}</td>
                                <td class="invoice-items-td-center">${barang.qty}</td>
                                <td class="invoice-items-td-center">${barang.satuan || 'Kg'}</td>
                                <td class="invoice-items-td-right">${formatRupiah(barang.harga)}</td>
                                <td class="invoice-items-td-right"><strong>${formatRupiah(barang.subtotal)}</strong></td>
                            </tr>
                            `).join('') : `
                            <tr>
                                <td class="invoice-items-td-center">1</td>
                                <td class="invoice-items-td">${item.namaBarang || item.barang || '-'}</td>
                                <td class="invoice-items-td-center">${item.qty}</td>
                                <td class="invoice-items-td-center">Kg</td>
                                <td class="invoice-items-td-right">${formatRupiah(item.harga)}</td>
                                <td class="invoice-items-td-right"><strong>${formatRupiah(item.subtotal || (item.qty * item.harga))}</strong></td>
                            </tr>
                            `}
                        </tbody>
                    </table>

                    <!-- TOTAL SECTION -->
                    <table class="invoice-summary-table">
                        <tr>
                            <td class="w-55pct"></td>
                            <td class="w-45pct">
                                <table class="w-100pct">
                                    <tr>
                                        <td class="p-4px-8px text-right">Subtotal</td>
                                        <td class="p-4px-8px text-right w-130px">${formatRupiah(item.subtotal || item.total)}</td>
                                    </tr>
                                    ${(item.diskon || item.nilaiDiskon || 0) > 0 ? `
                                    <tr>
                                        <td class="p-4px-8px text-right">Diskon</td>
                                        <td class="p-4px-8px text-right">- ${formatRupiah(item.diskon || item.nilaiDiskon || 0)}</td>
                                    </tr>
                                    ` : ''}
                                    ${(item.jenisPpn === 'ppn11' || item.jenisPpn === 'ppn1' || item.jenisPpn === 'dibebaskan' || (item.nilaiPpn || 0) > 0) ? `
                                    <tr>
                                        <td class="p-4px-8px text-right">
                                            ${item.jenisPpn === 'ppn11' ? 'PPN 11%' :
                        item.jenisPpn === 'ppn1' ? 'PPN 1.1%' :
                            item.jenisPpn === 'dibebaskan' ? 'PPN (Dibebaskan)' :
                                'PPN'}
                                        </td>
                                        <td class="p-4px-8px text-right">${formatRupiah(item.nilaiPpn || 0)}</td>
                                    </tr>
                                    ` : ''}
                                    <tr class="border-top-black">
                                        <td class="p-6px-8px text-right"><strong>Total Tagihan</strong></td>
                                        <td class="p-6px-8px text-right"><strong>${formatRupiah(item.total)}</strong></td>
                                    </tr>
                                    ${(item.dp || 0) > 0 ? `
                                    <tr>
                                        <td class="p-4px-8px text-right">Uang Muka (DP)</td>
                                        <td class="p-4px-8px text-right">- ${formatRupiah(item.dp)}</td>
                                    </tr>
                                    <tr>
                                        <td class="p-4px-8px text-right"><strong>Sisa Tagihan</strong></td>
                                        <td class="p-4px-8px text-right"><strong>${formatRupiah(item.total - item.dp)}</strong></td>
                                    </tr>
                                    ` : ''}
                                </table>
                            </td>
                        </tr>
                    </table>

                    <!-- TERBILANG -->
                    <div class="invoice-terbilang-box">
                        Terbilang: # ${terbilangRupiah(Number(item.total) || 0)} #
                    </div>

                    <!-- INFO PEMBAYARAN -->
                    <div class="invoice-payment-info">
                        Pembayaran mohon di transfer ke rekening <strong>BANK BCA No. Rek: 2803024545</strong> a.n <strong>PT. SUMBER GANDA MEKAR</strong>
                    </div>

                    <!-- TANDA TANGAN -->
                    <table class="invoice-signature-table">
                        <tr>
                            <td class="w-50pct text-center align-top">
                                <div>Penerima,</div>
                                <div class="invoice-spacer-60"></div>
                                <div class="invoice-signature-line"></div>
                            </td>
                            <td class="w-50pct text-center align-top">
                                <div>Hormat Kami,</div>
                                <div class="invoice-spacer-60"></div>
                                <div class="invoice-signature-line"></div>
                            </td>
                        </tr>
                    </table>
                </div>
            `;

            const fakturContent = document.getElementById('fakturContent');
            if (fakturContent) {
                fakturContent.innerHTML = html;
            }
        }

        function printPDF() {
            if (currentFakturData) {
                generateFakturPDF(currentFakturData, currentFakturData.type);
                document.body.classList.add('printing-faktur');
                setTimeout(() => {
                    window.print();
                    document.body.classList.remove('printing-faktur');
                }, 300);
            }
        }

        function printDotMatrix() {
            if (currentFakturData) {
                generateFakturDotMatrix(currentFakturData, currentFakturData.type);
                document.body.classList.add('printing-faktur');
                setTimeout(() => {
                    window.print();
                    document.body.classList.remove('printing-faktur');
                }, 300);
            }
        }

        // ========== FUNGSI LAPORAN DIVISI ==========

        function setDefaultDatesDivisi() {
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            const todayFormatted = `${dd}/${mm}/${yyyy}`;

            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            const dd1 = String(startOfMonth.getDate()).padStart(2, '0');
            const mm1 = String(startOfMonth.getMonth() + 1).padStart(2, '0');
            const yyyy1 = startOfMonth.getFullYear();
            const startFormatted = `${dd1}/${mm1}/${yyyy1}`;

            if (document.getElementById('filterDivisiMulai').value === '') {
                document.getElementById('filterDivisiMulai').value = startFormatted;
            }
            if (document.getElementById('filterDivisiSelesai').value === '') {
                document.getElementById('filterDivisiSelesai').value = todayFormatted;
            }
        }

        function updateLaporanDivisi() {
            const divisi = document.getElementById('filterDivisi').value;
            const tglMulai = convertToISODate(document.getElementById('filterDivisiMulai').value);
            const tglSelesai = convertToISODate(document.getElementById('filterDivisiSelesai').value);

            // Filter data berdasarkan divisi dan tanggal
            let penjualanFiltered = dataPenjualan;
            let pembelianFiltered = dataPembelian;

            if (tglMulai && tglSelesai) {
                penjualanFiltered = penjualanFiltered.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
                pembelianFiltered = pembelianFiltered.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
            }

            // Hitung per divisi
            const divisiList = ['Angkutan', 'Besi', 'Pakan'];

            divisiList.forEach(div => {
                const penjualanDiv = penjualanFiltered.filter(p => p.divisi === div);
                const pembelianDiv = pembelianFiltered.filter(p => p.divisi === div);

                const pendapatan = penjualanDiv.reduce((sum, item) => sum + item.total, 0);
                const beban = pembelianDiv.reduce((sum, item) => sum + item.total, 0);
                const laba = pendapatan - beban;

                const divName = div.toLowerCase();
                const divNameCap = div.charAt(0).toUpperCase() + div.slice(1);

                document.getElementById(`pendapatan${divNameCap}`).textContent = formatRupiah(pendapatan);
                document.getElementById(`beban${divNameCap}`).textContent = formatRupiah(beban);
                document.getElementById(`laba${divNameCap}Value`).textContent = formatRupiah(laba);

                // Update card color
                const cardLaba = document.getElementById(`laba${divNameCap}`);
                if (laba >= 0) {
                    cardLaba.className = 'card success';
                } else {
                    cardLaba.className = 'card danger';
                }
            });

            // Display detail transaksi
            displayDetailDivisi(divisi, penjualanFiltered, pembelianFiltered);
        }

        function displayDetailDivisi(divisi, penjualanData, pembelianData) {
            const tbody = document.getElementById('bodyLaporanDivisi');
            let html = '';
            let totalPendapatan = 0;
            let totalBeban = 0;
            let no = 1;

            // Filter berdasarkan divisi
            if (divisi !== 'semua') {
                penjualanData = penjualanData.filter(p => p.divisi === divisi);
                pembelianData = pembelianData.filter(p => p.divisi === divisi);
            }

            // Gabungkan data penjualan dan pembelian
            const allData = [];

            penjualanData.forEach(item => {
                // Ambil nama barang dari detailBarang
                let namaBarang = '-';
                if (item.detailBarang && item.detailBarang.length > 0) {
                    namaBarang = item.detailBarang.map(b => b.nama).join(', ');
                }
                allData.push({
                    divisi: item.divisi,
                    tanggal: item.tanggal,
                    noRef: item.noFaktur,
                    jenis: 'Penjualan',
                    keterangan: `${item.namaPelanggan || '-'} - ${namaBarang}`,
                    pendapatan: item.total,
                    beban: 0
                });
            });

            pembelianData.forEach(item => {
                // Ambil nama barang dari detailBarang
                let namaBarang = '-';
                if (item.detailBarang && item.detailBarang.length > 0) {
                    namaBarang = item.detailBarang.map(b => b.nama).join(', ');
                }
                allData.push({
                    divisi: item.divisi,
                    tanggal: item.tanggal,
                    noRef: item.noFaktur,
                    jenis: 'Pembelian',
                    keterangan: `${item.namaSupplier || '-'} - ${namaBarang}`,
                    pendapatan: 0,
                    beban: item.total
                });
            });

            // Sort by date
            allData.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

            if (allData.length === 0) {
                html = '<tr><td colspan="8" class="center">Tidak ada data untuk ditampilkan</td></tr>';
            } else {
                allData.forEach(item => {
                    totalPendapatan += item.pendapatan;
                    totalBeban += item.beban;

                    const divisiIcon = item.divisi === 'Angkutan' ? '🚛' : item.divisi === 'Besi' ? '🔩' : '🌾';
                    const jenisBadge = item.jenis === 'Penjualan' ?
                        '<span class="badge badge-lunas">💰 JUAL</span>' :
                        '<span class="badge badge-belum">🛒 BELI</span>';

                    html += `
                        <tr>
                            <td class="center">${no++}</td>
                            <td>${divisiIcon} ${item.divisi}</td>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td>${item.noRef}</td>
                            <td class="center">${jenisBadge}</td>
                            <td>${item.keterangan}</td>
                            <td class="number">${item.pendapatan > 0 ? formatRupiah(item.pendapatan) : '-'}</td>
                            <td class="number">${item.beban > 0 ? formatRupiah(item.beban) : '-'}</td>
                        </tr>
                    `;
                });
            }

            tbody.innerHTML = html;
            document.getElementById('totalPendapatanDivisi').textContent = formatRupiah(totalPendapatan);
            document.getElementById('totalBebanDivisi').textContent = formatRupiah(totalBeban);
            document.getElementById('totalLabaDivisi').textContent = formatRupiah(totalPendapatan - totalBeban);
        }

        // ========== FUNGSI LAPORAN NON PPN ==========

        function setDefaultDatesNonPPN() {
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            const todayFormatted = `${dd}/${mm}/${yyyy}`;

            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            const dd1 = String(startOfMonth.getDate()).padStart(2, '0');
            const mm1 = String(startOfMonth.getMonth() + 1).padStart(2, '0');
            const yyyy1 = startOfMonth.getFullYear();
            const startFormatted = `${dd1}/${mm1}/${yyyy1}`;

            if (document.getElementById('filterNonPpnMulai').value === '') {
                document.getElementById('filterNonPpnMulai').value = startFormatted;
            }
            if (document.getElementById('filterNonPpnSelesai').value === '') {
                document.getElementById('filterNonPpnSelesai').value = todayFormatted;
            }
        }

        function displayLaporanNonPPN() {
            const kategoriPPN = document.getElementById('filterKategoriPPN').value;
            const jenis = document.getElementById('filterJenisNonPpn').value;
            const tglMulai = convertToISODate(document.getElementById('filterNonPpnMulai').value);
            const tglSelesai = convertToISODate(document.getElementById('filterNonPpnSelesai').value);

            // Update label cards dan headers berdasarkan kategori PPN
            const labelMap = {
                'nonppn': 'Non PPN',
                'ppn11': 'PPN 11%',
                'ppn1': 'PPN 1.1%',
                'dibebaskan': 'PPN Dibebaskan'
            };
            const labelPPN = labelMap[kategoriPPN] || 'Non PPN';

            document.getElementById('labelPenjualanPPN').textContent = `Total Penjualan ${labelPPN}`;
            document.getElementById('labelPembelianPPN').textContent = `Total Pembelian ${labelPPN}`;
            document.getElementById('headerPenjualanPPN').textContent = `💰 Data Penjualan ${labelPPN}`;

            // Update header pembelian jika ada
            const headerPembelianEl = document.getElementById('headerPembelianPPN');
            if (headerPembelianEl) {
                headerPembelianEl.textContent = `🛒 Data Pembelian ${labelPPN}`;
            }

            // Filter data berdasarkan kategori PPN dari detailBarang
            // Transaksi termasuk jika ada minimal 1 barang dengan jenis PPN yang sesuai
            let penjualanFiltered = dataPenjualan.filter(p => {
                if (p.detailBarang && p.detailBarang.length > 0) {
                    return p.detailBarang.some(b => b.ppn === kategoriPPN);
                }
                return p.jenisPpn === kategoriPPN; // fallback untuk data lama
            });
            let pembelianFiltered = dataPembelian.filter(p => {
                if (p.detailBarang && p.detailBarang.length > 0) {
                    return p.detailBarang.some(b => b.ppn === kategoriPPN);
                }
                return p.jenisPpn === kategoriPPN; // fallback untuk data lama
            });

            // Filter by date
            if (tglMulai && tglSelesai) {
                penjualanFiltered = penjualanFiltered.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
                pembelianFiltered = pembelianFiltered.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
            }

            // Calculate totals - hitung dari detail barang yang sesuai PPN
            let totalPenjualan = 0;
            penjualanFiltered.forEach(p => {
                if (p.detailBarang && p.detailBarang.length > 0) {
                    p.detailBarang.forEach(b => {
                        if (b.ppn === kategoriPPN) {
                            totalPenjualan += b.subtotal;
                        }
                    });
                } else {
                    totalPenjualan += p.total;
                }
            });

            let totalPembelian = 0;
            pembelianFiltered.forEach(p => {
                if (p.detailBarang && p.detailBarang.length > 0) {
                    p.detailBarang.forEach(b => {
                        if (b.ppn === kategoriPPN) {
                            totalPembelian += b.subtotal;
                        }
                    });
                } else {
                    totalPembelian += p.total;
                }
            });

            const selisih = totalPenjualan - totalPembelian;

            // Update summary cards
            document.getElementById('totalPenjualanNonPPN').textContent = formatRupiah(totalPenjualan);
            document.getElementById('countPenjualanNonPPN').textContent = `${penjualanFiltered.length} transaksi`;
            document.getElementById('totalPembelianNonPPN').textContent = formatRupiah(totalPembelian);
            document.getElementById('countPembelianNonPPN').textContent = `${pembelianFiltered.length} transaksi`;
            document.getElementById('selisihNonPPN').textContent = formatRupiah(selisih);

            // Display tables based on selected type
            if (jenis === 'semua' || jenis === 'penjualan') {
                displayPenjualanNonPPNTable(penjualanFiltered, kategoriPPN);
            } else {
                document.getElementById('bodyPenjualanNonPPN').innerHTML = '<tr><td colspan="9" class="center">Pilih "Semua" atau "Penjualan Saja" untuk melihat data</td></tr>';
                document.getElementById('footerTotalPenjualanNonPPN').textContent = 'Rp 0';
            }

            if (jenis === 'semua' || jenis === 'pembelian') {
                displayPembelianNonPPNTable(pembelianFiltered, kategoriPPN);
            } else {
                document.getElementById('bodyPembelianNonPPN').innerHTML = '<tr><td colspan="9" class="center">Pilih "Semua" atau "Pembelian Saja" untuk melihat data</td></tr>';
                document.getElementById('footerTotalPembelianNonPPN').textContent = 'Rp 0';
            }
        }

        function displayPenjualanNonPPNTable(data, kategoriPPN) {
            const tbody = document.getElementById('bodyPenjualanNonPPN');
            let html = '';
            let total = 0;
            let rowNum = 1;

            if (data.length === 0) {
                html = '<tr><td colspan="9" class="center">Tidak ada data penjualan untuk kategori PPN ini</td></tr>';
            } else {
                data.forEach((item) => {
                    const divisiIcon = item.divisi === 'Angkutan' ? '🚛' : item.divisi === 'Besi' ? '🔩' : '🌾';

                    // Tampilkan per barang dari detailBarang
                    if (item.detailBarang && item.detailBarang.length > 0) {
                        item.detailBarang.forEach(barang => {
                            // Filter hanya barang dengan PPN yang sesuai
                            if (barang.ppn === kategoriPPN) {
                                total += barang.subtotal;
                                html += `
                                    <tr>
                                        <td class="center">${rowNum++}</td>
                                        <td>${formatTanggal(item.tanggal)}</td>
                                        <td>${divisiIcon} ${item.divisi || '-'}</td>
                                        <td>${item.noFaktur}</td>
                                        <td>${item.namaPelanggan || '-'}</td>
                                        <td>${barang.nama || '-'}</td>
                                        <td class="number">${barang.qty || 0}</td>
                                        <td class="number">${formatRupiah(barang.harga || 0)}</td>
                                        <td class="number">${formatRupiah(barang.subtotal || 0)}</td>
                                    </tr>
                                `;
                            }
                        });
                    }
                });
            }

            if (html === '') {
                html = '<tr><td colspan="9" class="center">Tidak ada data penjualan untuk kategori PPN ini</td></tr>';
            }

            tbody.innerHTML = html;
            document.getElementById('footerTotalPenjualanNonPPN').textContent = formatRupiah(total);
        }

        function displayPembelianNonPPNTable(data, kategoriPPN) {
            const tbody = document.getElementById('bodyPembelianNonPPN');
            let html = '';
            let total = 0;
            let rowNum = 1;

            if (data.length === 0) {
                html = '<tr><td colspan="9" class="center">Tidak ada data pembelian untuk kategori PPN ini</td></tr>';
            } else {
                data.forEach((item) => {
                    const divisiIcon = item.divisi === 'Angkutan' ? '🚛' : item.divisi === 'Besi' ? '🔩' : '🌾';

                    // Tampilkan per barang dari detailBarang
                    if (item.detailBarang && item.detailBarang.length > 0) {
                        item.detailBarang.forEach(barang => {
                            // Filter hanya barang dengan PPN yang sesuai
                            if (barang.ppn === kategoriPPN) {
                                total += barang.subtotal;
                                html += `
                                    <tr>
                                        <td class="center">${rowNum++}</td>
                                        <td>${formatTanggal(item.tanggal)}</td>
                                        <td>${divisiIcon} ${item.divisi || '-'}</td>
                                        <td>${item.noFaktur}</td>
                                        <td>${item.namaSupplier || '-'}</td>
                                        <td>${barang.nama || '-'}</td>
                                        <td class="number">${barang.qty || 0}</td>
                                        <td class="number">${formatRupiah(barang.harga || 0)}</td>
                                        <td class="number">${formatRupiah(barang.subtotal || 0)}</td>
                                    </tr>
                                `;
                            }
                        });
                    }
                });
            }

            if (html === '') {
                html = '<tr><td colspan="9" class="center">Tidak ada data pembelian untuk kategori PPN ini</td></tr>';
            }

            tbody.innerHTML = html;
            document.getElementById('footerTotalPembelianNonPPN').textContent = formatRupiah(total);
        }

        // ========== FUNGSI PEMBAYARAN ==========

        // Bayar Piutang
        function bayarPiutang(id) {
            const item = dataPenjualan.find(p => p.id === id);
            if (item) {
                let dibayar = item.dibayar || 0;
                const dp = item.dp || 0;
                const total = item.total || 0;
                const storedSisa = item.sisa;

                // Sisa-Based Heuristic for Legacy Data
                if (item.metodeBayar === 'kredit' && dp > 0 && storedSisa !== undefined) {
                    // Case A: DP detached from dibayar but accounted in Sisa
                    if (Math.abs((storedSisa + dibayar + dp) - total) < 50) {
                        dibayar += dp;
                    }
                    // Case B: DP ignored completely
                    else if (Math.abs((storedSisa + dibayar) - total) < 50) {
                        if (dibayar < dp) {
                            dibayar += dp;
                        }
                    }
                }

                const sisa = item.total - dibayar;

                document.getElementById('bayarIdPiutang').value = item.id;
                document.getElementById('bayarTipePiutang').value = 'transaksi';
                document.getElementById('bayarNoFakturPiutang').value = item.noFaktur;
                document.getElementById('bayarNamaPelanggan').value = item.namaPelanggan || item.pelanggan || '-';
                document.getElementById('bayarTotalPiutang').value = formatRupiah(item.total);
                document.getElementById('bayarSudahBayar').value = formatRupiah(dibayar);
                document.getElementById('bayarSisaPiutang').value = formatRupiah(sisa);

                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const yyyy = today.getFullYear();
                document.getElementById('bayarTglPiutang').value = `${dd}/${mm}/${yyyy}`;

                document.getElementById('bayarJumlahPiutang').value = '';
                document.getElementById('bayarJumlahPiutang').max = sisa;

                openModal('modalBayarPiutang');
            }
        }

        // Submit Bayar Piutang
        document.getElementById('formBayarPiutang').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('bayarIdPiutang').value);
            const tipe = document.getElementById('bayarTipePiutang').value;
            const jumlahBayar = parseFloat(document.getElementById('bayarJumlahPiutang').value);
            const metode = document.getElementById('bayarMetodePiutang').value;

            // Parse Tanggal (DD/MM/YYYY -> YYYY-MM-DD)
            const tglInput = document.getElementById('bayarTglPiutang').value;
            const tglParts = tglInput.split('/');
            if (tglParts.length !== 3) {
                alert('Format tanggal salah! Gunakan DD/MM/YYYY');
                return;
            }
            const tglBayar = `${tglParts[2]}-${tglParts[1]}-${tglParts[0]}`;

            if (tipe === 'saldo_awal') {
                const index = dataPiutangAwal.findIndex(p => p.id === id);
                if (index !== -1) {
                    const item = dataPiutangAwal[index];
                    const sisaSebelum = item.total - (item.dibayar || 0);

                    if (jumlahBayar > sisaSebelum) {
                        alert('Jumlah bayar melebihi sisa piutang!');
                        return;
                    }

                    // Update pembayaran
                    dataPiutangAwal[index].dibayar = (item.dibayar || 0) + jumlahBayar;

                    // Buat jurnal pembayaran
                    const jurnal = {
                        id: Date.now(),
                        tanggal: tglBayar,
                        noRef: `BPA-${id}`,
                        divisi: item.divisi,
                        keterangan: `Pembayaran piutang awal - ${item.namaPelanggan} (${metode})`,
                        entries: [
                            { akun: 'Kas', debit: jumlahBayar, kredit: 0 },
                            { akun: 'Piutang Usaha', debit: 0, kredit: jumlahBayar }
                        ]
                    };
                    dataJurnal.push(jurnal);

                    // Catat ke Kas Harian
                    const kasMasuk = {
                        id: Date.now() + 1,
                        tanggal: tglBayar,
                        jenis: 'masuk',
                        kategori: 'Pelunasan Piutang',
                        keterangan: `Pembayaran piutang awal - ${item.namaPelanggan} (${metode})`,
                        jumlah: jumlahBayar
                    };
                    dataKasHarian.push(kasMasuk);

                    saveDataToStorage();
                    displayPiutang();
                    displayJurnal();
                    displayKasHarian();
                    closeModal('modalBayarPiutang');
                    alert('Pembayaran piutang awal berhasil dicatat!');
                }
            } else {
                const index = dataPenjualan.findIndex(p => p.id === id);
                if (index !== -1) {
                    const item = dataPenjualan[index];
                    // Fix logic: check if dibayar needs to include dp (for old records)
                    let currentDibayar = item.dibayar || 0;
                    if (currentDibayar === 0 && item.dp > 0 && item.metodeBayar === 'kredit') {
                        currentDibayar = item.dp;
                    }

                    const sisaSebelum = item.total - currentDibayar;

                    if (jumlahBayar > sisaSebelum) {
                        alert('Jumlah bayar melebihi sisa piutang!');
                        return;
                    }

                    // Update pembayaran
                    dataPenjualan[index].dibayar = currentDibayar + jumlahBayar;
                    dataPenjualan[index].sisa = item.total - dataPenjualan[index].dibayar;

                    // Catat pembayaran
                    const pembayaran = {
                        id: Date.now(),
                        tanggal: tglBayar,
                        noFaktur: item.noFaktur,
                        pelanggan: item.namaPelanggan || item.pelanggan || '-',
                        jumlah: jumlahBayar,
                        metode: metode
                    };
                    dataPembayaranPiutang.push(pembayaran);

                    // Buat jurnal pembayaran piutang
                    const jurnal = {
                        id: Date.now(),
                        tanggal: tglBayar,
                        noRef: `BP-${item.noFaktur}`,
                        keterangan: `Pembayaran piutang ${item.namaPelanggan || item.pelanggan || '-'} - ${item.noFaktur} (${metode})`,
                        entries: [
                            { akun: 'Kas', debit: jumlahBayar, kredit: 0 },
                            { akun: 'Piutang Usaha', debit: 0, kredit: jumlahBayar }
                        ]
                    };
                    dataJurnal.push(jurnal);

                    // Catat ke Kas Harian
                    const kasMasuk = {
                        id: Date.now() + 1,
                        tanggal: tglBayar,
                        divisi: item.divisi,
                        jenis: 'masuk',
                        kategori: 'Pelunasan Piutang',
                        keterangan: `Pembayaran piutang ${item.namaPelanggan || item.pelanggan || '-'} - ${item.noFaktur} (${metode})`,
                        jumlah: jumlahBayar
                    };
                    dataKasHarian.push(kasMasuk);

                    saveDataToStorage();
                    displayPenjualan();
                    displayPiutang();
                    displayJurnal();
                    displayKasHarian();
                    closeModal('modalBayarPiutang');
                    alert('Pembayaran piutang berhasil dicatat!');
                }
            }
        });

        // Bayar Hutang
        function bayarHutang(id) {
            const item = dataPembelian.find(p => p.id === id);
            if (item) {
                let dibayar = item.dibayar || 0;
                const dp = item.dp || 0;
                const total = item.total || 0;
                const storedSisa = item.sisa;

                // Sisa-Based Heuristic for Legacy Data
                if (item.metodeBayar === 'kredit' && dp > 0 && storedSisa !== undefined) {
                    // Case A: DP detached from dibayar but accounted in Sisa
                    if (Math.abs((storedSisa + dibayar + dp) - total) < 50) {
                        dibayar += dp;
                    }
                    // Case B: DP ignored completely
                    else if (Math.abs((storedSisa + dibayar) - total) < 50) {
                        if (dibayar < dp) {
                            dibayar += dp;
                        }
                    }
                }

                const sisa = item.total - dibayar;

                document.getElementById('bayarIdHutang').value = item.id;
                document.getElementById('bayarTipeHutang').value = 'transaksi';
                document.getElementById('bayarNoFakturHutang').value = item.noFaktur;
                document.getElementById('bayarNamaSupplier').value = item.namaSupplier || item.supplier || '-';
                document.getElementById('bayarDivisiHutang').value = item.divisi || '-';
                document.getElementById('bayarTotalHutang').value = formatRupiah(item.total);
                document.getElementById('bayarSudahBayarHutang').value = formatRupiah(dibayar);
                document.getElementById('bayarSisaHutang').value = formatRupiah(sisa);

                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const yyyy = today.getFullYear();
                document.getElementById('bayarTglHutang').value = `${dd}/${mm}/${yyyy}`;

                document.getElementById('bayarJumlahHutang').value = '';
                document.getElementById('bayarJumlahHutang').max = sisa;

                openModal('modalBayarHutang');
            }
        }

        // Submit Bayar Hutang
        document.getElementById('formBayarHutang').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('bayarIdHutang').value);
            const tipe = document.getElementById('bayarTipeHutang').value;
            const jumlahBayar = parseFloat(document.getElementById('bayarJumlahHutang').value);
            const metode = document.getElementById('bayarMetodeHutang').value;

            // Parse Tanggal (DD/MM/YYYY -> YYYY-MM-DD)
            const tglInput = document.getElementById('bayarTglHutang').value;
            const tglParts = tglInput.split('/');
            if (tglParts.length !== 3) {
                alert('Format tanggal salah! Gunakan DD/MM/YYYY');
                return;
            }
            const tglBayar = `${tglParts[2]}-${tglParts[1]}-${tglParts[0]}`;

            if (tipe === 'saldo_awal') {
                const index = dataHutangAwal.findIndex(h => h.id === id);
                if (index !== -1) {
                    const item = dataHutangAwal[index];
                    const sisaSebelum = item.total - (item.dibayar || 0);

                    if (jumlahBayar > sisaSebelum) {
                        alert('Jumlah bayar melebihi sisa hutang!');
                        return;
                    }

                    // Update pembayaran
                    dataHutangAwal[index].dibayar = (item.dibayar || 0) + jumlahBayar;

                    // Buat jurnal pembayaran
                    const jurnal = {
                        id: Date.now(),
                        tanggal: tglBayar,
                        noRef: `BHA-${id}`,
                        divisi: item.divisi,
                        keterangan: `Pembayaran hutang awal - ${item.namaSupplier} (${metode})`,
                        entries: [
                            { akun: 'Hutang Usaha', debit: jumlahBayar, kredit: 0 },
                            { akun: 'Kas', debit: 0, kredit: jumlahBayar }
                        ]
                    };
                    dataJurnal.push(jurnal);

                    // Catat ke Kas Harian
                    const kasKeluar = {
                        id: Date.now() + 1,
                        tanggal: tglBayar,
                        jenis: 'keluar',
                        kategori: 'Bayar Hutang',
                        keterangan: `Pembayaran hutang awal - ${item.namaSupplier} (${metode})`,
                        jumlah: jumlahBayar
                    };
                    dataKasHarian.push(kasKeluar);

                    saveDataToStorage();
                    displayHutang();
                    displayJurnal();
                    displayKasHarian();
                    closeModal('modalBayarHutang');
                    alert('Pembayaran hutang awal berhasil dicatat!');
                }
            } else {
                const index = dataPembelian.findIndex(p => p.id === id);
                if (index !== -1) {
                    const item = dataPembelian[index];
                    // Fix logic: check if dibayar needs to include dp (for old records)
                    let currentDibayar = item.dibayar || 0;
                    if (currentDibayar === 0 && item.dp > 0 && item.metodeBayar === 'kredit') {
                        currentDibayar = item.dp;
                    }

                    const sisaSebelum = item.total - currentDibayar;

                    if (jumlahBayar > sisaSebelum) {
                        alert('Jumlah bayar melebihi sisa hutang!');
                        return;
                    }

                    // Update pembayaran
                    dataPembelian[index].dibayar = currentDibayar + jumlahBayar;
                    dataPembelian[index].sisa = item.total - dataPembelian[index].dibayar;

                    // Catat pembayaran
                    const pembayaran = {
                        id: Date.now(),
                        tanggal: tglBayar,
                        noFaktur: item.noFaktur,
                        supplier: item.namaSupplier || item.supplier || '-',
                        jumlah: jumlahBayar,
                        metode: metode
                    };
                    dataPembayaranHutang.push(pembayaran);

                    // Buat jurnal pembayaran hutang
                    const jurnal = {
                        id: Date.now(),
                        tanggal: tglBayar,
                        noRef: `BH-${item.noFaktur}`,
                        keterangan: `Pembayaran hutang ${item.namaSupplier || item.supplier || '-'} - ${item.noFaktur} (${metode})`,
                        entries: [
                            { akun: 'Hutang Usaha', debit: jumlahBayar, kredit: 0 },
                            { akun: 'Kas', debit: 0, kredit: jumlahBayar }
                        ]
                    };
                    dataJurnal.push(jurnal);

                    // Catat ke Kas Harian
                    const kasKeluar = {
                        id: Date.now() + 1,
                        tanggal: tglBayar,
                        divisi: item.divisi,
                        jenis: 'keluar',
                        kategori: 'Bayar Hutang',
                        keterangan: `Pembayaran hutang ${item.namaSupplier || item.supplier || '-'} - ${item.noFaktur} (${metode})`,
                        jumlah: jumlahBayar
                    };
                    dataKasHarian.push(kasKeluar);

                    saveDataToStorage();
                    displayPembelian();
                    displayHutang();
                    displayJurnal();
                    displayKasHarian();
                    closeModal('modalBayarHutang');
                    alert('Pembayaran hutang berhasil dicatat!');
                }
            }
        });

        // ========== FUNGSI PIUTANG/HUTANG AWAL ==========

        // Helper function to convert DD/MM/YYYY to YYYY-MM-DD
        function convertTanggalToISO(tgl) {
            if (!tgl) return '';
            const parts = tgl.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return tgl;
        }

        // Submit Piutang Awal
        function submitPiutangAwal(event) {
            event.preventDefault();

            const tanggalRaw = document.getElementById('tglPiutangAwal').value;
            const namaPelanggan = document.getElementById('namaPelangganPiutangAwal').value;
            const keterangan = document.getElementById('ketPiutangAwal').value;
            const totalStr = document.getElementById('jumlahPiutangAwal').value;
            const dibayarStr = document.getElementById('dibayarPiutangAwal').value;

            const tanggal = convertTanggalToISO(tanggalRaw);
            const total = parseRupiahValue(totalStr);
            const dibayar = parseRupiahValue(dibayarStr);

            if (!tanggal || !namaPelanggan || total <= 0) {
                alert('Lengkapi semua field yang wajib diisi!');
                return false;
            }

            const piutangAwal = {
                id: Date.now(),
                tanggal: tanggal,
                namaPelanggan: namaPelanggan,
                keterangan: keterangan || 'Saldo awal piutang',
                total: total,
                dibayar: dibayar
            };

            dataPiutangAwal.push(piutangAwal);
            saveDataToStorage();
            displayPiutang();

            // Reset form
            document.getElementById('formPiutangAwal').reset();
            alert('Piutang awal berhasil ditambahkan!');
            return false;
        }

        // Submit Hutang Awal
        function submitHutangAwal(event) {
            event.preventDefault();

            const tanggalRaw = document.getElementById('tglHutangAwal').value;
            const namaSupplier = document.getElementById('namaSupplierHutangAwal').value;
            const keterangan = document.getElementById('ketHutangAwal').value;
            const totalStr = document.getElementById('jumlahHutangAwal').value;
            const dibayarStr = document.getElementById('dibayarHutangAwal').value;

            const tanggal = convertTanggalToISO(tanggalRaw);
            const total = parseRupiahValue(totalStr);
            const dibayar = parseRupiahValue(dibayarStr);

            if (!tanggal || !namaSupplier || total <= 0) {
                alert('Lengkapi semua field yang wajib diisi!');
                return false;
            }

            const hutangAwal = {
                id: Date.now(),
                tanggal: tanggal,
                namaSupplier: namaSupplier,
                keterangan: keterangan || 'Saldo awal hutang',
                total: total,
                dibayar: dibayar
            };

            dataHutangAwal.push(hutangAwal);
            saveDataToStorage();
            displayHutang();

            // Reset form
            document.getElementById('formHutangAwal').reset();
            alert('Hutang awal berhasil ditambahkan!');
            return false;
        }

        // Bayar Piutang Awal
        function bayarPiutangAwal(id) {
            const item = dataPiutangAwal.find(p => p.id === id);
            if (item) {
                const dibayar = item.dibayar || 0;
                const sisa = item.total - dibayar;

                document.getElementById('bayarIdPiutang').value = item.id;
                document.getElementById('bayarTipePiutang').value = 'saldo_awal';
                document.getElementById('bayarNoFakturPiutang').value = 'SALDO AWAL';
                document.getElementById('bayarNamaPelanggan').value = item.namaPelanggan;
                document.getElementById('bayarTotalPiutang').value = formatRupiah(item.total);
                document.getElementById('bayarSudahBayar').value = formatRupiah(dibayar);
                document.getElementById('bayarSisaPiutang').value = formatRupiah(sisa);

                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const yyyy = today.getFullYear();
                document.getElementById('bayarTglPiutang').value = `${dd}/${mm}/${yyyy}`;

                document.getElementById('bayarJumlahPiutang').value = '';
                document.getElementById('bayarJumlahPiutang').max = sisa;

                openModal('modalBayarPiutang');
            }
        }

        // Bayar Hutang Awal
        function bayarHutangAwal(id) {
            const item = dataHutangAwal.find(h => h.id === id);
            if (item) {
                const dibayar = item.dibayar || 0;
                const sisa = item.total - dibayar;

                document.getElementById('bayarIdHutang').value = item.id;
                document.getElementById('bayarTipeHutang').value = 'saldo_awal';
                document.getElementById('bayarNoFakturHutang').value = 'SALDO AWAL';
                document.getElementById('bayarNamaSupplier').value = item.namaSupplier;
                document.getElementById('bayarDivisiHutang').value = item.divisi || '-';
                document.getElementById('bayarTotalHutang').value = formatRupiah(item.total);
                document.getElementById('bayarSudahBayarHutang').value = formatRupiah(dibayar);
                document.getElementById('bayarSisaHutang').value = formatRupiah(sisa);

                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const yyyy = today.getFullYear();
                document.getElementById('bayarTglHutang').value = `${dd}/${mm}/${yyyy}`;

                document.getElementById('bayarJumlahHutang').value = '';
                document.getElementById('bayarJumlahHutang').max = sisa;

                openModal('modalBayarHutang');
            }
        }

        // Hapus Piutang Awal
        function hapusPiutangAwal(id) {
            if (confirm('Apakah Anda yakin ingin menghapus piutang awal ini?')) {
                const index = dataPiutangAwal.findIndex(p => p.id === id);
                if (index !== -1) {
                    dataPiutangAwal.splice(index, 1);
                    saveDataToStorage();
                    displayPiutang();
                    alert('Piutang awal berhasil dihapus!');
                }
            }
        }

        // Hapus Hutang Awal
        function hapusHutangAwal(id) {
            if (confirm('Apakah Anda yakin ingin menghapus hutang awal ini?')) {
                const index = dataHutangAwal.findIndex(h => h.id === id);
                if (index !== -1) {
                    dataHutangAwal.splice(index, 1);
                    saveDataToStorage();
                    displayHutang();
                    alert('Hutang awal berhasil dihapus!');
                }
            }
        }

        // ========== FUNGSI EKSPOR EXCEL ==========

        function tableToExcel(tableId, filename) {
            const table = document.getElementById(tableId) || document.querySelector(`#${tableId.split(' ')[0]} table`);
            if (!table) {
                alert('Tabel tidak ditemukan!');
                return;
            }

            let html = table.outerHTML;
            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = filename + '.xls';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function eksporJurnalExcel() {
            const tglMulai = document.getElementById('filterJurnalMulai').value;
            const tglSelesai = document.getElementById('filterJurnalSelesai').value;
            const periode = tglMulai && tglSelesai ? `_${tglMulai}_${tglSelesai}` : '';

            // Buat tabel khusus untuk ekspor
            let html = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta http-equiv="content-type" content="text/plain; charset=UTF-8"/>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Laporan Jurnal</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <style>
                        .bg-purple-header { background-color: #667eea; color: white; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .p-10px { padding: 10px; }
                        th { background-color: #667eea; color: white; font-weight: bold; text-align: center; }
                        td { border: 1px solid #000; padding: 5px; vertical-align: top; }
                    </style>
                </head>
                <body>
                <table border="1">
                    <thead>
                        <tr class="bg-purple-header">
                            <th colspan="6" class="text-center p-10px">
                                LAPORAN JURNAL - PT. SUMBER GANDA MEKAR<br>
                                ${tglMulai && tglSelesai ? `Periode: ${formatTanggal(tglMulai)} s/d ${formatTanggal(tglSelesai)}` : 'Semua Periode'}
                            </th>
                        </tr>
                        <tr class="bg-purple-header">
                            <th>Tanggal</th>
                            <th>No. Ref</th>
                            <th>Keterangan</th>
                            <th>Akun</th>
                            <th>Debit</th>
                            <th>Kredit</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let jurnalData = [...dataJurnal];
            if (tglMulai && tglSelesai) {
                jurnalData = jurnalData.filter(j => j.tanggal >= tglMulai && j.tanggal <= tglSelesai);
            }

            jurnalData.forEach(jurnal => {
                jurnal.entries.forEach((entry, idx) => {
                    html += `<tr>`;
                    if (idx === 0) {
                        html += `
                            <td rowspan="${jurnal.entries.length}">${formatTanggal(jurnal.tanggal)}</td>
                            <td rowspan="${jurnal.entries.length}">${jurnal.noRef}</td>
                            <td rowspan="${jurnal.entries.length}">${jurnal.keterangan}</td>
                        `;
                    }
                    html += `
                        <td>${entry.akun}</td>
                        <td class="text-right">${entry.debit > 0 ? formatRupiah(entry.debit) : ''}</td>
                        <td class="text-right">${entry.kredit > 0 ? formatRupiah(entry.kredit) : ''}</td>
                    </tr>`;
                });
            });

            html += `</tbody></table></body></html>`;

            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = `Laporan_Jurnal${periode}.xls`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function eksporLabaRugiExcel() {
            const tglMulai = document.getElementById('filterLabaRugiMulai').value;
            const tglSelesai = document.getElementById('filterLabaRugiSelesai').value;
            const filterDivisi = document.getElementById('filterLabaRugiDivisi').value;
            const periode = tglMulai && tglSelesai ? `_${tglMulai}_${tglSelesai}` : '';

            let penjualan = [...dataPenjualan];
            let pembelian = [...dataPembelian];
            // Gunakan dataKasHarian (bukan dataTransaksiKas) agar sinkron dengan layar
            let kasKeluar = dataKasHarian.filter(k => k.jenis === 'keluar');
            let kasMasuk = dataKasHarian.filter(k => k.jenis === 'masuk');

            if (tglMulai && tglSelesai) {
                penjualan = penjualan.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
                pembelian = pembelian.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
                kasKeluar = kasKeluar.filter(k => k.tanggal >= tglMulai && k.tanggal <= tglSelesai);
                kasMasuk = kasMasuk.filter(k => k.tanggal >= tglMulai && k.tanggal <= tglSelesai);
            }

            const divisiList = filterDivisi === 'semua' ? ['Angkutan', 'Besi', 'Pakan'] : [filterDivisi];
            let totalPendapatanSemua = 0;
            let totalHPP = 0;
            let totalBebanOps = 0;
            const bebanPerKategori = {};

            // Variabel untuk menampung detail pendapatan lain
            const pendapatanLainPerKategori = {};
            let totalPendapatanLainSemua = 0;

            // Daftar kategori yang DIKECUALIKAN dari Pendapatan Lain (Non-Income Items)
            const nonPendapatanCategories = ['Penjualan', 'Pelunasan Piutang', 'Modal', 'Tambah Modal', 'Tarik Modal', 'Saldo Awal', 'Pinjaman', 'Pinjaman Sementara', 'Bayar Pinjaman', 'Transfer', 'Transfer Kas', 'Aset Tetap', 'Investasi', 'DP', 'Kas', 'Prive', 'Pembelian', 'Bayar Hutang'];

            divisiList.forEach(divisi => {
                const pendapatanPenjualan = penjualan
                    .filter(p => p.divisi === divisi)
                    .reduce((sum, item) => sum + item.total, 0);

                // Pendapatan Lain (Kas Masuk selain Penjualan/Pelunasan)
                let pendapatanLainDivisi = kasMasuk
                    .filter(k => k.divisi === divisi && !nonPendapatanCategories.includes(k.kategori))
                    .reduce((sum, item) => sum + item.jumlah, 0);

                // Kumpulkan detail pendapatan lain
                kasMasuk
                    .filter(k => k.divisi === divisi && !nonPendapatanCategories.includes(k.kategori))
                    .forEach(k => {
                        const namaKategori = k.kategori === 'Lainnya' ? 'Pendapatan Lain-lain' : k.kategori;
                        pendapatanLainPerKategori[namaKategori] = (pendapatanLainPerKategori[namaKategori] || 0) + k.jumlah;
                    });

                // Alokasi Pendapatan Lain Umum (1/3) ke divisi ini (jika bukan Umum)
                if (divisi !== 'Umum') {
                    const pendapatanLainUmum = kasMasuk
                        .filter(k => k.divisi === 'Umum' && !nonPendapatanCategories.includes(k.kategori))
                        .reduce((sum, item) => sum + item.jumlah, 0) / 3;

                    pendapatanLainDivisi += pendapatanLainUmum;

                    // Detail Pendapatan Lain Umum dialokasikan
                    kasMasuk
                        .filter(k => k.divisi === 'Umum' && !nonPendapatanCategories.includes(k.kategori))
                        .forEach(k => {
                            const namaKategori = k.kategori === 'Lainnya' ? 'Pendapatan Lain-lain' : k.kategori;
                            pendapatanLainPerKategori[namaKategori] = (pendapatanLainPerKategori[namaKategori] || 0) + (k.jumlah / 3);
                        });
                }

                const totalPendapatanDivisi = pendapatanPenjualan + pendapatanLainDivisi;

                const hppDivisi = pembelian
                    .filter(p => p.divisi === divisi)
                    .reduce((sum, item) => sum + item.total, 0);

                // Daftar kategori yang DIKECUALIKAN dari Beban Operasional (Non-Expense Items)
                const nonBebanCategories = ['Pembelian', 'Bayar Hutang', 'Prive', 'Penjualan', 'Pelunasan Piutang', 'Pendapatan Lain', 'Saldo Awal', 'Modal', 'Tambah Modal', 'Tarik Modal', 'Pinjaman', 'Pinjaman Sementara', 'Bayar Pinjaman', 'Transfer', 'Transfer Kas', 'Aset Tetap', 'Investasi', 'DP', 'Kas'];

                // Beban operasional spesifik divisi
                const bebanOpsDivisiSpesifik = kasKeluar
                    .filter(k => k.divisi === divisi && !nonBebanCategories.includes(k.kategori))
                    .reduce((sum, item) => sum + item.jumlah, 0);

                // Populate detail beban spesifik
                kasKeluar
                    .filter(k => k.divisi === divisi && !nonBebanCategories.includes(k.kategori))
                    .forEach(k => {
                        const namaKategori = k.kategori === 'Lainnya' ? 'Beban Lain-lain' : k.kategori;
                        bebanPerKategori[namaKategori] = (bebanPerKategori[namaKategori] || 0) + k.jumlah;
                    });

                // Beban operasional umum dibagi 3
                const bebanOpsUmum = kasKeluar
                    .filter(k => k.divisi === 'Umum' && !nonBebanCategories.includes(k.kategori))
                    .reduce((sum, item) => sum + item.jumlah, 0) / 3;

                // Populate detail beban umum (allocated)
                if (divisi !== 'Umum') {
                    kasKeluar
                        .filter(k => k.divisi === 'Umum' && !nonBebanCategories.includes(k.kategori))
                        .forEach(k => {
                            const namaKategori = k.kategori === 'Lainnya' ? 'Beban Lain-lain' : k.kategori;
                            bebanPerKategori[namaKategori] = (bebanPerKategori[namaKategori] || 0) + (k.jumlah / 3);
                        });
                }

                const bebanOpsDivisi = bebanOpsDivisiSpesifik + (divisi === 'Umum' ? 0 : bebanOpsUmum);

                totalPendapatanSemua += totalPendapatanDivisi;
                totalHPP += hppDivisi;
                totalBebanOps += bebanOpsDivisi;
                totalPendapatanLainSemua += pendapatanLainDivisi;
            });

            const totalPenjualanSemua = totalPendapatanSemua - totalPendapatanLainSemua;
            const totalBebanSemua = totalHPP + totalBebanOps;
            const labaBersihTotal = totalPendapatanSemua - totalBebanSemua;

            let judulLaporan = filterDivisi === 'semua'
                ? 'LAPORAN LABA RUGI - SEMUA DIVISI'
                : `LAPORAN LABA RUGI - DIVISI ${filterDivisi.toUpperCase()}`;

            let html = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta http-equiv="content-type" content="text/plain; charset=UTF-8"/>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Laporan Laba Rugi</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <style>
                        .bg-purple-header { background-color: #667eea; color: white; }
                        .bg-success-light { background-color: #d4edda; }
                        .bg-danger-light { background-color: #f8d7da; }
                        .bg-yellow-light-bold { background-color: #fff3cd; font-weight: bold; }
                        .bg-grey-light { background-color: #f5f5f5; }
                        .bg-success { background-color: #28a745; }
                        .bg-danger { background-color: #dc3545; }
                        .text-white { color: white; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .pl-20px { padding-left: 20px; }
                        .pl-40px { padding-left: 40px; }
                        .pl-60px { padding-left: 60px; }
                        .pr-20px { padding-right: 20px; }
                        .p-3 { padding: 10px; }
                        .w-50px { width: 50px; }
                        .font-bold { font-weight: bold; }
                        .font-size-16 { font-size: 14pt; }
                    </style>
                </head>
                <body>
                <table border="1">
                    <thead>
                        <tr class="bg-purple-header">
                            <th colspan="3" class="text-center p-3">
                                ${judulLaporan} - PT. SUMBER GANDA MEKAR<br>
                                ${tglMulai && tglSelesai ? `Periode: ${formatTanggal(tglMulai)} s/d ${formatTanggal(tglSelesai)}` : 'Semua Periode'}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="bg-success-light">
                            <td colspan="2" class="pl-20px"><strong>PENDAPATAN</strong></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="w-50px text-center">1</td>
                            <td class="pl-40px">Pendapatan Penjualan</td>
                            <td class="text-right">${formatRupiah(totalPenjualanSemua)}</td>
                        </tr>
            `;

            // Render Pendapatan Lain
            if (Object.keys(pendapatanLainPerKategori).length > 0) {
                Object.keys(pendapatanLainPerKategori).sort().forEach(kategori => {
                    html += `
                        <tr>
                            <td></td>
                            <td class="pl-40px">${kategori}</td>
                            <td class="text-right">${formatRupiah(pendapatanLainPerKategori[kategori])}</td>
                        </tr>
                    `;
                });
            }

            html += `
                        <tr class="bg-yellow-light-bold">
                            <td colspan="2" class="text-right pr-20px"><strong>Subtotal Pendapatan</strong></td>
                            <td class="text-right"><strong>${formatRupiah(totalPendapatanSemua)}</strong></td>
                        </tr>
                        <tr class="bg-danger-light">
                            <td colspan="2" class="pl-20px"><strong>BEBAN</strong></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="text-center">2</td>
                            <td class="pl-40px">Harga Pokok Penjualan (HPP)</td>
                            <td class="text-right">${formatRupiah(totalHPP)}</td>
                        </tr>
                        <tr>
                            <td class="text-center">3</td>
                            <td class="pl-40px font-bold">Beban Operasional:</td>
                            <td></td>
                        </tr>
                        ${Object.keys(bebanPerKategori).sort().map(kategori => `
                        <tr>
                            <td></td>
                            <td class="pl-60px">${kategori}</td>
                            <td class="text-right">${formatRupiah(bebanPerKategori[kategori])}</td>
                        </tr>
                        `).join('')}
                        <tr class="bg-grey-light">
                            <td></td>
                            <td class="text-right pr-20px font-bold">Total Beban Operasional</td>
                            <td class="text-right font-bold">${formatRupiah(totalBebanOps)}</td>
                        </tr>
                        <tr class="bg-yellow-light-bold">
                            <td colspan="2" class="text-right pr-20px"><strong>Subtotal Beban</strong></td>
                            <td class="text-right"><strong>${formatRupiah(totalBebanSemua)}</strong></td>
                        </tr>
                        <tr class="${labaBersihTotal >= 0 ? 'bg-success' : 'bg-danger'} text-white font-size-16">
                            <td colspan="2" class="text-right pr-20px font-bold">
                                ${labaBersihTotal >= 0 ? 'LABA' : 'RUGI'} BERSIH
                            </td>
                            <td class="text-right font-bold">${formatRupiah(labaBersihTotal)}</td>
                        </tr>
                    </tbody>
                </table>
                </body>
                </html>
            `;

            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            const namaFile = filterDivisi === 'semua'
                ? `Laporan_Laba_Rugi_Semua_Divisi${periode}.xls`
                : `Laporan_Laba_Rugi_${filterDivisi}${periode}.xls`;
            downloadLink.download = namaFile;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function eksporDivisiExcel() {
            const divisi = document.getElementById('filterDivisi').value;
            const tglMulai = document.getElementById('filterDivisiMulai').value;
            const tglSelesai = document.getElementById('filterDivisiSelesai').value;
            const periode = tglMulai && tglSelesai ? `_${tglMulai}_${tglSelesai}` : '';

            let penjualan = dataPenjualan.filter(p => p.divisi === divisi);
            let pembelian = dataPembelian.filter(p => p.divisi === divisi);

            if (tglMulai && tglSelesai) {
                penjualan = penjualan.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
                pembelian = pembelian.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
            }

            const totalPenjualan = penjualan.reduce((sum, item) => sum + item.total, 0);
            const totalPembelian = pembelian.reduce((sum, item) => sum + item.total, 0);
            const selisih = totalPenjualan - totalPembelian;

            let html = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta http-equiv="content-type" content="text/plain; charset=UTF-8"/>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Laporan Divisi ${divisi}</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <style>
                        .bg-purple-header { background-color: #667eea; color: white; }
                        .bg-green-light { background-color: #d4edda; }
                        .bg-red-light { background-color: #f8d7da; }
                        .bg-yellow-light { background-color: #fff3cd; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .p-10px { padding: 10px; }
                        .text-green { color: green; }
                        .text-red { color: red; }
                        th { background-color: #667eea; color: white; font-weight: bold; text-align: center; }
                        td { border: 1px solid #000; padding: 5px; }
                    </style>
                </head>
                <body>
                <table border="1">
                    <thead>
                        <tr class="bg-purple-header">
                            <th colspan="7" class="text-center p-10px">
                                LAPORAN DIVISI ${divisi.toUpperCase()} - PT. SUMBER GANDA MEKAR<br>
                                ${tglMulai && tglSelesai ? `Periode: ${formatTanggal(tglMulai)} s/d ${formatTanggal(tglSelesai)}` : 'Semua Periode'}
                            </th>
                        </tr>
                        <tr class="bg-green-light">
                            <th colspan="7">PENJUALAN (Total: ${formatRupiah(totalPenjualan)})</th>
                        </tr>
                        <tr class="bg-purple-header">
                            <th>No</th>
                            <th>Tanggal</th>
                            <th>No. Faktur</th>
                            <th>Pelanggan</th>
                            <th>Barang</th>
                            <th>Qty</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            penjualan.forEach((item, idx) => {
                html += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td>${item.noFaktur}</td>
                        <td>${item.pelanggan}</td>
                        <td>${item.barang}</td>
                        <td class="text-center">${item.qty}</td>
                        <td class="text-right">${formatRupiah(item.total)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <br>
                <table border="1">
                    <thead>
                        <tr class="bg-red-light">
                            <th colspan="7">PEMBELIAN (Total: ${formatRupiah(totalPembelian)})</th>
                        </tr>
                        <tr class="bg-purple-header">
                            <th>No</th>
                            <th>Tanggal</th>
                            <th>No. Faktur</th>
                            <th>Supplier</th>
                            <th>Barang</th>
                            <th>Qty</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pembelian.forEach((item, idx) => {
                html += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td>${item.noFaktur}</td>
                        <td>${item.supplier}</td>
                        <td>${item.barang}</td>
                        <td class="text-center">${item.qty}</td>
                        <td class="text-right">${formatRupiah(item.total)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <br>
                <table border="1">
                    <thead>
                        <tr class="bg-yellow-light">
                            <th class="p-10px">SELISIH (PENJUALAN - PEMBELIAN)</th>
                            <th class="text-right p-10px ${selisih >= 0 ? 'text-green' : 'text-red'}">${formatRupiah(selisih)}</th>
                        </tr>
                    </thead>
                </table>
                </body>
                </html>
            `;

            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = `Laporan_Divisi_${divisi}${periode}.xls`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function eksporPPNExcel() {
            const kategoriPPN = document.getElementById('filterKategoriPPN').value;
            const jenis = document.getElementById('filterJenisNonPpn').value;
            const tglMulai = document.getElementById('filterNonPpnMulai').value;
            const tglSelesai = document.getElementById('filterNonPpnSelesai').value;
            const periode = tglMulai && tglSelesai ? `_${tglMulai}_${tglSelesai}` : '';

            const labelMap = {
                'nonppn': 'Non PPN',
                'ppn11': 'PPN 11%',
                'ppn1': 'PPN 1.1%',
                'dibebaskan': 'PPN Dibebaskan'
            };
            const labelPPN = labelMap[kategoriPPN] || 'Non PPN';

            let penjualan = dataPenjualan.filter(p => p.jenisPpn === kategoriPPN);
            let pembelian = dataPembelian.filter(p => p.jenisPpn === kategoriPPN);

            if (tglMulai && tglSelesai) {
                penjualan = penjualan.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
                pembelian = pembelian.filter(p => p.tanggal >= tglMulai && p.tanggal <= tglSelesai);
            }

            const totalPenjualan = penjualan.reduce((sum, item) => sum + item.total, 0);
            const totalPembelian = pembelian.reduce((sum, item) => sum + item.total, 0);
            const selisih = totalPenjualan - totalPembelian;

            let html = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta http-equiv="content-type" content="text/plain; charset=UTF-8"/>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Laporan ${labelPPN}</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <style>
                        .bg-purple-header { background-color: #667eea; color: white; }
                        .bg-green-light { background-color: #d4edda; }
                        .bg-red-light { background-color: #f8d7da; }
                        .bg-yellow-light { background-color: #fff3cd; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .p-10px { padding: 10px; }
                        .text-green { color: green; }
                        .text-red { color: red; }
                        th { background-color: #667eea; color: white; font-weight: bold; text-align: center; }
                        td { border: 1px solid #000; padding: 5px; }
                    </style>
                </head>
                <body>
                <table border="1">
                    <thead>
                        <tr class="bg-purple-header">
                            <th colspan="9" class="text-center p-10px">
                                LAPORAN TRANSAKSI ${labelPPN.toUpperCase()} - PT. SUMBER GANDA MEKAR<br>
                                ${tglMulai && tglSelesai ? `Periode: ${formatTanggal(tglMulai)} s/d ${formatTanggal(tglSelesai)}` : 'Semua Periode'}
                            </th>
                        </tr>
            `;

            if (jenis === 'semua' || jenis === 'penjualan') {
                html += `
                        <tr class="bg-green-light">
                            <th colspan="9">PENJUALAN ${labelPPN} (Total: ${formatRupiah(totalPenjualan)})</th>
                        </tr>
                        <tr class="bg-purple-header">
                            <th>No</th>
                            <th>Tanggal</th>
                            <th>Divisi</th>
                            <th>No. Faktur</th>
                            <th>Pelanggan</th>
                            <th>Barang</th>
                            <th>Qty</th>
                            <th>Harga</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                penjualan.forEach((item, idx) => {
                    html += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td>${item.divisi || '-'}</td>
                            <td>${item.noFaktur}</td>
                            <td>${item.pelanggan}</td>
                            <td>${item.barang}</td>
                            <td class="text-center">${item.qty}</td>
                            <td class="text-right">${formatRupiah(item.harga)}</td>
                            <td class="text-right">${formatRupiah(item.total)}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table><br>`;
            }

            if (jenis === 'semua' || jenis === 'pembelian') {
                html += `
                    <table border="1">
                        <thead>
                            <tr class="bg-red-light">
                                <th colspan="9">PEMBELIAN ${labelPPN} (Total: ${formatRupiah(totalPembelian)})</th>
                            </tr>
                            <tr class="bg-purple-header">
                                <th>No</th>
                                <th>Tanggal</th>
                                <th>Divisi</th>
                                <th>No. Faktur</th>
                                <th>Supplier</th>
                                <th>Barang</th>
                                <th>Qty</th>
                                <th>Harga</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                pembelian.forEach((item, idx) => {
                    html += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td>${item.divisi || '-'}</td>
                            <td>${item.noFaktur}</td>
                            <td>${item.supplier}</td>
                            <td>${item.barang}</td>
                            <td class="text-center">${item.qty}</td>
                            <td class="text-right">${formatRupiah(item.harga)}</td>
                            <td class="text-right">${formatRupiah(item.total)}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;
            }

            if (jenis === 'semua') {
                html += `
                    <br>
                    <table border="1">
                        <thead>
                            <tr class="bg-yellow-light">
                                <th class="p-10px">SELISIH (PENJUALAN - PEMBELIAN)</th>
                                <th class="text-right p-10px ${selisih >= 0 ? 'text-green' : 'text-red'}">${formatRupiah(selisih)}</th>
                            </tr>
                        </thead>
                    </table>
                `;
            }

            html += `</body></html>`;

            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = `Laporan_${labelPPN.replace(/\s+/g, '_')}${periode}.xls`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }





        // ==================== CASH FLOW REPORT FUNCTIONS ====================

        function setDefaultDatesCashFlow() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            // Format DD/MM/YYYY
            const format = (d) => {
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const yyyy = d.getFullYear();
                return `${dd}/${mm}/${yyyy}`;
            };

            const startInput = document.getElementById('filterCashFlowMulai');
            const endInput = document.getElementById('filterCashFlowSelesai');

            if (startInput && !startInput.value) startInput.value = format(firstDay);
            if (endInput && !endInput.value) endInput.value = format(lastDay);
        }

        function recalculateJurnal(silent = false) {
            if (silent || confirm('Apakah Anda yakin ingin menghitung ulang data jurnal? \n\nProses ini akan:\n1. Menghapus data jurnal transaksi (Penjualan, Pembelian, Kas)\n2. Mempertahankan jurnal pembayaran Hutang/Piutang Awal\n3. Membuat ulang jurnal dari data transaksi.\n\nLakukan ini jika data laporan tidak sesuai.')) {
                try {
                    // Helper to normalize ISO dates (ensure YYYY-MM-DD)
                    const normalizeDate = (d) => {
                        if (!d) return d;
                        const parts = d.split('-');
                        if (parts.length === 3) {
                            return `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                        }
                        return d;
                    };

                    // Simpan jurnal pembayaran awal yang tidak memiliki master transaksi terpisah
                    const preservedJurnal = dataJurnal.filter(j =>
                        j.noRef && (String(j.noRef).startsWith('BPA-') || String(j.noRef).startsWith('BHA-'))
                    );

                    dataJurnal = [...preservedJurnal];

                    // Regenerate from Penjualan
                    if (dataPenjualan && Array.isArray(dataPenjualan)) {
                        dataPenjualan.forEach(t => {
                            t.tanggal = normalizeDate(t.tanggal);
                            buatJurnalPenjualan(t);
                        });
                    }

                    // Regenerate from Pembelian
                    if (dataPembelian && Array.isArray(dataPembelian)) {
                        dataPembelian.forEach(t => {
                            t.tanggal = normalizeDate(t.tanggal);
                            buatJurnalPembelian(t);
                        });
                    }

                    // Regenerate from Kas (dataTransaksiKas - Batch/Old)
                    if (dataTransaksiKas && Array.isArray(dataTransaksiKas)) {
                        dataTransaksiKas.forEach(t => {
                            t.tanggal = normalizeDate(t.tanggal);
                            if (t.jenis === 'masuk') buatJurnalKasMasuk(t);
                            else buatJurnalKasKeluar(t);
                        });
                    }

                    // Regenerate from Kas Harian (dataKasHarian - New/UI Tab)
                    if (dataKasHarian && Array.isArray(dataKasHarian)) {
                        dataKasHarian.forEach(k => {
                            const transaksi = {
                                tanggal: normalizeDate(k.tanggal),
                                noTransaksi: `KH-${k.id}`,
                                kategori: k.kategori,
                                keterangan: k.keterangan,
                                jumlah: k.jumlah
                            };

                            if (k.jenis === 'masuk') buatJurnalKasMasuk(transaksi);
                            else buatJurnalKasKeluar(transaksi);
                        });
                    }

                    // Regenerate from Pembayaran Hutang
                    if (dataPembayaranHutang && Array.isArray(dataPembayaranHutang)) {
                        dataPembayaranHutang.forEach(pembayaran => {
                            const tgl = normalizeDate(pembayaran.tanggal);
                            const jurnal = {
                                id: Date.now() + Math.random(),
                                tanggal: tgl,
                                noRef: `BH-${pembayaran.noFaktur}`,
                                keterangan: `Pembayaran hutang ${pembayaran.supplier} - ${pembayaran.noFaktur}`,
                                entries: [
                                    { akun: 'Hutang Usaha', debit: pembayaran.jumlah, kredit: 0 },
                                    { akun: 'Kas', debit: 0, kredit: pembayaran.jumlah }
                                ]
                            };
                            dataJurnal.push(jurnal);
                        });
                    }

                    // Regenerate from Pembayaran Piutang
                    if (dataPembayaranPiutang && Array.isArray(dataPembayaranPiutang)) {
                        dataPembayaranPiutang.forEach(pembayaran => {
                            const tgl = normalizeDate(pembayaran.tanggal);
                            const jurnal = {
                                id: Date.now() + Math.random(),
                                tanggal: tgl,
                                noRef: `BP-${pembayaran.noFaktur}`,
                                keterangan: `Pembayaran piutang ${pembayaran.pelanggan} - ${pembayaran.noFaktur}`,
                                entries: [
                                    { akun: 'Kas', debit: pembayaran.jumlah, kredit: 0 },
                                    { akun: 'Piutang Usaha', debit: 0, kredit: pembayaran.jumlah }
                                ]
                            };
                            dataJurnal.push(jurnal);
                        });
                    }

                    // Urutkan
                    dataJurnal.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

                    saveDataToStorage();
                    // Avoid infinite loop if called from displayCashFlow
                    if (!silent) {
                        displayCashFlow();
                        alert('Data jurnal berhasil diperbarui dan format tanggal dinormalisasi!');
                    }
                } catch (e) {
                    console.error(e);
                    alert('Terjadi kesalahan saat memproses data: ' + e.message);
                }
            }
        }

        function displayCashFlow() {
            // Safety check: if UI elements are missing (feature removed/disabled), do nothing
            const tglMulaiInput = document.getElementById('filterCashFlowMulai');
            if (!tglMulaiInput) return;

            try {
                console.log('=== displayCashFlow START ===');
                const tglSelesaiInput = document.getElementById('filterCashFlowSelesai');

                const tglMulaiStr = tglMulaiInput ? tglMulaiInput.value : '';
                const tglSelesaiStr = tglSelesaiInput ? tglSelesaiInput.value : '';

                console.log('Inputs:', { tglMulaiStr, tglSelesaiStr });

                if (!tglMulaiStr || !tglSelesaiStr) {
                    alert('Harap isi tanggal mulai dan selesai!');
                    return;
                }

                // Ensure dataJurnal exists
                if (!window.dataJurnal || !Array.isArray(window.dataJurnal)) {
                    window.dataJurnal = [];
                }

                // Auto-healing: If Jurnal is empty but we have transactions
                const hasPenjualan = window.dataPenjualan && window.dataPenjualan.length > 0;
                const hasPembelian = window.dataPembelian && window.dataPembelian.length > 0;
                const hasKas = window.dataTransaksiKas && window.dataTransaksiKas.length > 0;
                const hasKasHarian = window.dataKasHarian && window.dataKasHarian.length > 0;

                if (window.dataJurnal.length === 0 && (hasPenjualan || hasPembelian || hasKas || hasKasHarian)) {
                    console.log('Auto-healing Jurnal data...');
                    recalculateJurnal(true);
                }

                console.log(`Total jurnal data available: ${window.dataJurnal.length}`);

                // Convert DD/MM/YYYY to YYYY-MM-DD
                const toISO = (str) => {
                    if (!str) return '';
                    const s = String(str).trim();
                    // If already YYYY-MM-DD
                    if (s.match(/^\d{4}-\d{2}-\d{2}$/)) return s;

                    const parts = s.split('/');
                    if (parts.length === 3) {
                        const d = parts[0].padStart(2, '0');
                        const m = parts[1].padStart(2, '0');
                        const y = parts[2];
                        return `${y}-${m}-${d}`;
                    }
                    return s; // Return original if format unknown
                };

                // Helper to safely normalize date from dataJurnal for comparison
                const safeDate = (d) => {
                    if (!d) return '';
                    const s = String(d).trim(); // Ensure string

                    // if DD/MM/YYYY
                    if (s.includes('/')) {
                        const p = s.split('/');
                        if (p.length === 3) return `${p[2]}-${p[1].padStart(2, '0')}-${p[0].padStart(2, '0')}`;
                    }
                    // if YYYY-M-D or YYYY-MM-DD
                    if (s.includes('-')) {
                        const p = s.split('-');
                        if (p.length === 3) return `${p[0]}-${p[1].padStart(2, '0')}-${p[2].padStart(2, '0')}`;
                    }
                    return s;
                };

                const tglMulai = toISO(tglMulaiStr);
                const tglSelesai = toISO(tglSelesaiStr);

                console.log(`Filtering range (ISO): ${tglMulai} to ${tglSelesai}`);

                // 1. Hitung Saldo Awal
                let saldoAwal = 0;

                // Debug saldo awal calculation
                let saldoAwalCount = 0;
                window.dataJurnal.forEach(j => {
                    if (!j || !j.tanggal) return;
                    const tgl = safeDate(j.tanggal);
                    if (tgl < tglMulai) {
                        if (j.entries && Array.isArray(j.entries)) {
                            j.entries.forEach(entry => {
                                if (entry && entry.akun === 'Kas') {
                                    saldoAwal += ((entry.debit || 0) - (entry.kredit || 0));
                                    saldoAwalCount++;
                                }
                            });
                        }
                    }
                });
                console.log(`Saldo Awal calculated from ${saldoAwalCount} transactions: ${saldoAwal}`);

                // 2. Ambil transaksi periode ini
                let rows = [];
                let totalMasuk = 0;
                let totalKeluar = 0;

                const currentJurnal = window.dataJurnal.filter(j => {
                    if (!j || !j.tanggal) return false;
                    const tgl = safeDate(j.tanggal);
                    return tgl >= tglMulai && tgl <= tglSelesai;
                });

                console.log(`Found ${currentJurnal.length} entries in range`);

                currentJurnal.forEach(jurnal => {
                    if (!jurnal.entries || !Array.isArray(jurnal.entries)) return;

                    // Cari entry Kas dalam jurnal ini
                    const kasEntries = jurnal.entries.filter(e => e.akun === 'Kas');

                    if (kasEntries.length === 0) return; // Bukan transaksi kas

                    const totalKasDebit = kasEntries.reduce((sum, e) => sum + (e.debit || 0), 0);
                    const totalKasKredit = kasEntries.reduce((sum, e) => sum + (e.kredit || 0), 0);

                    if (totalKasDebit > 0) {
                        // KAS MASUK
                        const sources = jurnal.entries.filter(e => (e.kredit || 0) > 0 && e.akun !== 'Kas');
                        if (sources.length > 0) {
                            sources.forEach(source => {
                                rows.push({
                                    tanggal: safeDate(jurnal.tanggal),
                                    akun: source.akun,
                                    keterangan: jurnal.keterangan,
                                    masuk: source.kredit,
                                    keluar: 0
                                });
                                totalMasuk += source.kredit;
                            });
                        } else {
                            rows.push({
                                tanggal: safeDate(jurnal.tanggal),
                                akun: 'Tidak Diketahui',
                                keterangan: jurnal.keterangan,
                                masuk: totalKasDebit,
                                keluar: 0
                            });
                            totalMasuk += totalKasDebit;
                        }
                    }

                    if (totalKasKredit > 0) {
                        // KAS KELUAR
                        const destinations = jurnal.entries.filter(e => (e.debit || 0) > 0 && e.akun !== 'Kas');
                        if (destinations.length > 0) {
                            destinations.forEach(dest => {
                                rows.push({
                                    tanggal: safeDate(jurnal.tanggal),
                                    akun: dest.akun,
                                    keterangan: jurnal.keterangan,
                                    masuk: 0,
                                    keluar: dest.debit
                                });
                                totalKeluar += dest.debit;
                            });
                        } else {
                            rows.push({
                                tanggal: safeDate(jurnal.tanggal),
                                akun: 'Tidak Diketahui',
                                keterangan: jurnal.keterangan,
                                masuk: 0,
                                keluar: totalKasKredit
                            });
                            totalKeluar += totalKasKredit;
                        }
                    }
                });

                // Sort rows
                rows.sort((a, b) => {
                    const dateA = a.tanggal;
                    const dateB = b.tanggal;
                    if (dateA < dateB) return -1;
                    if (dateA > dateB) return 1;
                    return 0;
                });

                // Render Table
                const tbody = document.getElementById('bodyCashFlow');
                if (!tbody) {
                    console.error('Element bodyCashFlow not found!');
                    alert('Error: Tabel tidak ditemukan.');
                    return;
                }

                let html = '';

                // Warning jika data kosong
                if (window.dataJurnal.length === 0) {
                    html += '<tr><td colspan="7" class="center text-red-bold p-20px">Data jurnal kosong. Silakan klik tombol "🔄 Refresh Data" di atas untuk memuat data transaksi.</td></tr>';
                    tbody.innerHTML = html;
                    updateSummary(0, 0, 0);
                    return;
                }

                // Baris Saldo Awal
                html += `
                    <tr class="bg-gray-100 font-bold">
                        <td colspan="4">SALDO AWAL</td>
                        <td class="number">-</td>
                        <td class="number">-</td>
                        <td class="number">${formatRupiah(saldoAwal)}</td>
                    </tr>
                `;

                let currentSaldo = saldoAwal;

                if (rows.length === 0) {
                    html += '<tr><td colspan="7" class="center p-20px">Tidak ada transaksi kas pada periode ini</td></tr>';
                } else {
                    rows.forEach((row, idx) => {
                        currentSaldo += (row.masuk - row.keluar);
                        // Format tanggal kembali ke DD/MM/YYYY untuk display
                        const tglDisplay = row.tanggal.split('-').reverse().join('/');

                        html += `
                            <tr>
                                <td class="center">${idx + 1}</td>
                                <td>${tglDisplay}</td>
                                <td>${row.akun}</td>
                                <td>${row.keterangan}</td>
                                <td class="number text-green-600">${row.masuk > 0 ? formatRupiah(row.masuk) : '-'}</td>
                                <td class="number text-red-600">${row.keluar > 0 ? formatRupiah(row.keluar) : '-'}</td>
                                <td class="number font-bold">${formatRupiah(currentSaldo)}</td>
                            </tr>
                        `;
                    });
                }

                tbody.innerHTML = html;
                updateSummary(totalMasuk, totalKeluar, currentSaldo);

                console.log('=== displayCashFlow END ===');

            } catch (error) {
                console.error('Error displaying Cash Flow:', error);
                alert('Terjadi kesalahan saat menampilkan Cash Flow: ' + error.message);
            }
        }

        function updateSummary(masuk, keluar, saldo) {
            document.getElementById('totalCashFlowMasuk').textContent = formatRupiah(masuk);
            document.getElementById('totalCashFlowKeluar').textContent = formatRupiah(keluar);
            document.getElementById('saldoCashFlow').textContent = formatRupiah(saldo);
            document.getElementById('footerTotalMasukCF').textContent = formatRupiah(masuk);
            document.getElementById('footerTotalKeluarCF').textContent = formatRupiah(keluar);
            document.getElementById('footerSaldoCF').textContent = formatRupiah(saldo);
        }

        function printCashFlow() {
            const tglMulai = document.getElementById('filterCashFlowMulai').value;
            const tglSelesai = document.getElementById('filterCashFlowSelesai').value;
            const tableClone = document.getElementById('tableCashFlow').cloneNode(true);

            const win = window.open('', '', 'height=800,width=1000');
            win.document.write('<html><head><title>Laporan Cash Flow - PT. Sumber Ganda Mekar</title>');
            win.document.write('<style>');
            win.document.write('body { font-family: Arial, sans-serif; padding: 20px; margin: 0; background: white; }');
            win.document.write('.header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px; }');
            win.document.write('.header h1 { font-size: 18pt; margin: 0 0 5px 0; color: #2c3e50; }');
            win.document.write('.header h2 { font-size: 14pt; margin: 0 0 5px 0; color: #333; }');
            win.document.write('.header p { font-size: 10pt; margin: 3px 0; color: #666; }');
            win.document.write('table { border-collapse: collapse; width: 100%; font-size: 10pt; margin-top: 10px; }');
            win.document.write('th, td { border: 1px solid #333; padding: 6px 8px; }');
            win.document.write('th { background-color: #4472C4; color: white; text-align: center; font-weight: bold; }');
            win.document.write('td { text-align: left; }');
            win.document.write('td.number { text-align: right; font-family: Consolas, monospace; }');
            win.document.write('td.center { text-align: center; }');
            win.document.write('tr:nth-child(even) { background-color: #D6DCE4; }');
            win.document.write('tfoot tr { background-color: #FFC000 !important; font-weight: bold; }');
            win.document.write('.footer { text-align: center; margin-top: 30px; font-size: 9pt; color: #888; border-top: 1px solid #ccc; padding-top: 10px; }');
            win.document.write('.text-green-600 { color: #059669 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }');
            win.document.write('.text-red-600 { color: #dc2626 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }');
            win.document.write('.font-bold { font-weight: bold !important; }');
            win.document.write('@media print { body { padding: 10px; } }');
            win.document.write('</style>');
            win.document.write('</head><body>');
            win.document.write('<div class="header">');
            win.document.write('<h1>PT. SUMBER GANDA MEKAR</h1>');
            win.document.write('<h2>LAPORAN CASH FLOW</h2>');
            win.document.write(`<p>Periode: ${tglMulai} s/d ${tglSelesai}</p>`);
            win.document.write('</div>');
            win.document.write(tableClone.outerHTML);
            win.document.write('<div class="footer">Dicetak pada: ' + new Date().toLocaleString('id-ID') + '</div>');
            win.document.write('</body></html>');
            win.document.close();
            win.focus();
            win.print();
            win.close();
        }

        function eksporCashFlowExcel() {
            const tglMulai = document.getElementById('filterCashFlowMulai').value;
            const tglSelesai = document.getElementById('filterCashFlowSelesai').value;
            const table = document.getElementById('tableCashFlow');
            const rows = Array.from(table.rows);

            let html = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta http-equiv="content-type" content="text/plain; charset=UTF-8"/>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Cash Flow</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <style>
                        .header-title { font-size: 16pt; font-weight: bold; text-align: center; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        .font-bold { font-weight: bold; }
                        .text-green { color: #43a047; }
                        .text-red { color: #e53935; }
                        th { background-color: #4472C4; color: white; text-align: center; font-weight: bold; }
                        td { border: 1px solid #000; padding: 5px; }
                        .bg-even { background-color: #D6DCE4; }
                        .bg-footer { background-color: #FFC000; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <table border="1">
                        <tr>
                            <th colspan="7" class="header-title">LAPORAN CASH FLOW - PT. SUMBER GANDA MEKAR</th>
                        </tr>
                        <tr>
                            <th colspan="7" class="text-center">Periode: ${tglMulai} s/d ${tglSelesai}</th>
                        </tr>
                        <tr></tr>
            `;

            // Reconstruct table rows
            rows.forEach((row, index) => {
                // Check if it's header, body, or footer
                const parentTag = row.parentElement.tagName;
                const isHeader = parentTag === 'THEAD';
                const isFooter = parentTag === 'TFOOT';
                const isBody = parentTag === 'TBODY';

                // Skip header row if it's already in the template (but here we're taking from existing table)
                // The existing table headers are simple, so we can just use them.

                html += `<tr${isFooter ? ' class="bg-footer"' : (isBody && index % 2 === 0 ? ' class="bg-even"' : '')}>`;

                Array.from(row.cells).forEach(cell => {
                    let cellContent = cell.innerText;
                    let cellClass = '';

                    if (cell.classList.contains('number') || cell.classList.contains('text-right')) {
                        cellClass = 'text-right';
                    } else if (cell.classList.contains('center') || cell.classList.contains('text-center')) {
                        cellClass = 'text-center';
                    }

                    if (cell.classList.contains('text-green-600')) cellClass += ' text-green';
                    if (cell.classList.contains('text-red-600')) cellClass += ' text-red';
                    if (cell.classList.contains('font-bold')) cellClass += ' font-bold';

                    const colspan = cell.colSpan > 1 ? ` colspan="${cell.colSpan}"` : '';
                    const rowspan = cell.rowSpan > 1 ? ` rowspan="${cell.rowSpan}"` : '';
                    const tagName = isHeader ? 'th' : 'td';

                    html += `<${tagName}${colspan}${rowspan}${cellClass ? ` class="${cellClass.trim()}"` : ''}>${cellContent}</${tagName}>`;
                });

                html += '</tr>';
            });

            html += `
                    </table>
                </body>
                </html>
            `;

            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = `Laporan_CashFlow_${tglMulai}-${tglSelesai}.xls`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // ==================== SEARCH FUNCTIONS ====================

        // Search dalam satu tabel
        function searchTable(searchInputId, tableBodyId) {
            const searchValue = document.getElementById(searchInputId).value.toLowerCase();
            const tableBody = document.getElementById(tableBodyId);
            const rows = tableBody.getElementsByTagName('tr');
            let visibleCount = 0;
            let totalCount = 0;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                // Skip empty data row
                if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
                    continue;
                }

                totalCount++;
                const rowText = row.textContent.toLowerCase();

                if (rowText.includes(searchValue)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }

            // Update results info
            let resultsId = searchInputId.replace('search', 'results');
            const resultsDiv = document.getElementById(resultsId);
            if (resultsDiv) {
                if (searchValue === '') {
                    resultsDiv.textContent = '';
                } else if (visibleCount === 0) {
                    resultsDiv.innerHTML = `❌ Tidak ada hasil untuk "<strong>${searchValue}</strong>"`;
                    resultsDiv.classList.remove('text-success');
                    resultsDiv.classList.add('text-danger');
                } else {
                    resultsDiv.innerHTML = `✅ Ditemukan <strong>${visibleCount}</strong> dari ${totalCount} data`;
                    resultsDiv.classList.remove('text-danger');
                    resultsDiv.classList.add('text-success');
                }
            }
        }

        // Search Global di semua data
        function searchGlobal() {
            const searchValue = document.getElementById('searchGlobal').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('globalSearchResults');
            const resultsInfo = document.getElementById('resultsGlobal');

            if (searchValue === '') {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <p>🔍 Masukkan kata kunci untuk mencari di semua data</p>
                        <p class="search-hint">Cari berdasarkan: tanggal, nomor faktur/transaksi, nama pelanggan/supplier, barang, kategori, divisi, dll.</p>
                    </div>
                `;
                resultsInfo.textContent = '';
                return;
            }

            let totalResults = 0;
            let html = '';

            // Search in Penjualan
            const penjualanResults = dataPenjualan.filter(item => {
                return (item.tanggal || '').toLowerCase().includes(searchValue) ||
                    (item.noFaktur || '').toLowerCase().includes(searchValue) ||
                    (item.pelanggan || '').toLowerCase().includes(searchValue) ||
                    (item.barang || '').toLowerCase().includes(searchValue) ||
                    (item.divisi || '').toLowerCase().includes(searchValue) ||
                    (item.metodeBayar || '').toLowerCase().includes(searchValue) ||
                    formatRupiah(item.total || 0).toLowerCase().includes(searchValue);
            });

            if (penjualanResults.length > 0) {
                totalResults += penjualanResults.length;
                html += `<div class="global-search-category">💰 PENJUALAN (${penjualanResults.length} hasil)</div>`;
                html += '<div class="table-wrapper"><table class="excel-table"><thead><tr>';
                html += '<th>No</th><th>Tanggal</th><th>No. Faktur</th><th>Pelanggan</th><th>Barang</th><th>Qty</th><th>Total</th><th>Metode</th><th>Divisi</th>';
                html += '</tr></thead><tbody>';

                penjualanResults.forEach((item, index) => {
                    html += `<tr>
                        <td>${index + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td>${item.noFaktur || ''}</td>
                        <td>${item.pelanggan || ''}</td>
                        <td>${item.barang || ''}</td>
                        <td class="number">${formatAngka(item.qty || 0)}</td>
                        <td class="number">${formatRupiah(item.total || 0)}</td>
                        <td><span class="badge badge-${item.metodeBayar === 'tunai' ? 'tunai' : 'kredit'}">${(item.metodeBayar || '').toUpperCase()}</span></td>
                        <td>${item.divisi || ''}</td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
            }

            // Search in Pembelian
            const pembelianResults = dataPembelian.filter(item => {
                return (item.tanggal || '').toLowerCase().includes(searchValue) ||
                    (item.noFaktur || '').toLowerCase().includes(searchValue) ||
                    (item.supplier || '').toLowerCase().includes(searchValue) ||
                    (item.barang || '').toLowerCase().includes(searchValue) ||
                    (item.divisi || '').toLowerCase().includes(searchValue) ||
                    (item.metodeBayar || '').toLowerCase().includes(searchValue) ||
                    formatRupiah(item.total || 0).toLowerCase().includes(searchValue);
            });

            if (pembelianResults.length > 0) {
                totalResults += pembelianResults.length;
                html += `<div class="global-search-category">🛒 PEMBELIAN (${pembelianResults.length} hasil)</div>`;
                html += '<div class="table-wrapper"><table class="excel-table"><thead><tr>';
                html += '<th>No</th><th>Tanggal</th><th>No. Faktur</th><th>Supplier</th><th>Barang</th><th>Qty</th><th>Total</th><th>Metode</th><th>Divisi</th>';
                html += '</tr></thead><tbody>';

                pembelianResults.forEach((item, index) => {
                    html += `<tr>
                        <td>${index + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td>${item.noFaktur || ''}</td>
                        <td>${item.supplier || ''}</td>
                        <td>${item.barang || ''}</td>
                        <td class="number">${formatAngka(item.qty || 0)}</td>
                        <td class="number">${formatRupiah(item.total || 0)}</td>
                        <td><span class="badge badge-${item.metodeBayar === 'tunai' ? 'tunai' : 'kredit'}">${(item.metodeBayar || '').toUpperCase()}</span></td>
                        <td>${item.divisi || ''}</td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
            }

            // Search in Transaksi Kas
            const kasResults = dataTransaksiKas.filter(item => {
                return (item.tanggal || '').toLowerCase().includes(searchValue) ||
                    (item.noTransaksi || '').toLowerCase().includes(searchValue) ||
                    (item.jenis || '').toLowerCase().includes(searchValue) ||
                    (item.kategori || '').toLowerCase().includes(searchValue) ||
                    (item.keterangan || '').toLowerCase().includes(searchValue) ||
                    (item.divisi || '').toLowerCase().includes(searchValue) ||
                    formatRupiah(item.jumlah || 0).toLowerCase().includes(searchValue);
            });

            if (kasResults.length > 0) {
                totalResults += kasResults.length;
                html += `<div class="global-search-category">💵 TRANSAKSI KAS (${kasResults.length} hasil)</div>`;
                html += '<div class="table-wrapper"><table class="excel-table"><thead><tr>';
                html += '<th>No</th><th>Tanggal</th><th>No. Transaksi</th><th>Jenis</th><th>Kategori</th><th>Keterangan</th><th>Jumlah</th><th>Divisi</th>';
                html += '</tr></thead><tbody>';

                kasResults.forEach((item, index) => {
                    html += `<tr>
                        <td>${index + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td>${item.noTransaksi || ''}</td>
                        <td><span class="badge badge-${item.jenis === 'masuk' ? 'tunai' : 'danger'}">${(item.jenis || '').toUpperCase()}</span></td>
                        <td>${item.kategori || ''}</td>
                        <td>${item.keterangan || ''}</td>
                        <td class="number">${formatRupiah(item.jumlah || 0)}</td>
                        <td>${item.divisi || ''}</td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
            }

            // Search in Jurnal
            const jurnalResults = dataJurnal.filter(item => {
                return (item.tanggal || '').toLowerCase().includes(searchValue) ||
                    (item.referensi || '').toLowerCase().includes(searchValue) ||
                    (item.akun || '').toLowerCase().includes(searchValue) ||
                    (item.keterangan || '').toLowerCase().includes(searchValue) ||
                    formatRupiah(item.debit || 0).toLowerCase().includes(searchValue) ||
                    formatRupiah(item.kredit || 0).toLowerCase().includes(searchValue);
            });

            if (jurnalResults.length > 0) {
                totalResults += jurnalResults.length;
                html += `<div class="global-search-category">📖 JURNAL (${jurnalResults.length} hasil)</div>`;
                html += '<div class="table-wrapper"><table class="excel-table"><thead><tr>';
                html += '<th>No</th><th>Tanggal</th><th>Referensi</th><th>Akun</th><th>Keterangan</th><th>Debit</th><th>Kredit</th>';
                html += '</tr></thead><tbody>';

                jurnalResults.forEach((item, index) => {
                    html += `<tr>
                        <td>${index + 1}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td>${item.referensi || ''}</td>
                        <td>${item.akun || ''}</td>
                        <td>${item.keterangan || ''}</td>
                        <td class="number">${formatRupiah(item.debit || 0)}</td>
                        <td class="number">${formatRupiah(item.kredit || 0)}</td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
            }

            // Display results
            if (totalResults === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <p>❌ Tidak ada hasil ditemukan untuk "<strong>${searchValue}</strong>"</p>
                        <p class="search-hint">Coba gunakan kata kunci lain atau periksa ejaan.</p>
                    </div>
                `;
                resultsInfo.innerHTML = `❌ Tidak ada hasil untuk "<strong>${searchValue}</strong>"`;
                resultsInfo.classList.remove('text-success');
                resultsInfo.classList.add('text-danger');
            } else {
                resultsContainer.innerHTML = html;
                resultsInfo.innerHTML = `✅ Ditemukan <strong>${totalResults}</strong> hasil di semua data`;
                resultsInfo.classList.remove('text-danger');
                resultsInfo.classList.add('text-success');
            }
        }

        // Fungsi pencarian untuk tabel individual
        function searchTable(searchInputId, tableBodyId) {
            const searchValue = document.getElementById(searchInputId).value.toLowerCase();
            const tbody = document.getElementById(tableBodyId);
            const rows = tbody.getElementsByTagName('tr');
            let visibleCount = 0;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let found = false;

                // Cek semua sel dalam baris
                for (let j = 0; j < cells.length; j++) {
                    const cellText = cells[j].textContent || cells[j].innerText;
                    if (cellText.toLowerCase().indexOf(searchValue) > -1) {
                        found = true;
                        break;
                    }
                }

                // Tampilkan atau sembunyikan baris
                if (found || searchValue === '') {
                    row.classList.remove('d-none');
                    visibleCount++;
                } else {
                    row.classList.add('d-none');
                }
            }

            // Update info hasil pencarian
            const resultsId = searchInputId.replace('search', 'results');
            const resultsInfo = document.getElementById(resultsId);

            if (resultsInfo) {
                if (searchValue === '') {
                    resultsInfo.innerHTML = '';
                } else if (visibleCount === 0) {
                    resultsInfo.innerHTML = `❌ Tidak ada hasil untuk "<strong>${searchValue}</strong>"`;
                    resultsInfo.classList.remove('text-success');
                    resultsInfo.classList.add('text-danger');
                } else {
                    resultsInfo.innerHTML = `✅ Ditemukan <strong>${visibleCount}</strong> data`;
                    resultsInfo.classList.remove('text-danger');
                    resultsInfo.classList.add('text-success');
                }
            }
        }

        // ===========================
        // BATCH INPUT KAS MASUK/KELUAR
        // ===========================

        // Tambah Baris Batch Kas Masuk
        function tambahBarisBatchKasMasuk() {
            const kategori = document.getElementById('inputKategoriKasMasuk').value;
            const keterangan = document.getElementById('inputKeteranganKasMasuk').value.trim();
            const jumlahText = document.getElementById('inputJumlahKasMasuk').value;
            const jumlah = parseRupiah(jumlahText);

            if (!kategori) {
                alert('⚠️ Pilih kategori terlebih dahulu!');
                return;
            }
            if (!keterangan) {
                alert('⚠️ Isi keterangan terlebih dahulu!');
                return;
            }
            if (!jumlah || jumlah <= 0) {
                alert('⚠️ Jumlah harus lebih dari 0!');
                return;
            }

            batchKasMasuk.push({ kategori, keterangan, jumlah });

            // Reset input
            document.getElementById('inputKategoriKasMasuk').value = '';
            document.getElementById('inputKeteranganKasMasuk').value = '';
            document.getElementById('inputJumlahKasMasuk').value = '';

            displayBatchKasMasuk();
        }

        // Display Batch Kas Masuk
        function displayBatchKasMasuk() {
            const tbody = document.getElementById('bodyBatchKasMasuk');
            // Skip jika elemen tidak ada
            if (!tbody) return;

            if (batchKasMasuk.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="center p-20px text-grey-400">Belum ada data. Klik tombol ➕ untuk menambah transaksi</td></tr>';
                const totalEl = document.getElementById('totalBatchKasMasuk');
                if (totalEl) totalEl.textContent = 'Rp 0';
                return;
            }

            let html = '';
            let total = 0;

            batchKasMasuk.forEach((item, index) => {
                total += item.jumlah;
                html += `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${item.kategori}</td>
                        <td>${item.keterangan}</td>
                        <td class="number">${formatRupiah(item.jumlah)}</td>
                        <td class="center">
                            <button class="delete-btn" onclick="hapusBarisBatchKasMasuk(${index})">🗑️</button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            document.getElementById('totalBatchKasMasuk').textContent = formatRupiah(total);
        }

        // Hapus Baris Batch Kas Masuk
        function hapusBarisBatchKasMasuk(index) {
            batchKasMasuk.splice(index, 1);
            displayBatchKasMasuk();
        }

        // Simpan Batch Kas Masuk
        function simpanBatchKasMasuk() {
            const tanggal = document.getElementById('tglBatchKasMasuk').value;
            const divisi = document.getElementById('divisiBatchKasMasuk').value || 'Umum';

            if (!tanggal || !validateTanggal(tanggal)) {
                alert('⚠️ Tanggal tidak valid! Format: DD/MM/YYYY');
                return;
            }

            if (batchKasMasuk.length === 0) {
                alert('⚠️ Belum ada transaksi yang ditambahkan!');
                return;
            }

            const tanggalISO = convertToISODate(tanggal);
            // Generate nomor jurnal harian (satu nomor untuk semua transaksi di hari yang sama)
            const noJurnalHarian = generateNoJurnalKasHarian(tanggalISO, 'masuk');

            // Simpan semua transaksi dengan nomor jurnal yang sama per hari
            batchKasMasuk.forEach((item, index) => {
                const transaksi = {
                    id: Date.now() + index,
                    tanggal: tanggalISO,
                    noTransaksi: generateNoTransaksi('KM', dataTransaksiKas, tanggalISO),
                    noJurnalHarian: noJurnalHarian, // Nomor jurnal harian
                    jenis: 'masuk',
                    kategori: item.kategori,
                    keterangan: item.keterangan,
                    jumlah: item.jumlah,
                    divisi: divisi
                };

                dataTransaksiKas.push(transaksi);
                // Push dulu ke array agar count increment untuk nomor berikutnya
            });

            // Generate jurnal dari transaksi kas masuk
            buatJurnalKasMasuk({
                tanggal: tanggalISO,
                noJurnalHarian: noJurnalHarian,
                kategori: batchKasMasuk.map(b => b.kategori).join(', '),
                jumlah: batchKasMasuk.reduce((sum, b) => sum + b.jumlah, 0),
                keterangan: batchKasMasuk.map(b => `${b.kategori}: ${b.keterangan}`).join('; ')
            });

            // Simpan ke storage
            saveDataToStorage();

            // Update tampilan
            if (typeof displayTransaksiKas === 'function') displayTransaksiKas();
            if (typeof updateSaldoKas === 'function') updateSaldoKas();
            if (typeof displayJurnal === 'function') displayJurnal();

            alert(`✅ Berhasil menyimpan ${batchKasMasuk.length} transaksi kas masuk!\n\nNomor Jurnal: ${noJurnalHarian}`);

            // Reset form
            resetBatchKasMasuk();
        }

        // Reset Batch Kas Masuk
        function resetBatchKasMasuk() {
            batchKasMasuk = [];
            displayBatchKasMasuk();

            // Reset tanggal ke hari ini
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            const todayFormatted = `${dd}/${mm}/${yyyy}`;

            document.getElementById('tglBatchKasMasuk').value = todayFormatted;
            document.getElementById('divisiBatchKasMasuk').value = '';
            document.getElementById('inputKategoriKasMasuk').value = '';
            document.getElementById('inputKeteranganKasMasuk').value = '';
            document.getElementById('inputJumlahKasMasuk').value = '';
        }

        // Tambah Baris Batch Kas Keluar
        function tambahBarisBatchKasKeluar() {
            const kategori = document.getElementById('inputKategoriKasKeluar').value;
            const keterangan = document.getElementById('inputKeteranganKasKeluar').value.trim();
            const jumlahText = document.getElementById('inputJumlahKasKeluar').value;
            const jumlah = parseRupiah(jumlahText);

            if (!kategori) {
                alert('⚠️ Pilih kategori terlebih dahulu!');
                return;
            }
            if (!keterangan) {
                alert('⚠️ Isi keterangan terlebih dahulu!');
                return;
            }
            if (!jumlah || jumlah <= 0) {
                alert('⚠️ Jumlah harus lebih dari 0!');
                return;
            }

            batchKasKeluar.push({ kategori, keterangan, jumlah });

            // Reset input
            document.getElementById('inputKategoriKasKeluar').value = '';
            document.getElementById('inputKeteranganKasKeluar').value = '';
            document.getElementById('inputJumlahKasKeluar').value = '';

            displayBatchKasKeluar();
        }

        // Display Batch Kas Keluar
        function displayBatchKasKeluar() {
            const tbody = document.getElementById('bodyBatchKasKeluar');
            // Skip jika elemen tidak ada
            if (!tbody) return;

            if (batchKasKeluar.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="center p-20px text-grey-400">Belum ada data. Klik tombol ➕ untuk menambah transaksi</td></tr>';
                const totalEl = document.getElementById('totalBatchKasKeluar');
                if (totalEl) totalEl.textContent = 'Rp 0';
                return;
            }

            let html = '';
            let total = 0;

            batchKasKeluar.forEach((item, index) => {
                total += item.jumlah;
                html += `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${item.kategori}</td>
                        <td>${item.keterangan}</td>
                        <td class="number">${formatRupiah(item.jumlah)}</td>
                        <td class="center">
                            <button class="delete-btn" onclick="hapusBarisBatchKasKeluar(${index})">🗑️</button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            document.getElementById('totalBatchKasKeluar').textContent = formatRupiah(total);
        }

        // Hapus Baris Batch Kas Keluar
        function hapusBarisBatchKasKeluar(index) {
            batchKasKeluar.splice(index, 1);
            displayBatchKasKeluar();
        }

        // Simpan Batch Kas Keluar
        function simpanBatchKasKeluar() {
            const tanggal = document.getElementById('tglBatchKasKeluar').value;
            const divisi = document.getElementById('divisiBatchKasKeluar').value || 'Umum';

            if (!tanggal || !validateTanggal(tanggal)) {
                alert('⚠️ Tanggal tidak valid! Format: DD/MM/YYYY');
                return;
            }

            if (batchKasKeluar.length === 0) {
                alert('⚠️ Belum ada transaksi yang ditambahkan!');
                return;
            }

            const tanggalISO = convertToISODate(tanggal);
            // Generate nomor jurnal harian (satu nomor untuk semua transaksi di hari yang sama)
            const noJurnalHarian = generateNoJurnalKasHarian(tanggalISO, 'keluar');

            // Simpan semua transaksi dengan nomor jurnal yang sama per hari
            batchKasKeluar.forEach((item, index) => {
                const transaksi = {
                    id: Date.now() + index,
                    tanggal: tanggalISO,
                    noTransaksi: generateNoTransaksi('KK', dataTransaksiKas, tanggalISO),
                    noJurnalHarian: noJurnalHarian, // Nomor jurnal harian
                    jenis: 'keluar',
                    kategori: item.kategori,
                    keterangan: item.keterangan,
                    jumlah: item.jumlah,
                    divisi: divisi
                };

                dataTransaksiKas.push(transaksi);
                // Push dulu ke array agar count increment untuk nomor berikutnya
            });

            // Generate jurnal dari transaksi kas keluar
            buatJurnalKasKeluar({
                tanggal: tanggalISO,
                noJurnalHarian: noJurnalHarian,
                kategori: batchKasKeluar.map(b => b.kategori).join(', '),
                jumlah: batchKasKeluar.reduce((sum, b) => sum + b.jumlah, 0),
                keterangan: batchKasKeluar.map(b => `${b.kategori}: ${b.keterangan}`).join('; ')
            });

            // Simpan ke storage
            saveDataToStorage();

            // Update tampilan
            if (typeof displayTransaksiKas === 'function') displayTransaksiKas();
            if (typeof updateSaldoKas === 'function') updateSaldoKas();
            if (typeof displayJurnal === 'function') displayJurnal();

            alert(`✅ Berhasil menyimpan ${batchKasKeluar.length} transaksi kas keluar!\n\nNomor Jurnal: ${noJurnalHarian}`);

            // Reset form
            resetBatchKasKeluar();
        }

        // Reset Batch Kas Keluar
        function resetBatchKasKeluar() {
            batchKasKeluar = [];
            displayBatchKasKeluar();

            // Reset tanggal ke hari ini
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            const todayFormatted = `${dd}/${mm}/${yyyy}`;

            document.getElementById('tglBatchKasKeluar').value = todayFormatted;
            document.getElementById('divisiBatchKasKeluar').value = '';
            document.getElementById('inputKategoriKasKeluar').value = '';
            document.getElementById('inputKeteranganKasKeluar').value = '';
            document.getElementById('inputJumlahKasKeluar').value = '';
        }

    </script>
</body>

</html>